<!DOCTYPE html>
<html âš¡ lang="en">
  <head>
    <meta charset="utf-8">
    <title>Liquibase with Maven</title>
    <!-- <link rel="canonical" href="http://www.yegor256.com/_posts/2014/jul/2014-07-20-liquibase-in-maven" /> -->
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type='application/ld+json'>
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "_posts/2014/jul/2014-07-20-liquibase-in-maven.md"
        },
        "headline": "Liquibase with Maven",
        "image": {
          "@type": "ImageObject",
          "url": "http://img.teamed.io/face-1400x1400.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-07-20",
        "dateModified": "2014-07-20",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "http://img.teamed.io/face-1400x1400.jpg",
            "width": 1400,
            "height": 1400
          }
        },
        "description": "Liquibase is a convenient tool for database migration
management. Here, I explain how to use it with Maven projects.
",
        "keywords": ["liquibase integration testing java", "liquibase java mysql", "liquibase java postgresql", "liquibase java test", "liquibase maven example", "liquibase maven integration test", "liquibase maven mysql"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <h1>Liquibase with Maven</h1>
    <p><a href="http://www.liquibase.org">Liquibase</a> is a migration management tool
for relational databases. It versionalizes schema and data changes in
a database; similar to the way Git or SVN works for source code.
Thanks to their <a href="http://www.liquibase.org/documentation/maven/">Maven plugin</a>,
Liquibase can be used as a part
of a build automation scenario.</p>

<!--more-->

<h2 id="maven-plugin">Maven Plugin</h2>

<p>Let&#39;s assume you&#39;re using MySQL (PostgreSQL or any other
database configuration will be very similar.)</p>

<p>Add <code>liquibase-maven-plugin</code>
to your <a href="http://maven.apache.org/pom.html"><code>pom.xml</code></a> (get its latest
version in <a href="http://search.maven.org/">Maven Central</a>):</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project&gt;</span>
  [...]
  <span class="nt">&lt;build&gt;</span>
    [...]
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.liquibase<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>liquibase-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;changeLogFile&gt;</span>
            ${basedir}/src/main/liquibase/master.xml
          <span class="nt">&lt;/changeLogFile&gt;</span>
          <span class="nt">&lt;driver&gt;</span>com.mysql.jdbc.Driver<span class="nt">&lt;/driver&gt;</span>
          <span class="nt">&lt;url&gt;</span>jdbc:mysql://${mysql.host}:${mysql.port}/${mysql.db}<span class="nt">&lt;/url&gt;</span>
          <span class="nt">&lt;username&gt;</span>${mysql.login}<span class="nt">&lt;/username&gt;</span>
          <span class="nt">&lt;password&gt;</span>${mysql.password}<span class="nt">&lt;/password&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre></figure>

<p>To check that it works, run <code>mvn liquibase:help</code>.</p>

<p>I would recommend you keep database credentials
in <a href="http://maven.apache.org/settings.html"><code>settings.xml</code></a>
and  in their respective profiles. For example:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;settings&gt;</span>
  <span class="nt">&lt;profiles&gt;</span>
    <span class="nt">&lt;profile&gt;</span>
      <span class="nt">&lt;id&gt;</span>production<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;mysql.host&gt;</span>db.example.com<span class="nt">&lt;/mysql.host&gt;</span>
        <span class="nt">&lt;mysql.port&gt;</span>3306<span class="nt">&lt;/mysql.port&gt;</span>
        <span class="nt">&lt;mysql.db&gt;</span>example<span class="nt">&lt;/mysql.db&gt;</span>
      <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/profile&gt;</span>
    <span class="nt">&lt;profile&gt;</span>
      <span class="nt">&lt;id&gt;</span>test<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;mysql.host&gt;</span>test-db.example.com<span class="nt">&lt;/mysql.host&gt;</span>
        <span class="nt">&lt;mysql.port&gt;</span>3306<span class="nt">&lt;/mysql.port&gt;</span>
        <span class="nt">&lt;mysql.db&gt;</span>example-db<span class="nt">&lt;/mysql.db&gt;</span>
      <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/profile&gt;</span>
  <span class="nt">&lt;/profiles&gt;</span>
<span class="nt">&lt;/settings&gt;</span></code></pre></figure>

<p>When you run Maven, don&#39;t forget to turn
on one of the profiles. For example: <code>mvn -Pproduction</code>.</p>

<h2 id="initial-schema">Initial Schema</h2>

<p>I assume you already have a database with
a schema (tables, triggers, views, etc.) and some data.
You should &quot;reverse engineer&quot; it and create an initial schema
file for Liquibase. In other words, we should inform Liquibase
where we are at the moment, so that it starts to apply
changes from this point.</p>

<p>Maven plugin doesn&#39;t support it, so you will have to run
Liquibase directly. But, it&#39;s not that difficult. First,
run <code>mvn liquibase:help</code> in order to download all artifacts.
Then, replace placeholders with your actual credentials:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>java -jar <span class="se">\</span>
  ~/.m2/repository/org/liquibase/liquibase-core/3.1.1/liquibase-core-3.1.1.jar <span class="se">\</span>
  --driver<span class="o">=</span>com.mysql.jdbc.Driver <span class="se">\</span>
  --url<span class="o">=</span>jdbc:mysql://db.example.com:3306/example <span class="se">\</span>
  --username<span class="o">=</span>example --password<span class="o">=</span>example <span class="se">\</span>
  generateChangeLog &gt; src/main/liquibase/2014/000-initial-schema.xml</code></pre></figure>

<p>Liquibase will analyze your current database schema
and copy its own schema into <code>src/main/liquibase/2014/000-initial-schema.xml</code>.</p>

<h2 id="master-changeset">Master Changeset</h2>

<p>Now, create XML master changeset and save it to <code>src/main/liquibase/master.xml</code>:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;databaseChangeLog</span>
  <span class="na">xmlns=</span><span class="s">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.liquibase.org/xml/ns/dbchangelog</span>
<span class="s">    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;includeAll</span> <span class="na">path=</span><span class="s">&quot;src/main/liquibase/2014&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/databaseChangeLog&gt;</span></code></pre></figure>

<p>It is an entry point for Liquibase. It starts from this file
and loads all other changesets available in <code>src/main/liquibase/2014</code>.
They should be either <code>.xml</code> or <code>.sql</code>. I recommend that you use
XML mostly because it is easier to maintain and works faster.</p>

<h2 id="incremental-changesets">Incremental Changesets</h2>

<p>Let&#39;s create a simple changeset, which adds a new column to an existing table:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;databaseChangeLog</span> <span class="na">xmlns=</span><span class="s">&#39;http://www.liquibase.org/xml/ns/dbchangelog&#39;</span>
  <span class="na">xmlns:xsi=</span><span class="s">&#39;http://www.w3.org/2001/XMLSchema-instance&#39;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&#39;http://www.liquibase.org/xml/ns/dbchangelog</span>
<span class="s">    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">&quot;002&quot;</span> <span class="na">author=</span><span class="s">&quot;Yegor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sql&gt;</span>
      ALTER TABLE user ADD COLUMN address VARCHAR(1024);
    <span class="nt">&lt;/sql&gt;</span>
  <span class="nt">&lt;/changeSet&gt;</span>
<span class="nt">&lt;/databaseChangeLog&gt;</span></code></pre></figure>

<p>We save this file we in <code>src/main/liquibase/2014/002-add-user-address.xml</code>.
In big projects, you can name your files by the names of the tickets
they are produced in. For example, <code>045-3432.xml</code>, which means changeset
number 45 coming from ticket #3432.</p>

<p>The important thing is to have this numeric prefix in front of file names,
in order to sort them correctly. We want changes to be applied in their
correct chronological order.</p>

<p>That&#39;s it. We&#39;re ready to run <code>mvn liquibase:update -Pproduction</code> and
our production database will be updated &mdash; a new column will be
added to the <code>user</code> table.</p>

<p>Also, see how <a href="/2014/05/21/mysql-maven-plugin.html">MySQL Maven Plugin</a>
can help you to automate integration testing of database-connected classes.</p>

  </body>
</html>
