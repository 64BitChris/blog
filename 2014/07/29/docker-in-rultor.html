<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope itemtype="http://schema.org/WebPage"><head><base href="/"/><meta charset="utf-8"/><meta itemprop="name" content="Every Build in Its Own Docker Container"/><meta itemprop="author" content="Yegor Bugayenko"/><meta itemprop="breadcrumb" content="http://www.yegor256.com"/><meta itemprop="keywords" content="continuous delivery, continuous integration, docker builds ci, docker container continuous integration, docker continuous delivery, docker continuous integration, docker devops, jenkins docker, unit tests in docker"/><meta itemprop="description" content="Rultor.com runs every build in its own Docker container, perfectly isolating configurations and making them cacheable and reproducible."/><meta name="description" content="Rultor.com runs every build in its own Docker container, perfectly isolating configurations and making them cacheable and reproducible."/><meta name="keywords" content="continuous delivery, continuous integration, docker builds ci, docker container continuous integration, docker continuous delivery, docker continuous integration, docker devops, jenkins docker, unit tests in docker"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="twitter:creator" content="@yegor256"/><meta property="twitter:account_id" content="4503599630178231"/><meta property="og:url" content="http://www.yegor256.com"/><meta property="og:site_name" content="yegor256"/><meta property="og:image" content="/favicon.ico?3aa233c"/><meta property="og:title" content="Every Build in Its Own Docker Container"/><meta property="og:description" content="Rultor.com runs every build in its own Docker container, perfectly isolating configurations and making them cacheable and reproducible."/><link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="yegor256"/><link rel="shortcut icon" href="/favicon.ico?3aa233c"/><link rel="apple-touch-icon" href="/favicon.ico?3aa233c"/><link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="http://plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="publisher" href="http://plus.google.com/u/0/114792568016408327418"/><link rel="stylesheet" href="/css/layout.css?3aa233c"/><link rel="stylesheet" href="//img.teamed.io/yegor256/icons.css?3aa233c"/><link rel="canonical" href="http://www.yegor256.com/2014/07/29/docker-in-rultor.html"/><title>Every Build in Its Own Docker Container - Yegor Bugayenko</title></head><body><div class="wrapper"> <header class="header"><div> <a href="/about-me.html"> <img src="/images/yegor-bugayenko.png" class="photo" alt="photo of Yegor Bugayenko"/> </a></div> <nav role="navigation"><ul class="menu social notranslate"><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li><li><a href="/rss" title="RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li><li><a href="https://github.com/yegor256" title="my Github profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="icon icon-googleplus notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li><li><a href="http://www.youtube.com/user/technoparkcorp" title="my Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"><li> <a href="/best.html" title="best articles to read">12 best articles</a> · <a href="/contents.html" title="blog contents">all 130</a> · <a href="/webinars.html" title="webinars">webinars</a> · <a href="/" title="home page">home page</a></li></ul><ul class="menu"><li> Win <strong style="font-size:2em;color:#81b341"> <a href="/award.html" title="software quality award">$4,096</a> </strong> for Your Open Source Project!</li></ul> </nav><div id="search"> <input id="search-query" class="field field-text" name="q" placeholder="Search" autocomplete="off"/><div id="search-results" style="display:none"><div class="entries"></div></div></div><div style="color:#48624b;text-align:left;margin:2em 0"> <img src="/images/2015/08/webinar-5.gif" style="width:64px;height:64px;float:left;margin-right:1em" alt="webinar logo"/> Hey, don't miss the next webinar, on the 5th of August, at 11am PST; we'll talk about <a href="https://plus.google.com/events/cftrih1qol7h1q8sdprcbuv0c9g">Objects That End With -ER</a> and why they are actually an anti-pattern.</div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header></div> <section itemscope itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <code>http://www.yegor256.com/2014/07/29/docker-in-rultor.html</code></p><h1 itemprop="name">Every Build in Its Own Docker Container</h1><ul class="subline"><li> <time itemprop="datePublished" datetime="2014-07-29T00:00:00+00:00"> 29 July 2014 </time></li><li><a href='https://github.com/yegor256/blog/commits/master/_posts/2014/jul/2014-07-29-docker-in-rultor.md'>modified</a> on <time itemprop='dateModified' datetime='2014-10-02T07:34:09+0000'>2 October 2014</time></li><li class="printable">Yegor Bugayenko</li><li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2014/07/29/docker-in-rultor.html#disqus_thread">comments</a></li></ul><p class="unprintable"><a href='/tag/docker.html' class='tag notranslate'>docker</a> <a href='/tag/rultor.html' class='tag notranslate'>rultor</a> <a href='/tag/devops.html' class='tag notranslate'>devops</a></p><div class="buttons notranslate desktop-only"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/07/29/docker-in-rultor.html" title="Share on Facebook" class="button"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/07/29/docker-in-rultor.html&amp;text=Every+Build+in+Its+Own+Docker+Container" title="Share on Twitter" class="button"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/07/29/docker-in-rultor.html" title="Share on Google+" class="button"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/07/29/docker-in-rultor.html" title="Share on LinkedIn" class="button"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://www.stumbleupon.com/submit?url=http://www.yegor256.com/2014/07/29/docker-in-rultor.html&amp;title=Every+Build+in+Its+Own+Docker+Container" title="Share on StumbleUpon" class="button"> <span class="count count-stumbleupon">0</span> <i class="icon icon-stumbleupon notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=http://www.yegor256.com/2014/07/29/docker-in-rultor.html%3F2014-30&amp;title=Every+Build+in+Its+Own+Docker+Container" title="Share on Reddit" class="button"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=http://www.yegor256.com/2014/07/29/docker-in-rultor.html%3F2014-30&amp;t=Every+Build+in+Its+Own+Docker+Container" title="Share on Hacker News" class="button"> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav></div> </header> <main role="main"> <article class="main" role="article" itemprop="articleBody"> <figure class='badge'><a href='http://www.docker.io'><img src='http://doc.rultor.com/images/docker-logo.png' style='width:100px' alt='badge'/></a></figure><p><a href="http://www.docker.io">Docker</a> is a command line tool that can run a shell command in a virtual Linux, inside an isolated file system. Every time we build our projects, we want them to run in their own Docker containers. Take this Maven project for example:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker run -i -t ubuntu mvn clean <span class="nb">test</span></code></pre></div><figure class='badge'><a href='http://www.rultor.com'><img src='http://doc.rultor.com/images/logo.svg' style='width:100px' alt='badge'/></a></figure><p>This command will start a new Ubuntu system and execute <code>mvn clean test</code> inside it. <a href="http://www.rultor.com">Rultor.com</a>, our virtual assistant, does exactly that with our builds, when we deploy, package, test and merge them.</p><h2 id="why-docker?">Why Docker?</h2><p>What benefits does it give us? And why Docker, when there are many <a href="https://en.wikipedia.org/wiki/Operating_system-level_virtualization">other virtualization technologies</a>, like LXC, for example?</p><p>Well, there are a few very important benefits:</p><ul><li><p>Image repository (hub.docker.com)</p></li><li><p>Versioning</p></li><li><p>Application-centric</p></li></ul><p>Let's discuss them in details.</p><h2 id="image-repository">Image Repository</h2><p>Docker enables image sharing through its public repository at <a href="http://hub.docker.com">hub.docker.com</a>. This means that after I prepare a working environment for my application, I make an image out of it and push it to the hub.</p><p>Let's say, I want my Maven build to be executed in a container with a pre-installed graphviz package (in order to enable <code>dot</code> command line tool). First, I would start a plain vanilla Ubuntu container, and install graphviz inside it:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker run -i -t ubuntu /bin/bash
root@215d2696e8ad:/# sudo apt-get install -y graphviz
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
...
root@215d2696e8ad:/# <span class="nb">exit</span>
<span class="nv">$ </span>sudo docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS                     PORTS               NAMES
215d2696e8ad        ubuntu:14.04        /bin/bash           About a minute ago   Exited <span class="o">(</span>0<span class="o">)</span> <span class="m">3</span> seconds ago                       high_mccarthy</code></pre></div><p>I have a container that stopped a few seconds ago. Container's ID is <code>215d2696e8ad</code>. Now, I want to make it reusable for all further tests in Rultor.com. I have to create an image from it:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker commit 215d2696e8ad yegor256/beta
c5ad7718fc0e20fe4bf2c8a9bfade4db8617a25366ca5b64be2e1e8aa0de6e52</code></pre></div><p>I just made my new commit to a new image <code>yegor256/beta</code>. This image can be reused right now. I can create a new container from this image and it will have graphviz installed inside!</p><p>Now it's time to share my image at Docker hub, in order to make it available for Rultor:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker push yegor256/beta
The push refers to a repository <span class="o">[</span>yegor256/beta<span class="o">]</span> <span class="o">(</span>len: 1<span class="o">)</span>
Sending image list
Pushing repository yegor256/beta <span class="o">(</span><span class="m">1</span> tags<span class="o">)</span>
511136ea3c5a: Image already pushed, skipping
d7ac5e4f1812: Image already pushed, skipping
2f4b4d6a4a06: Image already pushed, skipping
83ff768040a0: Image already pushed, skipping
6c37f792ddac: Image already pushed, skipping
e54ca5efa2e9: Image already pushed, skipping
c5ad7718fc0e: Image successfully pushed
Pushing tag <span class="k">for</span> rev <span class="o">[</span>c5ad7718fc0e<span class="o">]</span> on <span class="o">{</span>https://registry-1.docker.io/v1/repositories/yegor256/beta/tags/latest<span class="o">}</span></code></pre></div><p>The last step is to configure Rultor to use this image in all builds. To do this, I will edit <a href="http://doc.rultor.com/reference.html"><code>.rultor.yml</code></a> in the root directory of my Github repository:</p><div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">docker</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yegor256/beta</span></code></pre></div><p>That's it. From now on, Rultor will use my custom Docker image with pre-installed graphviz, in every build (merge, release, deploy, etc.)</p><p>Moreover, if and when I want to add something else to the image, it's easy to do. Say, I want to install Ruby into my build image. I start a container from the image and install it (pay attention, I'm starting a container not from <code>ubuntu</code> image, as I did before, but from <code>yegor256/beta</code>):</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker run -i -t yegor256/beta /bin/bash
root@7e0fbd9806c9:/# sudo apt-get install -y ruby
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
...
root@7e0fbd9806c9:/# <span class="nb">exit</span>
<span class="nv">$ </span>sudo docker ps -a
CONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS                     PORTS               NAMES
7e0fbd9806c9        yegor256/beta:latest   /bin/bash           <span class="m">28</span> seconds ago      Exited <span class="o">(</span>0<span class="o">)</span> <span class="m">2</span> seconds ago                       pensive_pare
215d2696e8ad        ubuntu:14.04           /bin/bash           <span class="m">10</span> minutes ago      Exited <span class="o">(</span>0<span class="o">)</span> <span class="m">8</span> minutes ago                       high_mccarthy</code></pre></div><p>You can now see that I have two containers. The first one is the one I am using right now; it contains Ruby. The second one is the one I was using before and it contains graphviz.</p><p>Now I have to commit again and push:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker commit 7e0fbd9806c9 yegor256/beta
6cbfb7a6b18a2182f42171f6bb5aef67c4819b5c2795edffa6a63ba78aaada2d
<span class="nv">$ </span>sudo docker push yegor256/beta
...</code></pre></div><p>Thus, this Docker hub is a very convenient feature for Rultor and similar systems.</p><h2 id="versioning">Versioning</h2><p>As you saw in the example above, every change to a Docker image has its own version (hash) and it's possible to track changes. It is also possible to roll back to any particular change.</p><p>Rultor is not using this functionality itself, but Rultor users are able to control their build configurations with much better precision.</p><h2 id="application-centric">Application-Centric</h2><p>Docker, unlike LXC or Vagrant, for example, is application-centric. This means that when we start a container — we start an application. With other virtualization technologies, when you get a virtual machine — you get a fully functional Unix environment, where you can login through SSH and do whatever you want.</p><p>Docker makes things simpler. It doesn't give you SSH access to container, but runs an application inside and shows you its output. This is exactly what we need in Rultor. We need to run an automated build (for example Maven or Bundler), see its output and get its exit code. If the code is not zero, we fail the build and report to the user.</p><p>This is how we run Maven build:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo docker run --rm -i -t yegor256/rultor mvn clean <span class="nb">test</span>
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Building jcabi-github 0.13
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> --- maven-clean-plugin:2.5:clean <span class="o">(</span>default-clean<span class="o">)</span> @ jcabi-github ---
<span class="o">[</span>INFO<span class="o">]</span>
...</code></pre></div><p>As you can see, Maven starts immediately. We don't worry about the internals of the container. We just start an application inside it.</p><p>Furthermore, thanks to the <code>--rm</code> option, the container gets destroyed immediately after Maven execution is finished.</p><p>This is what application-centric is about.</p><p>Our overall impression of Docker is highly positive.</p><p>ps. A compact version of this article was published at <a href="http://devops.com/blogs/build-docker-containers/">devops.com</a></p></article> </main><div class="unprintable"><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/07/31/travis-and-rultor.html">Rultor + Travis</a></li><li><a href="/2014/08/29/docker-non-root.html">How We Run as a Non-Root Inside Docker Container</a></li><li><a href="/2015/03/29/rultor-with-appveyor.html">How AppVeyor Helps Me to Validate Pull Requests Before Rultor Merges Them</a></li><li><a href="/2014/09/13/deploying-to-heroku.html">Deploying to Heroku, in One Click</a></li><li><a href="/2014/09/11/deployment-script-vs-rultor.html">Deployment Script vs. Rultor</a></li></ul></div></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014-2015</p> </footer></div></section><script src="http://code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/ext/search.min.js?3aa233c"></script><script src="/js/global.js?3aa233c" async defer></script><script src="/js/post.js?3aa233c" async defer></script></body></html>