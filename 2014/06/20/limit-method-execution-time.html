<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebPage"><head><base href="/2014/06/20/limit-method-execution-time.html"/><meta charset="utf-8"/><meta itemprop="name" content="Limit Java Method Execution Time"/><meta itemprop="author" content="Yegor Bugayenko"/><meta itemprop="breadcrumb" content="http://www.yegor256.com"/><meta itemprop="keywords" content="aop annotations Timeable, aop java, aop method time annotations, aspect oriented programming java, aspectj timing, aspectj weaving annotations, java limit method execution time, limit method execution time java"/><meta itemprop="description" content="Aspect oriented programming with AspectJ and jcabi-aspects can help you to control maximum execution time for any single Java method"/><meta name="description" content="Aspect oriented programming with AspectJ and jcabi-aspects can help you to control maximum execution time for any single Java method"/><meta name="keywords" content="aop annotations Timeable, aop java, aop method time annotations, aspect oriented programming java, aspectj timing, aspectj weaving annotations, java limit method execution time, limit method execution time java"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="twitter:creator" content="@yegor256"/><meta property="twitter:account_id" content="4503599630178231"/><meta property="og:url" content="http://www.yegor256.com/2014/06/20/limit-method-execution-time.html"/><meta property="og:site_name" content="yegor256"/><meta property="og:title" content="Limit Java Method Execution Time"/><meta property="og:description" content="Aspect oriented programming with AspectJ and jcabi-aspects can help you to control maximum execution time for any single Java method"/><meta property="og:type" content="article"/><meta property="og:locale" content="en_US"/><meta property="fb:admins" content="10203747823006002"/><meta name="twitter:site" content="@yegor256"/><meta name="twitter:creator" content="@yegor256"/><meta name="twitter:url" content="http://www.yegor256.com/2014/06/20/limit-method-execution-time.html"/><meta property="article:author" content="https://www.facebook.com/yegor.bugayenko"/><meta name="p:domain_verify" content="61f09f0ef5db665328827225a3fc11bd"/><link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="yegor256"/><link rel="shortcut icon" href="/favicon.ico?ad2b5b5"/><link rel="apple-touch-icon" href="/favicon.ico?ad2b5b5"/><link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="http://plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="publisher" href="http://plus.google.com/u/0/114792568016408327418"/><link rel="stylesheet" href="/css/layout.css?ad2b5b5"/><link rel="canonical" href="http://www.yegor256.com/2014/06/20/limit-method-execution-time.html"/><title>Limit Java Method Execution Time - Yegor Bugayenko</title></head><body><div class="wrapper"> <header class="header"><div class="face"> <a href="/about-me.html"> <img src="/images/yegor-bugayenko-192x192.png" class="photo" alt="photo of Yegor Bugayenko"/> </a> <a href="/about-me.html"><span>hire me!</span></a></div> <nav><ul class="menu social notranslate"><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li><li><a href="/rss" title="RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li><li><a href="https://github.com/yegor256" title="my GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="icon icon-googleplus notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li><li><a href="http://www.youtube.com/user/technoparkcorp" title="my Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.pinterest.com/yegor256/" title="my Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"><li> <a href="/" title="home page">home</a> · <a href="/best.html" title="best articles to read">12 best</a> · <a href="/contents.html" title="blog contents">all 155</a> · <a href="/webinars.html" title="webinars">webinars</a> · <a href="/talks.html" title="talks">talks</a> · <a href="/award.html" title="software quality award">award</a></li></ul> </nav><div id="search"><form action="https://www.google.com/search" style="position:relative"> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input id="search-query" class="field field-text" onfocusin="$('#google').css('display', 'inline-block');" name="q" placeholder="Search" autocomplete="off"/> <span class="desktop-only"> <input type="image" src="/images/google-search-icon.png" id="google" title="search via Google" style="width:3em;height:3em;display:none;position:absolute;margin-left:1em"/> </span></form><div id="search-results" style="display:none"><div class="entries"></div></div></div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header><div class="hot"><ul><li> I need your help in reviewing my first book <strong><a href="/elegant-objects.html">Elegant Ojects</a></strong>, it is about object-oriented programming</li><li> Meet me in Kyiv next Monday at <a href="http://buildstuff.com.ua/">BuildStuff</a>, I'll talk about Chatbot architecture, and next Wednesday in Warsaw at <a href="http://devopsdays.pl/">DevOpsDays</a> for a discussion of Continuous Integration possible negative effects</li><li> <a href="https://plus.google.com/u/0/events/c6pfo5ku07kd5a92dgrmj5b1o6g">Webinar #9</a> will explain why Dependency Injection containers are a bad idea in OOP, don't miss it on December 1, at 11am PST (it's Tuesday!)</li></ul></div></div> <section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html&amp;format=svg" style="width:250px;height:250px"/></p><p class="printable"> <code>http://www.yegor256.com/2014/06/20/limit-method-execution-time.html</code></p><h1 itemprop="name">Limit Java Method Execution Time</h1><ul class="subline"><li> <time itemprop="datePublished" datetime="2014-06-20T00:00:00+00:00"> 20 June 2014 </time></li><li class='unprintable desktop-only'><a href='https://github.com/yegor256/blog/commits/master/_posts/2014/jun/2014-06-20-limit-method-execution-time.md'>modified</a> on <time itemprop='dateModified' datetime='2014-10-20T08:48:38+0000'>20 October 2014</time></li><li class="printable">Yegor Bugayenko</li><li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2014/06/20/limit-method-execution-time.html#disqus_thread">comments</a></li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'>java</a> <a href='/tag/aop.html' class='tag notranslate'>aop</a></p><div class="buttons notranslate desktop-only"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html" title="Share on Facebook" class="button"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html&amp;text=Limit+Java+Method+Execution+Time" title="Share on Twitter" class="button"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html" title="Share on Google+" class="button"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html" title="Share on LinkedIn" class="button"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://www.stumbleupon.com/submit?url=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html&amp;title=Limit+Java+Method+Execution+Time" title="Share on StumbleUpon" class="button"> <span class="count count-stumbleupon">0</span> <i class="icon icon-stumbleupon notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html%3F2014-24&amp;title=Limit+Java+Method+Execution+Time" title="Share on Reddit" class="button"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=http://www.yegor256.com/2014/06/20/limit-method-execution-time.html%3F2014-24&amp;t=Limit+Java+Method+Execution+Time" title="Share on Hacker News" class="button"> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav></div> </header> <main> <article class="main" itemprop="articleBody"> <figure class='badge'><a href='http://aspects.jcabi.com'><img src='http://img.jcabi.com/logo-square.svg' style='width:64px' alt='badge'/></a></figure><p>Say, you want to allow a Java method to work for a maximum of five seconds and want an exception to be thrown if the timeframe is exceeded. Here is how you can do it with <a href="http://aspects.jcabi.com">jcabi-aspects</a> and <a href="http://eclipse.org/aspectj/">AspectJ</a>:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Resource</span> <span class="o">{</span>
  <span class="nd">@Timeable</span><span class="o">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>Keep in mind that you should weave your classes after compilation, as explained <a href="http://aspects.jcabi.com/example-weaving.html">here</a>.</p><p>Let's discuss how this actually works, but first, I recommend you read <a href="/2014/06/01/aop-aspectj-java-method-logging.html">this post</a>, which explains how AOP aspects work together with Java annotations.</p><p>Due to <a href="http://aspects.jcabi.com/annotation-timeable.html"><code>@Timeable</code></a> annotation and class weaving, every call to a method <code>load()</code> is intercepted by an aspect from <a href="http://aspects.jcabi.com">jcabi-aspects</a>. That aspect starts a new thread that monitors the execution of a method every second, checking whether it is still running.</p><p>If the method runs for over five seconds, the thread calls <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code>interrupt()</code></a> on the method's thread.</p><p>Despite a very common expectation that a thread should be terminated immediately on that call, it is not happening at all. <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html">This article</a> explains the mechanism in more detail. Let's discuss it briefly:</p><ol><li><p><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code>interrupt()</code></a> sets a marker in a thread;</p></li><li><p>The thread checks <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code>interrupted()</code></a> as often as it can;</p></li><li><p>If the marker is set, the thread stops and throws <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/InterruptedException.html"><code>InterruptedException</code></a></p></li></ol><p>This method will <strong>not</strong> react to <code>interrupt()</code> call and will work until JVM is killed (very bad design):</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">work</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// do something</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>This is how we should refactor it in order to make sensitive to interruption requests:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">work</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interruped</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// do something</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>In other words, your method can only stop itself. Nothing else can do it. The thread it is running in can't be terminated by another thread. The best thing that the other thread can do is to send your thread a "message" (through <code>interrupt()</code> method) that it's time to stop. If your thread ignores the message, nobody can do anything.</p><p>Most I/O operations in JDK are designed this way. They check the interruption status of their threads while waiting for I/O resources.</p><p>Thus, use <code>@Timeable</code> annotation, but keep in mind that there could be situations when a thread can't be interrupted.</p></article> </main><div class="unprintable"><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/08/15/retry-java-method-on-exception.html">How to Retry Java Method Call on Exception</a></li><li><a href="/2014/08/03/cacheable-java-annotation.html">Cache Java Method Results</a></li><li><a href="/2014/06/01/aop-aspectj-java-method-logging.html">Java Method Logging with AOP and Annotations</a></li><li><a href="/2015/11/03/chatbot-better-than-ui-for-microservice.html">A Chatbot Is Better Than a UI for a Microservice</a></li><li><a href="/2015/10/20/interrupted-exception.html">What Do You Do With InterruptedException?</a></li></ul></div><div class="teamed-banner"> <a href="http://www.teamed.io"><img src="/images/teamed-banner.jpg" alt="teamed banner"/></a></div></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014-2015</p> </footer></div></section><script src="http://code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/global.js?ad2b5b5"></script><script src="/js/post.js?ad2b5b5"></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script></body></html>