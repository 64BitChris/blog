<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebPage"><head><base href="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html"/><meta charset="utf-8"/><meta itemprop="name" content="Built-in Fake Objects"/><meta itemprop="author" content="Yegor Bugayenko"/><meta itemprop="breadcrumb" content="http://www.yegor256.com"/><meta itemprop="keywords" content="best practices of mocking, java mock framework, java mocking, mocking frameworks, mocking is bad, mocking is evil, mocks are evil"/><meta itemprop="description" content="Mocking frameworks is not a good practice and should be your last resort; instead, create and ship fake classes together with your code."/><meta name="description" content="Mocking frameworks is not a good practice and should be your last resort; instead, create and ship fake classes together with your code."/><meta name="keywords" content="best practices of mocking, java mock framework, java mocking, mocking frameworks, mocking is bad, mocking is evil, mocks are evil"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="twitter:creator" content="@yegor256"/><meta property="twitter:account_id" content="4503599630178231"/><meta property="og:url" content="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html"/><meta property="og:site_name" content="yegor256"/><meta property="og:title" content="Built-in Fake Objects"/><meta property="og:description" content="Mocking frameworks is not a good practice and should be your last resort; instead, create and ship fake classes together with your code."/><meta property="og:type" content="article"/><meta property="og:locale" content="en_US"/><meta property="fb:admins" content="10203747823006002"/><meta name="twitter:site" content="@yegor256"/><meta name="twitter:creator" content="@yegor256"/><meta name="twitter:url" content="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html"/><meta property="article:author" content="https://www.facebook.com/yegor.bugayenko"/><meta name="p:domain_verify" content="61f09f0ef5db665328827225a3fc11bd"/><link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="yegor256"/><link rel="shortcut icon" href="/favicon.ico?1f0fe88"/><link rel="apple-touch-icon" href="/favicon.ico?1f0fe88"/><link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="http://plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="publisher" href="http://plus.google.com/u/0/114792568016408327418"/><link rel="stylesheet" href="/css/layout.css?1f0fe88"/><link rel="canonical" href="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html"/><title>Built-in Fake Objects - Yegor Bugayenko</title></head><body><div class="wrapper"> <header class="header"><div class="face"> <a href="/about-me.html"><span class="sub">subscribe</span></a> <a href="/about-me.html"> <img src="/images/yegor-bugayenko-192x192.png" class="photo" alt="photo of Yegor Bugayenko"/> </a> <a href="/about-me.html"><span class="hire">hire me</span></a></div> <nav><ul class="menu social notranslate"><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li><li><a href="/rss" title="RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li><li><a href="https://github.com/yegor256" title="my GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="icon icon-googleplus notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li><li><a href="http://www.youtube.com/user/technoparkcorp" title="my Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.pinterest.com/yegor256/" title="my Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"><li> <a href="/" title="home page">home</a> · <a href="/best.html" title="best articles to read">12 best</a> · <a href="/contents.html" title="blog contents">all 159</a> · <a href="/webinars.html" title="webinars">webinars</a> · <a href="/talks.html" title="talks">talks</a> · <a href="/award.html" title="software quality award">award</a></li></ul> </nav><div id="search"><form action="https://www.google.com/search" style="position:relative"> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input id="search-query" class="field field-text" onfocus="$('#google').css('display','inline-block')" name="q" placeholder="Search" autocomplete="off"/> <span class="desktop-only"> <input type="image" src="/images/google-search-icon.png" id="google" title="search via Google" style="width:3em;height:3em;display:none;position:absolute;margin-left:1em" alt="search via Google"/> </span></form><div id="search-results" style="display:none"><div class="entries"></div></div></div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header><div class="hot"><ul><li> While traveling, I'm starting to give lectures about OOP, project management and DevOps. Want me to talk <strong><a href="/lectures.html">in your office</a></strong>?</li><li> My first book <strong><a href="/elegant-objects.html">Elegant Objects</a></strong>, about object-oriented programming, will be published by the end of January</li><li> <a href="https://plus.google.com/u/0/events/c2l3nfnkkmfg01e2gvoks028a1c">Webinar #10</a> will be about Object-Relational Mapping (<strong>ORM</strong>) and why it is actually an <strong>anti-pattern</strong>, join us on January 6, at 11am PST</li></ul></div></div> <section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;format=svg" style="width:125px;height:125px" alt="QR code"/></p><p class="printable"> <code>http://www.yegor256.com/2014/09/23/built-in-fake-objects.html</code></p><h1 itemprop="name">Built-in Fake Objects</h1><ul class="subline"><li> <time itemprop="datePublished" datetime="2014-09-23T00:00:00+00:00"> 23 September 2014 </time></li><li class='unprintable desktop-only'><a href='https://github.com/yegor256/blog/commits/master/_posts/2014/sep/2014-09-23-built-in-fake-objects.md'>modified</a> on <time itemprop='dateModified' datetime='2015-11-21T06:26:40+0000'>21 November 2015</time></li><li class="printable">Yegor Bugayenko</li><li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html#disqus_thread">comments</a></li></ul><p class="unprintable"><a href='/tag/tdd.html' class='tag notranslate'>tdd</a> <a href='/tag/java.html' class='tag notranslate'>java</a></p><div class="buttons notranslate desktop-only"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on Facebook" class="button"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;text=Built-in+Fake+Objects" title="Share on Twitter" class="button"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on Google+" class="button"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on LinkedIn" class="button"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://www.stumbleupon.com/submit?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;title=Built-in+Fake+Objects" title="Share on StumbleUpon" class="button"> <span class="count count-stumbleupon">0</span> <i class="icon icon-stumbleupon notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html%3F2014-38&amp;title=Built-in+Fake+Objects" title="Share on Reddit" class="button"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html%3F2014-38&amp;t=Built-in+Fake+Objects" title="Share on Hacker News" class="button"> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav></div> </header> <main> <article class="main" itemprop="articleBody"><p>While mock objects are perfect instruments for unit testing, mocking through mock frameworks may turn your unit tests into an unmaintainable mess. Thanks to them we often hear that "mocking is bad" and "mocking is evil".</p><iframe class='video video-left' src='https://www.youtube.com/embed/l6MpCBzwDbg?controls=2' allowfullscreen></iframe><p>The root cause of this complexity is that our objects are too big. They have many methods and these methods return other objects, which also have methods. When we pass a mock version of such an object as a parameter, we should make sure that all of its methods return valid objects.</p><p>This leads to inevitable complexity, which turns unit tests to <a href="https://news.ycombinator.com/item?id=7353767">waste</a> almost impossible to maintain.</p><h2 id="object-hierarchy">Object Hierarchy</h2><p>Take the <code>Region</code> interface from <a href="http://dynamo.jcabi.com">jcabi-dynamo</a> as an example (this snippet and all others in this article are simplified, for the sake of brevity):</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Region</span> <span class="o">{</span>
  <span class="n">Table</span> <span class="nf">table</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre></div><p>Its <code>table()</code> method returns an instance of the <code>Table</code> interface, which has its own methods:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Table</span> <span class="o">{</span>
  <span class="n">Frame</span> <span class="nf">frame</span><span class="o">();</span>
  <span class="n">Item</span> <span class="nf">put</span><span class="o">(</span><span class="n">Attributes</span> <span class="n">attrs</span><span class="o">);</span>
  <span class="n">Region</span> <span class="nf">region</span><span class="o">();</span>
<span class="o">}</span></code></pre></div><p>Interface <code>Frame</code>, returned by the <code>frame()</code> method, also has its own methods. And so on. In order to create a properly mocked instance of interface <code>Region</code>, one would normally create a dozen other mock objects. With <a href="http://www.mockito.org">Mockito</a> it will look like this:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMe</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// many more lines here...</span>
  <span class="n">Frame</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Frame</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(...).</span><span class="na">when</span><span class="o">(</span><span class="n">frame</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
  <span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Table</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="n">frame</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">frame</span><span class="o">();</span>
  <span class="n">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Region</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">region</span><span class="o">).</span><span class="na">table</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">());</span>
<span class="o">}</span></code></pre></div><p>And all of this is just a <a href="/2015/05/25/unit-test-scaffolding.html">scaffolding</a> before the actual testing.</p><h2 id="sample-use-case">Sample Use Case</h2><p>Let's say, you're developing a project that uses jcabi-dynamo for managing data in <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a>. Your class may look similar to this:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Region</span> <span class="n">region</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Employee</span><span class="o">(</span><span class="n">String</span> <span class="n">empl</span><span class="o">,</span> <span class="n">Region</span> <span class="n">dynamo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">empl</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">region</span> <span class="o">=</span> <span class="n">dynamo</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">salary</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span>
      <span class="k">this</span><span class="o">.</span><span class="na">region</span>
        <span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">"employees"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">frame</span><span class="o">()</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
        <span class="o">.</span><span class="na">iterator</span><span class="o">()</span>
        <span class="o">.</span><span class="na">next</span><span class="o">()</span>
        <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"salary"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getN</span><span class="o">()</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>You can imagine how difficult it will be to unit test this class, using Mockito, for example. First, we have to mock the <code>Region</code> interface. Then, we have to mock a <code>Table</code> interface and make sure it is returned by the <code>table()</code> method. Then, we have to mock a <code>Frame</code> interface, etc.</p><p>The unit test will be much longer than the class itself. Besides that, its real purpose, which is to test the retrieval of an employee's salary, will not be obvious to the reader.</p><p>Moreover, when we need to test a similar method of a similar class, we will need to restart this mocking from scratch. Again, multiple lines of code, which will look very similar to what we have already written.</p><h2 id="fake-classes">Fake Classes</h2><p>The solution is to create fake classes and ship them together with real classes. This is what <a href="http://dynamo.jcabi.com">jcabi-dynamo</a> is doing. Just look at its <a href="http://dynamo.jcabi.com/apidocs-0.16.1/index.html">JavaDoc</a>. There is a package called <code>com.jcabi.dynamo.mock</code> that contains only fake classes, suitable only for unit testing.</p><p>Even though their sole purpose is to optimize unit testing, we <a href="/2014/08/19/how-to-release-to-maven-central.html">ship them</a> together with production code, in the same JAR package.</p><p>This is what a test will look like, when a fake class <code>MkRegion</code> is used:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">canFetchSalaryFromDynamoDb</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MkRegion</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">H2Data</span><span class="o">().</span><span class="na">with</span><span class="o">(</span>
        <span class="s">"employees"</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">"name"</span><span class="o">},</span>
        <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">"salary"</span><span class="o">}</span>
      <span class="o">)</span>
    <span class="o">);</span>
    <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">"employees"</span><span class="o">).</span><span class="na">put</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">Attributes</span><span class="o">()</span>
        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"Jeff"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"salary"</span><span class="o">,</span> <span class="k">new</span> <span class="nf">AttributeValue</span><span class="o">().</span><span class="na">withN</span><span class="o">(</span><span class="mi">50000</span><span class="o">))</span>
    <span class="o">);</span>
    <span class="n">Employee</span> <span class="n">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Employee</span><span class="o">(</span><span class="s">"Jeff"</span><span class="o">,</span> <span class="n">region</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">salary</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="mi">50000</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>This test looks obvious to me. First, we create a fake DynamoDB region, which works on top of <code>H2Data</code> storage (in-memory H2 database). The storage will be ready for a single <code>employees</code> table with a hash key <code>name</code> and a single <code>salary</code> attribute.</p><p>Then, we put a record into the table, with a hash <code>Jeff</code> and a salary <code>50000</code>.</p><p>Finally, we create an instance of class <code>Employee</code> and check how it fetches the salary from DynamoDB.</p><p>I'm currently doing the same thing in almost every open source library I'm working with. I'm creating a collection of fake classes, that simplify testing inside the library and for its users.</p><p>BTW, a great article on the same subject: <a href="http://nedbatchelder.com/blog/201206/tldw_stop_mocking_start_testing.html">tl;dw: Stop mocking, start testing</a> by Ned Batchelder.</p><p>PS. Check this out, on a very similar subject: <a href="/2014/04/18/jcabi-http-server-mocking.html">Mocking of HTTP Server in Java</a>.</p></article> </main><div class="unprintable"><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2015/07/16/fools-dont-write-unit-tests.html">Fools Don't Write Unit Tests</a></li><li><a href="/2015/12/08/temporal-coupling-between-method-calls.html">Temporal Coupling Between Method Calls</a></li><li><a href="/2015/12/01/rethrow-exceptions.html">Throwing an Exception Without Proper Context Is a Bad Habit</a></li><li><a href="/2015/11/03/chatbot-better-than-ui-for-microservice.html">A Chatbot Is Better Than a UI for a Microservice</a></li><li><a href="/2015/10/20/interrupted-exception.html">What Do You Do With InterruptedException?</a></li></ul></div><div class="teamed-banner"> <a href="http://www.teamed.io"><img src="/images/teamed-banner.jpg" alt="teamed banner"/></a></div></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014-2015</p> </footer></div></section><script src="http://code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/global.js?1f0fe88"></script><script src="/js/post.js?1f0fe88"></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script></body></html>