<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta charset="utf-8"/><meta name="description" content="Mocking frameworks is not a good practice and should be your last resort; instead, create and ship fake classes together with your code."/><meta name="keywords" content="best practices of mocking, java mock framework, java mocking, java mockito example, mocking frameworks, mocking is bad, mocking is evil, mockito java, mocks are evil, why mocking is evil"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="twitter:account_id" content="4503599630178231"/><link rel="shortcut icon" href="/favicon.ico?ce5e8e8"/><link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="//plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="stylesheet" href="/css/layout.css?ce5e8e8"/><link rel="canonical" href="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html"/><title>Built-in Fake Objects - Yegor Bugayenko</title></head><body><div class="wrapper"> <header class="header"><div> <a href="/about-me.html"> <img src="/images/yegor-bugayenko.png" class="photo" alt="photo"/> </a></div> <nav role="navigation"><ul class="menu social notranslate"><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li><li><a href="/rss" title="RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li><li><a href="https://github.com/yegor256" title="my Github profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="icon icon-googleplus notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li><li><a href="http://www.youtube.com/user/yegor256a" title="my Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"><li> <a href="/best.html" title="best articles to read">12 best articles</a> · <a href="/contents.html" title="blog contents">all 82</a> · <a href="/" title="home page">home page</a></li></ul> </nav><div id="search"> <input id="search-query" class="field field-text" name="q" placeholder="Search" autocomplete="off"/><div id="search-results" style="display:none"><div class="entries"></div></div></div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header></div> <section itemscope itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <code>http://www.yegor256.com/2014/09/23/built-in-fake-objects.html</code></p><h1 itemprop="name">Built-in Fake Objects</h1><ul class="subline"><li> <time itemprop="datePublished" datetime="2014-09-23T00:00:00+00:00"> 23 September 2014 </time></li><li class="printable">Yegor Bugayenko</li><li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2014/09/23/built-in-fake-objects.html#disqus_thread">comments</a></li></ul><p class="unprintable"><a href='/tag/testing.html' class='tag notranslate'>testing</a> <a href='/tag/java.html' class='tag notranslate'>java</a></p><div class="buttons notranslate"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on Facebook" class="button"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;text=Built-in+Fake+Objects" title="Share on Twitter" class="button"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on Google+" class="button"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html" title="Share on LinkedIn" class="button"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://www.stumbleupon.com/submit?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;title=Built-in+Fake+Objects" title="Share on StumbleUpon" class="button"> <span class="count count-stumbleupon">0</span> <i class="icon icon-stumbleupon notranslate" aria-hidden="true"></i> </a> <a href="http://del.icio.us/post?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;title=Built-in+Fake+Objects" title="Share on Delicious" class="button"> <span class="count count-delicious">0</span> <i class="icon icon-delicious notranslate" aria-hidden="true"></i> </a> <a href="http://digg.com/submit?phase=2&amp;url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html&amp;title=Built-in+Fake+Objects" title="Share on Digg" class="button"> <span class="count count-digg">0</span> <i class="icon icon-digg notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html%3F2014-38&amp;title=Built-in+Fake+Objects" title="Share on Reddit" class="button"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=http://www.yegor256.com/2014/09/23/built-in-fake-objects.html%3F2014-38&amp;t=Built-in+Fake+Objects" title="Share on Hacker News" class="button"> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav></div> </header> <main role="main"> <article class="main" role="article" itemprop="articleBody"><p>While mock objects are perfect instruments for unit testing, mocking through mock frameworks may turn your unit tests into an unmaintainable mess. Thanks to them we often hear that "mocking is bad" and "mocking is evil".</p><p>The root cause of this complexity is that our objects are too big. They have many methods and these methods return other objects, which also have methods. When we pass a mock version of such an object as a parameter, we should make sure that all of its methods return valid objects.</p><p>This leads to inevitable complexity, which turns unit tests to <a href="https://news.ycombinator.com/item?id=7353767">waste</a> almost impossible to maintain.</p><h2 id="object-hierarchy">Object Hierarchy</h2><p>Take the <code>Region</code> interface from <a href="http://dynamo.jcabi.com">jcabi-dynamo</a> as an example (this snippet and all others in this article are simplified, for the sake of brevity):</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Region</span> <span class="o">{</span>
  <span class="n">Table</span> <span class="nf">table</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre></div><p>Its <code>table()</code> method returns an instance of the <code>Table</code> interface, which has its own methods:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Table</span> <span class="o">{</span>
  <span class="n">Frame</span> <span class="nf">frame</span><span class="o">();</span>
  <span class="n">Item</span> <span class="nf">put</span><span class="o">(</span><span class="n">Attributes</span> <span class="n">attrs</span><span class="o">);</span>
  <span class="n">Region</span> <span class="nf">region</span><span class="o">();</span>
<span class="o">}</span></code></pre></div><p>Interface <code>Frame</code>, returned by the <code>frame()</code> method, also has its own methods. And so on. In order to create a properly mocked instance of interface <code>Region</code>, one would normally create a dozen other mock objects. With <a href="http://www.mockito.org">Mockito</a> it will look like this:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMe</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// many more lines here...</span>
  <span class="n">Frame</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Frame</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(...).</span><span class="na">when</span><span class="o">(</span><span class="n">frame</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
  <span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Table</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="n">frame</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">frame</span><span class="o">();</span>
  <span class="n">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Region</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="n">table</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">region</span><span class="o">).</span><span class="na">table</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">());</span>
<span class="o">}</span></code></pre></div><p>And all of this is just a scaffolding before the actual testing.</p><h2 id="sample-use-case">Sample Use Case</h2><p>Let's say, you're developing a project that uses jcabi-dynamo for managing data in DynamoDB. Your class may look similar to this:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Region</span> <span class="n">region</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Employee</span><span class="o">(</span><span class="n">String</span> <span class="n">empl</span><span class="o">,</span> <span class="n">Region</span> <span class="n">dynamo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">empl</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">region</span> <span class="o">=</span> <span class="n">dynamo</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">salary</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span>
      <span class="k">this</span><span class="o">.</span><span class="na">region</span>
        <span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">"employees"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">frame</span><span class="o">()</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
        <span class="o">.</span><span class="na">iterator</span><span class="o">()</span>
        <span class="o">.</span><span class="na">next</span><span class="o">()</span>
        <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"salary"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getN</span><span class="o">()</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>You can imagine how difficult it will be to unit test this class, using Mockito, for example. First, we have to mock the <code>Region</code> interface. Then, we have to mock a <code>Table</code> interface and make sure it is returned by the <code>table()</code> method. Then, we have to mock a <code>Frame</code> interface, etc.</p><p>The unit test will be much longer than the class itself. Besides that, its real purpose, which is to test the retrieval of an employee's salary, will not be obvious to the reader.</p><p>Moreover, when we need to test a similar method of a similar class, we will need to restart this mocking from scratch. Again, multiple lines of code, which will look very similar to what we have already written.</p><h2 id="fake-classes">Fake Classes</h2><p>The solution is to create fake classes and ship them together with real classes. This is what <a href="http://dynamo.jcabi.com">jcabi-dynamo</a> is doing. Just look at its <a href="http://dynamo.jcabi.com/apidocs-0.16.1/index.html">JavaDoc</a>. There is a package called <code>com.jcabi.dynamo.mock</code> that contains only fake classes, suitable only for unit testing.</p><p>Even though their sole purpose is to optimize unit testing, we ship them together with production code, in the same JAR package.</p><p>This is what a test will look like, when a fake class <code>MkRegion</code> is used:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">canFetchSalaryFromDynamoDb</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MkRegion</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">H2Data</span><span class="o">().</span><span class="na">with</span><span class="o">(</span>
        <span class="s">"employees"</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">"name"</span><span class="o">},</span>
        <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">"salary"</span><span class="o">}</span>
      <span class="o">)</span>
    <span class="o">);</span>
    <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">"employees"</span><span class="o">).</span><span class="na">put</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">Attributes</span><span class="o">()</span>
        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"Jeff"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"salary"</span><span class="o">,</span> <span class="k">new</span> <span class="nf">AttributeValue</span><span class="o">().</span><span class="na">withN</span><span class="o">(</span><span class="mi">50000</span><span class="o">))</span>
    <span class="o">);</span>
    <span class="n">Employee</span> <span class="n">emp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Employee</span><span class="o">(</span><span class="s">"Jeff"</span><span class="o">,</span> <span class="n">region</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">salary</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="mi">50000</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>This test looks obvious to me. First, we create a fake DynamoDB region, which works on top of <code>H2Data</code> storage (in-memory H2 database). The storage will be ready for a single <code>employees</code> table with a hash key <code>name</code> and a single <code>salary</code> attribute.</p><p>Then, we put a record into the table, with a hash <code>Jeff</code> and a salary <code>50000</code>.</p><p>Finally, we create an instance of class <code>Employee</code> and check how it fetches the salary from DynamoDB.</p><p>I'm currently doing the same thing in almost every open source library I'm working with. I'm creating a collection of fake classes, that simplify testing inside the library and for its users.</p><p>BTW, a great article on the same subject: <a href="http://nedbatchelder.com/blog/201206/tldw_stop_mocking_start_testing.html">tl;dw: Stop mocking, start testing</a> by Ned Batchelder.</p></article> </main><div class="unprintable"><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/08/22/art-of-software-testing.html">The Art of Software Testing by Glenford Myers</a></li><li><a href="/2014/06/21/casperjs-with-maven.html">CasperJS Tests in Maven Build</a></li><li><a href="/2014/04/28/xml-xpath-hamcrest-matchers.html">XML/XPath Matchers for Hamcrest</a></li><li><a href="/2014/04/13/bugs-are-welcome.html">Bugs Are Welcome</a></li><li><a href="/2014/04/06/phandom.html">PhantomJS as an HTML Validator</a></li></ul></div></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014</p> </footer></div></section><script src="/js/post.js?ce5e8e8" async></script><script src="//code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/ext/search.min.js?ce5e8e8"></script><script src="/js/global.js?ce5e8e8" async></script></body></html>