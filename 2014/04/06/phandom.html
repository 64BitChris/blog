<!DOCTYPE html>
<html>
  <head>
    <meta name="description" content="quality vs quantity" />
    <link rel="icon" type="image/gif" href="http://img.yegor256.com/icon-64x64.png">
    <link rel="shortcut icon" href="http://img.yegor256.com/icon-64x64.png" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://www.yegor256.com/rss"/>
    <link rel="author" href="https://plus.google.com/u/0/114792568016408327418?rel=author" />
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <meta name="keywords" content="software development, quality of software, programming, remote programming, distributed programming, static analysis, quality control" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" href="/css/layout.css"/>
    <title>Phantomjs as an HTML Validator</title>
  </head>
  <body>
    <div class="wrapper">
      <div class="content">
        <div class="top">
          <a href="/">home</a>
          &nbsp;
          <a href="/about-me.html">about me</a>
          &nbsp;
          <a href="http://feeds.feedburner.com/yegor256"><i class="fa fa-rss"></i></a>
        </div>
        <header>
  <h1>Phantomjs as an HTML Validator</h1>
</header>
<section>
  <p>
    <span class="date">6 April 2014</span>
    <a class="share" target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')"
      href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/04/06/phandom.html"><i class="fa fa-facebook-square"></i></a>
    <a class="share" target="_blank" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"
      href="https://twitter.com/share?url=http://www.yegor256.com/2014/04/06/phandom.html&amp;text=Phantomjs as an HTML Validator"><i class="fa fa-twitter-square"></i></button></a>
    <a class="share" target="_blank" onclick="return !window.open(this.href, 'Google+', 'width=640,height=300')"
      href="https://plus.google.com/share?url=http://www.yegor256.com/2014/04/06/phandom.html"><i class="fa fa-google-plus-square"></i></a>
  </p>
  <article><p>I&#39;ve created <a href="http://www.phandom.org">phandom.org</a> a few months ago,
but yesterday made a few changes to it. So it&#39;s a good moment to
explain how I&#39;m using it in some of my unit tests.</p>

<p>First, a few words about <a href="http://phantomjs.org/">phantomjs</a>. It is a
JavaScript interface to WebKit, while WebKit is a web browser, but without
a user interface. WebKit is a C++ library that enables manipulations with
HTML content, through DOM calls. For example, this is a simple JavaScript
code in <code>example.js</code>:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="javascript">1
2
3
4
5
6
7
8</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span>
  <span class="s1">&#39;http://google.com&#39;</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loaded!&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</td></tr></table>

<p>We run it from the command line:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="bash">1</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$ </span>phantomjs example.js
</pre></div>
</td></tr></table>

<p>Phantomjs creates <code>page</code> object
(provided by <a href="https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage">webpage</a>
module inside phantomjs), and asks it to <code>open()</code> a web page. The object
contacts WebKit and transforms this call into DOM instructions. The page will
be loaded, and phantomjs engine will be terminated on line 6.</p>

<p>WebKit renders a web page together with everything inside it, including CSS,
JavaScript, ActionScript, etc. It is doing it exactly as any web browser would
do.</p>

<p>So far so good, this is a traditional way of using phantomjs. Now, the idea
of <a href="http://www.phandom.org">Phandom</a> (which stands for &quot;PhantomJS DOM&quot;) inside
Java unit tests:</p>

<p>Let&#39;s give <code>phantomjs</code> an HTML page and ask him to render it. When ready, we&#39;ll
ask to show us how this HTML looks in WebKit&#39;s eyes. If we see our desired
elements there &mdash; our page is good enough. For example:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="java"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">com.rexsl.test.XhtmlMatchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.phandom.Phandom</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">();</span>
    <span class="c1">// This is the method we&#39;re testing. It is supposed</span>
    <span class="c1">// to return a valid HTML without broken JavaScript</span>
    <span class="c1">// and with all required HTML elements.</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">html</span><span class="o">();</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">xhtml</span><span class="o">(</span><span class="k">new</span> <span class="n">Phandom</span><span class="o">(</span><span class="n">html</span><span class="o">).</span><span class="na">dom</span><span class="o">()),</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">hasXPath</span><span class="o">(</span><span class="s">&quot;//p[.=&#39;Hello, world!&#39;]&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Here is what&#39;s happening. We&#39;re getting an HTML <code>html</code> as a <code>String</code>
from <code>doc</code> object, and then passing it to
<a href="http://www.phandom.org/apidocs-0.2.1/org/phandom/Phandom.html"><code>Phandom</code></a>
as an argument. Then,
on line 13, we&#39;re calling <code>Phandom.dom()</code> method in order to get an instance
of class <code>org.w3c.Document</code>.</p>

<p>If our HTML contains any broken JavaScript code, method <code>dom()</code> will
throw a runtime exception and unit test will fail. If HTML is clean
and WebKit can render it without problems, the test will pass.</p>

<p>I&#39;m using this mechanism in a few projects, and highly recommend it.</p>

<p>Of course, don&#39;t forget, that you should have phantomjs installed on your
build machine. In order to avoid accidental unit test failures when
phantomjs is not available, I&#39;ve made a supplementary method:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="java">1
2
3
4
5
6
7</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Assume</span><span class="o">.</span><span class="na">assumeTrue</span><span class="o">(</span><span class="n">Phandom</span><span class="o">.</span><span class="na">installed</span><span class="o">());</span>
    <span class="c1">// the rest of the unit test method body...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Enjoy and feel free to report problems through
<a href="https://github.com/yegor256/phandom/issues">Github issues</a> :)</p>
</article>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'yegor256';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

      </div>
    </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1963507-32']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <script type="text/javascript">
      var disqus_shortname = 'yegor256';
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
  </body>
</html>
