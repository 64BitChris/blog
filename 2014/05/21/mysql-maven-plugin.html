<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta charset="utf-8"/><meta name="description" content="jcabi-mysql-maven-plugin starts a fresh instance of MySQL server before integration tests and shuts it down when tests are finished."/><meta name="keywords" content="mariadb maven plugin, maven linux mysql, maven mysql java test, maven plugin for mysql, mysql integration testing java, mysql java test, mysql maven, mysql maven plugin"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="icon" type="image/png" href="http://img.yegor256.com/icon-128x128.png"><link rel="shortcut icon" href="//img.yegor256.com/icon-128x128.png"/><link rel="alternate" type="application/rss+xml" title="RSS" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="//plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="stylesheet" href="/css/layout.css?e4bbdbb"/><link rel="canonical" href="http://www.yegor256.com/2014/05/21/mysql-maven-plugin.html"/> <script src="//code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/all.js?e4bbdbb"></script><title>MySQL Maven Plugin</title></head><body><div class="wrapper"> <header class="header"><div> <a href="/about-me.html"> <img src="//img.yegor256.com/yegor-bugayenko.jpg" class="photo" alt="photo"/> </a></div> <nav role="navigation"><ul class="menu"><li><a href="/" title="home page"><i class="ico ico-home"></i></a></li><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="ico ico-tweet"></i></a></li><li><a href="/rss" title="RSS feed"><i class="ico ico-rss"></i></a></li><li><a href="https://github.com/yegor256" title="my Github profile"><i class="ico ico-x-github"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="ico ico-x-stackoverflow"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="ico ico-x-facebook"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="ico ico-x-google"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="ico ico-x-linkedin"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="ico ico-email"></i></a></li></ul> </nav><div class="gcse" role="search"><div class="gcse-search"></div></div> </header></div> <section itemscope itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name">MySQL Maven Plugin</h1> </header><p> <time itemprop="datePublished" datetime="2014-05-21T00:00:00+00:00"> 21 May 2014 </time></p><div class="buttons"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/05/21/mysql-maven-plugin.html" title="Share on Facebook" class="button"> <i class="ico ico-facebook"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/05/21/mysql-maven-plugin.html&amp;text=MySQL+Maven+Plugin" title="Share on Twitter" class="button"> <i class="ico ico-twitter"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/05/21/mysql-maven-plugin.html" title="Share on Google+" class="button"> <i class="ico ico-google"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/05/21/mysql-maven-plugin.html" title="Share on LinkedIn" class="button"> <i class="ico ico-linkedin"></i> </a> </nav></div><div class="buttons" style="text-align:right"> <span class="gray">discuss at</span> <nav class="share" role="navigation"> <a href="http://www.reddit.com/r/java/comments/265eii/mysql_maven_plugin_for_java_integration_testing/" title="discuss at reddit"> <i class="ico ico-reddit"></i> </a> </nav></div> <main role="main"> <article role="article" itemprop="articleBody"><p>I was using MySQL in a few Java web projects and found out there was no Maven plugin that would help me to test my DAO classes against a real MySQL server. There are plenty of mechanisms to mock a database persistence layer both in memory and on disc. However, it is always good to make sure that your classes are tested against a database identical to the one you have in production environment.</p><figure class='badge'><a href='http://mysql.jcabi.com'><img src='http://img.jcabi.com/logo-square.png' style='width:64px' alt='badge'/></a></figure><p>I've created my own Maven plugin, <a href="http://mysql.jcabi.com">jcabi-mysql-maven-plugin</a>, that does exactly two things: starts a MySQL server on <code>pre-integration-test</code> phase and shuts it down on <code>post-integration-test</code>.</p><p>This is how you configure it in <code>pom.xml</code> (see also its full <a href="http://mysql.jcabi.com/usage.html">usage instructions</a>):</p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>build-helper-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>reserve-network-port<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;portNames&gt;</span>
                <span class="nt">&lt;portName&gt;</span>mysql.port<span class="nt">&lt;/portName&gt;</span>
              <span class="nt">&lt;/portNames&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>unpack<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;artifactItems&gt;</span>
                <span class="nt">&lt;artifactItem&gt;</span>
                  <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
                  <span class="nt">&lt;artifactId&gt;</span>mysql-dist<span class="nt">&lt;/artifactId&gt;</span>
                  <span class="nt">&lt;version&gt;</span>5.6.14<span class="nt">&lt;/version&gt;</span>
                  <span class="nt">&lt;classifier&gt;</span>${mysql.classifier}<span class="nt">&lt;/classifier&gt;</span>
                  <span class="nt">&lt;type&gt;</span>zip<span class="nt">&lt;/type&gt;</span>
                  <span class="nt">&lt;overWrite&gt;</span>false<span class="nt">&lt;/overWrite&gt;</span>
                  <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/mysql-dist<span class="nt">&lt;/outputDirectory&gt;</span>
                <span class="nt">&lt;/artifactItem&gt;</span>
              <span class="nt">&lt;/artifactItems&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jcabi-mysql-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;id&gt;</span>mysql-test<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>classify<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>start<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>stop<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;port&gt;</span>${mysql.port}<span class="nt">&lt;/port&gt;</span>
              <span class="nt">&lt;data&gt;</span>${project.build.directory}/mysql-data<span class="nt">&lt;/data&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-failsafe-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;systemPropertyVariables&gt;</span>
            <span class="nt">&lt;mysql.port&gt;</span>${mysql.port}<span class="nt">&lt;/mysql.port&gt;</span>
          <span class="nt">&lt;/systemPropertyVariables&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>integration-test<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>verify<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
  [...]
<span class="nt">&lt;/project&gt;</span></code></pre></div><p>There are two plugins configured above. Let's take a look at what each does.</p><ol><li><p><a href="http://mojo.codehaus.org/build-helper-maven-plugin/reserve-network-port-mojo.html"><strong>build-helper-maven-plugin</strong></a> is reserving a temporary random TCP port, which will be used by MySQL server. We don't want to start a server on its default 3306 port, because there could be another server already running there. Besides that, if we use a hard-coded TCP port, we won't be able to run multiple builds in parallel. Maybe not a big deal when you're developing locally, but in continuous integration environment this can be a problem. That's why we're reserving a TCP port first.</p></li><li><p><a href="http://maven.apache.org/plugins/maven-dependency-plugin/unpack-mojo.html"><strong>maven-dependency-plugin</strong></a> is downloading a MySQL distribution in a zip archive (rather big file, over 300Mb for Linux), and unpacks it. This archive contains exactly the same files as you would use for a traditional MySQL installation. When the archive is unpacked, it is ready to start serving SQL requests as a normal MySQL server.</p></li><li><p><a href="http://mysql.jcabi.com"><strong>jcabi-mysql-maven-plugin</strong></a> starts a server, binding it to a TCP port reserved randomly. The main responsibility of my Maven plugin is to make sure that MySQL server starts correctly on every platform (Mac OS, Linux, Windows) and stops when it's not needed any more. All the rest is done by the MySQL distribution itself.</p></li><li><p><a href="http://mojo.codehaus.org/build-helper-maven-plugin/reserve-network-port-mojo.html"><strong>maven-failsafe-plugin</strong></a> is running unit tests on <code>integration-test</code> phase. Its main difference from maven-surefire-plugin is that it doesn't fail a build when some tests fail. Instead, it saves all failures into supplementary files in <code>target</code> directory and allows the build continue. Later, when we call its <code>verify</code> goal, it will fail a build if there were any errors during its <code>integration-test</code> goal execution.</p></li></ol><p>To be precise, this is the order in which Maven will execute configured goals:</p><div class="highlight"><pre><code class="language-text" data-lang="text">jcabi-mysql-maven-plugin:classify
maven-dependency-plugin:unpack
build-helper-maven-plugin:reserve-network-port
jcabi-mysql-maven-plugin:start
maven-failsafe-plugin:integration-test
jcabi-mysql-maven-plugin:stop
maven-failsafe-plugin:verify</code></pre></div><p>Run <code>mvn clean install</code> and see how it works. If it doesn't work for some reason, don't hesitate <a href="https://github.com/jcabi/jcabi-mysql-maven-plugin/issues">to report an issue to Github</a>.</p><p>Now it's time to create an integration test, which will connect to the temporary MySQL server, create a table there and insert some data into it. This is just an example to show that MySQL server is running and is capable of serving transactions (I'm using <a href="http://jdbc.jcabi.com">jcabi-jdbc</a>):</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooITCase</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PORT</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"mysql.port"</span><span class="o">);</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">worksWithMysqlServer</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span>
      <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
        <span class="s">"jdbc:mysql://localhost:%s/root?user=root&amp;password=root"</span><span class="o">,</span>
        <span class="n">FooITCase</span><span class="o">.</span><span class="na">PORT</span>
      <span class="o">)</span>
    <span class="o">);</span>
    <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"CREATE TABLE foo (id INT PRIMARY KEY)"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>If you're using Hibernate, just create a <code>db.properties</code> file in <code>src/test/resources</code> directory. In that file you would do something like:</p><div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">hibernate.connection.url</span><span class="o">=</span><span class="s">jdbc:mysql://localhost:${mysql.port}/root</span>
<span class="na">hibernate.connection.username</span><span class="o">=</span><span class="s">root</span>
<span class="na">hibernate.connection.password</span><span class="o">=</span><span class="s">root</span></code></pre></div><p>Maven will replace that <code>${mysql.port}</code> with the number of reserved TCP port, during resources copying. This operation is called "resources filtering", and you can read about it <a href="http://maven.apache.org/plugins/maven-resources-plugin/examples/filter.html">here</a>.</p><p>That's pretty much it. I'm using <a href="http://mysql.jcabi.com">jcabi-mysql-maven-plugin</a> in a few projects, and it helps me to stay confident that my code works with a real MySQL server. I'm also using the Liquibase Maven plugin in order to populate an empty server with tables required for the application. Nevertheless, that is a story for the next post :)</p></article> </main><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/07/20/liquibase-in-maven.html">Liquibase with Maven</a></li><li><a href="/2014/06/21/casperjs-with-maven.html">CasperJS Tests in Maven Build</a></li><li><a href="/2014/05/01/dynamodb-local-maven-plugin.html">DynamoDB Local Maven Plugin</a></li><li><a href="/2014/07/03/how-to-read-manifest-mf.html">How to Read MANIFEST.MF Files</a></li><li><a href="/2014/06/26/sass-in-java-webapp.html">SASS in Java Webapp</a></li></ul></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014</p> </footer></div></section></body></html>