<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta charset="utf-8"/><meta name="description" content="Caching Java method results is easy with jcabi-aspects, a small library that uses AspectJ and Java annotations"/><meta name="keywords" content="@Cacheable, aop caching, cache java method, cache result of java method, java aop cache, java cache method calls, java cache method results, java method cache annotation, java method caching"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="twitter:account_id" content="4503599630178231"/><link rel="icon" type="image/png" href="http://img.yegor256.com/icon-128x128.png"><link rel="shortcut icon" href="//img.yegor256.com/icon-128x128.png"/><link rel="alternate" type="application/rss+xml" title="RSS" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="//plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="stylesheet" href="/css/layout.css?6529134"/><link rel="canonical" href="http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html"/> <script src="/js/search.min.js?6529134"></script><script src="/js/all.js?6529134"></script><title>Cache Java Method Results</title></head><body><div class="wrapper"> <header class="header"><div> <a href="/about-me.html"> <img src="//img.yegor256.com/yegor-bugayenko.jpg" class="photo" alt="photo"/> </a></div> <nav role="navigation"><ul class="menu"><li><a href="/" title="home page"><i class="ico ico-home"></i></a></li><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="ico ico-tweet"></i></a></li><li><a href="/rss" title="RSS feed"><i class="ico ico-rss"></i></a></li><li><a href="https://github.com/yegor256" title="my Github profile"><i class="ico ico-x-github"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="ico ico-x-stackoverflow"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="ico ico-x-facebook"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="ico ico-x-google"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="ico ico-x-linkedin"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="ico ico-email"></i></a></li></ul> </nav><div id="search"> <input id="search-query" class="field field-text" name="q" placeholder="Search" autocomplete="off"/><div id="search-results" style="display:none"><div class="entries"></div></div></div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header></div> <section itemscope itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name">Cache Java Method Results</h1> </header><p> <time itemprop="datePublished" datetime="2014-08-03T00:00:00+00:00"> 3 August 2014 </time></p><div class="buttons"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on Facebook" class="button"> <i class="ico ico-facebook"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html&amp;text=Cache+Java+Method+Results" title="Share on Twitter" class="button"> <i class="ico ico-twitter"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on Google+" class="button"> <i class="ico ico-google"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on LinkedIn" class="button"> <i class="ico ico-linkedin"></i> </a> </nav></div><div class="buttons" style="text-align:right"> <span class="gray">discuss at</span> <nav class="share" role="navigation"> <a href="http://redd.it/2cikh0" title="discuss at reddit"> <i class="ico ico-reddit"></i> </a> <a href="https://news.ycombinator.com/item?id=8130679" title="discuss at hacker-news"> <i class="ico ico-hacker-news"></i> </a> </nav></div> <main role="main"> <article role="article" itemprop="articleBody"> <figure class='badge'><a href='http://aspects.jcabi.com'><img src='http://img.jcabi.com/logo-square.svg' style='width:64px' alt='badge'/></a></figure><p>Say, you have a method that takes time to execute and you want its result to be cached. There are <a href="http://www.coderanch.com/how-to/java/CachingStrategies">many solutions</a>, including <a href="http://commons.apache.org/proper/commons-jcs/">Apache Commons JCS</a>, <a href="http://www.ehcache.org">Ehcache</a>, <a href="https://jcp.org/en/jsr/detail?id=107">JSR 107</a>, <a href="https://code.google.com/p/guava-libraries/wiki/CachesExplained">Guava Caching</a> and many others.</p><p><a href="http://aspects.jcabi.com/annotation-cacheable.html">jcabi-aspects</a> offers a very simple one, based on AOP aspects and Java6 annotations:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.jcabi.aspects.Cacheable</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Page</span> <span class="o">{</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">load</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="s">"http://google.com"</span><span class="o">).</span><span class="na">getContent</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>The result of <code>load()</code> method will be cached in memory for five minutes.</p><h2 id="how-it-works?">How It Works?</h2><p>This post about <a href="/2014/06/01/aop-aspectj-java-method-logging.html">AOP, AspectJ and method loging</a> explains how "aspect weaving" works (I highly recommend that you read it first).</p><p>Here I'll explain how caching works.</p><p>The approach is very straight forward. There is a static hash map with keys as "method coordinates" and values as their results. Method coordinates consist of the object, an owner of the method and a method name with parameter types.</p><p>In the example above, right after the method <code>load()</code> finishes, the map gets a new entry (simplified example, of course):</p><div class="highlight"><pre><code class="language-text" data-lang="text">key: [page, "load()"]
value: "&lt;html&gt;...&lt;/html&gt;"</code></pre></div><p>Every consecutive call to <code>load()</code> will be intercepted by the aspect from <a href="http://aspects.jcabi.com">jcabi-aspects</a> and resolved immediately with a value from the cache map. The method will not get any control until the end of its lifetime, which is five minutes in the example above.</p><h2 id="what-about-cache-flushing?">What About Cache Flushing?</h2><p>Sometimes it's necessary to have the ability to flush cache before the end of its lifetime. Here is a practical example:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.jcabi.aspects.Cacheable</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">)</span>
  <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// calculate their amount in MySQL</span>
  <span class="o">}</span>
  <span class="nd">@Cacheable.FlushBefore</span>
  <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Employee</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// add a new one to MySQL</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>It's obvious that the number of employees in the database will be different after <code>add()</code> method execution and the result of <code>size()</code> should be invalidated in cache. This invalidation operation is called "flushing" and <code>@Cacheable.FlushBefore</code> triggers it.</p><p>Actually, every call to <code>add()</code> invalidates all cached methods in this class, not only <code>size()</code>.</p><p>There is also <code>@Cacheable.FlushAfter</code>. The difference is that <code>FlushBefore</code> guarantees that cache is already invalidated when the method <code>add()</code> starts. <code>FlushAfter</code> invalidates cache after method <code>add()</code> finishes. This small difference makes a big one, sometimes.</p><p>This article explains <a href="http://aspects.jcabi.com/example-weaving.html">how to add jcabi-aspects to your project</a>.</p></article> </main><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/06/01/aop-aspectj-java-method-logging.html">Java Method Logging with AOP and Annotations</a></li><li><a href="/2014/06/20/limit-method-execution-time.html">Limit Java Method Execution Time</a></li><li><a href="/2014/07/03/how-to-read-manifest-mf.html">How to Read MANIFEST.MF Files</a></li><li><a href="/2014/04/24/java-xml-parsing-and-traversing.html">Java XML Parsing Made Easy</a></li><li><a href="/2014/04/11/jcabi-http-intro.html">Fluent Java Http Client</a></li></ul></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <noscript> Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014</p> </footer></div></section></body></html>