<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta charset="utf-8"/><meta name="description" content="Caching Java method results is easy with jcabi-aspects, a small library that uses AspectJ and Java annotations"/><meta name="keywords" content="@Cacheable, aop caching, cache java method, cache result of java method, java aop cache, java cache method calls, java cache method results, java method cache annotation, java method caching"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="twitter:account_id" content="4503599630178231"/><link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="yegor256"/><link rel="shortcut icon" href="/favicon.ico?75b8c12"/><link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="http://plus.google.com/u/0/114792568016408327418?rel=author"/><link rel="stylesheet" href="/css/layout.css?75b8c12"/><link rel="stylesheet" href="//img.teamed.io/yegor256/icons.css?75b8c12"/><link rel="canonical" href="http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html"/><title>Cache Java Method Results - Yegor Bugayenko</title></head><body><div class="wrapper"> <header class="header"><div> <a href="/about-me.html"> <img src="/images/yegor-bugayenko.png" class="photo" alt="photo"/> </a></div> <nav role="navigation"><ul class="menu social notranslate"><li><a href="http://www.twitter.com/yegor256" title="follow me in Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li><li><a href="/rss" title="RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li><li><a href="https://github.com/yegor256" title="my Github profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li><li><a href="http://stackoverflow.com/users/187141/yegor256" title="my StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.facebook.com/yegor.bugayenko" title="follow me in Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li><li><a href="https://plus.google.com/+YegorBugayenko/posts" title="follow me in Google+"><i class="icon icon-googleplus notranslate" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/yegor256" title="my LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li><li><a href="http://www.youtube.com/user/technoparkcorp" title="my Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li><li><a href="mailto:yegor@teamed.io" title="yegor@teamed.io"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"><li> <a href="/best.html" title="best articles to read">12 best articles</a> · <a href="/contents.html" title="blog contents">all 112</a> · <a href="/" title="home page">home page</a></li></ul><ul class="menu"><li> Win <strong style="font-size:2em;color:#81b341"> <a href="/award.html" title="software quality award">$4,096</a> </strong> for Your Open Source Project!</li></ul> </nav><div id="search"> <input id="search-query" class="field field-text" name="q" placeholder="Search" autocomplete="off"/><div id="search-results" style="display:none"><div class="entries"></div></div></div><div style="color:#fab319;text-align:left;margin:2em 0"> <img src="/images/2015/05/webinar-2.jpg" style="width:64px;height:64px;float:left;margin-right:1em" alt="webinar logo"/> Don't miss the <a href="https://plus.google.com/events/ce8vv0tp2ri3p5gm7k6m4ban5d0"><strong>second webinar</strong></a> on the 6th of May, at 11am PST; it will take one hour and we'll talk about <a href="https://plus.google.com/events/ce8vv0tp2ri3p5gm7k6m4ban5d0">"Immutable Objects vs. Common Sense"</a>.</div> <script id="search-results-template" type="text/mustache">
          {{#entries}}
            <div>
              <a href="{{url}}">{{title}}</a>
            </div>
          {{/entries}}
        </script></header></div> <section itemscope itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <code>http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html</code></p><h1 itemprop="name">Cache Java Method Results</h1><ul class="subline"><li> <time itemprop="datePublished" datetime="2014-08-03T00:00:00+00:00"> 3 August 2014 </time></li><li><a href='https://github.com/yegor256/blog/commits/master/_posts/2014/aug/2014-08-03-cacheable-java-annotation.md'>modified</a> on <time itemprop='dateModified' datetime='2014-10-24T13:09:54+0000'>24 October 2014</time></li><li class="printable">Yegor Bugayenko</li><li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html#disqus_thread">comments</a></li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'>java</a> <a href='/tag/jcabi.html' class='tag notranslate'>jcabi</a> <a href='/tag/aop.html' class='tag notranslate'>aop</a></p><div class="buttons notranslate desktop-only"> <nav class="share" role="navigation"> <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on Facebook" class="button"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html&amp;text=Cache+Java+Method+Results" title="Share on Twitter" class="button"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on Google+" class="button"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html" title="Share on LinkedIn" class="button"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://www.stumbleupon.com/submit?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html&amp;title=Cache+Java+Method+Results" title="Share on StumbleUpon" class="button"> <span class="count count-stumbleupon">0</span> <i class="icon icon-stumbleupon notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html%3F2014-31&amp;title=Cache+Java+Method+Results" title="Share on Reddit" class="button"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=http://www.yegor256.com/2014/08/03/cacheable-java-annotation.html%3F2014-31&amp;t=Cache+Java+Method+Results" title="Share on Hacker News" class="button"> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav></div> </header> <main role="main"> <article class="main" role="article" itemprop="articleBody"> <figure class='badge'><a href='http://aspects.jcabi.com'><img src='http://img.jcabi.com/logo-square.svg' style='width:64px' alt='badge'/></a></figure><p>Say, you have a method that takes time to execute and you want its result to be cached. There are <a href="http://www.coderanch.com/how-to/java/CachingStrategies">many solutions</a>, including <a href="http://commons.apache.org/proper/commons-jcs/">Apache Commons JCS</a>, <a href="http://www.ehcache.org">Ehcache</a>, <a href="https://jcp.org/en/jsr/detail?id=107">JSR 107</a>, <a href="https://code.google.com/p/guava-libraries/wiki/CachesExplained">Guava Caching</a> and many others.</p><p><a href="http://aspects.jcabi.com/annotation-cacheable.html">jcabi-aspects</a> offers a very simple one, based on AOP aspects and Java6 annotations:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.jcabi.aspects.Cacheable</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Page</span> <span class="o">{</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">load</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="s">"http://google.com"</span><span class="o">).</span><span class="na">getContent</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>The result of <code>load()</code> method will be cached in memory for five minutes.</p><h2 id="how-it-works?">How It Works?</h2><p>This post about <a href="/2014/06/01/aop-aspectj-java-method-logging.html">AOP, AspectJ and method loging</a> explains how "aspect weaving" works (I highly recommend that you read it first).</p><p>Here I'll explain how caching works.</p><p>The approach is very straight forward. There is a static hash map with keys as "method coordinates" and values as their results. Method coordinates consist of the object, an owner of the method and a method name with parameter types.</p><p>In the example above, right after the method <code>load()</code> finishes, the map gets a new entry (simplified example, of course):</p><div class="highlight"><pre><code class="language-text" data-lang="text">key: [page, "load()"]
value: "&lt;html&gt;...&lt;/html&gt;"</code></pre></div><p>Every consecutive call to <code>load()</code> will be intercepted by the aspect from <a href="http://aspects.jcabi.com">jcabi-aspects</a> and resolved immediately with a value from the cache map. The method will not get any control until the end of its lifetime, which is five minutes in the example above.</p><h2 id="what-about-cache-flushing?">What About Cache Flushing?</h2><p>Sometimes it's necessary to have the ability to flush cache before the end of its lifetime. Here is a practical example:</p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.jcabi.aspects.Cacheable</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">)</span>
  <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// calculate their amount in MySQL</span>
  <span class="o">}</span>
  <span class="nd">@Cacheable.FlushBefore</span>
  <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Employee</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// add a new one to MySQL</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>It's obvious that the number of employees in the database will be different after <code>add()</code> method execution and the result of <code>size()</code> should be invalidated in cache. This invalidation operation is called "flushing" and <code>@Cacheable.FlushBefore</code> triggers it.</p><p>Actually, every call to <code>add()</code> invalidates all cached methods in this class, not only <code>size()</code>.</p><p>There is also <code>@Cacheable.FlushAfter</code>. The difference is that <code>FlushBefore</code> guarantees that cache is already invalidated when the method <code>add()</code> starts. <code>FlushAfter</code> invalidates cache after method <code>add()</code> finishes. This small difference makes a big one, sometimes.</p><p>This article explains <a href="http://aspects.jcabi.com/example-weaving.html">how to add jcabi-aspects to your project</a>.</p></article> </main><div class="unprintable"><h2>Related Posts</h2><p>You may also find these posts interesting:</p><ul><li><a href="/2014/08/15/retry-java-method-on-exception.html">How to Retry Java Method Call on Exception</a></li><li><a href="/2014/06/01/aop-aspectj-java-method-logging.html">Java Method Logging with AOP and Annotations</a></li><li><a href="/2014/06/20/limit-method-execution-time.html">Limit Java Method Execution Time</a></li><li><a href="/2015/02/05/jcabi-parent-maven-pom.html">Don't Repeat Yourself in Maven POMs; Use Jcabi-Parent</a></li><li><a href="/2015/02/02/xsl-transformations-in-java.html">XSL Transformation in Java: An Easy Way</a></li></ul></div></div><div class="disqus" role="complementary"><div id="disqus_thread"></div> <a href="http://disqus.com" class="dsq-brlink"> comments powered by <span class="logo-disqus">Disqus</span> </a></div><div class="wrapper"> <footer class="footer"><p> © <span itemprop="author">Yegor Bugayenko</span>, 2014</p> </footer></div></section><script src="http://code.jquery.com/jquery-2.1.0.min.js"></script><script src="/js/ext/search.min.js?75b8c12"></script><script src="/js/global.js?75b8c12" async defer></script><script src="/js/post.js?75b8c12" async defer></script></body></html>