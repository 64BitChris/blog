<!DOCTYPE html>
<html âš¡ lang="en">
  <head>
    <meta charset="utf-8">
    <title>How AppVeyor Helps Me to Validate Pull Requests Before Rultor Merges Them</title>
    <!-- <link rel="canonical" href="http://www.yegor256.com/_posts/2015/mar/2015-03-29-rultor-with-appveyor" /> -->
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type='application/ld+json'>
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "_posts/2015/mar/2015-03-29-rultor-with-appveyor.md"
        },
        "headline": "How AppVeyor Helps Me to Validate Pull Requests Before Rultor Merges Them",
        "image": {
          "@type": "ImageObject",
          "url": "http://img.teamed.io/face-1400x1400.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2015-03-29",
        "dateModified": "2015-03-29",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "http://img.teamed.io/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "AppVeyor is a continuous integration platform for Windows
projects; Rultor is a Docker based DevOps assistant for merge, release and deploy operations;
they can work together.
",
        "keywords": ["appveyor", "appveyor merge pull request", "appveyor and rultor", "appveyor devops", "windows builds with docker"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <h1>How AppVeyor Helps Me to Validate Pull Requests Before Rultor Merges Them</h1>
    

<p><a href="http://www.appveyor.com">AppVeyor</a> is a great cloud
<a href="/2014/10/08/continuous-integration-is-dead.html">continuous integration</a> service that builds
Windows projects. <a href="http://www.rultor.com">Rultor</a> is a DevOps assistant, which automates
release, merge and deploy operations, using Docker containers. These posts
explain how Rultor works and what it&#39;s for:
<a href="/2014/07/24/rultor-automated-merging.html">Rultor.com, a Merging Bot</a>
and <a href="/2014/07/21/read-only-master-branch.html">Master Branch Must Be Read-Only</a>.</p>



<p>The problem is that Rultor is running all scripts inside Docker containers
and Docker can&#39;t build Windows projects. The only and the best logical solution
is to trigger AppVeyor before running all other scripts in Docker. If AppVeyor
gives a green light, we continue with our usual in-Docker script. Otherwise,
we fail the entire build. Below I explain how this automation was configured
in <a href="http://www.takes.org">Takes framework</a>.</p>

<!--more-->

<p>First, I got a token from my AppVeyor account (at the time
of writing it was <a href="https://ci.appveyor.com/api-token">here</a>). I created
a text file <code>curl-appveyor.cfg</code> with this content (it&#39;s not my real token inside,
just an example):</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">--silent
--header &quot;Authorization: Bearer 1hdmsfbs7xccb9x6g1y4&quot;
--header &quot;Content-Type: application/json&quot;
--header &quot;Accept: application/json&quot;</code></pre></figure>

<p>Then, I encrypted this file, using <a href="https://github.com/yegor256/rultor-remote"><code>rultor</code></a>
command line tool:</p>



<p>The file I created was called
<a href="https://github.com/yegor256/takes/blob/master/curl-appveyor.cfg.asc"><code>curl-appveyor.cfg.asc</code></a>.
I committed and pushed into <a href="https://github.com/yegor256/takes">yegor256/takes</a>
GitHub repository.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git add curl-appveyor.cfg.asc
<span class="nv">$ </span>git commit -am <span class="s1">&#39;CURL config for Appveyor&#39;</span>
<span class="nv">$ </span>git push origin master</code></pre></figure>

<p>Then, I configured AppVeyor &quot;pinging&quot; from Docker script.
This is what I did in <a href="https://github.com/yegor256/takes/blob/master/.rultor.yml"><code>.rultor.yml</code></a>:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">decrypt</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">curl-appveyor.cfg</span><span class="p-Indicator">:</span> <span class="s">&quot;repo/curl-appveyor.cfg.asc&quot;</span>
<span class="l-Scalar-Plain">merge</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
    <span class="no">ver=$(curl -K ../curl-appveyor.cfg \</span>
      <span class="no">--data &quot;{accountName: &#39;yegor256&#39;,</span>
        <span class="no">projectSlug: &#39;takes&#39;,</span>
        <span class="no">pullRequestId: &#39;${pull_id}&#39;}&quot; \</span>
      <span class="no">https://ci.appveyor.com/api/builds | jq -r &#39;.version&#39;)</span>
    <span class="no">while true; do</span>
      <span class="no">status=$(curl -K ../curl-appveyor.cfg \</span>
        <span class="no">https://ci.appveyor.com/api/projects/yegor256/takes/build/${ver} \</span>
        <span class="no">| jq -r &#39;.build.status&#39;)</span>
      <span class="no">if [ &quot;${status}&quot; == &quot;success&quot; ]; then break; fi</span>
      <span class="no">if [ &quot;${status}&quot; == &quot;failed&quot; ]; then</span>
        <span class="no">echo &quot;see https://ci.appveyor.com/project/yegor256/takes/build/${ver}&quot;</span>
        <span class="no">exit 1</span>
      <span class="no">fi</span>
      <span class="no">echo &quot;waiting for AppVeyor build ${ver}: ${status}&quot;</span>
      <span class="no">sleep 5s</span>
    <span class="no">done</span>
    <span class="no">mvn clean install</span></code></pre></figure>

<p>There is no magic here, it&#39;s very simple. First, I start a new build
using <code>/api/builds</code> end-point of
<a href="http://www.appveyor.com/docs/api/projects-builds#start-build-of-pull-request-github-only">AppVeyor REST API</a>.
<code>${pull_id}</code> is an environment variable that is coming from Rultor,
it contains an integer number of current pull request.</p>

<p>I&#39;m using <a href="http://stedolan.github.io/jq/">jq</a>
in order to parse AppVeyor JSON output.</p>

<p>Once the build is started, I&#39;m getting its unique <code>version</code> and start
looping to check its status. I&#39;m waiting for <code>success</code> or <code>failed</code>. Anything
else will mean that the build is still in progress and I should keep looping.</p>

<p>You can see how it works in this pull request, for example:
<a href="https://github.com/yegor256/takes/pull/93">yegor256/takes#93</a>.</p>

  </body>
</html>
