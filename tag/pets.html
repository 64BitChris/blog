<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="{&quot;layout&quot;=&gt;&quot;tag-index&quot;, &quot;posts&quot;=&gt;[#&lt;Jekyll::Document _posts/2017/sep/2017-09-26-threecopies-server-data-backup.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/sep/2017-09-05-rehttp-http-repeater.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/jun/2017-06-22-object-oriented-input-output-in-cactoos.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/apr/2017-04-25-sixnines.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-30-jare-instant-free-cdn.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-15-wring-dispatcher-github-notifications.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/jun/2015-06-25-xml-data-xsl-views-takes-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/may/2015-05-18-cookie-based-authentication.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/mar/2015-03-22-takes-java-web-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/dec/2014-12-04-synchronization-between-nodes.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/may/2014-05-18-cloud-autoincrement-counters.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-21-s3-http-basic-auth.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-06-phandom.md collection=posts&gt;], &quot;tag&quot;=&gt;&quot;pets&quot;, &quot;content&quot;=&gt;&quot;&quot;, &quot;dir&quot;=&gt;&quot;/tag/&quot;, &quot;name&quot;=&gt;&quot;pets.html&quot;, &quot;path&quot;=&gt;&quot;tag/pets.html&quot;, &quot;url&quot;=&gt;&quot;/tag/pets&quot;, &quot;title&quot;=&gt;&quot;pets&quot;, &quot;description&quot;=&gt;&quot;pets: more about pets in this collection of recently published articles... the list is updated every few weeks.&quot;}" /> <meta name="keywords" content="{&quot;layout&quot;=&gt;&quot;tag-index&quot;, &quot;posts&quot;=&gt;[#&lt;Jekyll::Document _posts/2017/sep/2017-09-26-threecopies-server-data-backup.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/sep/2017-09-05-rehttp-http-repeater.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/jun/2017-06-22-object-oriented-input-output-in-cactoos.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/apr/2017-04-25-sixnines.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-30-jare-instant-free-cdn.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-15-wring-dispatcher-github-notifications.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/jun/2015-06-25-xml-data-xsl-views-takes-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/may/2015-05-18-cookie-based-authentication.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/mar/2015-03-22-takes-java-web-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/dec/2014-12-04-synchronization-between-nodes.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/may/2014-05-18-cloud-autoincrement-counters.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-21-s3-http-basic-auth.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-06-phandom.md collection=posts&gt;], &quot;tag&quot;=&gt;&quot;pets&quot;, &quot;content&quot;=&gt;&quot;&quot;, &quot;dir&quot;=&gt;&quot;/tag/&quot;, &quot;name&quot;=&gt;&quot;pets.html&quot;, &quot;path&quot;=&gt;&quot;tag/pets.html&quot;, &quot;url&quot;=&gt;&quot;/tag/pets&quot;, &quot;title&quot;=&gt;&quot;pets&quot;, &quot;description&quot;=&gt;&quot;pets: more about pets in this collection of recently published articles... the list is updated every few weeks.&quot;}" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="pets"/> <meta name="twitter:description" property="og:description" content="{&quot;layout&quot;=&gt;&quot;tag-index&quot;, &quot;posts&quot;=&gt;[#&lt;Jekyll::Document _posts/2017/sep/2017-09-26-threecopies-server-data-backup.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/sep/2017-09-05-rehttp-http-repeater.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/jun/2017-06-22-object-oriented-input-output-in-cactoos.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2017/apr/2017-04-25-sixnines.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-30-jare-instant-free-cdn.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2016/mar/2016-03-15-wring-dispatcher-github-notifications.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/jun/2015-06-25-xml-data-xsl-views-takes-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/may/2015-05-18-cookie-based-authentication.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2015/mar/2015-03-22-takes-java-web-framework.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/dec/2014-12-04-synchronization-between-nodes.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/may/2014-05-18-cloud-autoincrement-counters.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-21-s3-http-basic-auth.md collection=posts&gt;, #&lt;Jekyll::Document _posts/2014/apr/2014-04-06-phandom.md collection=posts&gt;], &quot;tag&quot;=&gt;&quot;pets&quot;, &quot;content&quot;=&gt;&quot;&quot;, &quot;dir&quot;=&gt;&quot;/tag/&quot;, &quot;name&quot;=&gt;&quot;pets.html&quot;, &quot;path&quot;=&gt;&quot;tag/pets.html&quot;, &quot;url&quot;=&gt;&quot;/tag/pets&quot;, &quot;title&quot;=&gt;&quot;pets&quot;, &quot;description&quot;=&gt;&quot;pets: more about pets in this collection of recently published articles... the list is updated every few weeks.&quot;}"/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/tag/pets"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/tag/pets" /> <link rel="amphtml" href="https://www.yegor256.com/tag/pets" /> <title>pets </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /tag/pets><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /tag/pets><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /tag/pets><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /tag/pets><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /tag/pets><a href="/books.html" title="The books I wrote">Books</a></li> <li /tag/pets><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /tag/pets><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /tag/pets class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /tag/pets><a href="/award.html" title="Software quality award">Award</a></li> <li /tag/pets><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /tag/pets><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /tag/pets><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header itemprop="name"><h1>13 posts about pets</h1></header> <article itemprop="articleBody"> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.threecopies.com&quot;&gt;&lt;img src=&quot;http://www.threecopies.com/images/logo.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I have a number of data resources which exist in one place only and which I don’t really want to lose. For example, I have a hosted PHP website, and a MySQL database hosted at the same place. I also have a NoSQL database at Amazon DynamoDB, a PostgreSQL database at Heroku, and also… Well, there are many of them. How to back them up was always a question for me.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Main picture&quot; src=&quot;/images/2017/09/threecopies.jpg&quot; /&gt;&lt;/figure&gt; &lt;p&gt;The most straightforward way is to rent a cheap $15/mo server (or use an existing one) and configure Cron to run a custom bash script, which will pull the data from the MySQL database, package it, and upload it to some place where it will be safe, such as Amazon S3 bucket. Then, I would need another script for the PostgreSQL database, and another one for the FTP file archive, etc.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=KYd24FN58wg&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/KYd24FN58wg/mqdefault.jpg&quot; alt=&quot;YouTube video #KYd24FN58wg&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Object-Oriented Java Web App from Scratch in One Hour: ThreeCopies.com (Webinar #28); 4 October 2017.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;This is actually how I was doing it for years. The drawbacks of this solution were always the same:&lt;/p&gt; &lt;ul&gt; &lt;li&gt;I needed to pay for the server.&lt;/li&gt; &lt;li&gt;I needed to make sure the server was always up and running (Linux is far from reliable).&lt;/li&gt; &lt;li&gt;I needed to back up my scripts too.&lt;/li&gt; &lt;li&gt;I needed to SSH to the server every time I wanted to change a script, remember where they were, how they start, etc.&lt;/li&gt; &lt;/ul&gt; &lt;p&gt;The biggest issue is that every single owner of a data source faces exactly the same set of problems. “Why can’t I create a hosted solution for these scripts, to help everybody to back up their data,” I was asking myself for years. “Well, I can,” was the answer just a few weeks ago, and I created &lt;a href=&quot;http://www.threecopies.com&quot;&gt;ThreeCopies&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;It’s a very simple hosted executor of bash scripts, which you edit through a web interface. Then one of our servers starts a Docker container (&lt;a href=&quot;https://hub.docker.com/r/yegor256/threecopies/&quot;&gt;yegor256/threecopies&lt;/a&gt; is the image, here is the &lt;a href=&quot;https://github.com/yegor256/threecopies/blob/master/src/docker/Dockerfile&quot;&gt;&lt;code&gt;Dockerfile&lt;/code&gt;&lt;/a&gt;) and runs your script inside.&lt;/p&gt; &lt;p&gt;The script starts every hour, every day and every week. Hence the name: “three copies.” It’s good practice for data backup to create separate copies with different regularities. Also, you might want to put different data into different copies. To help your script understand which copy is running at any particular time we pass the &lt;code&gt;$period&lt;/code&gt; environment variable into it, with the value of either &lt;code&gt;hour&lt;/code&gt;, &lt;code&gt;day&lt;/code&gt;, or &lt;code&gt;week&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;How your script pulls the data, packages it, and archives it, depends on the data. I created a short cheat sheet for most common scenarios. This is how I backup the MySQL database for &lt;a href=&quot;http://www.thepmp.com&quot;&gt;thePMP&lt;/a&gt;, for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# I don&amp;#39;t want to back up every hour&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;hour&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# I dump the entire database into the file&lt;/span&gt; mysqldump --lock-tables&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; --host&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;db.thepmp.com &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; --user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;thepmp --password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;********* &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; --databases thepmp &amp;gt; thepmp.sql &lt;span class=&quot;c1&quot;&gt;# I compress the file&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;date &lt;span class=&quot;s2&quot;&gt;&amp;quot;+%Y-%m-%d-%H-%M&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.tgz&amp;quot;&lt;/span&gt; tar czf &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; thepmp.sql &lt;span class=&quot;c1&quot;&gt;# I upload it to Amazon S3 bucket&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;[default]&amp;quot;&lt;/span&gt; &amp;gt; ~/.s3cfg &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;access_key=AKIAICJKH*****CVLAFA&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ~/.s3cfg &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;secret_key=yQv3g3ao654Ns**********H1xQSfZlTkseA0haG&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ~/.s3cfg s3cmd --no-progress put &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;s3://backup.yegor256.com/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The output of the script is available through the web interface and this is yet another benefit of this solution. It’s easy to monitor what went wrong and restart the script. All logs are available through the browser. No SSH, no terminals.&lt;/p&gt; &lt;p&gt;I would say that it’s a light version of &lt;a href=&quot;https://aws.amazon.com/datapipeline/&quot;&gt;AWS Data Pipeline&lt;/a&gt;. &lt;a href=&quot;http://www.threecopies.com&quot;&gt;ThreeCopies&lt;/a&gt; does exactly the same, but it’s easier to configure, and it’s cheaper. I’m charging $0.01 per script execution hour. And I actually charge per second, while AWS always charges for a full hour. For $5.00 you get 500 hours. For example, the script you see above takes about 5 minutes to complete (the database is not huge). If you skip the hourly executions, like I did above, you will consume 170 minutes of server time every month, which will cost you about &lt;strong&gt;$0.34 per year&lt;/strong&gt;! This is much cheaper than a server and its monitoring, I believe.&lt;/p&gt; &lt;p&gt;One more thing before you go. ThreeCopies is written in Java 8 and is open source, find it &lt;a href=&quot;https://github.com/yegor256/threecopies&quot;&gt;in GitHub&lt;/a&gt;. Feel free to inspect the code, find bugs, and contribute with fixes or improvements.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, image, buffer, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2017-09-26 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="ThreeCopies.com---Server-Side Data Backup Service"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.threecopies.com&quot;&gt;&lt;img src=&quot;http://www.threecopies.com/images/logo.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I have a number of data resources which exist in one place only and which I don’t really want to lose. For example, I have a hosted PHP website, and a MySQL database hosted at the same place. I also have a NoSQL database at Amazon DynamoDB, a PostgreSQL database at Heroku, and also… Well, there are many of them. How to back them up was always a question for me.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Main picture&quot; src=&quot;/images/2017/09/threecopies.jpg&quot; /&gt;&lt;/figure&gt; &lt;p&gt;The most straightforward way is to rent a cheap $15/mo server (or use an existing one) and configure Cron to run a custom bash script, which will pull the data from the MySQL database, package it, and upload it to some place where it will be safe, such as Amazon S3 bucket. Then, I would need another script for the PostgreSQL database, and another one for the FTP file archive, etc.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=KYd24FN58wg&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/KYd24FN58wg/mqdefault.jpg&quot; alt=&quot;YouTube video #KYd24FN58wg&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Object-Oriented Java Web App from Scratch in One Hour: ThreeCopies.com (Webinar #28); 4 October 2017.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;This is actually how I was doing it for years. The drawbacks of this solution were always the same:&lt;/p&gt; &lt;ul&gt; &lt;li&gt;I needed to pay for the server.&lt;/li&gt; &lt;li&gt;I needed to make sure the server was always up and running (Linux is far from reliable).&lt;/li&gt; &lt;li&gt;I needed to back up my scripts too.&lt;/li&gt; &lt;li&gt;I needed to SSH to the server every time I wanted to change a script, remember where they were, how they start, etc.&lt;/li&gt; &lt;/ul&gt; &lt;p&gt;The biggest issue is that every single owner of a data source faces exactly the same set of problems. “Why can’t I create a hosted solution for these scripts, to help everybody to back up their data,” I was asking myself for years. “Well, I can,” was the answer just a few weeks ago, and I created &lt;a href=&quot;http://www.threecopies.com&quot;&gt;ThreeCopies&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;It’s a very simple hosted executor of bash scripts, which you edit through a web interface. Then one of our servers starts a Docker container (&lt;a href=&quot;https://hub.docker.com/r/yegor256/threecopies/&quot;&gt;yegor256/threecopies&lt;/a&gt; is the image, here is the &lt;a href=&quot;https://github.com/yegor256/threecopies/blob/master/src/docker/Dockerfile&quot;&gt;&lt;code&gt;Dockerfile&lt;/code&gt;&lt;/a&gt;) and runs your script inside.&lt;/p&gt; &lt;p&gt;The script starts every hour, every day and every week. Hence the name: “three copies.” It’s good practice for data backup to create separate copies with different regularities. Also, you might want to put different data into different copies. To help your script understand which copy is running at any particular time we pass the &lt;code&gt;$period&lt;/code&gt; environment variable into it, with the value of either &lt;code&gt;hour&lt;/code&gt;, &lt;code&gt;day&lt;/code&gt;, or &lt;code&gt;week&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;How your script pulls the data, packages it, and archives it, depends on the data. I created a short cheat sheet for most common scenarios. This is how I backup the MySQL database for &lt;a href=&quot;http://www.thepmp.com&quot;&gt;thePMP&lt;/a&gt;, for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;# I don&amp;#39;t want to back up every hour&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;hour&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# I dump the entire database into the file&lt;/span&gt; mysqldump --lock-tables&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; --host&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;db.thepmp.com &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; --user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;thepmp --password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;********* &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; --databases thepmp &amp;gt; thepmp.sql &lt;span class=&quot;c1&quot;&gt;# I compress the file&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;date &lt;span class=&quot;s2&quot;&gt;&amp;quot;+%Y-%m-%d-%H-%M&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.tgz&amp;quot;&lt;/span&gt; tar czf &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; thepmp.sql &lt;span class=&quot;c1&quot;&gt;# I upload it to Amazon S3 bucket&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;[default]&amp;quot;&lt;/span&gt; &amp;gt; ~/.s3cfg &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;access_key=AKIAICJKH*****CVLAFA&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ~/.s3cfg &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;secret_key=yQv3g3ao654Ns**********H1xQSfZlTkseA0haG&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ~/.s3cfg s3cmd --no-progress put &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;s3://backup.yegor256.com/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;tgz&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The output of the script is available through the web interface and this is yet another benefit of this solution. It’s easy to monitor what went wrong and restart the script. All logs are available through the browser. No SSH, no terminals.&lt;/p&gt; &lt;p&gt;I would say that it’s a light version of &lt;a href=&quot;https://aws.amazon.com/datapipeline/&quot;&gt;AWS Data Pipeline&lt;/a&gt;. &lt;a href=&quot;http://www.threecopies.com&quot;&gt;ThreeCopies&lt;/a&gt; does exactly the same, but it’s easier to configure, and it’s cheaper. I’m charging $0.01 per script execution hour. And I actually charge per second, while AWS always charges for a full hour. For $5.00 you get 500 hours. For example, the script you see above takes about 5 minutes to complete (the database is not huge). If you skip the hourly executions, like I did above, you will consume 170 minutes of server time every month, which will cost you about &lt;strong&gt;$0.34 per year&lt;/strong&gt;! This is much cheaper than a server and its monitoring, I believe.&lt;/p&gt; &lt;p&gt;One more thing before you go. ThreeCopies is written in Java 8 and is open source, find it &lt;a href=&quot;https://github.com/yegor256/threecopies&quot;&gt;in GitHub&lt;/a&gt;. Feel free to inspect the code, find bugs, and contribute with fixes or improvements.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html" /> <link rel="amphtml" href="https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.amp.html" /> <title>ThreeCopies.com---Server-Side Data Backup Service </title> <meta name='og:image' content='https://www.yegor256.com/images/2017/09/threecopies.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2017/09/threecopies.jpg'/><meta name='og:image:width' content='1466'/> <meta name='twitter:image:width' content='1466'/><meta name='og:image:height' content='1132'/> <meta name='twitter:image:height' content='1132'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Main picture'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2017/09/26/threecopies-server-data-backup.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2017/09/26/threecopies-server-data-backup.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html</code></p><h1 itemprop="name headline mainEntityOfPage">ThreeCopies.com---Server-Side Data Backup Service</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2017-09-26T00:00:00+00:00"> 26 September 2017 </time> </li> <li class="desktop-only" itemprop="locationCreated">Odessa, Ukraine</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.threecopies.com"><img src="http://www.threecopies.com/images/logo.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>I have a number of data resources which exist in one place only and which I don’t really want to lose. For example, I have a hosted PHP website, and a MySQL database hosted at the same place. I also have a NoSQL database at Amazon DynamoDB, a PostgreSQL database at Heroku, and also… Well, there are many of them. How to back them up was always a question for me.</p><figure class="jb_picture"><img itemprop="image" alt="Main picture" src="/images/2017/09/threecopies.jpg" /></figure><p>The most straightforward way is to rent a cheap $15/mo server (or use an existing one) and configure Cron to run a custom bash script, which will pull the data from the MySQL database, package it, and upload it to some place where it will be safe, such as Amazon S3 bucket. Then, I would need another script for the PostgreSQL database, and another one for the FTP file archive, etc.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=KYd24FN58wg"><div class="box"> <img src="https://i.ytimg.com/vi/KYd24FN58wg/mqdefault.jpg" alt="YouTube video #KYd24FN58wg" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Object-Oriented Java Web App from Scratch in One Hour: ThreeCopies.com (Webinar #28); 4 October 2017.</div></aside><p>This is actually how I was doing it for years. The drawbacks of this solution were always the same:</p><ul> <li>I needed to pay for the server.</li> <li>I needed to make sure the server was always up and running (Linux is far from reliable).</li> <li>I needed to back up my scripts too.</li> <li>I needed to SSH to the server every time I wanted to change a script, remember where they were, how they start, etc.</li></ul><p>The biggest issue is that every single owner of a data source faces exactly the same set of problems. “Why can’t I create a hosted solution for these scripts, to help everybody to back up their data,” I was asking myself for years. “Well, I can,” was the answer just a few weeks ago, and I created <a href="http://www.threecopies.com">ThreeCopies</a>.</p><p>It’s a very simple hosted executor of bash scripts, which you edit through a web interface. Then one of our servers starts a Docker container (<a href="https://hub.docker.com/r/yegor256/threecopies/">yegor256/threecopies</a> is the image, here is the <a href="https://github.com/yegor256/threecopies/blob/master/src/docker/Dockerfile"><code>Dockerfile</code></a>) and runs your script inside.</p><p>The script starts every hour, every day and every week. Hence the name: “three copies.” It’s good practice for data backup to create separate copies with different regularities. Also, you might want to put different data into different copies. To help your script understand which copy is running at any particular time we pass the <code>$period</code> environment variable into it, with the value of either <code>hour</code>, <code>day</code>, or <code>week</code>.</p><p>How your script pulls the data, packages it, and archives it, depends on the data. I created a short cheat sheet for most common scenarios. This is how I backup the MySQL database for <a href="http://www.thepmp.com">thePMP</a>, for example:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># I don&#39;t want to back up every hour</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">period</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;hour&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">exit</span> <span class="m">0</span><span class="p">;</span> <span class="k">fi</span>

<span class="c1"># I dump the entire database into the file</span>
mysqldump --lock-tables<span class="o">=</span><span class="nb">false</span> --host<span class="o">=</span>db.thepmp.com <span class="se">\</span>
  --user<span class="o">=</span>thepmp --password<span class="o">=</span>********* <span class="se">\</span>
  --databases thepmp &gt; thepmp.sql

<span class="c1"># I compress the file</span>
<span class="nv">tgz</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date <span class="s2">&quot;+%Y-%m-%d-%H-%M&quot;</span><span class="k">)</span><span class="s2">.tgz&quot;</span>
tar czf <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span> thepmp.sql

<span class="c1"># I upload it to Amazon S3 bucket</span>
<span class="nb">echo</span> <span class="s2">&quot;[default]&quot;</span> &gt; ~/.s3cfg
<span class="nb">echo</span> <span class="s2">&quot;access_key=AKIAICJKH*****CVLAFA&quot;</span> &gt;&gt; ~/.s3cfg
<span class="nb">echo</span> <span class="s2">&quot;secret_key=yQv3g3ao654Ns**********H1xQSfZlTkseA0haG&quot;</span> &gt;&gt; ~/.s3cfg
s3cmd --no-progress put <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;s3://backup.yegor256.com/</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span></code></pre></figure><p>The output of the script is available through the web interface and this is yet another benefit of this solution. It’s easy to monitor what went wrong and restart the script. All logs are available through the browser. No SSH, no terminals.</p><p>I would say that it’s a light version of <a href="https://aws.amazon.com/datapipeline/">AWS Data Pipeline</a>. <a href="http://www.threecopies.com">ThreeCopies</a> does exactly the same, but it’s easier to configure, and it’s cheaper. I’m charging $0.01 per script execution hour. And I actually charge per second, while AWS always charges for a full hour. For $5.00 you get 500 hours. For example, the script you see above takes about 5 minutes to complete (the database is not huge). If you skip the hourly executions, like I did above, you will consume 170 minutes of server time every month, which will cost you about <strong>$0.34 per year</strong>! This is much cheaper than a server and its monitoring, I believe.</p><p>One more thing before you go. ThreeCopies is written in Java 8 and is open source, find it <a href="https://github.com/yegor256/threecopies">in GitHub</a>. Feel free to inspect the code, find bugs, and contribute with fixes or improvements.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html&amp;text=ThreeCopies.com---Server-Side+Data+Backup+Service" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html%3F2017-39&amp;title=ThreeCopies.com---Server-Side+Data+Backup+Service" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/09/26/threecopies-server-data-backup.html%3F2017-39&amp;t=ThreeCopies.com---Server-Side+Data+Backup+Service" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.threecopies.com"><img src="http://www.threecopies.com/images/logo.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>I have a number of data resources which exist in one place only and which I don’t really want to lose. For example, I have a hosted PHP website, and a MySQL database hosted at the same place. I also have a NoSQL database at Amazon DynamoDB, a PostgreSQL database at Heroku, and also… Well, there are many of them. How to back them up was always a question for me.</p><figure class="jb_picture"><img itemprop="image" alt="Main picture" src="/images/2017/09/threecopies.jpg" /></figure><p>The most straightforward way is to rent a cheap $15/mo server (or use an existing one) and configure Cron to run a custom bash script, which will pull the data from the MySQL database, package it, and upload it to some place where it will be safe, such as Amazon S3 bucket. Then, I would need another script for the PostgreSQL database, and another one for the FTP file archive, etc.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=KYd24FN58wg"><div class="box"> <img src="https://i.ytimg.com/vi/KYd24FN58wg/mqdefault.jpg" alt="YouTube video #KYd24FN58wg" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Object-Oriented Java Web App from Scratch in One Hour: ThreeCopies.com (Webinar #28); 4 October 2017.</div></aside><p>This is actually how I was doing it for years. The drawbacks of this solution were always the same:</p><ul> <li>I needed to pay for the server.</li> <li>I needed to make sure the server was always up and running (Linux is far from reliable).</li> <li>I needed to back up my scripts too.</li> <li>I needed to SSH to the server every time I wanted to change a script, remember where they were, how they start, etc.</li></ul><p>The biggest issue is that every single owner of a data source faces exactly the same set of problems. “Why can’t I create a hosted solution for these scripts, to help everybody to back up their data,” I was asking myself for years. “Well, I can,” was the answer just a few weeks ago, and I created <a href="http://www.threecopies.com">ThreeCopies</a>.</p><p>It’s a very simple hosted executor of bash scripts, which you edit through a web interface. Then one of our servers starts a Docker container (<a href="https://hub.docker.com/r/yegor256/threecopies/">yegor256/threecopies</a> is the image, here is the <a href="https://github.com/yegor256/threecopies/blob/master/src/docker/Dockerfile"><code>Dockerfile</code></a>) and runs your script inside.</p><p>The script starts every hour, every day and every week. Hence the name: “three copies.” It’s good practice for data backup to create separate copies with different regularities. Also, you might want to put different data into different copies. To help your script understand which copy is running at any particular time we pass the <code>$period</code> environment variable into it, with the value of either <code>hour</code>, <code>day</code>, or <code>week</code>.</p><p>How your script pulls the data, packages it, and archives it, depends on the data. I created a short cheat sheet for most common scenarios. This is how I backup the MySQL database for <a href="http://www.thepmp.com">thePMP</a>, for example:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># I don&#39;t want to back up every hour</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">period</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;hour&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">exit</span> <span class="m">0</span><span class="p">;</span> <span class="k">fi</span>

<span class="c1"># I dump the entire database into the file</span>
mysqldump --lock-tables<span class="o">=</span><span class="nb">false</span> --host<span class="o">=</span>db.thepmp.com <span class="se">\</span>
  --user<span class="o">=</span>thepmp --password<span class="o">=</span>********* <span class="se">\</span>
  --databases thepmp &gt; thepmp.sql

<span class="c1"># I compress the file</span>
<span class="nv">tgz</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date <span class="s2">&quot;+%Y-%m-%d-%H-%M&quot;</span><span class="k">)</span><span class="s2">.tgz&quot;</span>
tar czf <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span> thepmp.sql

<span class="c1"># I upload it to Amazon S3 bucket</span>
<span class="nb">echo</span> <span class="s2">&quot;[default]&quot;</span> &gt; ~/.s3cfg
<span class="nb">echo</span> <span class="s2">&quot;access_key=AKIAICJKH*****CVLAFA&quot;</span> &gt;&gt; ~/.s3cfg
<span class="nb">echo</span> <span class="s2">&quot;secret_key=yQv3g3ao654Ns**********H1xQSfZlTkseA0haG&quot;</span> &gt;&gt; ~/.s3cfg
s3cmd --no-progress put <span class="s2">&quot;</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;s3://backup.yegor256.com/</span><span class="si">${</span><span class="nv">tgz</span><span class="si">}</span><span class="s2">&quot;</span></code></pre></figure><p>The output of the script is available through the web interface and this is yet another benefit of this solution. It’s easy to monitor what went wrong and restart the script. All logs are available through the browser. No SSH, no terminals.</p><p>I would say that it’s a light version of <a href="https://aws.amazon.com/datapipeline/">AWS Data Pipeline</a>. <a href="http://www.threecopies.com">ThreeCopies</a> does exactly the same, but it’s easier to configure, and it’s cheaper. I’m charging $0.01 per script execution hour. And I actually charge per second, while AWS always charges for a full hour. For $5.00 you get 500 hours. For example, the script you see above takes about 5 minutes to complete (the database is not huge). If you skip the hourly executions, like I did above, you will consume 170 minutes of server time every month, which will cost you about <strong>$0.34 per year</strong>! This is much cheaper than a server and its monitoring, I believe.</p><p>One more thing before you go. ThreeCopies is written in Java 8 and is open source, find it <a href="https://github.com/yegor256/threecopies">in GitHub</a>. Feel free to inspect the code, find bugs, and contribute with fixes or improvements.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.rehttp.net&quot;&gt;&lt;img src=&quot;http://www.rehttp.net/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I faced a problem a few weeks ago with &lt;a href=&quot;http://www.0pdd.com&quot;&gt;0pdd.com&lt;/a&gt;, one of my web apps that is supposed to receive HTTP requests (known as &lt;a href=&quot;https://developer.github.com/webhooks/&quot;&gt;webhooks&lt;/a&gt;) from GitHub: sometimes the app is down, GitHub gets an HTTP error, and never sends the request again. The request simply gets lost. There is absolutely no way to receive it again once the app is back up. I realized that I needed a &lt;a href=&quot;https://buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/&quot;&gt;service mesh&lt;/a&gt; between GitHub and my web app, to accept HTTP requests and repeat them later if they can’t be delivered immediately.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;I created &lt;a href=&quot;http://www.rehttp.net&quot;&gt;rehttp.net&lt;/a&gt; to do exactly that.&lt;/p&gt; &lt;p&gt;See, the URL I’ve been giving to GitHub is this one:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;http://www.0pdd.com/hook/github&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;From now on a new URL has to be used:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;https://www.rehttp.net/p/http://www.0pdd.com/hook/github&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It looks very similar, but starts with &lt;code&gt;https://www.rehttp.net/p/&lt;/code&gt;. GitHub sends all webhook PUT/POST requests to the ReHTTP server, which stores them in a temporary database (I’m using AWS DynamoDB).&lt;/p&gt; &lt;p&gt;ReHTTP attempts to deliver them immediately. If something goes wrong and the server HTTP response code is not in the 200-299 range, the next attempt is made in about an hour. Then it retries every hour for about a day. If all attempts fail, it abandons the request and that’s it.&lt;/p&gt; &lt;p&gt;What is interesting is that now I can see a summary of my API &lt;a href=&quot;https://www.rehttp.net/i?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&quot;&gt;here&lt;/a&gt;. I see how many requests were processed successfully over the last 24 hours and how many of them failed. Also, I have this cute button:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;https://www.rehttp.net/b?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&quot; alt=&quot;badge&quot; /&gt;&lt;/p&gt; &lt;p&gt;And I have a URL for checking the status of the entire API:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;https://www.rehttp.net/s?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I gave this URL to &lt;a href=&quot;https://www.statuscake.com/&quot;&gt;StatusCake&lt;/a&gt; to ping it every five minutes. If and when something goes wrong, StatusCake will email me and drop me a message on the phone.&lt;/p&gt; &lt;p&gt;ReHTTP is absolutely free. It is written in Java and the code is open. See its &lt;a href=&quot;https://github.com/yegor256/rehttp&quot;&gt;GitHub repository&lt;/a&gt; and contribute if you find any bugs or just want to add a feature.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2017-09-05 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="ReHTTP.net---HTTP Repeater"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.rehttp.net&quot;&gt;&lt;img src=&quot;http://www.rehttp.net/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I faced a problem a few weeks ago with &lt;a href=&quot;http://www.0pdd.com&quot;&gt;0pdd.com&lt;/a&gt;, one of my web apps that is supposed to receive HTTP requests (known as &lt;a href=&quot;https://developer.github.com/webhooks/&quot;&gt;webhooks&lt;/a&gt;) from GitHub: sometimes the app is down, GitHub gets an HTTP error, and never sends the request again. The request simply gets lost. There is absolutely no way to receive it again once the app is back up. I realized that I needed a &lt;a href=&quot;https://buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/&quot;&gt;service mesh&lt;/a&gt; between GitHub and my web app, to accept HTTP requests and repeat them later if they can’t be delivered immediately.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;I created &lt;a href=&quot;http://www.rehttp.net&quot;&gt;rehttp.net&lt;/a&gt; to do exactly that.&lt;/p&gt; &lt;p&gt;See, the URL I’ve been giving to GitHub is this one:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;http://www.0pdd.com/hook/github&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;From now on a new URL has to be used:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;https://www.rehttp.net/p/http://www.0pdd.com/hook/github&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It looks very similar, but starts with &lt;code&gt;https://www.rehttp.net/p/&lt;/code&gt;. GitHub sends all webhook PUT/POST requests to the ReHTTP server, which stores them in a temporary database (I’m using AWS DynamoDB).&lt;/p&gt; &lt;p&gt;ReHTTP attempts to deliver them immediately. If something goes wrong and the server HTTP response code is not in the 200-299 range, the next attempt is made in about an hour. Then it retries every hour for about a day. If all attempts fail, it abandons the request and that’s it.&lt;/p&gt; &lt;p&gt;What is interesting is that now I can see a summary of my API &lt;a href=&quot;https://www.rehttp.net/i?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&quot;&gt;here&lt;/a&gt;. I see how many requests were processed successfully over the last 24 hours and how many of them failed. Also, I have this cute button:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;https://www.rehttp.net/b?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&quot; alt=&quot;badge&quot; /&gt;&lt;/p&gt; &lt;p&gt;And I have a URL for checking the status of the entire API:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;https://www.rehttp.net/s?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I gave this URL to &lt;a href=&quot;https://www.statuscake.com/&quot;&gt;StatusCake&lt;/a&gt; to ping it every five minutes. If and when something goes wrong, StatusCake will email me and drop me a message on the phone.&lt;/p&gt; &lt;p&gt;ReHTTP is absolutely free. It is written in Java and the code is open. See its &lt;a href=&quot;https://github.com/yegor256/rehttp&quot;&gt;GitHub repository&lt;/a&gt; and contribute if you find any bugs or just want to add a feature.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html" /> <link rel="amphtml" href="https://www.yegor256.com/2017/09/05/rehttp-http-repeater.amp.html" /> <title>ReHTTP.net---HTTP Repeater </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2017/09/05/rehttp-http-repeater.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2017/09/05/rehttp-http-repeater.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html</code></p><h1 itemprop="name headline mainEntityOfPage">ReHTTP.net---HTTP Repeater</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2017-09-05T00:00:00+00:00"> 5 September 2017 </time> </li> <li class="desktop-only" itemprop="locationCreated">Odessa, Ukraine</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.rehttp.net"><img src="http://www.rehttp.net/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>I faced a problem a few weeks ago with <a href="http://www.0pdd.com">0pdd.com</a>, one of my web apps that is supposed to receive HTTP requests (known as <a href="https://developer.github.com/webhooks/">webhooks</a>) from GitHub: sometimes the app is down, GitHub gets an HTTP error, and never sends the request again. The request simply gets lost. There is absolutely no way to receive it again once the app is back up. I realized that I needed a <a href="https://buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/">service mesh</a> between GitHub and my web app, to accept HTTP requests and repeat them later if they can’t be delivered immediately.</p><p>I created <a href="http://www.rehttp.net">rehttp.net</a> to do exactly that.</p><p>See, the URL I’ve been giving to GitHub is this one:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>http://www.0pdd.com/hook/github</code></pre></figure><p>From now on a new URL has to be used:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>https://www.rehttp.net/p/http://www.0pdd.com/hook/github</code></pre></figure><p>It looks very similar, but starts with <code>https://www.rehttp.net/p/</code>. GitHub sends all webhook PUT/POST requests to the ReHTTP server, which stores them in a temporary database (I’m using AWS DynamoDB).</p><p>ReHTTP attempts to deliver them immediately. If something goes wrong and the server HTTP response code is not in the 200-299 range, the next attempt is made in about an hour. Then it retries every hour for about a day. If all attempts fail, it abandons the request and that’s it.</p><p>What is interesting is that now I can see a summary of my API <a href="https://www.rehttp.net/i?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub">here</a>. I see how many requests were processed successfully over the last 24 hours and how many of them failed. Also, I have this cute button:</p><p><img src="https://www.rehttp.net/b?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub" alt="badge" /></p><p>And I have a URL for checking the status of the entire API:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>https://www.rehttp.net/s?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub</code></pre></figure><p>I gave this URL to <a href="https://www.statuscake.com/">StatusCake</a> to ping it every five minutes. If and when something goes wrong, StatusCake will email me and drop me a message on the phone.</p><p>ReHTTP is absolutely free. It is written in Java and the code is open. See its <a href="https://github.com/yegor256/rehttp">GitHub repository</a> and contribute if you find any bugs or just want to add a feature.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html&amp;text=ReHTTP.net---HTTP+Repeater" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html%3F2017-36&amp;title=ReHTTP.net---HTTP+Repeater" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/09/05/rehttp-http-repeater.html%3F2017-36&amp;t=ReHTTP.net---HTTP+Repeater" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.rehttp.net"><img src="http://www.rehttp.net/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>I faced a problem a few weeks ago with <a href="http://www.0pdd.com">0pdd.com</a>, one of my web apps that is supposed to receive HTTP requests (known as <a href="https://developer.github.com/webhooks/">webhooks</a>) from GitHub: sometimes the app is down, GitHub gets an HTTP error, and never sends the request again. The request simply gets lost. There is absolutely no way to receive it again once the app is back up. I realized that I needed a <a href="https://buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/">service mesh</a> between GitHub and my web app, to accept HTTP requests and repeat them later if they can’t be delivered immediately.</p><p>I created <a href="http://www.rehttp.net">rehttp.net</a> to do exactly that.</p><p>See, the URL I’ve been giving to GitHub is this one:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>http://www.0pdd.com/hook/github</code></pre></figure><p>From now on a new URL has to be used:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>https://www.rehttp.net/p/http://www.0pdd.com/hook/github</code></pre></figure><p>It looks very similar, but starts with <code>https://www.rehttp.net/p/</code>. GitHub sends all webhook PUT/POST requests to the ReHTTP server, which stores them in a temporary database (I’m using AWS DynamoDB).</p><p>ReHTTP attempts to deliver them immediately. If something goes wrong and the server HTTP response code is not in the 200-299 range, the next attempt is made in about an hour. Then it retries every hour for about a day. If all attempts fail, it abandons the request and that’s it.</p><p>What is interesting is that now I can see a summary of my API <a href="https://www.rehttp.net/i?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub">here</a>. I see how many requests were processed successfully over the last 24 hours and how many of them failed. Also, I have this cute button:</p><p><img src="https://www.rehttp.net/b?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub" alt="badge" /></p><p>And I have a URL for checking the status of the entire API:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>https://www.rehttp.net/s?u=http%3A%2F%2Fwww.0pdd.com%2Fhook%2Fgithub</code></pre></figure><p>I gave this URL to <a href="https://www.statuscake.com/">StatusCake</a> to ping it every five minutes. If and when something goes wrong, StatusCake will email me and drop me a message on the phone.</p><p>ReHTTP is absolutely free. It is written in Java and the code is open. See its <a href="https://github.com/yegor256/rehttp">GitHub repository</a> and contribute if you find any bugs or just want to add a feature.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.cactoos.org&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/books/elegant-objects/cactus.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://www.cactoos.org&quot;&gt;Cactoos&lt;/a&gt; is a library of object-oriented Java primitives &lt;a href=&quot;https://github.com/yegor256/cactoos#contributors&quot;&gt;we&lt;/a&gt; started to work on just a few weeks ago. The intent was to propose a clean and more declarative alternative to &lt;a href=&quot;https://en.wikipedia.org/wiki/Java_Development_Kit&quot;&gt;JDK&lt;/a&gt;, &lt;a href=&quot;https://github.com/google/guava&quot;&gt;Guava&lt;/a&gt;, &lt;a href=&quot;https://commons.apache.org/&quot;&gt;Apache Commons&lt;/a&gt;, and others. Instead of calling static &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;procedures&lt;/a&gt; we want to use &lt;a href=&quot;/2016/07/14/who-is-object.html&quot;&gt;objects&lt;/a&gt;, the way they are supposed to be used. Let’s see how input/output works in a &lt;em&gt;pure&lt;/em&gt; &lt;a href=&quot;/2016/08/15/what-is-wrong-object-oriented-programming.html&quot;&gt;object-oriented&lt;/a&gt; fashion.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;&lt;strong&gt;Disclaimer&lt;/strong&gt;: The version I’m using at the time of writing is &lt;a href=&quot;https://github.com/yegor256/cactoos/releases/tag/0.9&quot;&gt;0.9&lt;/a&gt;. Later versions may have different names of classes and a totally different design.&lt;/p&gt; &lt;p&gt;Let’s say you want to read a file. This is how you would do it with the static method &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#readAllBytes%28java.nio.file.Path%29&quot;&gt;&lt;code&gt;readAllBytes()&lt;/code&gt;&lt;/a&gt; from the &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;utility class&lt;/a&gt; &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html&quot;&gt;&lt;code&gt;Files&lt;/code&gt;&lt;/a&gt; in JDK7:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readAllBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/photo.jpg&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This code is very imperative—it reads the file content right here and now, placing it into the array.&lt;/p&gt; &lt;p&gt;This is how you do it with &lt;a href=&quot;https://github.com/yegor256/cactoos&quot;&gt;Cactoos&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Bytes&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/photo.jpg&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Pay attention—there are no method calls yet. Just three constructors of three classes that compose a bigger object. The object &lt;code&gt;source&lt;/code&gt; is of type &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Bytes.html&quot;&gt;&lt;code&gt;Bytes&lt;/code&gt;&lt;/a&gt; and represents the content of the file. To get that content out of it we call its method &lt;code&gt;asBytes()&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;asBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is the moment when the file system is touched. This approach, as you can see, is absolutely declarative and thanks to that possesses all the benefits of object orientation.&lt;/p&gt; &lt;p&gt;Here is another example. Say you want to write some text into a file. Here is how you do it in Cactoos. First you need the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Input&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then you need the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html&quot;&gt;&lt;code&gt;Output&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we want to copy the input to the output. There is no “copy” operation in &lt;em&gt;pure&lt;/em&gt; OOP. Moreover, there must be no operations at all. Just objects. We have a class named &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/TeeInput.html&quot;&gt;&lt;code&gt;TeeInput&lt;/code&gt;&lt;/a&gt;, which is an &lt;code&gt;Input&lt;/code&gt; that copies everything you read from it to the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html&quot;&gt;&lt;code&gt;Output&lt;/code&gt;&lt;/a&gt;, similar to what &lt;a href=&quot;https://commons.apache.org/proper/commons-io/javadocs/api-1.4/org/apache/commons/io/input/TeeInputStream.html&quot;&gt;&lt;code&gt;TeeInputStream&lt;/code&gt;&lt;/a&gt; from &lt;a href=&quot;https://commons.apache.org/&quot;&gt;Apache Commons&lt;/a&gt; does, but encapsulated. So we don’t copy, we create an &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt; that will copy if you &lt;em&gt;touch&lt;/em&gt; it:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Input&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tee&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we have to “touch” it. And we have to touch every single byte of it, in order to make sure they all are copied. If we just &lt;code&gt;read()&lt;/code&gt; the first byte, only one byte will be copied to the file. The best way to touch them all is to calculate the size of the &lt;code&gt;tee&lt;/code&gt; object, going byte by byte. We have an object for it, called &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/LengthOfInput.html&quot;&gt;&lt;code&gt;LengthOfInput&lt;/code&gt;&lt;/a&gt;. It encapsulates an &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt; and behaves like its length in bytes:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tee&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then we take the value out of it and the file writing operation takes place:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Thus, the entire operation of writing the string to the file will look like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// happens here&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is its procedural alternative from &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29&quot;&gt;JDK7&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;“Why is object-oriented better, even though it’s longer?” I hear you ask. Because it perfectly &lt;strong&gt;decouples&lt;/strong&gt; concepts, while the procedural one keeps them together.&lt;/p&gt; &lt;p&gt;Let’s say, you are designing a class that is supposed to encrypt some text and save it to a file. Here is how you would design it the procedural way (not a real encryption, of course):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;replaceAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;[a-z]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Works fine, but what will happen when you decide to extend it to also write to an &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html&quot;&gt;&lt;code&gt;OutputStream&lt;/code&gt;&lt;/a&gt;? How will you modify this class? How ugly will it look after that? That’s because the design is not object-oriented.&lt;/p&gt; &lt;p&gt;This is how you would do the same design, in an object-oriented way, with &lt;a href=&quot;http://www.cactoos.org&quot;&gt;Cactoos&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;replaceAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;[a-z]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;What do we do with this design if we want &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html&quot;&gt;&lt;code&gt;OutputStream&lt;/code&gt;&lt;/a&gt; to be accepted? We just add one &lt;a href=&quot;/2015/05/28/one-primary-constructor.html&quot;&gt;secondary&lt;/a&gt; constructor:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputStream&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputStreamAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Done. That’s how easy and elegant it is.&lt;/p&gt; &lt;p&gt;That’s because concepts are perfectly separated and functionality is encapsulated. In the procedural example the behavior of the object is located outside of it, in the method &lt;code&gt;encode()&lt;/code&gt;. The file itself doesn’t know how to write, some outside procedure &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29&quot;&gt;&lt;code&gt;Files.write()&lt;/code&gt;&lt;/a&gt; knows that instead.&lt;/p&gt; &lt;p&gt;To the contrary, in the object-oriented design the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/FileAsOutput.html&quot;&gt;&lt;code&gt;FileAsOutput&lt;/code&gt;&lt;/a&gt; knows how to write, and nobody else does. The file writing functionality is encapsulated and this makes it possible to decorate the objects in any possible way, creating reusable and replaceable composite objects.&lt;/p&gt; &lt;p&gt;Do you see the beauty of OOP now?&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2017-06-22 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Object-Oriented Declarative Input/Output in Cactoos"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.cactoos.org&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/books/elegant-objects/cactus.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://www.cactoos.org&quot;&gt;Cactoos&lt;/a&gt; is a library of object-oriented Java primitives &lt;a href=&quot;https://github.com/yegor256/cactoos#contributors&quot;&gt;we&lt;/a&gt; started to work on just a few weeks ago. The intent was to propose a clean and more declarative alternative to &lt;a href=&quot;https://en.wikipedia.org/wiki/Java_Development_Kit&quot;&gt;JDK&lt;/a&gt;, &lt;a href=&quot;https://github.com/google/guava&quot;&gt;Guava&lt;/a&gt;, &lt;a href=&quot;https://commons.apache.org/&quot;&gt;Apache Commons&lt;/a&gt;, and others. Instead of calling static &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;procedures&lt;/a&gt; we want to use &lt;a href=&quot;/2016/07/14/who-is-object.html&quot;&gt;objects&lt;/a&gt;, the way they are supposed to be used. Let’s see how input/output works in a &lt;em&gt;pure&lt;/em&gt; &lt;a href=&quot;/2016/08/15/what-is-wrong-object-oriented-programming.html&quot;&gt;object-oriented&lt;/a&gt; fashion.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;&lt;strong&gt;Disclaimer&lt;/strong&gt;: The version I’m using at the time of writing is &lt;a href=&quot;https://github.com/yegor256/cactoos/releases/tag/0.9&quot;&gt;0.9&lt;/a&gt;. Later versions may have different names of classes and a totally different design.&lt;/p&gt; &lt;p&gt;Let’s say you want to read a file. This is how you would do it with the static method &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#readAllBytes%28java.nio.file.Path%29&quot;&gt;&lt;code&gt;readAllBytes()&lt;/code&gt;&lt;/a&gt; from the &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;utility class&lt;/a&gt; &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html&quot;&gt;&lt;code&gt;Files&lt;/code&gt;&lt;/a&gt; in JDK7:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readAllBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/photo.jpg&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This code is very imperative—it reads the file content right here and now, placing it into the array.&lt;/p&gt; &lt;p&gt;This is how you do it with &lt;a href=&quot;https://github.com/yegor256/cactoos&quot;&gt;Cactoos&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Bytes&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/photo.jpg&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Pay attention—there are no method calls yet. Just three constructors of three classes that compose a bigger object. The object &lt;code&gt;source&lt;/code&gt; is of type &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Bytes.html&quot;&gt;&lt;code&gt;Bytes&lt;/code&gt;&lt;/a&gt; and represents the content of the file. To get that content out of it we call its method &lt;code&gt;asBytes()&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;asBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is the moment when the file system is touched. This approach, as you can see, is absolutely declarative and thanks to that possesses all the benefits of object orientation.&lt;/p&gt; &lt;p&gt;Here is another example. Say you want to write some text into a file. Here is how you do it in Cactoos. First you need the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Input&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then you need the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html&quot;&gt;&lt;code&gt;Output&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we want to copy the input to the output. There is no “copy” operation in &lt;em&gt;pure&lt;/em&gt; OOP. Moreover, there must be no operations at all. Just objects. We have a class named &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/TeeInput.html&quot;&gt;&lt;code&gt;TeeInput&lt;/code&gt;&lt;/a&gt;, which is an &lt;code&gt;Input&lt;/code&gt; that copies everything you read from it to the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html&quot;&gt;&lt;code&gt;Output&lt;/code&gt;&lt;/a&gt;, similar to what &lt;a href=&quot;https://commons.apache.org/proper/commons-io/javadocs/api-1.4/org/apache/commons/io/input/TeeInputStream.html&quot;&gt;&lt;code&gt;TeeInputStream&lt;/code&gt;&lt;/a&gt; from &lt;a href=&quot;https://commons.apache.org/&quot;&gt;Apache Commons&lt;/a&gt; does, but encapsulated. So we don’t copy, we create an &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt; that will copy if you &lt;em&gt;touch&lt;/em&gt; it:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Input&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tee&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we have to “touch” it. And we have to touch every single byte of it, in order to make sure they all are copied. If we just &lt;code&gt;read()&lt;/code&gt; the first byte, only one byte will be copied to the file. The best way to touch them all is to calculate the size of the &lt;code&gt;tee&lt;/code&gt; object, going byte by byte. We have an object for it, called &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/LengthOfInput.html&quot;&gt;&lt;code&gt;LengthOfInput&lt;/code&gt;&lt;/a&gt;. It encapsulates an &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html&quot;&gt;&lt;code&gt;Input&lt;/code&gt;&lt;/a&gt; and behaves like its length in bytes:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tee&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then we take the value out of it and the file writing operation takes place:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Thus, the entire operation of writing the string to the file will look like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// happens here&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is its procedural alternative from &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29&quot;&gt;JDK7&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/tmp/hello.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;“Why is object-oriented better, even though it’s longer?” I hear you ask. Because it perfectly &lt;strong&gt;decouples&lt;/strong&gt; concepts, while the procedural one keeps them together.&lt;/p&gt; &lt;p&gt;Let’s say, you are designing a class that is supposed to encrypt some text and save it to a file. Here is how you would design it the procedural way (not a real encryption, of course):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Files&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;replaceAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;[a-z]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Works fine, but what will happen when you decide to extend it to also write to an &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html&quot;&gt;&lt;code&gt;OutputStream&lt;/code&gt;&lt;/a&gt;? How will you modify this class? How ugly will it look after that? That’s because the design is not object-oriented.&lt;/p&gt; &lt;p&gt;This is how you would do the same design, in an object-oriented way, with &lt;a href=&quot;http://www.cactoos.org&quot;&gt;Cactoos&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LengthOfInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TeeInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BytesAsInput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextAsBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StringAsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;replaceAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;[a-z]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;target&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;What do we do with this design if we want &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html&quot;&gt;&lt;code&gt;OutputStream&lt;/code&gt;&lt;/a&gt; to be accepted? We just add one &lt;a href=&quot;/2015/05/28/one-primary-constructor.html&quot;&gt;secondary&lt;/a&gt; constructor:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputStream&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OutputStreamAsOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Done. That’s how easy and elegant it is.&lt;/p&gt; &lt;p&gt;That’s because concepts are perfectly separated and functionality is encapsulated. In the procedural example the behavior of the object is located outside of it, in the method &lt;code&gt;encode()&lt;/code&gt;. The file itself doesn’t know how to write, some outside procedure &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29&quot;&gt;&lt;code&gt;Files.write()&lt;/code&gt;&lt;/a&gt; knows that instead.&lt;/p&gt; &lt;p&gt;To the contrary, in the object-oriented design the &lt;a href=&quot;http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/FileAsOutput.html&quot;&gt;&lt;code&gt;FileAsOutput&lt;/code&gt;&lt;/a&gt; knows how to write, and nobody else does. The file writing functionality is encapsulated and this makes it possible to decorate the objects in any possible way, creating reusable and replaceable composite objects.&lt;/p&gt; &lt;p&gt;Do you see the beauty of OOP now?&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html" /> <link rel="amphtml" href="https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.amp.html" /> <title>Object-Oriented Declarative Input/Output in Cactoos </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2017/06/22/object-oriented-input-output-in-cactoos.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html</code></p><h1 itemprop="name headline mainEntityOfPage">Object-Oriented Declarative Input/Output in Cactoos</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2017-06-22T00:00:00+00:00"> 22 June 2017 </time> </li> <li class="desktop-only" itemprop="locationCreated">Dnipro, Ukraine</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.cactoos.org"><img src="https://www.yegor256.com/images/books/elegant-objects/cactus.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p><a href="http://www.cactoos.org">Cactoos</a> is a library of object-oriented Java primitives <a href="https://github.com/yegor256/cactoos#contributors">we</a> started to work on just a few weeks ago. The intent was to propose a clean and more declarative alternative to <a href="https://en.wikipedia.org/wiki/Java_Development_Kit">JDK</a>, <a href="https://github.com/google/guava">Guava</a>, <a href="https://commons.apache.org/">Apache Commons</a>, and others. Instead of calling static <a href="/2014/05/05/oop-alternative-to-utility-classes.html">procedures</a> we want to use <a href="/2016/07/14/who-is-object.html">objects</a>, the way they are supposed to be used. Let’s see how input/output works in a <em>pure</em> <a href="/2016/08/15/what-is-wrong-object-oriented-programming.html">object-oriented</a> fashion.</p><p><strong>Disclaimer</strong>: The version I’m using at the time of writing is <a href="https://github.com/yegor256/cactoos/releases/tag/0.9">0.9</a>. Later versions may have different names of classes and a totally different design.</p><p>Let’s say you want to read a file. This is how you would do it with the static method <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#readAllBytes%28java.nio.file.Path%29"><code>readAllBytes()</code></a> from the <a href="/2014/05/05/oop-alternative-to-utility-classes.html">utility class</a> <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html"><code>Files</code></a> in JDK7:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/photo.jpg&quot;</span><span class="o">).</span><span class="na">toPath</span><span class="o">()</span>
<span class="o">);</span></code></pre></figure><p>This code is very imperative—it reads the file content right here and now, placing it into the array.</p><p>This is how you do it with <a href="https://github.com/yegor256/cactoos">Cactoos</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Bytes</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputAsBytes</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">FileAsInput</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/photo.jpg&quot;</span><span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Pay attention—there are no method calls yet. Just three constructors of three classes that compose a bigger object. The object <code>source</code> is of type <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Bytes.html"><code>Bytes</code></a> and represents the content of the file. To get that content out of it we call its method <code>asBytes()</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">bytes</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">asBytes</span><span class="o">();</span></code></pre></figure><p>This is the moment when the file system is touched. This approach, as you can see, is absolutely declarative and thanks to that possesses all the benefits of object orientation.</p><p>Here is another example. Say you want to write some text into a file. Here is how you do it in Cactoos. First you need the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Input</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
      <span class="s">&quot;Hello, world!&quot;</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Then you need the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html"><code>Output</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Output</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Now, we want to copy the input to the output. There is no “copy” operation in <em>pure</em> OOP. Moreover, there must be no operations at all. Just objects. We have a class named <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/TeeInput.html"><code>TeeInput</code></a>, which is an <code>Input</code> that copies everything you read from it to the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html"><code>Output</code></a>, similar to what <a href="https://commons.apache.org/proper/commons-io/javadocs/api-1.4/org/apache/commons/io/input/TeeInputStream.html"><code>TeeInputStream</code></a> from <a href="https://commons.apache.org/">Apache Commons</a> does, but encapsulated. So we don’t copy, we create an <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a> that will copy if you <em>touch</em> it:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Input</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span></code></pre></figure><p>Now, we have to “touch” it. And we have to touch every single byte of it, in order to make sure they all are copied. If we just <code>read()</code> the first byte, only one byte will be copied to the file. The best way to touch them all is to calculate the size of the <code>tee</code> object, going byte by byte. We have an object for it, called <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/LengthOfInput.html"><code>LengthOfInput</code></a>. It encapsulates an <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a> and behaves like its length in bytes:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Scalar</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">length</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span><span class="n">tee</span><span class="o">);</span></code></pre></figure><p>Then we take the value out of it and the file writing operation takes place:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="na">value</span><span class="o">();</span></code></pre></figure><p>Thus, the entire operation of writing the string to the file will look like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
          <span class="s">&quot;Hello, world!&quot;</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">).</span><span class="na">value</span><span class="o">();</span> <span class="c1">// happens here</span></code></pre></figure><p>This is its procedural alternative from <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29">JDK7</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">).</span><span class="na">toPath</span><span class="o">(),</span>
  <span class="s">&quot;Hello, world!&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()</span>
<span class="o">);</span></code></pre></figure><p>“Why is object-oriented better, even though it’s longer?” I hear you ask. Because it perfectly <strong>decouples</strong> concepts, while the procedural one keeps them together.</p><p>Let’s say, you are designing a class that is supposed to encrypt some text and save it to a file. Here is how you would design it the procedural way (not a real encryption, of course):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">File</span> <span class="n">target</span><span class="o">;</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
      <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">,</span>
      <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;[a-z]&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Works fine, but what will happen when you decide to extend it to also write to an <a href="https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html"><code>OutputStream</code></a>? How will you modify this class? How ugly will it look after that? That’s because the design is not object-oriented.</p><p>This is how you would do the same design, in an object-oriented way, with <a href="http://www.cactoos.org">Cactoos</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Output</span> <span class="n">target</span><span class="o">;</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">Output</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">output</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
              <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;[a-z]&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">),</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span>
      <span class="o">)</span>
    <span class="o">).</span><span class="na">value</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>What do we do with this design if we want <a href="https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html"><code>OutputStream</code></a> to be accepted? We just add one <a href="/2015/05/28/one-primary-constructor.html">secondary</a> constructor:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">OutputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">OutputStreamAsOutput</span><span class="o">(</span><span class="n">stream</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Done. That’s how easy and elegant it is.</p><p>That’s because concepts are perfectly separated and functionality is encapsulated. In the procedural example the behavior of the object is located outside of it, in the method <code>encode()</code>. The file itself doesn’t know how to write, some outside procedure <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29"><code>Files.write()</code></a> knows that instead.</p><p>To the contrary, in the object-oriented design the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/FileAsOutput.html"><code>FileAsOutput</code></a> knows how to write, and nobody else does. The file writing functionality is encapsulated and this makes it possible to decorate the objects in any possible way, creating reusable and replaceable composite objects.</p><p>Do you see the beauty of OOP now?</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html&amp;text=Object-Oriented+Declarative+Input%2FOutput+in+Cactoos" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html%3F2017-25&amp;title=Object-Oriented+Declarative+Input%2FOutput+in+Cactoos" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/06/22/object-oriented-input-output-in-cactoos.html%3F2017-25&amp;t=Object-Oriented+Declarative+Input%2FOutput+in+Cactoos" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.cactoos.org"><img src="https://www.yegor256.com/images/books/elegant-objects/cactus.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p><a href="http://www.cactoos.org">Cactoos</a> is a library of object-oriented Java primitives <a href="https://github.com/yegor256/cactoos#contributors">we</a> started to work on just a few weeks ago. The intent was to propose a clean and more declarative alternative to <a href="https://en.wikipedia.org/wiki/Java_Development_Kit">JDK</a>, <a href="https://github.com/google/guava">Guava</a>, <a href="https://commons.apache.org/">Apache Commons</a>, and others. Instead of calling static <a href="/2014/05/05/oop-alternative-to-utility-classes.html">procedures</a> we want to use <a href="/2016/07/14/who-is-object.html">objects</a>, the way they are supposed to be used. Let’s see how input/output works in a <em>pure</em> <a href="/2016/08/15/what-is-wrong-object-oriented-programming.html">object-oriented</a> fashion.</p><p><strong>Disclaimer</strong>: The version I’m using at the time of writing is <a href="https://github.com/yegor256/cactoos/releases/tag/0.9">0.9</a>. Later versions may have different names of classes and a totally different design.</p><p>Let’s say you want to read a file. This is how you would do it with the static method <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#readAllBytes%28java.nio.file.Path%29"><code>readAllBytes()</code></a> from the <a href="/2014/05/05/oop-alternative-to-utility-classes.html">utility class</a> <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html"><code>Files</code></a> in JDK7:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/photo.jpg&quot;</span><span class="o">).</span><span class="na">toPath</span><span class="o">()</span>
<span class="o">);</span></code></pre></figure><p>This code is very imperative—it reads the file content right here and now, placing it into the array.</p><p>This is how you do it with <a href="https://github.com/yegor256/cactoos">Cactoos</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Bytes</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputAsBytes</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">FileAsInput</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/photo.jpg&quot;</span><span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Pay attention—there are no method calls yet. Just three constructors of three classes that compose a bigger object. The object <code>source</code> is of type <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Bytes.html"><code>Bytes</code></a> and represents the content of the file. To get that content out of it we call its method <code>asBytes()</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">bytes</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">asBytes</span><span class="o">();</span></code></pre></figure><p>This is the moment when the file system is touched. This approach, as you can see, is absolutely declarative and thanks to that possesses all the benefits of object orientation.</p><p>Here is another example. Say you want to write some text into a file. Here is how you do it in Cactoos. First you need the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Input</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
      <span class="s">&quot;Hello, world!&quot;</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Then you need the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html"><code>Output</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Output</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Now, we want to copy the input to the output. There is no “copy” operation in <em>pure</em> OOP. Moreover, there must be no operations at all. Just objects. We have a class named <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/TeeInput.html"><code>TeeInput</code></a>, which is an <code>Input</code> that copies everything you read from it to the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Output.html"><code>Output</code></a>, similar to what <a href="https://commons.apache.org/proper/commons-io/javadocs/api-1.4/org/apache/commons/io/input/TeeInputStream.html"><code>TeeInputStream</code></a> from <a href="https://commons.apache.org/">Apache Commons</a> does, but encapsulated. So we don’t copy, we create an <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a> that will copy if you <em>touch</em> it:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Input</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span></code></pre></figure><p>Now, we have to “touch” it. And we have to touch every single byte of it, in order to make sure they all are copied. If we just <code>read()</code> the first byte, only one byte will be copied to the file. The best way to touch them all is to calculate the size of the <code>tee</code> object, going byte by byte. We have an object for it, called <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/LengthOfInput.html"><code>LengthOfInput</code></a>. It encapsulates an <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/Input.html"><code>Input</code></a> and behaves like its length in bytes:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Scalar</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">length</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span><span class="n">tee</span><span class="o">);</span></code></pre></figure><p>Then we take the value out of it and the file writing operation takes place:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="na">value</span><span class="o">();</span></code></pre></figure><p>Thus, the entire operation of writing the string to the file will look like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
          <span class="s">&quot;Hello, world!&quot;</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">).</span><span class="na">value</span><span class="o">();</span> <span class="c1">// happens here</span></code></pre></figure><p>This is its procedural alternative from <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29">JDK7</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/hello.txt&quot;</span><span class="o">).</span><span class="na">toPath</span><span class="o">(),</span>
  <span class="s">&quot;Hello, world!&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()</span>
<span class="o">);</span></code></pre></figure><p>“Why is object-oriented better, even though it’s longer?” I hear you ask. Because it perfectly <strong>decouples</strong> concepts, while the procedural one keeps them together.</p><p>Let’s say, you are designing a class that is supposed to encrypt some text and save it to a file. Here is how you would design it the procedural way (not a real encryption, of course):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">File</span> <span class="n">target</span><span class="o">;</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span>
      <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">,</span>
      <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;[a-z]&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Works fine, but what will happen when you decide to extend it to also write to an <a href="https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html"><code>OutputStream</code></a>? How will you modify this class? How ugly will it look after that? That’s because the design is not object-oriented.</p><p>This is how you would do the same design, in an object-oriented way, with <a href="http://www.cactoos.org">Cactoos</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Output</span> <span class="n">target</span><span class="o">;</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">FileAsOutput</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">Output</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">output</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">LengthOfInput</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">TeeInput</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">BytesAsInput</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">TextAsBytes</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">StringAsText</span><span class="o">(</span>
              <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;[a-z]&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">),</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span>
      <span class="o">)</span>
    <span class="o">).</span><span class="na">value</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>What do we do with this design if we want <a href="https://docs.oracle.com/javase/7/docs/api/java/io/OutputStream.html"><code>OutputStream</code></a> to be accepted? We just add one <a href="/2015/05/28/one-primary-constructor.html">secondary</a> constructor:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">class</span> <span class="nc">Encoder</span> <span class="o">{</span>
  <span class="n">Encoder</span><span class="o">(</span><span class="kd">final</span> <span class="n">OutputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">OutputStreamAsOutput</span><span class="o">(</span><span class="n">stream</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Done. That’s how easy and elegant it is.</p><p>That’s because concepts are perfectly separated and functionality is encapsulated. In the procedural example the behavior of the object is located outside of it, in the method <code>encode()</code>. The file itself doesn’t know how to write, some outside procedure <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#write%28java.nio.file.Path,%20byte[],%20java.nio.file.OpenOption...%29"><code>Files.write()</code></a> knows that instead.</p><p>To the contrary, in the object-oriented design the <a href="http://static.javadoc.io/org.cactoos/cactoos/0.9/org/cactoos/io/FileAsOutput.html"><code>FileAsOutput</code></a> knows how to write, and nobody else does. The file writing functionality is encapsulated and this makes it possible to decorate the objects in any possible way, creating reusable and replaceable composite objects.</p><p>Do you see the beauty of OOP now?</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.sixnines.io&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/images/logo.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;Availability is a metric that demonstrates how often your website is available to its users. Technically, it’s a ratio between the number of successful attempts to open the website and the number of failed ones. If one out of a hundred attempts failed, we can say the availability is 99 percent. High-quality websites aim for so-called “six nines” &lt;a href=&quot;https://en.wikipedia.org/wiki/High_availability&quot;&gt;high availability&lt;/a&gt;, so named by the number of 9s in the ratio: 99.9999 percent. We created a service that helps you measure this metric and demonstrate its value to your users: &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Main picture&quot; src=&quot;/images/2017/04/sixnines.jpg&quot; /&gt;&lt;/figure&gt; &lt;p&gt;All you need to do is log in using your &lt;a href=&quot;https://www.github.com&quot;&gt;GitHub&lt;/a&gt; account and register your URI, which &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; will validate. This operation will cost you $4.95 (processed by &lt;a href=&quot;https://www.stripe.com&quot;&gt;Stripe&lt;/a&gt;). It’s a once-in-a-lifetime fee (if you don’t have any money, &lt;a href=&quot;mailto:free@sixnines.io&quot;&gt;email&lt;/a&gt; us and we’ll figure something out). As soon as your URI is in the system, we will monitor it &lt;a href=&quot;http://www.sixnines.io/terms&quot;&gt;forever&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;The key problem with the availability metric is that it takes &lt;em&gt;a lot&lt;/em&gt; of time in order to really guarantee a figure of “six nines.” Indeed, look at the ratio: 99.9999 percent means that only one attempt out of a &lt;em&gt;million&lt;/em&gt; fails (provided we make them regularly with equal intervals). In order to ping your website at least a million times, we would have to work for 694 days and ping every minute. This would take more than two years.&lt;/p&gt; &lt;p&gt;Only after those two years of 24-7 work would we be able to &lt;em&gt;prove&lt;/em&gt; that your website is of “high availability” and the value of the metric really is equal to 99.9999 percent (you would have all kinds of reasons to be proud of it).&lt;/p&gt; &lt;p&gt;You can see some big websites being checked by &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; already:&lt;/p&gt; &lt;p&gt;Google&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/4739&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/4739&quot; alt=&quot;Google at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Facebook&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/e203&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/e203&quot; alt=&quot;Facebook at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Twitter&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/cd52&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/cd52&quot; alt=&quot;Twitter at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Yahoo&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/63d1&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/63d1&quot; alt=&quot;Yahoo at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Instagram&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/bcba&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/bcba&quot; alt=&quot;Instagram at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;And this is my blog’s availability (it’s hosted on &lt;a href=&quot;https://pages.github.com/&quot;&gt;GitHub Pages&lt;/a&gt;):&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.sixnines.io/h/3ba1652f&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/3ba1652f&quot; alt=&quot;Yegor256 at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;As you see, their numbers are far from “six nines” because we just started to measure them. In two years, we will see what their real availability is.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; is written in Ruby and is open source, hosted in &lt;a href=&quot;https://github.com/yegor256/sixnines&quot;&gt;GitHub&lt;/a&gt;. Don’t hesitate to contribute.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, image, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2017-04-25 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="SixNines.io, Your Website Availability Monitor"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.sixnines.io&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/images/logo.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;Availability is a metric that demonstrates how often your website is available to its users. Technically, it’s a ratio between the number of successful attempts to open the website and the number of failed ones. If one out of a hundred attempts failed, we can say the availability is 99 percent. High-quality websites aim for so-called “six nines” &lt;a href=&quot;https://en.wikipedia.org/wiki/High_availability&quot;&gt;high availability&lt;/a&gt;, so named by the number of 9s in the ratio: 99.9999 percent. We created a service that helps you measure this metric and demonstrate its value to your users: &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Main picture&quot; src=&quot;/images/2017/04/sixnines.jpg&quot; /&gt;&lt;/figure&gt; &lt;p&gt;All you need to do is log in using your &lt;a href=&quot;https://www.github.com&quot;&gt;GitHub&lt;/a&gt; account and register your URI, which &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; will validate. This operation will cost you $4.95 (processed by &lt;a href=&quot;https://www.stripe.com&quot;&gt;Stripe&lt;/a&gt;). It’s a once-in-a-lifetime fee (if you don’t have any money, &lt;a href=&quot;mailto:free@sixnines.io&quot;&gt;email&lt;/a&gt; us and we’ll figure something out). As soon as your URI is in the system, we will monitor it &lt;a href=&quot;http://www.sixnines.io/terms&quot;&gt;forever&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;The key problem with the availability metric is that it takes &lt;em&gt;a lot&lt;/em&gt; of time in order to really guarantee a figure of “six nines.” Indeed, look at the ratio: 99.9999 percent means that only one attempt out of a &lt;em&gt;million&lt;/em&gt; fails (provided we make them regularly with equal intervals). In order to ping your website at least a million times, we would have to work for 694 days and ping every minute. This would take more than two years.&lt;/p&gt; &lt;p&gt;Only after those two years of 24-7 work would we be able to &lt;em&gt;prove&lt;/em&gt; that your website is of “high availability” and the value of the metric really is equal to 99.9999 percent (you would have all kinds of reasons to be proud of it).&lt;/p&gt; &lt;p&gt;You can see some big websites being checked by &lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; already:&lt;/p&gt; &lt;p&gt;Google&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/4739&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/4739&quot; alt=&quot;Google at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Facebook&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/e203&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/e203&quot; alt=&quot;Facebook at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Twitter&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/cd52&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/cd52&quot; alt=&quot;Twitter at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Yahoo&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/63d1&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/63d1&quot; alt=&quot;Yahoo at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Instagram&lt;br /&gt; &lt;a href=&quot;http://www.sixnines.io/h/bcba&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/bcba&quot; alt=&quot;Instagram at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;And this is my blog’s availability (it’s hosted on &lt;a href=&quot;https://pages.github.com/&quot;&gt;GitHub Pages&lt;/a&gt;):&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.sixnines.io/h/3ba1652f&quot;&gt;&lt;img src=&quot;http://www.sixnines.io/b/3ba1652f&quot; alt=&quot;Yegor256 at SixNines&quot; /&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;As you see, their numbers are far from “six nines” because we just started to measure them. In two years, we will see what their real availability is.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.sixnines.io&quot;&gt;SixNines&lt;/a&gt; is written in Ruby and is open source, hosted in &lt;a href=&quot;https://github.com/yegor256/sixnines&quot;&gt;GitHub&lt;/a&gt;. Don’t hesitate to contribute.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2017/04/25/sixnines.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2017/04/25/sixnines.html" /> <link rel="amphtml" href="https://www.yegor256.com/2017/04/25/sixnines.amp.html" /> <title>SixNines.io, Your Website Availability Monitor </title> <meta name='og:image' content='https://www.yegor256.com/images/2017/04/sixnines.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2017/04/sixnines.jpg'/><meta name='og:image:width' content='1280'/> <meta name='twitter:image:width' content='1280'/><meta name='og:image:height' content='973'/> <meta name='twitter:image:height' content='973'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Main picture'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2017/04/25/sixnines.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2017/04/25/sixnines.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2017/04/25/sixnines.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2017/04/25/sixnines.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2017/04/25/sixnines.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2017/04/25/sixnines.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2017/04/25/sixnines.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2017/04/25/sixnines.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2017/04/25/sixnines.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2017/04/25/sixnines.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2017/04/25/sixnines.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2017/04/25/sixnines.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/04/25/sixnines.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2017/04/25/sixnines.html</code></p><h1 itemprop="name headline mainEntityOfPage">SixNines.io, Your Website Availability Monitor</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2017-04-25T00:00:00+00:00"> 25 April 2017 </time> </li> <li class="desktop-only" itemprop="locationCreated">Moscow, Russia</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2017/04/25/sixnines.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.sixnines.io"><img src="http://www.sixnines.io/images/logo.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>Availability is a metric that demonstrates how often your website is available to its users. Technically, it’s a ratio between the number of successful attempts to open the website and the number of failed ones. If one out of a hundred attempts failed, we can say the availability is 99 percent. High-quality websites aim for so-called “six nines” <a href="https://en.wikipedia.org/wiki/High_availability">high availability</a>, so named by the number of 9s in the ratio: 99.9999 percent. We created a service that helps you measure this metric and demonstrate its value to your users: <a href="http://www.sixnines.io">SixNines</a>.</p><figure class="jb_picture"><img itemprop="image" alt="Main picture" src="/images/2017/04/sixnines.jpg" /></figure><p>All you need to do is log in using your <a href="https://www.github.com">GitHub</a> account and register your URI, which <a href="http://www.sixnines.io">SixNines</a> will validate. This operation will cost you $4.95 (processed by <a href="https://www.stripe.com">Stripe</a>). It’s a once-in-a-lifetime fee (if you don’t have any money, <a href="mailto:free@sixnines.io">email</a> us and we’ll figure something out). As soon as your URI is in the system, we will monitor it <a href="http://www.sixnines.io/terms">forever</a>.</p><p>The key problem with the availability metric is that it takes <em>a lot</em> of time in order to really guarantee a figure of “six nines.” Indeed, look at the ratio: 99.9999 percent means that only one attempt out of a <em>million</em> fails (provided we make them regularly with equal intervals). In order to ping your website at least a million times, we would have to work for 694 days and ping every minute. This would take more than two years.</p><p>Only after those two years of 24-7 work would we be able to <em>prove</em> that your website is of “high availability” and the value of the metric really is equal to 99.9999 percent (you would have all kinds of reasons to be proud of it).</p><p>You can see some big websites being checked by <a href="http://www.sixnines.io">SixNines</a> already:</p><p>Google<br /> <a href="http://www.sixnines.io/h/4739"><img src="http://www.sixnines.io/b/4739" alt="Google at SixNines" /></a></p><p>Facebook<br /> <a href="http://www.sixnines.io/h/e203"><img src="http://www.sixnines.io/b/e203" alt="Facebook at SixNines" /></a></p><p>Twitter<br /> <a href="http://www.sixnines.io/h/cd52"><img src="http://www.sixnines.io/b/cd52" alt="Twitter at SixNines" /></a></p><p>Yahoo<br /> <a href="http://www.sixnines.io/h/63d1"><img src="http://www.sixnines.io/b/63d1" alt="Yahoo at SixNines" /></a></p><p>Instagram<br /> <a href="http://www.sixnines.io/h/bcba"><img src="http://www.sixnines.io/b/bcba" alt="Instagram at SixNines" /></a></p><p>And this is my blog’s availability (it’s hosted on <a href="https://pages.github.com/">GitHub Pages</a>):</p><p><a href="http://www.sixnines.io/h/3ba1652f"><img src="http://www.sixnines.io/b/3ba1652f" alt="Yegor256 at SixNines" /></a></p><p>As you see, their numbers are far from “six nines” because we just started to measure them. In two years, we will see what their real availability is.</p><p><a href="http://www.sixnines.io">SixNines</a> is written in Ruby and is open source, hosted in <a href="https://github.com/yegor256/sixnines">GitHub</a>. Don’t hesitate to contribute.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/04/25/sixnines.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2017/04/25/sixnines.html&amp;text=SixNines.io%2C+Your+Website+Availability+Monitor" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2017/04/25/sixnines.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/04/25/sixnines.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2017/04/25/sixnines.html%3F2017-17&amp;title=SixNines.io%2C+Your+Website+Availability+Monitor" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/04/25/sixnines.html%3F2017-17&amp;t=SixNines.io%2C+Your+Website+Availability+Monitor" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.sixnines.io"><img src="http://www.sixnines.io/images/logo.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>Availability is a metric that demonstrates how often your website is available to its users. Technically, it’s a ratio between the number of successful attempts to open the website and the number of failed ones. If one out of a hundred attempts failed, we can say the availability is 99 percent. High-quality websites aim for so-called “six nines” <a href="https://en.wikipedia.org/wiki/High_availability">high availability</a>, so named by the number of 9s in the ratio: 99.9999 percent. We created a service that helps you measure this metric and demonstrate its value to your users: <a href="http://www.sixnines.io">SixNines</a>.</p><figure class="jb_picture"><img itemprop="image" alt="Main picture" src="/images/2017/04/sixnines.jpg" /></figure><p>All you need to do is log in using your <a href="https://www.github.com">GitHub</a> account and register your URI, which <a href="http://www.sixnines.io">SixNines</a> will validate. This operation will cost you $4.95 (processed by <a href="https://www.stripe.com">Stripe</a>). It’s a once-in-a-lifetime fee (if you don’t have any money, <a href="mailto:free@sixnines.io">email</a> us and we’ll figure something out). As soon as your URI is in the system, we will monitor it <a href="http://www.sixnines.io/terms">forever</a>.</p><p>The key problem with the availability metric is that it takes <em>a lot</em> of time in order to really guarantee a figure of “six nines.” Indeed, look at the ratio: 99.9999 percent means that only one attempt out of a <em>million</em> fails (provided we make them regularly with equal intervals). In order to ping your website at least a million times, we would have to work for 694 days and ping every minute. This would take more than two years.</p><p>Only after those two years of 24-7 work would we be able to <em>prove</em> that your website is of “high availability” and the value of the metric really is equal to 99.9999 percent (you would have all kinds of reasons to be proud of it).</p><p>You can see some big websites being checked by <a href="http://www.sixnines.io">SixNines</a> already:</p><p>Google<br /> <a href="http://www.sixnines.io/h/4739"><img src="http://www.sixnines.io/b/4739" alt="Google at SixNines" /></a></p><p>Facebook<br /> <a href="http://www.sixnines.io/h/e203"><img src="http://www.sixnines.io/b/e203" alt="Facebook at SixNines" /></a></p><p>Twitter<br /> <a href="http://www.sixnines.io/h/cd52"><img src="http://www.sixnines.io/b/cd52" alt="Twitter at SixNines" /></a></p><p>Yahoo<br /> <a href="http://www.sixnines.io/h/63d1"><img src="http://www.sixnines.io/b/63d1" alt="Yahoo at SixNines" /></a></p><p>Instagram<br /> <a href="http://www.sixnines.io/h/bcba"><img src="http://www.sixnines.io/b/bcba" alt="Instagram at SixNines" /></a></p><p>And this is my blog’s availability (it’s hosted on <a href="https://pages.github.com/">GitHub Pages</a>):</p><p><a href="http://www.sixnines.io/h/3ba1652f"><img src="http://www.sixnines.io/b/3ba1652f" alt="Yegor256 at SixNines" /></a></p><p>As you see, their numbers are far from “six nines” because we just started to measure them. In two years, we will see what their real availability is.</p><p><a href="http://www.sixnines.io">SixNines</a> is written in Ruby and is open source, hosted in <a href="https://github.com/yegor256/sixnines">GitHub</a>. Don’t hesitate to contribute.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.jare.io&quot;&gt;&lt;img src=&quot;http://www.jare.io/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;CDN stands for a Content Delivery Network. Technically, it is a bunch of servers located in different countries and continents. You give them your &lt;code&gt;logo.gif&lt;/code&gt; and they give you a URL, which resolves to a different server depending on who is trying to resolve it. As a result, the file is always close to the end-user and your website loads much faster than without a CDN. Sounds good, but all CDN providers want money for their service and usually a rather complex setup and registration procedure. My pet project &lt;a href=&quot;http://www.jare.io&quot;&gt;jare.io&lt;/a&gt; is a free CDN that is simple to configure. It utilizes AWS CloudFront resources.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let me show how it works and then, if you’re interested in the details, I will explain how it’s done internally. Say you have this HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;img&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//www.teamed.io/image/logo.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I want this &lt;code&gt;logo.svg&lt;/code&gt; to be delivered via a CDN. There are two steps. First, I register my domain at &lt;a href=&quot;http://www.jare.io&quot;&gt;jare.io&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/jare-1.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Second, I change my HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;img&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//cf.jare.io/?u=http://www.teamed.io/images/logo.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s it.&lt;/p&gt; &lt;p&gt;Try it with your own resources and you will see how much faster they will be loaded.&lt;/p&gt; &lt;p&gt;It’s absolutely free, but I ask you to be reasonable. If your traffic is huge, you need your own account in CloudFront or somewhere else. My service is for small projects.&lt;/p&gt; &lt;p&gt;Now for more technical details, if you want to know how technically this solution works. First, let’s discuss what CDN is and how it works.&lt;/p&gt; &lt;h2 id=&quot;url-dns-tcp-http&quot;&gt;URL, DNS, TCP, HTTP&lt;/h2&gt; &lt;p&gt;When your browser wants to load an image, it has a &lt;a href=&quot;https://en.wikipedia.org/wiki/Uniform_Resource_Locator&quot;&gt;URL&lt;/a&gt; for that, like in the example above. This is the URL: &lt;code&gt;http://www.teamed.io/image/logo.svg&lt;/code&gt;. There are three important parts in this address. First is &lt;code&gt;http&lt;/code&gt;, the &lt;a href=&quot;https://en.wikipedia.org/wiki/Communications_protocol&quot;&gt;protocol&lt;/a&gt;. Second is &lt;code&gt;www.teamed.io&lt;/code&gt;, the &lt;a href=&quot;https://en.wikipedia.org/wiki/Host_%28network%29&quot;&gt;host&lt;/a&gt; name, and the tail &lt;code&gt;/images/logo.svg&lt;/code&gt;, which is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax&quot;&gt;path&lt;/a&gt;. To load the image, the browser has to open a &lt;a href=&quot;https://en.wikipedia.org/wiki/Network_socket&quot;&gt;socket&lt;/a&gt;, connecting your computer and the server, which has the image. To open a socket, the browser needs to know the &lt;a href=&quot;https://en.wikipedia.org/wiki/IP_address&quot;&gt;IP address&lt;/a&gt; of the server.&lt;/p&gt; &lt;p&gt;There is no such address in that URL. In order to find the IP address, the browser is doing what is called a lookup. It connects to the nearest &lt;a href=&quot;https://en.wikipedia.org/wiki/Name_server&quot;&gt;name server&lt;/a&gt; and asks “what is the IP address of www.teamed.io?” The answer usually contains a single IP address:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup www.teamed.io Server: 172.16.0.1 Address: 172.16.0.1#53 Non-authoritative answer: www.teamed.io canonical name = teamed.github.io. teamed.github.io canonical name = github.map.fastly.net. Name: github.map.fastly.net Address: 199.27.79.133&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;IP address of &lt;code&gt;www.teamed.io&lt;/code&gt; is &lt;code&gt;199.27.79.133&lt;/code&gt;, at the time of writing.&lt;/p&gt; &lt;p&gt;When the address is known, the browser opens a new socket and sends an &lt;a href=&quot;https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_message&quot;&gt;HTTP request&lt;/a&gt; through it:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET /images/logo.svg HTTP/1.1 Host: www.teamed.io Accept: image/*&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server responds with an &lt;a href=&quot;https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Response_message&quot;&gt;HTTP response&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 200 OK Content-Type: image/svg+xml [SVG image content goes here, over 1000 bytes]&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Scalable_Vector_Graphics&quot;&gt;SVG&lt;/a&gt; image we’re looking for. The browser renders it on the web page and that’s it.&lt;/p&gt; &lt;h2 id=&quot;the-network-of-edge-servers&quot;&gt;The Network of Edge Servers&lt;/h2&gt; &lt;p&gt;So far so good, but if the distance between your browser and that IP address is rather large, loading the image will take a lot of time. Well, hundreds of milliseconds. Try to load this image, which is located on a server that is hosted in Prague, Czech Republic (I’m using &lt;code&gt;curl&lt;/code&gt; as suggested &lt;a href=&quot;https://josephscott.org/archives/2011/10/timing-details-with-curl/&quot;&gt;here&lt;/a&gt;):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ curl -w &amp;quot;@f.txt&amp;quot; -o /dev/null -s \ http://www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif time_namelookup: 0.005 time_connect: 0.376 time_pretransfer: 0.377 time_starttransfer: 0.566 ---------- time_total: 0.567&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I’m trying to do it from Palo Alto, California, which is about half a globe away from Prague. As you can see, it takes over 500ms. That’s too much, especially if a web page contains many images. Overall, page loading may take seconds, just because the server is too far away from me. Well, it will inevitably be too far away from some users, no matter where we host it. If we host it here in California, it will be close enough to me and the image will be loaded instantly (less than 50ms). But then it will be too slow for users in Prague.&lt;/p&gt; &lt;p&gt;This problem has no solutions if the server generates images or pages on the fly in some unique way and if we can’t install a number of servers in different countries and continents. But in most cases, such as our logo example, this is not a problem. This logo doesn’t need to be unique for each user. It is a very &lt;em&gt;static&lt;/em&gt; resource, which needs to be created only once and be delivered to everybody, without any changes.&lt;/p&gt; &lt;p&gt;So, how about we install a server somewhere here in California and let Californian users connect to it. When a request for &lt;code&gt;logo.gif&lt;/code&gt; comes to one of the &lt;em&gt;edge&lt;/em&gt; servers, it will connect to the central server in Prague and load the file. This will happen only once. After that, the edge server will not request the file from the central server. It will return it immediately, from its internal cache.&lt;/p&gt; &lt;p&gt;We need to have many edge servers, preferably in all countries where our users may be located. The first request will take longer, but all others will be much faster because they will be served from the closest edge server.&lt;/p&gt; &lt;p&gt;Now, the question is how the browser will know which edge server is the closest, right? We simply trick the domain name resolution process. Depending on who is asking, the DNS will give different answers. Let’s take &lt;code&gt;cf.jare.io&lt;/code&gt;, for example (it is the name of all edge servers responsible for delivering our content in AWS CloudFront, a CNAME for &lt;code&gt;djk1be5eatcae.cloudfront.net&lt;/code&gt;). If I’m looking it up from California, I’m getting the following answer:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup cf.jare.io Server: 192.168.1.1 Address: 192.168.1.1#53 Non-authoritative answer: cf.jare.io canonical name = djk1be5eatcae.cloudfront.net. Name: djk1be5eatcae.cloudfront.net Address: 54.230.141.211&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;An edge server with IP address &lt;code&gt;54.230.141.211&lt;/code&gt; is located in &lt;a href=&quot;https://db-ip.com/54.230.141.211&quot;&gt;San Francisco&lt;/a&gt;. This is rather close to me, less than fifty miles. If I do the same operation from a server in Virginia, I get a different response:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup cf.jare.io Server: 172.16.0.23 Address: 172.16.0.23#53 Non-authoritative answer: cf.jare.io canonical name = djk1be5eatcae.cloudfront.net. Name: djk1be5eatcae.cloudfront.net Address: 52.85.131.217&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;An edge server with IP address &lt;code&gt;52.85.131.217&lt;/code&gt; is located in &lt;a href=&quot;https://db-ip.com/52.85.131.217&quot;&gt;Washington&lt;/a&gt;, which is far away from me, but very close to the server I was making the lookup from.&lt;/p&gt; &lt;p&gt;There are thousands of name servers around the world and all of them have different information about where that edge server &lt;code&gt;cf.jare.io&lt;/code&gt; is physically located. Depending on who is asking, the answer will be different.&lt;/p&gt; &lt;h2 id=&quot;aws-cloudfront&quot;&gt;AWS CloudFront&lt;/h2&gt; &lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/cloudfront/&quot;&gt;CloudFront&lt;/a&gt; is one of the simplest CDN solutions. All you have to do to start delivering your content through their edge nodes is to create a “distribution” and configure it. A distribution is basically a connector between content origin and edge servers:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;/uml/b5d40b6498ca48f6d2efc8671dd6d1e6.svg&quot; style=&quot;width:75%&quot; alt=&quot;PlantUML SVG diagram&quot; class=&quot;plantuml&quot; /&gt;&lt;/p&gt; &lt;p&gt;One of edge servers receives an HTTP request. If it already has that &lt;code&gt;logo.svg&lt;/code&gt; in its cache, it immediately returns an HTTP response with its content inside. If its cache is empty, the edge server makes an HTTP request to the central server. This server knows about the “distribution” and its configuration. It makes an HTTP connection to the origin server, which is &lt;code&gt;www.teamed.io&lt;/code&gt; and asks it to return &lt;code&gt;logo.svg&lt;/code&gt;. When done, the image is returned to the edge server, where it is cached.&lt;/p&gt; &lt;p&gt;This looks rather simple, but it’s not free and it’s not that quick to configure. You have to create an account with CloudFront, register your credit card there, and get an approval. Then you have to create a distribution and configure it. You should then create that CNAME in your name server. If you’re doing it for a single website, it’s not a big deal. If you have a dozen websites, it’s a time consuming operation.&lt;/p&gt; &lt;h2 id=&quot;jareio-a-middle-man&quot;&gt;Jare.io, a Middle Man&lt;/h2&gt; &lt;p&gt;Jare.io is an extra component in that diagram, which makes your life easier:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;/uml/aecf8b3862f82e6d5d8d27e948d45c83.svg&quot; style=&quot;width:75%&quot; alt=&quot;PlantUML SVG diagram&quot; class=&quot;plantuml&quot; /&gt;&lt;/p&gt; &lt;p&gt;Jare.io has a “relay,” which acts as an origin server for CloudFront. All requests that arrive to &lt;code&gt;cf.jare.io&lt;/code&gt; are dispatched to the relay. The relay decides what to do with them. The decision is based on the information from the HTTP request URI. For example, the request from the browser has this URI path:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;/?u=http://www.teamed.io/images/logo.svg&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Remember, the request is made to &lt;code&gt;cf.jare.io&lt;/code&gt;, which is the address of the edge server. This exact URI arrives at &lt;code&gt;relay.jare.io&lt;/code&gt;. The URI contains enough information to make a decision about which file has to be returned. The relay makes a new HTTP request to &lt;code&gt;www.teamed.io&lt;/code&gt; and retrieves the image.&lt;/p&gt; &lt;p&gt;The beauty of this solution is that it’s easy. For small websites, it is a free and quick CDN.&lt;/p&gt; &lt;p&gt;By the way, when we query the same image through jare.io (and CloudFront), it comes back much faster:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ curl -w &amp;quot;@f.txt&amp;quot; -o /dev/null -s \ http://cf.jare.io/?u=www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif time_namelookup: 0.005 time_connect: 0.021 time_pretransfer: 0.021 time_starttransfer: 0.041 ---------- time_total: 0.041&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Most of the work is done by AWS CloudFront, while jare.io is just a relay that makes its configuration more convenient. Besides, it makes it free, because jare.io is sponsored by &lt;a href=&quot;https://www.zerocracy.com&quot;&gt;Zerocracy&lt;/a&gt;. In other words, my company will pay for your usage of CloudFront. I would appreciate if you kept that in mind and didn’t use jare.io for traffic-intensive resources.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, social, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2016-03-30 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Jare.io, an Instant and Free CDN"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.jare.io&quot;&gt;&lt;img src=&quot;http://www.jare.io/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;CDN stands for a Content Delivery Network. Technically, it is a bunch of servers located in different countries and continents. You give them your &lt;code&gt;logo.gif&lt;/code&gt; and they give you a URL, which resolves to a different server depending on who is trying to resolve it. As a result, the file is always close to the end-user and your website loads much faster than without a CDN. Sounds good, but all CDN providers want money for their service and usually a rather complex setup and registration procedure. My pet project &lt;a href=&quot;http://www.jare.io&quot;&gt;jare.io&lt;/a&gt; is a free CDN that is simple to configure. It utilizes AWS CloudFront resources.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let me show how it works and then, if you’re interested in the details, I will explain how it’s done internally. Say you have this HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;img&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//www.teamed.io/image/logo.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I want this &lt;code&gt;logo.svg&lt;/code&gt; to be delivered via a CDN. There are two steps. First, I register my domain at &lt;a href=&quot;http://www.jare.io&quot;&gt;jare.io&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/jare-1.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Second, I change my HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;img&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//cf.jare.io/?u=http://www.teamed.io/images/logo.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s it.&lt;/p&gt; &lt;p&gt;Try it with your own resources and you will see how much faster they will be loaded.&lt;/p&gt; &lt;p&gt;It’s absolutely free, but I ask you to be reasonable. If your traffic is huge, you need your own account in CloudFront or somewhere else. My service is for small projects.&lt;/p&gt; &lt;p&gt;Now for more technical details, if you want to know how technically this solution works. First, let’s discuss what CDN is and how it works.&lt;/p&gt; &lt;h2 id=&quot;url-dns-tcp-http&quot;&gt;URL, DNS, TCP, HTTP&lt;/h2&gt; &lt;p&gt;When your browser wants to load an image, it has a &lt;a href=&quot;https://en.wikipedia.org/wiki/Uniform_Resource_Locator&quot;&gt;URL&lt;/a&gt; for that, like in the example above. This is the URL: &lt;code&gt;http://www.teamed.io/image/logo.svg&lt;/code&gt;. There are three important parts in this address. First is &lt;code&gt;http&lt;/code&gt;, the &lt;a href=&quot;https://en.wikipedia.org/wiki/Communications_protocol&quot;&gt;protocol&lt;/a&gt;. Second is &lt;code&gt;www.teamed.io&lt;/code&gt;, the &lt;a href=&quot;https://en.wikipedia.org/wiki/Host_%28network%29&quot;&gt;host&lt;/a&gt; name, and the tail &lt;code&gt;/images/logo.svg&lt;/code&gt;, which is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax&quot;&gt;path&lt;/a&gt;. To load the image, the browser has to open a &lt;a href=&quot;https://en.wikipedia.org/wiki/Network_socket&quot;&gt;socket&lt;/a&gt;, connecting your computer and the server, which has the image. To open a socket, the browser needs to know the &lt;a href=&quot;https://en.wikipedia.org/wiki/IP_address&quot;&gt;IP address&lt;/a&gt; of the server.&lt;/p&gt; &lt;p&gt;There is no such address in that URL. In order to find the IP address, the browser is doing what is called a lookup. It connects to the nearest &lt;a href=&quot;https://en.wikipedia.org/wiki/Name_server&quot;&gt;name server&lt;/a&gt; and asks “what is the IP address of www.teamed.io?” The answer usually contains a single IP address:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup www.teamed.io Server: 172.16.0.1 Address: 172.16.0.1#53 Non-authoritative answer: www.teamed.io canonical name = teamed.github.io. teamed.github.io canonical name = github.map.fastly.net. Name: github.map.fastly.net Address: 199.27.79.133&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;IP address of &lt;code&gt;www.teamed.io&lt;/code&gt; is &lt;code&gt;199.27.79.133&lt;/code&gt;, at the time of writing.&lt;/p&gt; &lt;p&gt;When the address is known, the browser opens a new socket and sends an &lt;a href=&quot;https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_message&quot;&gt;HTTP request&lt;/a&gt; through it:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET /images/logo.svg HTTP/1.1 Host: www.teamed.io Accept: image/*&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server responds with an &lt;a href=&quot;https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Response_message&quot;&gt;HTTP response&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 200 OK Content-Type: image/svg+xml [SVG image content goes here, over 1000 bytes]&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Scalable_Vector_Graphics&quot;&gt;SVG&lt;/a&gt; image we’re looking for. The browser renders it on the web page and that’s it.&lt;/p&gt; &lt;h2 id=&quot;the-network-of-edge-servers&quot;&gt;The Network of Edge Servers&lt;/h2&gt; &lt;p&gt;So far so good, but if the distance between your browser and that IP address is rather large, loading the image will take a lot of time. Well, hundreds of milliseconds. Try to load this image, which is located on a server that is hosted in Prague, Czech Republic (I’m using &lt;code&gt;curl&lt;/code&gt; as suggested &lt;a href=&quot;https://josephscott.org/archives/2011/10/timing-details-with-curl/&quot;&gt;here&lt;/a&gt;):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ curl -w &amp;quot;@f.txt&amp;quot; -o /dev/null -s \ http://www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif time_namelookup: 0.005 time_connect: 0.376 time_pretransfer: 0.377 time_starttransfer: 0.566 ---------- time_total: 0.567&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I’m trying to do it from Palo Alto, California, which is about half a globe away from Prague. As you can see, it takes over 500ms. That’s too much, especially if a web page contains many images. Overall, page loading may take seconds, just because the server is too far away from me. Well, it will inevitably be too far away from some users, no matter where we host it. If we host it here in California, it will be close enough to me and the image will be loaded instantly (less than 50ms). But then it will be too slow for users in Prague.&lt;/p&gt; &lt;p&gt;This problem has no solutions if the server generates images or pages on the fly in some unique way and if we can’t install a number of servers in different countries and continents. But in most cases, such as our logo example, this is not a problem. This logo doesn’t need to be unique for each user. It is a very &lt;em&gt;static&lt;/em&gt; resource, which needs to be created only once and be delivered to everybody, without any changes.&lt;/p&gt; &lt;p&gt;So, how about we install a server somewhere here in California and let Californian users connect to it. When a request for &lt;code&gt;logo.gif&lt;/code&gt; comes to one of the &lt;em&gt;edge&lt;/em&gt; servers, it will connect to the central server in Prague and load the file. This will happen only once. After that, the edge server will not request the file from the central server. It will return it immediately, from its internal cache.&lt;/p&gt; &lt;p&gt;We need to have many edge servers, preferably in all countries where our users may be located. The first request will take longer, but all others will be much faster because they will be served from the closest edge server.&lt;/p&gt; &lt;p&gt;Now, the question is how the browser will know which edge server is the closest, right? We simply trick the domain name resolution process. Depending on who is asking, the DNS will give different answers. Let’s take &lt;code&gt;cf.jare.io&lt;/code&gt;, for example (it is the name of all edge servers responsible for delivering our content in AWS CloudFront, a CNAME for &lt;code&gt;djk1be5eatcae.cloudfront.net&lt;/code&gt;). If I’m looking it up from California, I’m getting the following answer:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup cf.jare.io Server: 192.168.1.1 Address: 192.168.1.1#53 Non-authoritative answer: cf.jare.io canonical name = djk1be5eatcae.cloudfront.net. Name: djk1be5eatcae.cloudfront.net Address: 54.230.141.211&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;An edge server with IP address &lt;code&gt;54.230.141.211&lt;/code&gt; is located in &lt;a href=&quot;https://db-ip.com/54.230.141.211&quot;&gt;San Francisco&lt;/a&gt;. This is rather close to me, less than fifty miles. If I do the same operation from a server in Virginia, I get a different response:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ nslookup cf.jare.io Server: 172.16.0.23 Address: 172.16.0.23#53 Non-authoritative answer: cf.jare.io canonical name = djk1be5eatcae.cloudfront.net. Name: djk1be5eatcae.cloudfront.net Address: 52.85.131.217&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;An edge server with IP address &lt;code&gt;52.85.131.217&lt;/code&gt; is located in &lt;a href=&quot;https://db-ip.com/52.85.131.217&quot;&gt;Washington&lt;/a&gt;, which is far away from me, but very close to the server I was making the lookup from.&lt;/p&gt; &lt;p&gt;There are thousands of name servers around the world and all of them have different information about where that edge server &lt;code&gt;cf.jare.io&lt;/code&gt; is physically located. Depending on who is asking, the answer will be different.&lt;/p&gt; &lt;h2 id=&quot;aws-cloudfront&quot;&gt;AWS CloudFront&lt;/h2&gt; &lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/cloudfront/&quot;&gt;CloudFront&lt;/a&gt; is one of the simplest CDN solutions. All you have to do to start delivering your content through their edge nodes is to create a “distribution” and configure it. A distribution is basically a connector between content origin and edge servers:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;/uml/b5d40b6498ca48f6d2efc8671dd6d1e6.svg&quot; style=&quot;width:75%&quot; alt=&quot;PlantUML SVG diagram&quot; class=&quot;plantuml&quot; /&gt;&lt;/p&gt; &lt;p&gt;One of edge servers receives an HTTP request. If it already has that &lt;code&gt;logo.svg&lt;/code&gt; in its cache, it immediately returns an HTTP response with its content inside. If its cache is empty, the edge server makes an HTTP request to the central server. This server knows about the “distribution” and its configuration. It makes an HTTP connection to the origin server, which is &lt;code&gt;www.teamed.io&lt;/code&gt; and asks it to return &lt;code&gt;logo.svg&lt;/code&gt;. When done, the image is returned to the edge server, where it is cached.&lt;/p&gt; &lt;p&gt;This looks rather simple, but it’s not free and it’s not that quick to configure. You have to create an account with CloudFront, register your credit card there, and get an approval. Then you have to create a distribution and configure it. You should then create that CNAME in your name server. If you’re doing it for a single website, it’s not a big deal. If you have a dozen websites, it’s a time consuming operation.&lt;/p&gt; &lt;h2 id=&quot;jareio-a-middle-man&quot;&gt;Jare.io, a Middle Man&lt;/h2&gt; &lt;p&gt;Jare.io is an extra component in that diagram, which makes your life easier:&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;/uml/aecf8b3862f82e6d5d8d27e948d45c83.svg&quot; style=&quot;width:75%&quot; alt=&quot;PlantUML SVG diagram&quot; class=&quot;plantuml&quot; /&gt;&lt;/p&gt; &lt;p&gt;Jare.io has a “relay,” which acts as an origin server for CloudFront. All requests that arrive to &lt;code&gt;cf.jare.io&lt;/code&gt; are dispatched to the relay. The relay decides what to do with them. The decision is based on the information from the HTTP request URI. For example, the request from the browser has this URI path:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;/?u=http://www.teamed.io/images/logo.svg&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Remember, the request is made to &lt;code&gt;cf.jare.io&lt;/code&gt;, which is the address of the edge server. This exact URI arrives at &lt;code&gt;relay.jare.io&lt;/code&gt;. The URI contains enough information to make a decision about which file has to be returned. The relay makes a new HTTP request to &lt;code&gt;www.teamed.io&lt;/code&gt; and retrieves the image.&lt;/p&gt; &lt;p&gt;The beauty of this solution is that it’s easy. For small websites, it is a free and quick CDN.&lt;/p&gt; &lt;p&gt;By the way, when we query the same image through jare.io (and CloudFront), it comes back much faster:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;$ curl -w &amp;quot;@f.txt&amp;quot; -o /dev/null -s \ http://cf.jare.io/?u=www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif time_namelookup: 0.005 time_connect: 0.021 time_pretransfer: 0.021 time_starttransfer: 0.041 ---------- time_total: 0.041&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Most of the work is done by AWS CloudFront, while jare.io is just a relay that makes its configuration more convenient. Besides, it makes it free, because jare.io is sponsored by &lt;a href=&quot;https://www.zerocracy.com&quot;&gt;Zerocracy&lt;/a&gt;. In other words, my company will pay for your usage of CloudFront. I would appreciate if you kept that in mind and didn’t use jare.io for traffic-intensive resources.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html" /> <link rel="amphtml" href="https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.amp.html" /> <title>Jare.io, an Instant and Free CDN </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2016/03/30/jare-instant-free-cdn.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2016/03/30/jare-instant-free-cdn.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html</code></p><h1 itemprop="name headline mainEntityOfPage">Jare.io, an Instant and Free CDN</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2016-03-30T00:00:00+00:00"> 30 March 2016 </time> </li> <li class="desktop-only" itemprop="locationCreated">Palo Alto, CA</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><ul class="subline"> <li>Discussed at:</li> <li><a href="https://news.ycombinator.com/item?id=11394981">hackernews</a></li></ul><p class="unprintable"><figure class="badge"><a href="http://www.jare.io"><img src="http://www.jare.io/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>CDN stands for a Content Delivery Network. Technically, it is a bunch of servers located in different countries and continents. You give them your <code>logo.gif</code> and they give you a URL, which resolves to a different server depending on who is trying to resolve it. As a result, the file is always close to the end-user and your website loads much faster than without a CDN. Sounds good, but all CDN providers want money for their service and usually a rather complex setup and registration procedure. My pet project <a href="http://www.jare.io">jare.io</a> is a free CDN that is simple to configure. It utilizes AWS CloudFront resources.</p><p>First, let me show how it works and then, if you’re interested in the details, I will explain how it’s done internally. Say you have this HTML:</p><figure class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//www.teamed.io/image/logo.svg&quot;</span><span class="p">/&gt;</span></code></pre></figure><p>I want this <code>logo.svg</code> to be delivered via a CDN. There are two steps. First, I register my domain at <a href="http://www.jare.io">jare.io</a>:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/jare-1.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Second, I change my HTML:</p><figure class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//cf.jare.io/?u=http://www.teamed.io/images/logo.svg&quot;</span><span class="p">/&gt;</span></code></pre></figure><p>That’s it.</p><p>Try it with your own resources and you will see how much faster they will be loaded.</p><p>It’s absolutely free, but I ask you to be reasonable. If your traffic is huge, you need your own account in CloudFront or somewhere else. My service is for small projects.</p><p>Now for more technical details, if you want to know how technically this solution works. First, let’s discuss what CDN is and how it works.</p><h2 id="url-dns-tcp-http">URL, DNS, TCP, HTTP</h2><p>When your browser wants to load an image, it has a <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Locator">URL</a> for that, like in the example above. This is the URL: <code>http://www.teamed.io/image/logo.svg</code>. There are three important parts in this address. First is <code>http</code>, the <a href="https://en.wikipedia.org/wiki/Communications_protocol">protocol</a>. Second is <code>www.teamed.io</code>, the <a href="https://en.wikipedia.org/wiki/Host_%28network%29">host</a> name, and the tail <code>/images/logo.svg</code>, which is the <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax">path</a>. To load the image, the browser has to open a <a href="https://en.wikipedia.org/wiki/Network_socket">socket</a>, connecting your computer and the server, which has the image. To open a socket, the browser needs to know the <a href="https://en.wikipedia.org/wiki/IP_address">IP address</a> of the server.</p><p>There is no such address in that URL. In order to find the IP address, the browser is doing what is called a lookup. It connects to the nearest <a href="https://en.wikipedia.org/wiki/Name_server">name server</a> and asks “what is the IP address of www.teamed.io?” The answer usually contains a single IP address:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup www.teamed.io
Server:   172.16.0.1
Address:  172.16.0.1#53

Non-authoritative answer:
www.teamed.io canonical name = teamed.github.io.
teamed.github.io  canonical name = github.map.fastly.net.
Name: github.map.fastly.net
Address: 199.27.79.133</code></pre></figure><p>IP address of <code>www.teamed.io</code> is <code>199.27.79.133</code>, at the time of writing.</p><p>When the address is known, the browser opens a new socket and sends an <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_message">HTTP request</a> through it:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET /images/logo.svg HTTP/1.1
Host: www.teamed.io
Accept: image/*</code></pre></figure><p>The server responds with an <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Response_message">HTTP response</a>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 200 OK
Content-Type: image/svg+xml

[SVG image content goes here, over 1000 bytes]</code></pre></figure><p>That is the <a href="https://en.wikipedia.org/wiki/Scalable_Vector_Graphics">SVG</a> image we’re looking for. The browser renders it on the web page and that’s it.</p><h2 id="the-network-of-edge-servers">The Network of Edge Servers</h2><p>So far so good, but if the distance between your browser and that IP address is rather large, loading the image will take a lot of time. Well, hundreds of milliseconds. Try to load this image, which is located on a server that is hosted in Prague, Czech Republic (I’m using <code>curl</code> as suggested <a href="https://josephscott.org/archives/2011/10/timing-details-with-curl/">here</a>):</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ curl -w &quot;@f.txt&quot; -o /dev/null -s \
  http://www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif
    time_namelookup:  0.005
       time_connect:  0.376
   time_pretransfer:  0.377
 time_starttransfer:  0.566
                    ----------
         time_total:  0.567</code></pre></figure><p>I’m trying to do it from Palo Alto, California, which is about half a globe away from Prague. As you can see, it takes over 500ms. That’s too much, especially if a web page contains many images. Overall, page loading may take seconds, just because the server is too far away from me. Well, it will inevitably be too far away from some users, no matter where we host it. If we host it here in California, it will be close enough to me and the image will be loaded instantly (less than 50ms). But then it will be too slow for users in Prague.</p><p>This problem has no solutions if the server generates images or pages on the fly in some unique way and if we can’t install a number of servers in different countries and continents. But in most cases, such as our logo example, this is not a problem. This logo doesn’t need to be unique for each user. It is a very <em>static</em> resource, which needs to be created only once and be delivered to everybody, without any changes.</p><p>So, how about we install a server somewhere here in California and let Californian users connect to it. When a request for <code>logo.gif</code> comes to one of the <em>edge</em> servers, it will connect to the central server in Prague and load the file. This will happen only once. After that, the edge server will not request the file from the central server. It will return it immediately, from its internal cache.</p><p>We need to have many edge servers, preferably in all countries where our users may be located. The first request will take longer, but all others will be much faster because they will be served from the closest edge server.</p><p>Now, the question is how the browser will know which edge server is the closest, right? We simply trick the domain name resolution process. Depending on who is asking, the DNS will give different answers. Let’s take <code>cf.jare.io</code>, for example (it is the name of all edge servers responsible for delivering our content in AWS CloudFront, a CNAME for <code>djk1be5eatcae.cloudfront.net</code>). If I’m looking it up from California, I’m getting the following answer:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup cf.jare.io
Server:   192.168.1.1
Address:  192.168.1.1#53

Non-authoritative answer:
cf.jare.io  canonical name = djk1be5eatcae.cloudfront.net.
Name: djk1be5eatcae.cloudfront.net
Address: 54.230.141.211</code></pre></figure><p>An edge server with IP address <code>54.230.141.211</code> is located in <a href="https://db-ip.com/54.230.141.211">San Francisco</a>. This is rather close to me, less than fifty miles. If I do the same operation from a server in Virginia, I get a different response:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup cf.jare.io
Server:   172.16.0.23
Address:  172.16.0.23#53

Non-authoritative answer:
cf.jare.io  canonical name = djk1be5eatcae.cloudfront.net.
Name: djk1be5eatcae.cloudfront.net
Address: 52.85.131.217</code></pre></figure><p>An edge server with IP address <code>52.85.131.217</code> is located in <a href="https://db-ip.com/52.85.131.217">Washington</a>, which is far away from me, but very close to the server I was making the lookup from.</p><p>There are thousands of name servers around the world and all of them have different information about where that edge server <code>cf.jare.io</code> is physically located. Depending on who is asking, the answer will be different.</p><h2 id="aws-cloudfront">AWS CloudFront</h2><p><a href="https://aws.amazon.com/cloudfront/">CloudFront</a> is one of the simplest CDN solutions. All you have to do to start delivering your content through their edge nodes is to create a “distribution” and configure it. A distribution is basically a connector between content origin and edge servers:</p><p><img src="/uml/b5d40b6498ca48f6d2efc8671dd6d1e6.svg" style="width:75%" alt="PlantUML SVG diagram" class="plantuml" /></p><p>One of edge servers receives an HTTP request. If it already has that <code>logo.svg</code> in its cache, it immediately returns an HTTP response with its content inside. If its cache is empty, the edge server makes an HTTP request to the central server. This server knows about the “distribution” and its configuration. It makes an HTTP connection to the origin server, which is <code>www.teamed.io</code> and asks it to return <code>logo.svg</code>. When done, the image is returned to the edge server, where it is cached.</p><p>This looks rather simple, but it’s not free and it’s not that quick to configure. You have to create an account with CloudFront, register your credit card there, and get an approval. Then you have to create a distribution and configure it. You should then create that CNAME in your name server. If you’re doing it for a single website, it’s not a big deal. If you have a dozen websites, it’s a time consuming operation.</p><h2 id="jareio-a-middle-man">Jare.io, a Middle Man</h2><p>Jare.io is an extra component in that diagram, which makes your life easier:</p><p><img src="/uml/aecf8b3862f82e6d5d8d27e948d45c83.svg" style="width:75%" alt="PlantUML SVG diagram" class="plantuml" /></p><p>Jare.io has a “relay,” which acts as an origin server for CloudFront. All requests that arrive to <code>cf.jare.io</code> are dispatched to the relay. The relay decides what to do with them. The decision is based on the information from the HTTP request URI. For example, the request from the browser has this URI path:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>/?u=http://www.teamed.io/images/logo.svg</code></pre></figure><p>Remember, the request is made to <code>cf.jare.io</code>, which is the address of the edge server. This exact URI arrives at <code>relay.jare.io</code>. The URI contains enough information to make a decision about which file has to be returned. The relay makes a new HTTP request to <code>www.teamed.io</code> and retrieves the image.</p><p>The beauty of this solution is that it’s easy. For small websites, it is a free and quick CDN.</p><p>By the way, when we query the same image through jare.io (and CloudFront), it comes back much faster:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ curl -w &quot;@f.txt&quot; -o /dev/null -s \
  http://cf.jare.io/?u=www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif
    time_namelookup:  0.005
       time_connect:  0.021
   time_pretransfer:  0.021
 time_starttransfer:  0.041
                    ----------
         time_total:  0.041</code></pre></figure><p>Most of the work is done by AWS CloudFront, while jare.io is just a relay that makes its configuration more convenient. Besides, it makes it free, because jare.io is sponsored by <a href="https://www.zerocracy.com">Zerocracy</a>. In other words, my company will pay for your usage of CloudFront. I would appreciate if you kept that in mind and didn’t use jare.io for traffic-intensive resources.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html&amp;text=Jare.io%2C+an+Instant+and+Free+CDN" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html%3F2016-13&amp;title=Jare.io%2C+an+Instant+and+Free+CDN" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2016/03/30/jare-instant-free-cdn.html%3F2016-13&amp;t=Jare.io%2C+an+Instant+and+Free+CDN" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.jare.io"><img src="http://www.jare.io/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>CDN stands for a Content Delivery Network. Technically, it is a bunch of servers located in different countries and continents. You give them your <code>logo.gif</code> and they give you a URL, which resolves to a different server depending on who is trying to resolve it. As a result, the file is always close to the end-user and your website loads much faster than without a CDN. Sounds good, but all CDN providers want money for their service and usually a rather complex setup and registration procedure. My pet project <a href="http://www.jare.io">jare.io</a> is a free CDN that is simple to configure. It utilizes AWS CloudFront resources.</p><p>First, let me show how it works and then, if you’re interested in the details, I will explain how it’s done internally. Say you have this HTML:</p><figure class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//www.teamed.io/image/logo.svg&quot;</span><span class="p">/&gt;</span></code></pre></figure><p>I want this <code>logo.svg</code> to be delivered via a CDN. There are two steps. First, I register my domain at <a href="http://www.jare.io">jare.io</a>:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/jare-1.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Second, I change my HTML:</p><figure class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//cf.jare.io/?u=http://www.teamed.io/images/logo.svg&quot;</span><span class="p">/&gt;</span></code></pre></figure><p>That’s it.</p><p>Try it with your own resources and you will see how much faster they will be loaded.</p><p>It’s absolutely free, but I ask you to be reasonable. If your traffic is huge, you need your own account in CloudFront or somewhere else. My service is for small projects.</p><p>Now for more technical details, if you want to know how technically this solution works. First, let’s discuss what CDN is and how it works.</p><h2 id="url-dns-tcp-http">URL, DNS, TCP, HTTP</h2><p>When your browser wants to load an image, it has a <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Locator">URL</a> for that, like in the example above. This is the URL: <code>http://www.teamed.io/image/logo.svg</code>. There are three important parts in this address. First is <code>http</code>, the <a href="https://en.wikipedia.org/wiki/Communications_protocol">protocol</a>. Second is <code>www.teamed.io</code>, the <a href="https://en.wikipedia.org/wiki/Host_%28network%29">host</a> name, and the tail <code>/images/logo.svg</code>, which is the <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax">path</a>. To load the image, the browser has to open a <a href="https://en.wikipedia.org/wiki/Network_socket">socket</a>, connecting your computer and the server, which has the image. To open a socket, the browser needs to know the <a href="https://en.wikipedia.org/wiki/IP_address">IP address</a> of the server.</p><p>There is no such address in that URL. In order to find the IP address, the browser is doing what is called a lookup. It connects to the nearest <a href="https://en.wikipedia.org/wiki/Name_server">name server</a> and asks “what is the IP address of www.teamed.io?” The answer usually contains a single IP address:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup www.teamed.io
Server:   172.16.0.1
Address:  172.16.0.1#53

Non-authoritative answer:
www.teamed.io canonical name = teamed.github.io.
teamed.github.io  canonical name = github.map.fastly.net.
Name: github.map.fastly.net
Address: 199.27.79.133</code></pre></figure><p>IP address of <code>www.teamed.io</code> is <code>199.27.79.133</code>, at the time of writing.</p><p>When the address is known, the browser opens a new socket and sends an <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_message">HTTP request</a> through it:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET /images/logo.svg HTTP/1.1
Host: www.teamed.io
Accept: image/*</code></pre></figure><p>The server responds with an <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Response_message">HTTP response</a>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 200 OK
Content-Type: image/svg+xml

[SVG image content goes here, over 1000 bytes]</code></pre></figure><p>That is the <a href="https://en.wikipedia.org/wiki/Scalable_Vector_Graphics">SVG</a> image we’re looking for. The browser renders it on the web page and that’s it.</p><h2 id="the-network-of-edge-servers">The Network of Edge Servers</h2><p>So far so good, but if the distance between your browser and that IP address is rather large, loading the image will take a lot of time. Well, hundreds of milliseconds. Try to load this image, which is located on a server that is hosted in Prague, Czech Republic (I’m using <code>curl</code> as suggested <a href="https://josephscott.org/archives/2011/10/timing-details-with-curl/">here</a>):</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ curl -w &quot;@f.txt&quot; -o /dev/null -s \
  http://www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif
    time_namelookup:  0.005
       time_connect:  0.376
   time_pretransfer:  0.377
 time_starttransfer:  0.566
                    ----------
         time_total:  0.567</code></pre></figure><p>I’m trying to do it from Palo Alto, California, which is about half a globe away from Prague. As you can see, it takes over 500ms. That’s too much, especially if a web page contains many images. Overall, page loading may take seconds, just because the server is too far away from me. Well, it will inevitably be too far away from some users, no matter where we host it. If we host it here in California, it will be close enough to me and the image will be loaded instantly (less than 50ms). But then it will be too slow for users in Prague.</p><p>This problem has no solutions if the server generates images or pages on the fly in some unique way and if we can’t install a number of servers in different countries and continents. But in most cases, such as our logo example, this is not a problem. This logo doesn’t need to be unique for each user. It is a very <em>static</em> resource, which needs to be created only once and be delivered to everybody, without any changes.</p><p>So, how about we install a server somewhere here in California and let Californian users connect to it. When a request for <code>logo.gif</code> comes to one of the <em>edge</em> servers, it will connect to the central server in Prague and load the file. This will happen only once. After that, the edge server will not request the file from the central server. It will return it immediately, from its internal cache.</p><p>We need to have many edge servers, preferably in all countries where our users may be located. The first request will take longer, but all others will be much faster because they will be served from the closest edge server.</p><p>Now, the question is how the browser will know which edge server is the closest, right? We simply trick the domain name resolution process. Depending on who is asking, the DNS will give different answers. Let’s take <code>cf.jare.io</code>, for example (it is the name of all edge servers responsible for delivering our content in AWS CloudFront, a CNAME for <code>djk1be5eatcae.cloudfront.net</code>). If I’m looking it up from California, I’m getting the following answer:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup cf.jare.io
Server:   192.168.1.1
Address:  192.168.1.1#53

Non-authoritative answer:
cf.jare.io  canonical name = djk1be5eatcae.cloudfront.net.
Name: djk1be5eatcae.cloudfront.net
Address: 54.230.141.211</code></pre></figure><p>An edge server with IP address <code>54.230.141.211</code> is located in <a href="https://db-ip.com/54.230.141.211">San Francisco</a>. This is rather close to me, less than fifty miles. If I do the same operation from a server in Virginia, I get a different response:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ nslookup cf.jare.io
Server:   172.16.0.23
Address:  172.16.0.23#53

Non-authoritative answer:
cf.jare.io  canonical name = djk1be5eatcae.cloudfront.net.
Name: djk1be5eatcae.cloudfront.net
Address: 52.85.131.217</code></pre></figure><p>An edge server with IP address <code>52.85.131.217</code> is located in <a href="https://db-ip.com/52.85.131.217">Washington</a>, which is far away from me, but very close to the server I was making the lookup from.</p><p>There are thousands of name servers around the world and all of them have different information about where that edge server <code>cf.jare.io</code> is physically located. Depending on who is asking, the answer will be different.</p><h2 id="aws-cloudfront">AWS CloudFront</h2><p><a href="https://aws.amazon.com/cloudfront/">CloudFront</a> is one of the simplest CDN solutions. All you have to do to start delivering your content through their edge nodes is to create a “distribution” and configure it. A distribution is basically a connector between content origin and edge servers:</p><p><img src="/uml/b5d40b6498ca48f6d2efc8671dd6d1e6.svg" style="width:75%" alt="PlantUML SVG diagram" class="plantuml" /></p><p>One of edge servers receives an HTTP request. If it already has that <code>logo.svg</code> in its cache, it immediately returns an HTTP response with its content inside. If its cache is empty, the edge server makes an HTTP request to the central server. This server knows about the “distribution” and its configuration. It makes an HTTP connection to the origin server, which is <code>www.teamed.io</code> and asks it to return <code>logo.svg</code>. When done, the image is returned to the edge server, where it is cached.</p><p>This looks rather simple, but it’s not free and it’s not that quick to configure. You have to create an account with CloudFront, register your credit card there, and get an approval. Then you have to create a distribution and configure it. You should then create that CNAME in your name server. If you’re doing it for a single website, it’s not a big deal. If you have a dozen websites, it’s a time consuming operation.</p><h2 id="jareio-a-middle-man">Jare.io, a Middle Man</h2><p>Jare.io is an extra component in that diagram, which makes your life easier:</p><p><img src="/uml/aecf8b3862f82e6d5d8d27e948d45c83.svg" style="width:75%" alt="PlantUML SVG diagram" class="plantuml" /></p><p>Jare.io has a “relay,” which acts as an origin server for CloudFront. All requests that arrive to <code>cf.jare.io</code> are dispatched to the relay. The relay decides what to do with them. The decision is based on the information from the HTTP request URI. For example, the request from the browser has this URI path:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>/?u=http://www.teamed.io/images/logo.svg</code></pre></figure><p>Remember, the request is made to <code>cf.jare.io</code>, which is the address of the edge server. This exact URI arrives at <code>relay.jare.io</code>. The URI contains enough information to make a decision about which file has to be returned. The relay makes a new HTTP request to <code>www.teamed.io</code> and retrieves the image.</p><p>The beauty of this solution is that it’s easy. For small websites, it is a free and quick CDN.</p><p>By the way, when we query the same image through jare.io (and CloudFront), it comes back much faster:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>$ curl -w &quot;@f.txt&quot; -o /dev/null -s \
  http://cf.jare.io/?u=www.vlada.cz/images/vlada/vlada-ceske-republiky_en.gif
    time_namelookup:  0.005
       time_connect:  0.021
   time_pretransfer:  0.021
 time_starttransfer:  0.041
                    ----------
         time_total:  0.041</code></pre></figure><p>Most of the work is done by AWS CloudFront, while jare.io is just a relay that makes its configuration more convenient. Besides, it makes it free, because jare.io is sponsored by <a href="https://www.zerocracy.com">Zerocracy</a>. In other words, my company will pay for your usage of CloudFront. I would appreciate if you kept that in mind and didn’t use jare.io for traffic-intensive resources.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.wring.io&quot;&gt;&lt;img src=&quot;http://www.wring.io/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I’m taking participation in over 50 repositories in GitHub. &lt;a href=&quot;https://www.zerocracy.com&quot;&gt;We&lt;/a&gt; manage all of our projects there. GitHub is sending me hundreds of emails every day. I’m serious. Hundreds! I tried to filter them somehow in Gmail, but it’s not really possible. Gmail filters are not powerful enough to understand the difference between different types of notifications, and there are many other problems. I decided to create my own simple filtering machine. It’s called &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;The idea of wring.io is simple. First, I’m registering my sources of notifications (called “pipes”), such as GitHub. Then I’m giving &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt; permission to connect to GitHub on my behalf and fetch whatever is new there.&lt;/p&gt; &lt;p&gt;Then I’m configuring what should be filtered out, using text matching and/or regular expressions. Right after a new pipe is created, &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt; starts pulling all my sources and updating my inbox. All I need to do is delete new messages from my inbox when I’m done with them. That’s it.&lt;/p&gt; &lt;p&gt;Let’s see an example. First I’m creating a new pipe:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/wring-1.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;It’s a JSON object. Property &lt;code&gt;class&lt;/code&gt; must be set to &lt;code&gt;io.wring.agents.github.AgGithub&lt;/code&gt;. This is the name of the Java class that will be pulling my notifications from GitHub. The project is open source, so you can see how the class actually works: &lt;a href=&quot;https://github.com/yegor256/wring/blob/0.8.5/src/main/java/io/wring/agents/github/AgGithub.java&quot;&gt;&lt;code&gt;AgGithub&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Property &lt;code&gt;token&lt;/code&gt; must be set to the &lt;a href=&quot;https://github.com/settings/tokens/new&quot;&gt;personal access token&lt;/a&gt; that I should create first in GitHub. The server will connect to GitHub on my behalf and under my credentials:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/wring-2.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Property &lt;code&gt;ignore&lt;/code&gt; must have an array of strings. Each item is a matching pattern. I can use a text or a regular expression. By default, it’s a text. If exactly the same text is found in a notification, it will be ignored. To use a regular expression, I need to wrap it in slashes (for example &lt;code&gt;/[a-z]+/&lt;/code&gt;). You may skip that property and just specify this JSON:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;quot;class&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;io.wring.agents.github.AgGithub&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;quot;token&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;your-personal-access-token&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then I go to my inbox and read what’s there.&lt;/p&gt; &lt;p&gt;This solution literally saves me hours of time now. Feel free to use it, it’s absolutely free. Moreover, it’s open source, so feel free to contribute.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, place, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2016-03-15 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Wring.io, a Dispatcher of GitHub Notifications"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.wring.io&quot;&gt;&lt;img src=&quot;http://www.wring.io/images/logo.svg&quot; style=&quot;width:92px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I’m taking participation in over 50 repositories in GitHub. &lt;a href=&quot;https://www.zerocracy.com&quot;&gt;We&lt;/a&gt; manage all of our projects there. GitHub is sending me hundreds of emails every day. I’m serious. Hundreds! I tried to filter them somehow in Gmail, but it’s not really possible. Gmail filters are not powerful enough to understand the difference between different types of notifications, and there are many other problems. I decided to create my own simple filtering machine. It’s called &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;The idea of wring.io is simple. First, I’m registering my sources of notifications (called “pipes”), such as GitHub. Then I’m giving &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt; permission to connect to GitHub on my behalf and fetch whatever is new there.&lt;/p&gt; &lt;p&gt;Then I’m configuring what should be filtered out, using text matching and/or regular expressions. Right after a new pipe is created, &lt;a href=&quot;http://www.wring.io&quot;&gt;wring.io&lt;/a&gt; starts pulling all my sources and updating my inbox. All I need to do is delete new messages from my inbox when I’m done with them. That’s it.&lt;/p&gt; &lt;p&gt;Let’s see an example. First I’m creating a new pipe:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/wring-1.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;It’s a JSON object. Property &lt;code&gt;class&lt;/code&gt; must be set to &lt;code&gt;io.wring.agents.github.AgGithub&lt;/code&gt;. This is the name of the Java class that will be pulling my notifications from GitHub. The project is open source, so you can see how the class actually works: &lt;a href=&quot;https://github.com/yegor256/wring/blob/0.8.5/src/main/java/io/wring/agents/github/AgGithub.java&quot;&gt;&lt;code&gt;AgGithub&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Property &lt;code&gt;token&lt;/code&gt; must be set to the &lt;a href=&quot;https://github.com/settings/tokens/new&quot;&gt;personal access token&lt;/a&gt; that I should create first in GitHub. The server will connect to GitHub on my behalf and under my credentials:&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2016/03/wring-2.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Property &lt;code&gt;ignore&lt;/code&gt; must have an array of strings. Each item is a matching pattern. I can use a text or a regular expression. By default, it’s a text. If exactly the same text is found in a notification, it will be ignored. To use a regular expression, I need to wrap it in slashes (for example &lt;code&gt;/[a-z]+/&lt;/code&gt;). You may skip that property and just specify this JSON:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;quot;class&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;io.wring.agents.github.AgGithub&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;quot;token&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;your-personal-access-token&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Then I go to my inbox and read what’s there.&lt;/p&gt; &lt;p&gt;This solution literally saves me hours of time now. Feel free to use it, it’s absolutely free. Moreover, it’s open source, so feel free to contribute.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html" /> <link rel="amphtml" href="https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.amp.html" /> <title>Wring.io, a Dispatcher of GitHub Notifications </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2016/03/15/wring-dispatcher-github-notifications.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html</code></p><h1 itemprop="name headline mainEntityOfPage">Wring.io, a Dispatcher of GitHub Notifications</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2016-03-15T00:00:00+00:00"> 15 March 2016 </time> </li> <li class="desktop-only" itemprop="locationCreated">Frankfurt, Germany</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.wring.io"><img src="http://www.wring.io/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>I’m taking participation in over 50 repositories in GitHub. <a href="https://www.zerocracy.com">We</a> manage all of our projects there. GitHub is sending me hundreds of emails every day. I’m serious. Hundreds! I tried to filter them somehow in Gmail, but it’s not really possible. Gmail filters are not powerful enough to understand the difference between different types of notifications, and there are many other problems. I decided to create my own simple filtering machine. It’s called <a href="http://www.wring.io">wring.io</a>.</p><p>The idea of wring.io is simple. First, I’m registering my sources of notifications (called “pipes”), such as GitHub. Then I’m giving <a href="http://www.wring.io">wring.io</a> permission to connect to GitHub on my behalf and fetch whatever is new there.</p><p>Then I’m configuring what should be filtered out, using text matching and/or regular expressions. Right after a new pipe is created, <a href="http://www.wring.io">wring.io</a> starts pulling all my sources and updating my inbox. All I need to do is delete new messages from my inbox when I’m done with them. That’s it.</p><p>Let’s see an example. First I’m creating a new pipe:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/wring-1.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>It’s a JSON object. Property <code>class</code> must be set to <code>io.wring.agents.github.AgGithub</code>. This is the name of the Java class that will be pulling my notifications from GitHub. The project is open source, so you can see how the class actually works: <a href="https://github.com/yegor256/wring/blob/0.8.5/src/main/java/io/wring/agents/github/AgGithub.java"><code>AgGithub</code></a>.</p><p>Property <code>token</code> must be set to the <a href="https://github.com/settings/tokens/new">personal access token</a> that I should create first in GitHub. The server will connect to GitHub on my behalf and under my credentials:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/wring-2.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Property <code>ignore</code> must have an array of strings. Each item is a matching pattern. I can use a text or a regular expression. By default, it’s a text. If exactly the same text is found in a notification, it will be ignored. To use a regular expression, I need to wrap it in slashes (for example <code>/[a-z]+/</code>). You may skip that property and just specify this JSON:</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;io.wring.agents.github.AgGithub&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;your-personal-access-token&quot;</span>
<span class="p">}</span></code></pre></figure><p>Then I go to my inbox and read what’s there.</p><p>This solution literally saves me hours of time now. Feel free to use it, it’s absolutely free. Moreover, it’s open source, so feel free to contribute.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html&amp;text=Wring.io%2C+a+Dispatcher+of+GitHub+Notifications" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html%3F2016-11&amp;title=Wring.io%2C+a+Dispatcher+of+GitHub+Notifications" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2016/03/15/wring-dispatcher-github-notifications.html%3F2016-11&amp;t=Wring.io%2C+a+Dispatcher+of+GitHub+Notifications" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.wring.io"><img src="http://www.wring.io/images/logo.svg" style="width:92px;max-width:100%;" alt="badge" /></a></figure><p>I’m taking participation in over 50 repositories in GitHub. <a href="https://www.zerocracy.com">We</a> manage all of our projects there. GitHub is sending me hundreds of emails every day. I’m serious. Hundreds! I tried to filter them somehow in Gmail, but it’s not really possible. Gmail filters are not powerful enough to understand the difference between different types of notifications, and there are many other problems. I decided to create my own simple filtering machine. It’s called <a href="http://www.wring.io">wring.io</a>.</p><p>The idea of wring.io is simple. First, I’m registering my sources of notifications (called “pipes”), such as GitHub. Then I’m giving <a href="http://www.wring.io">wring.io</a> permission to connect to GitHub on my behalf and fetch whatever is new there.</p><p>Then I’m configuring what should be filtered out, using text matching and/or regular expressions. Right after a new pipe is created, <a href="http://www.wring.io">wring.io</a> starts pulling all my sources and updating my inbox. All I need to do is delete new messages from my inbox when I’m done with them. That’s it.</p><p>Let’s see an example. First I’m creating a new pipe:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/wring-1.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>It’s a JSON object. Property <code>class</code> must be set to <code>io.wring.agents.github.AgGithub</code>. This is the name of the Java class that will be pulling my notifications from GitHub. The project is open source, so you can see how the class actually works: <a href="https://github.com/yegor256/wring/blob/0.8.5/src/main/java/io/wring/agents/github/AgGithub.java"><code>AgGithub</code></a>.</p><p>Property <code>token</code> must be set to the <a href="https://github.com/settings/tokens/new">personal access token</a> that I should create first in GitHub. The server will connect to GitHub on my behalf and under my credentials:</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2016/03/wring-2.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Property <code>ignore</code> must have an array of strings. Each item is a matching pattern. I can use a text or a regular expression. By default, it’s a text. If exactly the same text is found in a notification, it will be ignored. To use a regular expression, I need to wrap it in slashes (for example <code>/[a-z]+/</code>). You may skip that property and just specify this JSON:</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;io.wring.agents.github.AgGithub&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;your-personal-access-token&quot;</span>
<span class="p">}</span></code></pre></figure><p>Then I go to my inbox and read what’s there.</p><p>This solution literally saves me hours of time now. Feel free to use it, it’s absolutely free. Moreover, it’s open source, so feel free to contribute.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.takes.org&quot;&gt;&lt;img src=&quot;http://www.takes.org/logo.png&quot; style=&quot;width:96px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;A year ago, I &lt;a href=&quot;/2014/06/25/xml-and-xslt-in-browser.html&quot;&gt;tried to explain&lt;/a&gt; how effectively data and its presentation can be separated in a web application with the help of XML and XSL. In a few words, instead of using &lt;a href=&quot;https://en.wikipedia.org/wiki/Comparison_of_web_template_engines&quot;&gt;templating&lt;/a&gt; (like JSP, Velocity, FreeMarker, etc.) and injection of data into HTML, we compose them in the form of an XML document and then let the XSL stylesheet transform them into HTML. Here is a brief example of how all this can be used together with the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes framework&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let’s agree that templating is a bad idea in the first place. Yes, I mean it. The entire design of JSP is wrong, with all due respect to its creators. Here is how it works: Let’s say my website has to fetch the current exchange rate of the euro from a database and show it on the home page. Here’s how my &lt;code&gt;index.jsp&lt;/code&gt; would look:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-jsp&quot; data-lang=&quot;jsp&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;EUR/USD: &lt;span class=&quot;k&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rates&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;In order to create HTML, the JSP engine will have to call &lt;code&gt;get()&lt;/code&gt; on object &lt;code&gt;rates&lt;/code&gt; and render what’s returned through &lt;code&gt;toString()&lt;/code&gt;. It’s a terrible design for a few reasons. First, the view is tightly coupled with the model. Second, the flexibility of rendering is very limited. Third, the result of rendering is not reusable, and views are not stackable. There are many other reasons … more about them in one of the next articles.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=nheD2LNYrpk&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg&quot; alt=&quot;YouTube video #nheD2LNYrpk&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;Let’s see how this should be done right. First, we let our model generate the output in XML format, for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?xml version=&amp;quot;1.1&amp;quot;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;page&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;rate&amp;gt;&lt;/span&gt;1.1324&lt;span class=&quot;nt&quot;&gt;&amp;lt;/rate&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/page&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is what the model will produce, having no knowledge of the view. Then, we create the view as an XSL stylesheet, which will transform XML into HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:stylesheet&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;version=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;1.0&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns:xsl=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/1999/XSL/Transform&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/1999/xhtml&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:template&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;match=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;page&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:text&amp;gt;&lt;/span&gt;EUR/USD: &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:text&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:value-of&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;select=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rate&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:template&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:stylesheet&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;As you see, the view doesn’t know anything about the model in terms of implementation. All it knows is the format of XML data output produced by the model. Here is how you design it in the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes framework&lt;/a&gt;. Let’s start with a simple example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It’s a simple web application that starts a web server and never ends (it waits for connections in daemon mode). To make it work, we should create a simple “take” named &lt;code&gt;TkApp&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkWrap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;page&amp;gt;&amp;lt;rate&amp;gt;1.1324&amp;lt;/rate&amp;gt;&amp;lt;/page&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This “take” always returns the same XML response, but it doesn’t do any XSL transformation yet. We need to add the &lt;code&gt;RsXSLT&lt;/code&gt; class to the picture:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXSLT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;?xml-stylesheet type=&amp;#39;text/xsl&amp;#39; href=&amp;#39;/xsl/index.xsl&amp;#39;?&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;page&amp;gt;&amp;lt;rate&amp;gt;1.1324&amp;lt;/rate&amp;gt;&amp;lt;/page&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Excuse me for using string concatenation, which is a &lt;a href=&quot;/2014/06/19/avoid-string-concatenation.html&quot;&gt;bad practice&lt;/a&gt;; it’s merely for the simplicity of the example.&lt;/p&gt; &lt;p&gt;As you see, I also added an XML stylesheet processing instruction to the XML. &lt;code&gt;RsXSLT&lt;/code&gt; will understand it and try to find the &lt;code&gt;/xsl/index.xsl&lt;/code&gt; resource on classpath. You see the content of that file above.&lt;/p&gt; &lt;p&gt;That’s it.&lt;/p&gt; &lt;p&gt;Well, not really. Building XML from strings is not a good idea. We have a better instrument in the Takes framework. We use &lt;a href=&quot;http://www.xembly.org&quot;&gt;Xembly&lt;/a&gt;, which is a simple imperative language for building and modifying XML documents. More about it here: &lt;a href=&quot;/2014/04/09/xembly-intro.html&quot;&gt;Xembly, an Assembly for XML&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Here is how our &lt;code&gt;TkApp&lt;/code&gt; would look:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXSLT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXembly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeStylesheet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/xsl/index.xsl&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeAppend&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;page&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeDirectives&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Directives&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rate&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;1.1324&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The most important class here is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/RsXembly.html&quot;&gt;&lt;code&gt;RsXembly&lt;/code&gt;&lt;/a&gt;. The idea is to let model classes expose their data through Xembly “directives,” which will later be applied to a DOM structure by &lt;code&gt;RsXembly&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;&lt;code&gt;XeChain&lt;/code&gt;, &lt;code&gt;XeStylesheet&lt;/code&gt;, &lt;code&gt;XeAppend&lt;/code&gt;, and &lt;code&gt;XeDirectives&lt;/code&gt; expose directives but with different meanings (they are all instances of an &lt;code&gt;XeSource&lt;/code&gt; interface). Their names describe their intentions rather well. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeChain.html&quot;&gt;&lt;code&gt;XeChain&lt;/code&gt;&lt;/a&gt; just chains everything that is delivered by encapsulated “directive sources.” &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeStylesheet.html&quot;&gt;&lt;code&gt;XeStylesheet&lt;/code&gt;&lt;/a&gt; returns directives that create a single XML processing instruction. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeAppend.html&quot;&gt;&lt;code&gt;XeAppend&lt;/code&gt;&lt;/a&gt; creates an XML node and adds encapsulated directives to it. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeDirectives.html&quot;&gt;&lt;code&gt;XeDirectives&lt;/code&gt;&lt;/a&gt; simply returns what’s inside.&lt;/p&gt; &lt;p&gt;In the end, this code will create exactly the same XML document as I created above with string concatenation.&lt;/p&gt; &lt;p&gt;The beauty of this approach is in the perfect &lt;a href=&quot;/2018/09/18/fear-of-coupling.html&quot;&gt;decoupling&lt;/a&gt; of data generation and XML building and translation between XML and HTML. It is perfectly reusable and “stackable.” We can transform the data in XML format multiple times, applying different XSL stylesheets to each one. We can even transform them into &lt;a href=&quot;/2015/11/16/json-vs-xml.html&quot;&gt;JSON&lt;/a&gt; without changing a line of code in model classes.&lt;/p&gt; &lt;p&gt;Moreover, we can format them differently, using rather powerful XSLT 2.0 instruments. XSLT by itself is a powerful and purely functional language that enables any possible data manipulations. No templating engine is even close to it.&lt;/p&gt; &lt;p&gt;Take a look at how it works in the &lt;a href=&quot;https://github.com/yegor256/rultor/blob/1.55/src/main/java/com/rultor/web/RsPage.java&quot;&gt;&lt;code&gt;RsPage&lt;/code&gt;&lt;/a&gt; class in Rultor, for example.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, place, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2015-06-25 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="XML Data and XSL Views in Takes Framework"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.takes.org&quot;&gt;&lt;img src=&quot;http://www.takes.org/logo.png&quot; style=&quot;width:96px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;A year ago, I &lt;a href=&quot;/2014/06/25/xml-and-xslt-in-browser.html&quot;&gt;tried to explain&lt;/a&gt; how effectively data and its presentation can be separated in a web application with the help of XML and XSL. In a few words, instead of using &lt;a href=&quot;https://en.wikipedia.org/wiki/Comparison_of_web_template_engines&quot;&gt;templating&lt;/a&gt; (like JSP, Velocity, FreeMarker, etc.) and injection of data into HTML, we compose them in the form of an XML document and then let the XSL stylesheet transform them into HTML. Here is a brief example of how all this can be used together with the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes framework&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let’s agree that templating is a bad idea in the first place. Yes, I mean it. The entire design of JSP is wrong, with all due respect to its creators. Here is how it works: Let’s say my website has to fetch the current exchange rate of the euro from a database and show it on the home page. Here’s how my &lt;code&gt;index.jsp&lt;/code&gt; would look:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-jsp&quot; data-lang=&quot;jsp&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;EUR/USD: &lt;span class=&quot;k&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rates&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;In order to create HTML, the JSP engine will have to call &lt;code&gt;get()&lt;/code&gt; on object &lt;code&gt;rates&lt;/code&gt; and render what’s returned through &lt;code&gt;toString()&lt;/code&gt;. It’s a terrible design for a few reasons. First, the view is tightly coupled with the model. Second, the flexibility of rendering is very limited. Third, the result of rendering is not reusable, and views are not stackable. There are many other reasons … more about them in one of the next articles.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=nheD2LNYrpk&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg&quot; alt=&quot;YouTube video #nheD2LNYrpk&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;Let’s see how this should be done right. First, we let our model generate the output in XML format, for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?xml version=&amp;quot;1.1&amp;quot;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;page&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;rate&amp;gt;&lt;/span&gt;1.1324&lt;span class=&quot;nt&quot;&gt;&amp;lt;/rate&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/page&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is what the model will produce, having no knowledge of the view. Then, we create the view as an XSL stylesheet, which will transform XML into HTML:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:stylesheet&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;version=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;1.0&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns:xsl=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/1999/XSL/Transform&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/1999/xhtml&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:template&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;match=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;page&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:text&amp;gt;&lt;/span&gt;EUR/USD: &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:text&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;xsl:value-of&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;select=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rate&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:template&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/xsl:stylesheet&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;As you see, the view doesn’t know anything about the model in terms of implementation. All it knows is the format of XML data output produced by the model. Here is how you design it in the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes framework&lt;/a&gt;. Let’s start with a simple example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It’s a simple web application that starts a web server and never ends (it waits for connections in daemon mode). To make it work, we should create a simple “take” named &lt;code&gt;TkApp&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkWrap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;page&amp;gt;&amp;lt;rate&amp;gt;1.1324&amp;lt;/rate&amp;gt;&amp;lt;/page&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This “take” always returns the same XML response, but it doesn’t do any XSL transformation yet. We need to add the &lt;code&gt;RsXSLT&lt;/code&gt; class to the picture:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXSLT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;?xml-stylesheet type=&amp;#39;text/xsl&amp;#39; href=&amp;#39;/xsl/index.xsl&amp;#39;?&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;page&amp;gt;&amp;lt;rate&amp;gt;1.1324&amp;lt;/rate&amp;gt;&amp;lt;/page&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Excuse me for using string concatenation, which is a &lt;a href=&quot;/2014/06/19/avoid-string-concatenation.html&quot;&gt;bad practice&lt;/a&gt;; it’s merely for the simplicity of the example.&lt;/p&gt; &lt;p&gt;As you see, I also added an XML stylesheet processing instruction to the XML. &lt;code&gt;RsXSLT&lt;/code&gt; will understand it and try to find the &lt;code&gt;/xsl/index.xsl&lt;/code&gt; resource on classpath. You see the content of that file above.&lt;/p&gt; &lt;p&gt;That’s it.&lt;/p&gt; &lt;p&gt;Well, not really. Building XML from strings is not a good idea. We have a better instrument in the Takes framework. We use &lt;a href=&quot;http://www.xembly.org&quot;&gt;Xembly&lt;/a&gt;, which is a simple imperative language for building and modifying XML documents. More about it here: &lt;a href=&quot;/2014/04/09/xembly-intro.html&quot;&gt;Xembly, an Assembly for XML&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Here is how our &lt;code&gt;TkApp&lt;/code&gt; would look:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXSLT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsXembly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeStylesheet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/xsl/index.xsl&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeAppend&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;page&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XeDirectives&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Directives&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rate&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;1.1324&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;application/xml&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The most important class here is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/RsXembly.html&quot;&gt;&lt;code&gt;RsXembly&lt;/code&gt;&lt;/a&gt;. The idea is to let model classes expose their data through Xembly “directives,” which will later be applied to a DOM structure by &lt;code&gt;RsXembly&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;&lt;code&gt;XeChain&lt;/code&gt;, &lt;code&gt;XeStylesheet&lt;/code&gt;, &lt;code&gt;XeAppend&lt;/code&gt;, and &lt;code&gt;XeDirectives&lt;/code&gt; expose directives but with different meanings (they are all instances of an &lt;code&gt;XeSource&lt;/code&gt; interface). Their names describe their intentions rather well. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeChain.html&quot;&gt;&lt;code&gt;XeChain&lt;/code&gt;&lt;/a&gt; just chains everything that is delivered by encapsulated “directive sources.” &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeStylesheet.html&quot;&gt;&lt;code&gt;XeStylesheet&lt;/code&gt;&lt;/a&gt; returns directives that create a single XML processing instruction. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeAppend.html&quot;&gt;&lt;code&gt;XeAppend&lt;/code&gt;&lt;/a&gt; creates an XML node and adds encapsulated directives to it. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeDirectives.html&quot;&gt;&lt;code&gt;XeDirectives&lt;/code&gt;&lt;/a&gt; simply returns what’s inside.&lt;/p&gt; &lt;p&gt;In the end, this code will create exactly the same XML document as I created above with string concatenation.&lt;/p&gt; &lt;p&gt;The beauty of this approach is in the perfect &lt;a href=&quot;/2018/09/18/fear-of-coupling.html&quot;&gt;decoupling&lt;/a&gt; of data generation and XML building and translation between XML and HTML. It is perfectly reusable and “stackable.” We can transform the data in XML format multiple times, applying different XSL stylesheets to each one. We can even transform them into &lt;a href=&quot;/2015/11/16/json-vs-xml.html&quot;&gt;JSON&lt;/a&gt; without changing a line of code in model classes.&lt;/p&gt; &lt;p&gt;Moreover, we can format them differently, using rather powerful XSLT 2.0 instruments. XSLT by itself is a powerful and purely functional language that enables any possible data manipulations. No templating engine is even close to it.&lt;/p&gt; &lt;p&gt;Take a look at how it works in the &lt;a href=&quot;https://github.com/yegor256/rultor/blob/1.55/src/main/java/com/rultor/web/RsPage.java&quot;&gt;&lt;code&gt;RsPage&lt;/code&gt;&lt;/a&gt; class in Rultor, for example.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html" /> <link rel="amphtml" href="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.amp.html" /> <title>XML Data and XSL Views in Takes Framework </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2015/06/25/xml-data-xsl-views-takes-framework.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html</code></p><h1 itemprop="name headline mainEntityOfPage">XML Data and XSL Views in Takes Framework</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2015-06-25T00:00:00+00:00"> 25 June 2015 </time> </li> <li class="desktop-only" itemprop="locationCreated">Palo Alto, CA</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.takes.org"><img src="http://www.takes.org/logo.png" style="width:96px;max-width:100%;" alt="badge" /></a></figure><p>A year ago, I <a href="/2014/06/25/xml-and-xslt-in-browser.html">tried to explain</a> how effectively data and its presentation can be separated in a web application with the help of XML and XSL. In a few words, instead of using <a href="https://en.wikipedia.org/wiki/Comparison_of_web_template_engines">templating</a> (like JSP, Velocity, FreeMarker, etc.) and injection of data into HTML, we compose them in the form of an XML document and then let the XSL stylesheet transform them into HTML. Here is a brief example of how all this can be used together with the <a href="http://www.takes.org">Takes framework</a>.</p><p>First, let’s agree that templating is a bad idea in the first place. Yes, I mean it. The entire design of JSP is wrong, with all due respect to its creators. Here is how it works: Let’s say my website has to fetch the current exchange rate of the euro from a database and show it on the home page. Here’s how my <code>index.jsp</code> would look:</p><figure class="highlight"><pre><code class="language-jsp" data-lang="jsp"><span></span><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>EUR/USD: <span class="k">&lt;%=</span> <span class="n">rates</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="k">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure><p>In order to create HTML, the JSP engine will have to call <code>get()</code> on object <code>rates</code> and render what’s returned through <code>toString()</code>. It’s a terrible design for a few reasons. First, the view is tightly coupled with the model. Second, the flexibility of rendering is very limited. Third, the result of rendering is not reusable, and views are not stackable. There are many other reasons … more about them in one of the next articles.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=nheD2LNYrpk"><div class="box"> <img src="https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg" alt="YouTube video #nheD2LNYrpk" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.</div></aside><p>Let’s see how this should be done right. First, we let our model generate the output in XML format, for example:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="cp">&lt;?xml version=&quot;1.1&quot;?&gt;</span>
<span class="nt">&lt;page&gt;</span>
  <span class="nt">&lt;rate&gt;</span>1.1324<span class="nt">&lt;/rate&gt;</span>
<span class="nt">&lt;/page&gt;</span></code></pre></figure><p>This is what the model will produce, having no knowledge of the view. Then, we create the view as an XSL stylesheet, which will transform XML into HTML:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span>
  <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>
  <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;page&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>
          <span class="nt">&lt;xsl:text&gt;</span>EUR/USD: <span class="nt">&lt;/xsl:text&gt;</span>
          <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;rate&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;/html&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:stylesheet&gt;</span></code></pre></figure><p>As you see, the view doesn’t know anything about the model in terms of implementation. All it knows is the format of XML data output produced by the model. Here is how you design it in the <a href="http://www.takes.org">Takes framework</a>. Let’s start with a simple example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>It’s a simple web application that starts a web server and never ends (it waits for connections in daemon mode). To make it work, we should create a simple “take” named <code>TkApp</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span>
        <span class="s">&quot;&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;&quot;</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This “take” always returns the same XML response, but it doesn’t do any XSL transformation yet. We need to add the <code>RsXSLT</code> class to the picture:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span>
        <span class="s">&quot;&lt;?xml-stylesheet type=&#39;text/xsl&#39; href=&#39;/xsl/index.xsl&#39;?&gt;&quot;</span>
        <span class="o">+</span> <span class="s">&quot;&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;&quot;</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>Excuse me for using string concatenation, which is a <a href="/2014/06/19/avoid-string-concatenation.html">bad practice</a>; it’s merely for the simplicity of the example.</p><p>As you see, I also added an XML stylesheet processing instruction to the XML. <code>RsXSLT</code> will understand it and try to find the <code>/xsl/index.xsl</code> resource on classpath. You see the content of that file above.</p><p>That’s it.</p><p>Well, not really. Building XML from strings is not a good idea. We have a better instrument in the Takes framework. We use <a href="http://www.xembly.org">Xembly</a>, which is a simple imperative language for building and modifying XML documents. More about it here: <a href="/2014/04/09/xembly-intro.html">Xembly, an Assembly for XML</a>.</p><p>Here is how our <code>TkApp</code> would look:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsXembly</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">XeChain</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">XeStylesheet</span><span class="o">(</span><span class="s">&quot;/xsl/index.xsl&quot;</span><span class="o">),</span>
          <span class="k">new</span> <span class="n">XeAppend</span><span class="o">(</span>
            <span class="s">&quot;page&quot;</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">XeDirectives</span><span class="o">(</span>
              <span class="k">new</span> <span class="n">Directives</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;rate&quot;</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;1.1324&quot;</span><span class="o">)</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>The most important class here is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/RsXembly.html"><code>RsXembly</code></a>. The idea is to let model classes expose their data through Xembly “directives,” which will later be applied to a DOM structure by <code>RsXembly</code>.</p><p><code>XeChain</code>, <code>XeStylesheet</code>, <code>XeAppend</code>, and <code>XeDirectives</code> expose directives but with different meanings (they are all instances of an <code>XeSource</code> interface). Their names describe their intentions rather well. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeChain.html"><code>XeChain</code></a> just chains everything that is delivered by encapsulated “directive sources.” <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeStylesheet.html"><code>XeStylesheet</code></a> returns directives that create a single XML processing instruction. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeAppend.html"><code>XeAppend</code></a> creates an XML node and adds encapsulated directives to it. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeDirectives.html"><code>XeDirectives</code></a> simply returns what’s inside.</p><p>In the end, this code will create exactly the same XML document as I created above with string concatenation.</p><p>The beauty of this approach is in the perfect <a href="/2018/09/18/fear-of-coupling.html">decoupling</a> of data generation and XML building and translation between XML and HTML. It is perfectly reusable and “stackable.” We can transform the data in XML format multiple times, applying different XSL stylesheets to each one. We can even transform them into <a href="/2015/11/16/json-vs-xml.html">JSON</a> without changing a line of code in model classes.</p><p>Moreover, we can format them differently, using rather powerful XSLT 2.0 instruments. XSLT by itself is a powerful and purely functional language that enables any possible data manipulations. No templating engine is even close to it.</p><p>Take a look at how it works in the <a href="https://github.com/yegor256/rultor/blob/1.55/src/main/java/com/rultor/web/RsPage.java"><code>RsPage</code></a> class in Rultor, for example.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html&amp;text=XML+Data+and+XSL+Views+in+Takes+Framework" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html%3F2015-25&amp;title=XML+Data+and+XSL+Views+in+Takes+Framework" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html%3F2015-25&amp;t=XML+Data+and+XSL+Views+in+Takes+Framework" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.takes.org"><img src="http://www.takes.org/logo.png" style="width:96px;max-width:100%;" alt="badge" /></a></figure><p>A year ago, I <a href="/2014/06/25/xml-and-xslt-in-browser.html">tried to explain</a> how effectively data and its presentation can be separated in a web application with the help of XML and XSL. In a few words, instead of using <a href="https://en.wikipedia.org/wiki/Comparison_of_web_template_engines">templating</a> (like JSP, Velocity, FreeMarker, etc.) and injection of data into HTML, we compose them in the form of an XML document and then let the XSL stylesheet transform them into HTML. Here is a brief example of how all this can be used together with the <a href="http://www.takes.org">Takes framework</a>.</p><p>First, let’s agree that templating is a bad idea in the first place. Yes, I mean it. The entire design of JSP is wrong, with all due respect to its creators. Here is how it works: Let’s say my website has to fetch the current exchange rate of the euro from a database and show it on the home page. Here’s how my <code>index.jsp</code> would look:</p><figure class="highlight"><pre><code class="language-jsp" data-lang="jsp"><span></span><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>EUR/USD: <span class="k">&lt;%=</span> <span class="n">rates</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="k">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure><p>In order to create HTML, the JSP engine will have to call <code>get()</code> on object <code>rates</code> and render what’s returned through <code>toString()</code>. It’s a terrible design for a few reasons. First, the view is tightly coupled with the model. Second, the flexibility of rendering is very limited. Third, the result of rendering is not reusable, and views are not stackable. There are many other reasons … more about them in one of the next articles.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=nheD2LNYrpk"><div class="box"> <img src="https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg" alt="YouTube video #nheD2LNYrpk" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.</div></aside><p>Let’s see how this should be done right. First, we let our model generate the output in XML format, for example:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="cp">&lt;?xml version=&quot;1.1&quot;?&gt;</span>
<span class="nt">&lt;page&gt;</span>
  <span class="nt">&lt;rate&gt;</span>1.1324<span class="nt">&lt;/rate&gt;</span>
<span class="nt">&lt;/page&gt;</span></code></pre></figure><p>This is what the model will produce, having no knowledge of the view. Then, we create the view as an XSL stylesheet, which will transform XML into HTML:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span>
  <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>
  <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;page&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>
          <span class="nt">&lt;xsl:text&gt;</span>EUR/USD: <span class="nt">&lt;/xsl:text&gt;</span>
          <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;rate&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;/html&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:stylesheet&gt;</span></code></pre></figure><p>As you see, the view doesn’t know anything about the model in terms of implementation. All it knows is the format of XML data output produced by the model. Here is how you design it in the <a href="http://www.takes.org">Takes framework</a>. Let’s start with a simple example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>It’s a simple web application that starts a web server and never ends (it waits for connections in daemon mode). To make it work, we should create a simple “take” named <code>TkApp</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span>
        <span class="s">&quot;&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;&quot;</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This “take” always returns the same XML response, but it doesn’t do any XSL transformation yet. We need to add the <code>RsXSLT</code> class to the picture:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span>
        <span class="s">&quot;&lt;?xml-stylesheet type=&#39;text/xsl&#39; href=&#39;/xsl/index.xsl&#39;?&gt;&quot;</span>
        <span class="o">+</span> <span class="s">&quot;&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;&quot;</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>Excuse me for using string concatenation, which is a <a href="/2014/06/19/avoid-string-concatenation.html">bad practice</a>; it’s merely for the simplicity of the example.</p><p>As you see, I also added an XML stylesheet processing instruction to the XML. <code>RsXSLT</code> will understand it and try to find the <code>/xsl/index.xsl</code> resource on classpath. You see the content of that file above.</p><p>That’s it.</p><p>Well, not really. Building XML from strings is not a good idea. We have a better instrument in the Takes framework. We use <a href="http://www.xembly.org">Xembly</a>, which is a simple imperative language for building and modifying XML documents. More about it here: <a href="/2014/04/09/xembly-intro.html">Xembly, an Assembly for XML</a>.</p><p>Here is how our <code>TkApp</code> would look:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsXembly</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">XeChain</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">XeStylesheet</span><span class="o">(</span><span class="s">&quot;/xsl/index.xsl&quot;</span><span class="o">),</span>
          <span class="k">new</span> <span class="n">XeAppend</span><span class="o">(</span>
            <span class="s">&quot;page&quot;</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">XeDirectives</span><span class="o">(</span>
              <span class="k">new</span> <span class="n">Directives</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;rate&quot;</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;1.1324&quot;</span><span class="o">)</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="s">&quot;application/xml&quot;</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>The most important class here is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/RsXembly.html"><code>RsXembly</code></a>. The idea is to let model classes expose their data through Xembly “directives,” which will later be applied to a DOM structure by <code>RsXembly</code>.</p><p><code>XeChain</code>, <code>XeStylesheet</code>, <code>XeAppend</code>, and <code>XeDirectives</code> expose directives but with different meanings (they are all instances of an <code>XeSource</code> interface). Their names describe their intentions rather well. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeChain.html"><code>XeChain</code></a> just chains everything that is delivered by encapsulated “directive sources.” <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeStylesheet.html"><code>XeStylesheet</code></a> returns directives that create a single XML processing instruction. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeAppend.html"><code>XeAppend</code></a> creates an XML node and adds encapsulated directives to it. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeDirectives.html"><code>XeDirectives</code></a> simply returns what’s inside.</p><p>In the end, this code will create exactly the same XML document as I created above with string concatenation.</p><p>The beauty of this approach is in the perfect <a href="/2018/09/18/fear-of-coupling.html">decoupling</a> of data generation and XML building and translation between XML and HTML. It is perfectly reusable and “stackable.” We can transform the data in XML format multiple times, applying different XSL stylesheets to each one. We can even transform them into <a href="/2015/11/16/json-vs-xml.html">JSON</a> without changing a line of code in model classes.</p><p>Moreover, we can format them differently, using rather powerful XSLT 2.0 instruments. XSLT by itself is a powerful and purely functional language that enables any possible data manipulations. No templating engine is even close to it.</p><p>Take a look at how it works in the <a href="https://github.com/yegor256/rultor/blob/1.55/src/main/java/com/rultor/web/RsPage.java"><code>RsPage</code></a> class in Rultor, for example.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.takes.org&quot;&gt;&lt;img src=&quot;http://www.takes.org/logo.png&quot; style=&quot;width:96px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;When you enter your email and password into the Facebook login page, you get into your account. Then, wherever you go in the site, you always see your photo at the top right corner of the page. Facebook remembers you and doesn’t ask for the password again and again. This works thanks to &lt;a href=&quot;https://en.wikipedia.org/wiki/HTTP_cookie&quot;&gt;HTTP cookies&lt;/a&gt; and is called &lt;strong&gt;cookie-based authentication&lt;/strong&gt;. Even though this mechanism often causes some security problems, it is very popular and simple. Here is how &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; makes it possible in a few lines of code.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let’s see how it works. Moreover, let’s see how I believe it should work.&lt;/p&gt; &lt;p&gt;Step one: The user enters an email and password and clicks “submit.” The server receives a POST request with this information inside:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;POST / HTTP/1.1 Host: www.facebook.com Content-Type: application/x-www-form-urlencoded email=me@yegor256.com&amp;amp;password=itisasecret&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server matches the provided information with its records and decides what to do. If the information is invalid, it returns the same login page, asking you to enter it all again. If the information is valid, the server returns something like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Since the response status code is 303, the browser goes to the page specified in the &lt;code&gt;Location&lt;/code&gt; header and opens the front page of the site. This is what it sends to the server:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET / HTTP/1.1 Host: www.facebook.com Cookie: user=me@yegor256.com&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server gets my email from the &lt;code&gt;Cookie&lt;/code&gt; header and understands that it’s me again! No need to ask for the password once more. The server trusts the information from the cookie. That’s it. That’s what cookie-based authentication is all about.&lt;/p&gt; &lt;h2 id=&quot;wait--what-about-security&quot;&gt;Wait … What About Security?&lt;/h2&gt; &lt;p&gt;Right, what about security? If the server trusts any browser request with a user email in the &lt;code&gt;Cookie&lt;/code&gt; header, anyone would be able to send my email from another place and get access to my account.&lt;/p&gt; &lt;p&gt;The first step to prevent this is to encrypt the email with a secret encryption key, known only to the server. Nobody except the server itself will be able to encrypt it the same way the server needs to decrypt it. The response would look like this, using an example of encryption by &lt;a href=&quot;https://en.wikipedia.org/wiki/XOR_cipher&quot;&gt;XOR cipher&lt;/a&gt; with &lt;code&gt;bamboo&lt;/code&gt; as a secret key:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is not the best encryption mechanism, though; for proper encryption, it’s better to use something stronger like &lt;a href=&quot;https://en.wikipedia.org/wiki/Data_Encryption_Standard&quot;&gt;DES&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;This all sounds good, but what if someone hijacks the traffic between the server and the browser and gets a hold of a properly encrypted email cookie? In this case, the thief would be able to use the same cookie for authentication even without knowing its content. The server would trust the information and let the person into my account. This type of attack is called &lt;a href=&quot;http://en.wikipedia.org/wiki/Man-in-the-middle_attack&quot;&gt;man-in-the-middle&lt;/a&gt; (MITM). To prevent this from happening, we should use HTTPS and inform the browser that the cookie is sensitive and should never be returned to the server without SSL encryption. That’s done by an extra flag in the &lt;code&gt;Set-Cookie&lt;/code&gt; header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;There is yet another type of attack associated with cookie-based authentication, based on a browser’s ability to expose all cookies associated with a web page to JavaScript executed inside it. An attacker may inject some malicious JavaScript code into the page (Don’t ask me how … this will happen only if your entire HTML rendering is done wrong), and this code will gain access to the cookie. Then, the code will send the cookie somewhere else so the attacker can collect it. This type of attack is called &lt;a href=&quot;http://en.wikipedia.org/wiki/Cross-site_scripting&quot;&gt;cross-site scripting&lt;/a&gt; (XSS). To prevent this, there is another flag for the &lt;code&gt;Set-Cookie&lt;/code&gt; header, called &lt;code&gt;HttpOnly&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure; HttpOnly&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The presence of this flag will tell the browser that this particular cookie can be transferred back to the server only through HTTP requests. JavaScript won’t have access to it.&lt;/p&gt; &lt;h2 id=&quot;how-its-done-in-takes&quot;&gt;How It’s Done in Takes&lt;/h2&gt; &lt;p&gt;Here is how this cookie-based authentication mechanism is designed in the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework. The entire framework consists of &lt;em&gt;takes&lt;/em&gt;, which receive requests and produce responses (&lt;a href=&quot;/2015/03/22/takes-java-web-framework.html&quot;&gt;this article&lt;/a&gt; explains the framework in more detail). When the request comes in, we should find the authentication cookie in the &lt;code&gt;Cookie&lt;/code&gt; header and translate it to the user credentials. When the response goes out, we should add the &lt;code&gt;Set-Cookie&lt;/code&gt; header to it with the encrypted user credentials. That’s it. Just these two steps.&lt;/p&gt; &lt;p&gt;Let’s say we have an account page that is supposed to show the current user’s balance:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkAccount&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Balances&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;balances&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Identity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// get it from request&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsHTML&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Your balance is %s&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;balances&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;retrieve&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Right after the &lt;code&gt;request&lt;/code&gt; comes in, we should retrieve the identity of the user, encoded inside an authenticating cookie. To make this mechanism reusable, we have the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html&quot;&gt;&lt;code&gt;TkAuth&lt;/code&gt;&lt;/a&gt; decorator, which wraps an existing &lt;em&gt;take&lt;/em&gt;, decodes an incoming cookie, and adds a new &lt;code&gt;TkAuth&lt;/code&gt; header to the request with the user’s identification information:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Codec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;codec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()));&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Pass&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;codec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAccount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Again, when &lt;code&gt;TkAuth&lt;/code&gt; receives a request with an authenticating cookie inside, it asks &lt;code&gt;pass&lt;/code&gt; to decode the cookie and return either a valid &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html&quot;&gt;&lt;code&gt;Identity&lt;/code&gt;&lt;/a&gt; or &lt;code&gt;Identity.ANONYMOUS&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;Then, when the response goes back to the browser, &lt;code&gt;TkAuth&lt;/code&gt; asks &lt;code&gt;pass&lt;/code&gt; to encode the identity back into a string and adds &lt;code&gt;Set-Cookie&lt;/code&gt; to the response.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html&quot;&gt;&lt;code&gt;PsCookie&lt;/code&gt;&lt;/a&gt; uses an instance of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html&quot;&gt;&lt;code&gt;Codec&lt;/code&gt;&lt;/a&gt; in order to do these backward and forward encoding operations.&lt;/p&gt; &lt;p&gt;When our &lt;code&gt;TkAccount&lt;/code&gt; &lt;em&gt;take&lt;/em&gt; wants to retrieve a currently authenticated user identity from the request, it can use &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html&quot;&gt;&lt;code&gt;RqAuth&lt;/code&gt;&lt;/a&gt;, a utility decorator of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkAccount&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Identity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;identity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// other manipulations with the user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The &lt;code&gt;RqAuth&lt;/code&gt; decorator uses the header, added by &lt;code&gt;PsCookie&lt;/code&gt;, in order to authenticate the user and create an &lt;code&gt;Identity&lt;/code&gt; object.&lt;/p&gt; &lt;h2 id=&quot;how-is-it-composable&quot;&gt;How Is It Composable?&lt;/h2&gt; &lt;p&gt;This mechanism is indeed very extensible and “composable.” Let’s say we want to skip authentication during integration testing. Here is how:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;cm&quot;&gt;/* if running integration tests */&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html&quot;&gt;&lt;code&gt;PsChain&lt;/code&gt;&lt;/a&gt; implements &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html&quot;&gt;&lt;code&gt;Pass&lt;/code&gt;&lt;/a&gt; and attempts to authenticate the user by asking all encapsulated passes, one by one. The first one in the chain is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html&quot;&gt;&lt;code&gt;PsFake&lt;/code&gt;&lt;/a&gt;. Using a single boolean argument in its constructor, it makes a decision whether to return a fake identity or return nothing. With just a single boolean trigger, we can switch off the entire authentication mechanism in the app.&lt;/p&gt; &lt;p&gt;Let’s say you want to authenticate users through Facebook OAuth. Here is how:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API key ...&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API secret ...&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;When a user clicks on the login link on your site, the browser goes to &lt;code&gt;facebook.com&lt;/code&gt;, where his or her identity is verified. Then, Facebook returns a &lt;code&gt;302&lt;/code&gt; redirection response with a &lt;code&gt;Location&lt;/code&gt; header set to the URL we provide in the login link. The link must include something like this: &lt;code&gt;?PsByFlag=PsFacebook&lt;/code&gt;. This will tell &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html&quot;&gt;&lt;code&gt;PsByFlag&lt;/code&gt;&lt;/a&gt; that this request authenticates a user.&lt;/p&gt; &lt;p&gt;&lt;code&gt;PsByFlag&lt;/code&gt; will iterate through all encapsulated “pairs” and try to find the right one. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html&quot;&gt;&lt;code&gt;PsFacebook&lt;/code&gt;&lt;/a&gt; will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.&lt;/p&gt; &lt;p&gt;Here is how we can implement a logout mechanism:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API key ...&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API secret ...&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsLogout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsLogout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we can add &lt;code&gt;?PsByFlag=PsLogout&lt;/code&gt; to any link on the site and it will log the current user out.&lt;/p&gt; &lt;p&gt;You can see how all this works in a real application by checking out the &lt;a href=&quot;https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java&quot;&gt;&lt;code&gt;TkAppAuth&lt;/code&gt;&lt;/a&gt; class in &lt;a href=&quot;http://www.rultor.com&quot;&gt;Rultor&lt;/a&gt;.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2015-05-18 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="How Cookie-Based Authentication Works in the Takes Framework"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.takes.org&quot;&gt;&lt;img src=&quot;http://www.takes.org/logo.png&quot; style=&quot;width:96px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;When you enter your email and password into the Facebook login page, you get into your account. Then, wherever you go in the site, you always see your photo at the top right corner of the page. Facebook remembers you and doesn’t ask for the password again and again. This works thanks to &lt;a href=&quot;https://en.wikipedia.org/wiki/HTTP_cookie&quot;&gt;HTTP cookies&lt;/a&gt; and is called &lt;strong&gt;cookie-based authentication&lt;/strong&gt;. Even though this mechanism often causes some security problems, it is very popular and simple. Here is how &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; makes it possible in a few lines of code.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, let’s see how it works. Moreover, let’s see how I believe it should work.&lt;/p&gt; &lt;p&gt;Step one: The user enters an email and password and clicks “submit.” The server receives a POST request with this information inside:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;POST / HTTP/1.1 Host: www.facebook.com Content-Type: application/x-www-form-urlencoded email=me@yegor256.com&amp;amp;password=itisasecret&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server matches the provided information with its records and decides what to do. If the information is invalid, it returns the same login page, asking you to enter it all again. If the information is valid, the server returns something like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Since the response status code is 303, the browser goes to the page specified in the &lt;code&gt;Location&lt;/code&gt; header and opens the front page of the site. This is what it sends to the server:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET / HTTP/1.1 Host: www.facebook.com Cookie: user=me@yegor256.com&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The server gets my email from the &lt;code&gt;Cookie&lt;/code&gt; header and understands that it’s me again! No need to ask for the password once more. The server trusts the information from the cookie. That’s it. That’s what cookie-based authentication is all about.&lt;/p&gt; &lt;h2 id=&quot;wait--what-about-security&quot;&gt;Wait … What About Security?&lt;/h2&gt; &lt;p&gt;Right, what about security? If the server trusts any browser request with a user email in the &lt;code&gt;Cookie&lt;/code&gt; header, anyone would be able to send my email from another place and get access to my account.&lt;/p&gt; &lt;p&gt;The first step to prevent this is to encrypt the email with a secret encryption key, known only to the server. Nobody except the server itself will be able to encrypt it the same way the server needs to decrypt it. The response would look like this, using an example of encryption by &lt;a href=&quot;https://en.wikipedia.org/wiki/XOR_cipher&quot;&gt;XOR cipher&lt;/a&gt; with &lt;code&gt;bamboo&lt;/code&gt; as a secret key:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This is not the best encryption mechanism, though; for proper encryption, it’s better to use something stronger like &lt;a href=&quot;https://en.wikipedia.org/wiki/Data_Encryption_Standard&quot;&gt;DES&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;This all sounds good, but what if someone hijacks the traffic between the server and the browser and gets a hold of a properly encrypted email cookie? In this case, the thief would be able to use the same cookie for authentication even without knowing its content. The server would trust the information and let the person into my account. This type of attack is called &lt;a href=&quot;http://en.wikipedia.org/wiki/Man-in-the-middle_attack&quot;&gt;man-in-the-middle&lt;/a&gt; (MITM). To prevent this from happening, we should use HTTPS and inform the browser that the cookie is sensitive and should never be returned to the server without SSL encryption. That’s done by an extra flag in the &lt;code&gt;Set-Cookie&lt;/code&gt; header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;There is yet another type of attack associated with cookie-based authentication, based on a browser’s ability to expose all cookies associated with a web page to JavaScript executed inside it. An attacker may inject some malicious JavaScript code into the page (Don’t ask me how … this will happen only if your entire HTML rendering is done wrong), and this code will gain access to the cookie. Then, the code will send the cookie somewhere else so the attacker can collect it. This type of attack is called &lt;a href=&quot;http://en.wikipedia.org/wiki/Cross-site_scripting&quot;&gt;cross-site scripting&lt;/a&gt; (XSS). To prevent this, there is another flag for the &lt;code&gt;Set-Cookie&lt;/code&gt; header, called &lt;code&gt;HttpOnly&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure; HttpOnly&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The presence of this flag will tell the browser that this particular cookie can be transferred back to the server only through HTTP requests. JavaScript won’t have access to it.&lt;/p&gt; &lt;h2 id=&quot;how-its-done-in-takes&quot;&gt;How It’s Done in Takes&lt;/h2&gt; &lt;p&gt;Here is how this cookie-based authentication mechanism is designed in the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework. The entire framework consists of &lt;em&gt;takes&lt;/em&gt;, which receive requests and produce responses (&lt;a href=&quot;/2015/03/22/takes-java-web-framework.html&quot;&gt;this article&lt;/a&gt; explains the framework in more detail). When the request comes in, we should find the authentication cookie in the &lt;code&gt;Cookie&lt;/code&gt; header and translate it to the user credentials. When the response goes out, we should add the &lt;code&gt;Set-Cookie&lt;/code&gt; header to it with the encrypted user credentials. That’s it. Just these two steps.&lt;/p&gt; &lt;p&gt;Let’s say we have an account page that is supposed to show the current user’s balance:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkAccount&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Balances&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;balances&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Identity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// get it from request&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsHTML&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Your balance is %s&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;balances&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;retrieve&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Right after the &lt;code&gt;request&lt;/code&gt; comes in, we should retrieve the identity of the user, encoded inside an authenticating cookie. To make this mechanism reusable, we have the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html&quot;&gt;&lt;code&gt;TkAuth&lt;/code&gt;&lt;/a&gt; decorator, which wraps an existing &lt;em&gt;take&lt;/em&gt;, decodes an incoming cookie, and adds a new &lt;code&gt;TkAuth&lt;/code&gt; header to the request with the user’s identification information:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Codec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;codec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()));&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Pass&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;codec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAccount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pass&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Again, when &lt;code&gt;TkAuth&lt;/code&gt; receives a request with an authenticating cookie inside, it asks &lt;code&gt;pass&lt;/code&gt; to decode the cookie and return either a valid &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html&quot;&gt;&lt;code&gt;Identity&lt;/code&gt;&lt;/a&gt; or &lt;code&gt;Identity.ANONYMOUS&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;Then, when the response goes back to the browser, &lt;code&gt;TkAuth&lt;/code&gt; asks &lt;code&gt;pass&lt;/code&gt; to encode the identity back into a string and adds &lt;code&gt;Set-Cookie&lt;/code&gt; to the response.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html&quot;&gt;&lt;code&gt;PsCookie&lt;/code&gt;&lt;/a&gt; uses an instance of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html&quot;&gt;&lt;code&gt;Codec&lt;/code&gt;&lt;/a&gt; in order to do these backward and forward encoding operations.&lt;/p&gt; &lt;p&gt;When our &lt;code&gt;TkAccount&lt;/code&gt; &lt;em&gt;take&lt;/em&gt; wants to retrieve a currently authenticated user identity from the request, it can use &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html&quot;&gt;&lt;code&gt;RqAuth&lt;/code&gt;&lt;/a&gt;, a utility decorator of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkAccount&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Identity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;identity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// other manipulations with the user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The &lt;code&gt;RqAuth&lt;/code&gt; decorator uses the header, added by &lt;code&gt;PsCookie&lt;/code&gt;, in order to authenticate the user and create an &lt;code&gt;Identity&lt;/code&gt; object.&lt;/p&gt; &lt;h2 id=&quot;how-is-it-composable&quot;&gt;How Is It Composable?&lt;/h2&gt; &lt;p&gt;This mechanism is indeed very extensible and “composable.” Let’s say we want to skip authentication during integration testing. Here is how:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;cm&quot;&gt;/* if running integration tests */&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html&quot;&gt;&lt;code&gt;PsChain&lt;/code&gt;&lt;/a&gt; implements &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html&quot;&gt;&lt;code&gt;Pass&lt;/code&gt;&lt;/a&gt; and attempts to authenticate the user by asking all encapsulated passes, one by one. The first one in the chain is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html&quot;&gt;&lt;code&gt;PsFake&lt;/code&gt;&lt;/a&gt;. Using a single boolean argument in its constructor, it makes a decision whether to return a fake identity or return nothing. With just a single boolean trigger, we can switch off the entire authentication mechanism in the app.&lt;/p&gt; &lt;p&gt;Let’s say you want to authenticate users through Facebook OAuth. Here is how:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API key ...&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API secret ...&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;When a user clicks on the login link on your site, the browser goes to &lt;code&gt;facebook.com&lt;/code&gt;, where his or her identity is verified. Then, Facebook returns a &lt;code&gt;302&lt;/code&gt; redirection response with a &lt;code&gt;Location&lt;/code&gt; header set to the URL we provide in the login link. The link must include something like this: &lt;code&gt;?PsByFlag=PsFacebook&lt;/code&gt;. This will tell &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html&quot;&gt;&lt;code&gt;PsByFlag&lt;/code&gt;&lt;/a&gt; that this request authenticates a user.&lt;/p&gt; &lt;p&gt;&lt;code&gt;PsByFlag&lt;/code&gt; will iterate through all encapsulated “pairs” and try to find the right one. &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html&quot;&gt;&lt;code&gt;PsFacebook&lt;/code&gt;&lt;/a&gt; will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.&lt;/p&gt; &lt;p&gt;Here is how we can implement a logout mechanism:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// original application &amp;quot;take&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsChain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsFacebook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API key ...&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;... Facebook API secret ...&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsByFlag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Pair&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsLogout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSimpleName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsLogout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PsCookie&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcHex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcXOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CcPlain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, we can add &lt;code&gt;?PsByFlag=PsLogout&lt;/code&gt; to any link on the site and it will log the current user out.&lt;/p&gt; &lt;p&gt;You can see how all this works in a real application by checking out the &lt;a href=&quot;https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java&quot;&gt;&lt;code&gt;TkAppAuth&lt;/code&gt;&lt;/a&gt; class in &lt;a href=&quot;http://www.rultor.com&quot;&gt;Rultor&lt;/a&gt;.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" /> <link rel="amphtml" href="https://www.yegor256.com/2015/05/18/cookie-based-authentication.amp.html" /> <title>How Cookie-Based Authentication Works in the Takes Framework </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2015/05/18/cookie-based-authentication.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2015/05/18/cookie-based-authentication.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2015/05/18/cookie-based-authentication.html</code></p><h1 itemprop="name headline mainEntityOfPage">How Cookie-Based Authentication Works in the Takes Framework</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2015-05-18T00:00:00+00:00"> 18 May 2015 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.takes.org"><img src="http://www.takes.org/logo.png" style="width:96px;max-width:100%;" alt="badge" /></a></figure><p>When you enter your email and password into the Facebook login page, you get into your account. Then, wherever you go in the site, you always see your photo at the top right corner of the page. Facebook remembers you and doesn’t ask for the password again and again. This works thanks to <a href="https://en.wikipedia.org/wiki/HTTP_cookie">HTTP cookies</a> and is called <strong>cookie-based authentication</strong>. Even though this mechanism often causes some security problems, it is very popular and simple. Here is how <a href="http://www.takes.org">Takes</a> makes it possible in a few lines of code.</p><p>First, let’s see how it works. Moreover, let’s see how I believe it should work.</p><p>Step one: The user enters an email and password and clicks “submit.” The server receives a POST request with this information inside:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>POST / HTTP/1.1
Host: www.facebook.com
Content-Type: application/x-www-form-urlencoded

email=me@yegor256.com&amp;password=itisasecret</code></pre></figure><p>The server matches the provided information with its records and decides what to do. If the information is invalid, it returns the same login page, asking you to enter it all again. If the information is valid, the server returns something like this:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com</code></pre></figure><p>Since the response status code is 303, the browser goes to the page specified in the <code>Location</code> header and opens the front page of the site. This is what it sends to the server:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET / HTTP/1.1
Host: www.facebook.com
Cookie: user=me@yegor256.com</code></pre></figure><p>The server gets my email from the <code>Cookie</code> header and understands that it’s me again! No need to ask for the password once more. The server trusts the information from the cookie. That’s it. That’s what cookie-based authentication is all about.</p><h2 id="wait--what-about-security">Wait … What About Security?</h2><p>Right, what about security? If the server trusts any browser request with a user email in the <code>Cookie</code> header, anyone would be able to send my email from another place and get access to my account.</p><p>The first step to prevent this is to encrypt the email with a secret encryption key, known only to the server. Nobody except the server itself will be able to encrypt it the same way the server needs to decrypt it. The response would look like this, using an example of encryption by <a href="https://en.wikipedia.org/wiki/XOR_cipher">XOR cipher</a> with <code>bamboo</code> as a secret key:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39</code></pre></figure><p>This is not the best encryption mechanism, though; for proper encryption, it’s better to use something stronger like <a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>.</p><p>This all sounds good, but what if someone hijacks the traffic between the server and the browser and gets a hold of a properly encrypted email cookie? In this case, the thief would be able to use the same cookie for authentication even without knowing its content. The server would trust the information and let the person into my account. This type of attack is called <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> (MITM). To prevent this from happening, we should use HTTPS and inform the browser that the cookie is sensitive and should never be returned to the server without SSL encryption. That’s done by an extra flag in the <code>Set-Cookie</code> header:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure</code></pre></figure><p>There is yet another type of attack associated with cookie-based authentication, based on a browser’s ability to expose all cookies associated with a web page to JavaScript executed inside it. An attacker may inject some malicious JavaScript code into the page (Don’t ask me how … this will happen only if your entire HTML rendering is done wrong), and this code will gain access to the cookie. Then, the code will send the cookie somewhere else so the attacker can collect it. This type of attack is called <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a> (XSS). To prevent this, there is another flag for the <code>Set-Cookie</code> header, called <code>HttpOnly</code>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure; HttpOnly</code></pre></figure><p>The presence of this flag will tell the browser that this particular cookie can be transferred back to the server only through HTTP requests. JavaScript won’t have access to it.</p><h2 id="how-its-done-in-takes">How It’s Done in Takes</h2><p>Here is how this cookie-based authentication mechanism is designed in the <a href="http://www.takes.org">Takes</a> framework. The entire framework consists of <em>takes</em>, which receive requests and produce responses (<a href="/2015/03/22/takes-java-web-framework.html">this article</a> explains the framework in more detail). When the request comes in, we should find the authentication cookie in the <code>Cookie</code> header and translate it to the user credentials. When the response goes out, we should add the <code>Set-Cookie</code> header to it with the encrypted user credentials. That’s it. Just these two steps.</p><p>Let’s say we have an account page that is supposed to show the current user’s balance:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Balances</span> <span class="n">balances</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="c1">// get it from request</span>
    <span class="k">return</span> <span class="n">RsHTML</span><span class="o">(</span>
      <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
        <span class="s">&quot;&lt;html&gt;Your balance is %s&lt;/html&gt;&quot;</span><span class="o">,</span>
        <span class="k">this</span><span class="o">.</span><span class="na">balances</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Right after the <code>request</code> comes in, we should retrieve the identity of the user, encoded inside an authenticating cookie. To make this mechanism reusable, we have the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html"><code>TkAuth</code></a> decorator, which wraps an existing <em>take</em>, decodes an incoming cookie, and adds a new <code>TkAuth</code> header to the request with the user’s identification information:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">Codec</span> <span class="n">codec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()));</span>
<span class="kd">final</span> <span class="n">Pass</span> <span class="n">pass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span><span class="n">codec</span><span class="o">);</span>
<span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span><span class="k">new</span> <span class="n">TkAccount</span><span class="o">(),</span> <span class="n">pass</span><span class="o">);</span></code></pre></figure><p>Again, when <code>TkAuth</code> receives a request with an authenticating cookie inside, it asks <code>pass</code> to decode the cookie and return either a valid <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html"><code>Identity</code></a> or <code>Identity.ANONYMOUS</code>.</p><p>Then, when the response goes back to the browser, <code>TkAuth</code> asks <code>pass</code> to encode the identity back into a string and adds <code>Set-Cookie</code> to the response.</p><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html"><code>PsCookie</code></a> uses an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html"><code>Codec</code></a> in order to do these backward and forward encoding operations.</p><p>When our <code>TkAccount</code> <em>take</em> wants to retrieve a currently authenticated user identity from the request, it can use <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html"><code>RqAuth</code></a>, a utility decorator of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqAuth</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">identity</span><span class="o">();</span>
    <span class="c1">// other manipulations with the user</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The <code>RqAuth</code> decorator uses the header, added by <code>PsCookie</code>, in order to authenticate the user and create an <code>Identity</code> object.</p><h2 id="how-is-it-composable">How Is It Composable?</h2><p>This mechanism is indeed very extensible and “composable.” Let’s say we want to skip authentication during integration testing. Here is how:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsFake</span><span class="o">(</span><span class="cm">/* if running integration tests */</span><span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html"><code>PsChain</code></a> implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html"><code>Pass</code></a> and attempts to authenticate the user by asking all encapsulated passes, one by one. The first one in the chain is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html"><code>PsFake</code></a>. Using a single boolean argument in its constructor, it makes a decision whether to return a fake identity or return nothing. With just a single boolean trigger, we can switch off the entire authentication mechanism in the app.</p><p>Let’s say you want to authenticate users through Facebook OAuth. Here is how:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsFacebook</span><span class="o">(</span>
          <span class="s">&quot;... Facebook API key ...&quot;</span><span class="o">,</span>
          <span class="s">&quot;... Facebook API secret ...&quot;</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>When a user clicks on the login link on your site, the browser goes to <code>facebook.com</code>, where his or her identity is verified. Then, Facebook returns a <code>302</code> redirection response with a <code>Location</code> header set to the URL we provide in the login link. The link must include something like this: <code>?PsByFlag=PsFacebook</code>. This will tell <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html"><code>PsByFlag</code></a> that this request authenticates a user.</p><p><code>PsByFlag</code> will iterate through all encapsulated “pairs” and try to find the right one. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html"><code>PsFacebook</code></a> will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.</p><p>Here is how we can implement a logout mechanism:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsFacebook</span><span class="o">(</span>
          <span class="s">&quot;... Facebook API key ...&quot;</span><span class="o">,</span>
          <span class="s">&quot;... Facebook API secret ...&quot;</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsLogout</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsLogout</span><span class="o">()</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Now, we can add <code>?PsByFlag=PsLogout</code> to any link on the site and it will log the current user out.</p><p>You can see how all this works in a real application by checking out the <a href="https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java"><code>TkAppAuth</code></a> class in <a href="http://www.rultor.com">Rultor</a>.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html&amp;text=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html%3F2015-20&amp;title=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html%3F2015-20&amp;t=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.takes.org"><img src="http://www.takes.org/logo.png" style="width:96px;max-width:100%;" alt="badge" /></a></figure><p>When you enter your email and password into the Facebook login page, you get into your account. Then, wherever you go in the site, you always see your photo at the top right corner of the page. Facebook remembers you and doesn’t ask for the password again and again. This works thanks to <a href="https://en.wikipedia.org/wiki/HTTP_cookie">HTTP cookies</a> and is called <strong>cookie-based authentication</strong>. Even though this mechanism often causes some security problems, it is very popular and simple. Here is how <a href="http://www.takes.org">Takes</a> makes it possible in a few lines of code.</p><p>First, let’s see how it works. Moreover, let’s see how I believe it should work.</p><p>Step one: The user enters an email and password and clicks “submit.” The server receives a POST request with this information inside:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>POST / HTTP/1.1
Host: www.facebook.com
Content-Type: application/x-www-form-urlencoded

email=me@yegor256.com&amp;password=itisasecret</code></pre></figure><p>The server matches the provided information with its records and decides what to do. If the information is invalid, it returns the same login page, asking you to enter it all again. If the information is valid, the server returns something like this:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com</code></pre></figure><p>Since the response status code is 303, the browser goes to the page specified in the <code>Location</code> header and opens the front page of the site. This is what it sends to the server:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET / HTTP/1.1
Host: www.facebook.com
Cookie: user=me@yegor256.com</code></pre></figure><p>The server gets my email from the <code>Cookie</code> header and understands that it’s me again! No need to ask for the password once more. The server trusts the information from the cookie. That’s it. That’s what cookie-based authentication is all about.</p><h2 id="wait--what-about-security">Wait … What About Security?</h2><p>Right, what about security? If the server trusts any browser request with a user email in the <code>Cookie</code> header, anyone would be able to send my email from another place and get access to my account.</p><p>The first step to prevent this is to encrypt the email with a secret encryption key, known only to the server. Nobody except the server itself will be able to encrypt it the same way the server needs to decrypt it. The response would look like this, using an example of encryption by <a href="https://en.wikipedia.org/wiki/XOR_cipher">XOR cipher</a> with <code>bamboo</code> as a secret key:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39</code></pre></figure><p>This is not the best encryption mechanism, though; for proper encryption, it’s better to use something stronger like <a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>.</p><p>This all sounds good, but what if someone hijacks the traffic between the server and the browser and gets a hold of a properly encrypted email cookie? In this case, the thief would be able to use the same cookie for authentication even without knowing its content. The server would trust the information and let the person into my account. This type of attack is called <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> (MITM). To prevent this from happening, we should use HTTPS and inform the browser that the cookie is sensitive and should never be returned to the server without SSL encryption. That’s done by an extra flag in the <code>Set-Cookie</code> header:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure</code></pre></figure><p>There is yet another type of attack associated with cookie-based authentication, based on a browser’s ability to expose all cookies associated with a web page to JavaScript executed inside it. An attacker may inject some malicious JavaScript code into the page (Don’t ask me how … this will happen only if your entire HTML rendering is done wrong), and this code will gain access to the cookie. Then, the code will send the cookie somewhere else so the attacker can collect it. This type of attack is called <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a> (XSS). To prevent this, there is another flag for the <code>Set-Cookie</code> header, called <code>HttpOnly</code>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure; HttpOnly</code></pre></figure><p>The presence of this flag will tell the browser that this particular cookie can be transferred back to the server only through HTTP requests. JavaScript won’t have access to it.</p><h2 id="how-its-done-in-takes">How It’s Done in Takes</h2><p>Here is how this cookie-based authentication mechanism is designed in the <a href="http://www.takes.org">Takes</a> framework. The entire framework consists of <em>takes</em>, which receive requests and produce responses (<a href="/2015/03/22/takes-java-web-framework.html">this article</a> explains the framework in more detail). When the request comes in, we should find the authentication cookie in the <code>Cookie</code> header and translate it to the user credentials. When the response goes out, we should add the <code>Set-Cookie</code> header to it with the encrypted user credentials. That’s it. Just these two steps.</p><p>Let’s say we have an account page that is supposed to show the current user’s balance:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Balances</span> <span class="n">balances</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="c1">// get it from request</span>
    <span class="k">return</span> <span class="n">RsHTML</span><span class="o">(</span>
      <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
        <span class="s">&quot;&lt;html&gt;Your balance is %s&lt;/html&gt;&quot;</span><span class="o">,</span>
        <span class="k">this</span><span class="o">.</span><span class="na">balances</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Right after the <code>request</code> comes in, we should retrieve the identity of the user, encoded inside an authenticating cookie. To make this mechanism reusable, we have the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html"><code>TkAuth</code></a> decorator, which wraps an existing <em>take</em>, decodes an incoming cookie, and adds a new <code>TkAuth</code> header to the request with the user’s identification information:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">Codec</span> <span class="n">codec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()));</span>
<span class="kd">final</span> <span class="n">Pass</span> <span class="n">pass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span><span class="n">codec</span><span class="o">);</span>
<span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span><span class="k">new</span> <span class="n">TkAccount</span><span class="o">(),</span> <span class="n">pass</span><span class="o">);</span></code></pre></figure><p>Again, when <code>TkAuth</code> receives a request with an authenticating cookie inside, it asks <code>pass</code> to decode the cookie and return either a valid <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html"><code>Identity</code></a> or <code>Identity.ANONYMOUS</code>.</p><p>Then, when the response goes back to the browser, <code>TkAuth</code> asks <code>pass</code> to encode the identity back into a string and adds <code>Set-Cookie</code> to the response.</p><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html"><code>PsCookie</code></a> uses an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html"><code>Codec</code></a> in order to do these backward and forward encoding operations.</p><p>When our <code>TkAccount</code> <em>take</em> wants to retrieve a currently authenticated user identity from the request, it can use <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html"><code>RqAuth</code></a>, a utility decorator of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqAuth</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">identity</span><span class="o">();</span>
    <span class="c1">// other manipulations with the user</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The <code>RqAuth</code> decorator uses the header, added by <code>PsCookie</code>, in order to authenticate the user and create an <code>Identity</code> object.</p><h2 id="how-is-it-composable">How Is It Composable?</h2><p>This mechanism is indeed very extensible and “composable.” Let’s say we want to skip authentication during integration testing. Here is how:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsFake</span><span class="o">(</span><span class="cm">/* if running integration tests */</span><span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html"><code>PsChain</code></a> implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html"><code>Pass</code></a> and attempts to authenticate the user by asking all encapsulated passes, one by one. The first one in the chain is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html"><code>PsFake</code></a>. Using a single boolean argument in its constructor, it makes a decision whether to return a fake identity or return nothing. With just a single boolean trigger, we can switch off the entire authentication mechanism in the app.</p><p>Let’s say you want to authenticate users through Facebook OAuth. Here is how:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsFacebook</span><span class="o">(</span>
          <span class="s">&quot;... Facebook API key ...&quot;</span><span class="o">,</span>
          <span class="s">&quot;... Facebook API secret ...&quot;</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>When a user clicks on the login link on your site, the browser goes to <code>facebook.com</code>, where his or her identity is verified. Then, Facebook returns a <code>302</code> redirection response with a <code>Location</code> header set to the URL we provide in the login link. The link must include something like this: <code>?PsByFlag=PsFacebook</code>. This will tell <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html"><code>PsByFlag</code></a> that this request authenticates a user.</p><p><code>PsByFlag</code> will iterate through all encapsulated “pairs” and try to find the right one. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html"><code>PsFacebook</code></a> will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.</p><p>Here is how we can implement a logout mechanism:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="k">new</span> <span class="n">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application &quot;take&quot;</span>
  <span class="k">new</span> <span class="n">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsFacebook</span><span class="o">(</span>
          <span class="s">&quot;... Facebook API key ...&quot;</span><span class="o">,</span>
          <span class="s">&quot;... Facebook API secret ...&quot;</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="k">new</span> <span class="n">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="n">PsLogout</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="n">PsLogout</span><span class="o">()</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="n">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="n">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="n">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span></code></pre></figure><p>Now, we can add <code>?PsByFlag=PsLogout</code> to any link on the site and it will log the current user out.</p><p>You can see how all this works in a real application by checking out the <a href="https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java"><code>TkAppAuth</code></a> class in <a href="http://www.rultor.com">Rultor</a>.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;p&gt;I used to utilize Servlets, JSP, JAX-RS, Spring Framework, Play Framework, JSF with Facelets, and a bit of Spark Framework. All of these solutions, in my humble opinion, are very far from being object-oriented and elegant. They all are full of static methods, un-testable data structures, and dirty hacks. So about a month ago, I decided to create my own Java web framework. I put a few basic principles into its foundation: 1) No &lt;a href=&quot;/2014/05/13/why-null-is-bad.html&quot;&gt;NULLs&lt;/a&gt;, 2) no public &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;static&lt;/a&gt; methods, 3) no &lt;a href=&quot;/2014/06/09/objects-should-be-immutable.html&quot;&gt;mutable&lt;/a&gt; classes, and 4) no class casting, reflection, and &lt;a href=&quot;/2015/04/02/class-casting-is-anti-pattern.html&quot;&gt;&lt;code&gt;instanceof&lt;/code&gt;&lt;/a&gt; operators. These four basic principles should guarantee clean code and transparent architecture. That’s how the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework was born. Let’s see what was created and how it works.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Making of The Godfather (1972) by Francis Ford Coppola&quot; src=&quot;/images/2015/03/godfather-shooting-scene.jpg&quot; longdesc=&quot;#9fedcf46&quot; /&gt;&lt;figcaption id=&quot;9fedcf46&quot;&gt;Making of The Godfather (1972) by Francis Ford Coppola&lt;/figcaption&gt;&lt;/figure&gt; &lt;h2 id=&quot;java-web-architecture-in-a-nutshell&quot;&gt;Java Web Architecture in a Nutshell&lt;/h2&gt; &lt;p&gt;This is how I understand a web application architecture and its components, in simple terms.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=nheD2LNYrpk&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg&quot; alt=&quot;YouTube video #nheD2LNYrpk&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;First, to create a web server, we should create a new &lt;a href=&quot;http://en.wikipedia.org/wiki/Network_socket&quot;&gt;network socket&lt;/a&gt;, that accepts connections on a certain &lt;a href=&quot;http://en.wikipedia.org/wiki/Port_%28computer_networking%29&quot;&gt;TCP port&lt;/a&gt;. Usually it is 80, but I’m going to use 8080 for testing purposes. This is done in Java with the &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html&quot;&gt;&lt;code&gt;ServerSocket&lt;/code&gt;&lt;/a&gt; class:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s enough to start a web server. Now, the socket is ready and listening on port 8080. When someone opens &lt;code&gt;http://localhost:8080&lt;/code&gt; in their browser, the connection will be established and the browser will spin its waiting wheel forever. Compile this snippet and try. We just built a simple web server without the use of any frameworks. We’re not doing anything with incoming connections yet, but we’re not rejecting them either. All of them are being lined up inside that &lt;code&gt;server&lt;/code&gt; object. It’s being done in a background thread; that’s why we need to put that &lt;code&gt;while(true)&lt;/code&gt; in afterward. Without this endless pause, the app will finish its execution immediately and the server socket will shut down.&lt;/p&gt; &lt;p&gt;The next step is to accept the incoming connections. In Java, that’s done through a blocking call to the &lt;code&gt;accept()&lt;/code&gt; method:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The method is blocking its thread and waiting until a new connection arrives. As soon as that happens, it returns an instance of &lt;code&gt;Socket&lt;/code&gt;. In order to accept the next connection, we should call &lt;code&gt;accept()&lt;/code&gt; again. So basically, our web server should work like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 1. Read HTTP request from the socket&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 2. Prepare an HTTP response&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 3. Send HTTP response to the socket&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 4. Close the socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It’s an endless cycle that accepts a new connection, understands it, creates a response, returns the response, and accepts a new connection again. HTTP protocol is stateless, which means the server should not remember what happened in any previous connection. All it cares about is the incoming HTTP request in this particular connection.&lt;/p&gt; &lt;p&gt;The HTTP request is coming from the input stream of the socket and looks like a multi-line block of text. This is what you would see if you read an input stream of the socket:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufferedReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufferedReader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStreamReader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readLine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;You will see something like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET / HTTP/1.1 Host: localhost:8080 Connection: keep-alive Cache-Control: max-age=0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36 Accept-Encoding: gzip, deflate, sdch Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The client (the Google Chrome browser, for example) passes this text into the connection established. It connects to port 8080 at &lt;code&gt;localhost&lt;/code&gt;, and as soon as the connection is ready, it immediately sends this text into it, then waits for a response.&lt;/p&gt; &lt;p&gt;Our job is to create an HTTP response using the information we get in the request. If our server is very primitive, we can basically ignore all the information in the request and just return “Hello, world!” to all requests (I’m using &lt;a href=&quot;https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/IOUtils.html&quot;&gt;&lt;code&gt;IOUtils&lt;/code&gt;&lt;/a&gt; for simplicity):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.Socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.apache.commons.io.IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toInputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;HTTP/1.1 200 OK\r\n\r\nHello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getOutputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s it. The server is ready. Try to compile and run it. Point your browser to &lt;code&gt;http://localhost:8080&lt;/code&gt;, and you will see &lt;code&gt;Hello, world!&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ javac -cp commons-io.jar Foo.java $ java -cp commons-io.jar:. Foo &lt;span class=&quot;p&quot;&gt;&amp;amp;&lt;/span&gt; $ curl http://localhost:8080 -v * Rebuilt URL to: http://localhost:8080/ * Connected to localhost &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;::1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; port &lt;span class=&quot;m&quot;&gt;8080&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;#0)&lt;/span&gt; &amp;gt; GET / HTTP/1.1 &amp;gt; User-Agent: curl/7.37.1 &amp;gt; Host: localhost:8080 &amp;gt; Accept: */* &amp;gt; &amp;lt; HTTP/1.1 &lt;span class=&quot;m&quot;&gt;200&lt;/span&gt; OK * no chunk, no close, no size. Assume close to signal end &amp;lt; * Closing connection &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; Hello, world!&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s all you need to build a web server. Now let’s discuss how to make it object-oriented and composable. Let’s try to see how the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework was built.&lt;/p&gt; &lt;h2 id=&quot;routingdispatching&quot;&gt;Routing/Dispatching&lt;/h2&gt; &lt;p&gt;Routing/dispatching is combined with response printing in Takes. All you need to do to create a working web application is to create a single class that implements &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Take.html&quot;&gt;&lt;code&gt;Take&lt;/code&gt;&lt;/a&gt; interface:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkFoo&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;And now it’s time to start a server:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtBasic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtBasic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFoo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html&quot;&gt;&lt;code&gt;FtBasic&lt;/code&gt;&lt;/a&gt; class does the exact same socket manipulations explained above. It starts a server socket on port 8080 and dispatches all incoming connections through an instance of &lt;code&gt;TkFoo&lt;/code&gt; that we are giving to its constructor. It does this dispatching in an endless cycle, checking every second whether it’s time to stop with an instance of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/Exit.html&quot;&gt;&lt;code&gt;Exit&lt;/code&gt;&lt;/a&gt;. Obviously, &lt;code&gt;Exit.NEVER&lt;/code&gt; always responds with, “Don’t stop, please.”&lt;/p&gt; &lt;h2 id=&quot;http-request&quot;&gt;HTTP Request&lt;/h2&gt; &lt;p&gt;Now let’s see what’s inside the HTTP request arriving at &lt;code&gt;TkFoo&lt;/code&gt; and what we can get out of it. This is how the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt; interface is defined in &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStream&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The request is divided into two parts: the head and the body. The head contains all lines that go before the empty line that starts a body, according to HTTP specification in &lt;a href=&quot;http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html&quot;&gt;RFC 2616&lt;/a&gt;. There are many useful decorators for &lt;code&gt;Request&lt;/code&gt; in the framework. For example, &lt;code&gt;RqMethod&lt;/code&gt; will help you get the method name from the first line of the header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;method&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;code&gt;RqHref&lt;/code&gt; will help extract the query part and parse it. For example, this is the request:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;123&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.1&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;Host:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;example&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;com&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This code will extract that &lt;code&gt;123&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Integer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqHref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;param&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;code&gt;RqPrint&lt;/code&gt; can get the entire request or its body printed as a &lt;code&gt;String&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqPrint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The idea here is to keep the &lt;code&gt;Request&lt;/code&gt; interface simple and provide this request parsing functionality to its decorators. This approach helps the framework keep classes small and cohesive. Each decorator is very small and solid, doing exactly one thing. All of these decorators are in the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rq/package-summary.html&quot;&gt;&lt;code&gt;org.takes.rq&lt;/code&gt;&lt;/a&gt; package. As you already probably understand, the &lt;code&gt;Rq&lt;/code&gt; prefix stands for &lt;code&gt;Request&lt;/code&gt;.&lt;/p&gt; &lt;h2 id=&quot;first-real-web-app&quot;&gt;First Real Web App&lt;/h2&gt; &lt;p&gt;Let’s create our first real web application, which will do something useful. I would recommend starting with an &lt;code&gt;Entry&lt;/code&gt; class, which is required by Java to start an app from the command line:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This class contains just a single &lt;code&gt;main()&lt;/code&gt; static method that will be called by JVM when the app starts from the command line. As you see, it instantiates &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtCli.html&quot;&gt;&lt;code&gt;FtCli&lt;/code&gt;&lt;/a&gt;, giving it an instance of class &lt;code&gt;TkApp&lt;/code&gt; and command line arguments. We’ll create the &lt;code&gt;TkApp&lt;/code&gt; class in a second. &lt;code&gt;FtCli&lt;/code&gt; (translates to “front-end with command line interface”) makes an instance of the same &lt;code&gt;FtBasic&lt;/code&gt;, wrapping it into a few useful decorators and configuring it according to command line arguments. For example, &lt;code&gt;--port=8080&lt;/code&gt; will be converted into a &lt;code&gt;8080&lt;/code&gt; port number and passed as a second argument of the &lt;code&gt;FtBasic&lt;/code&gt; constructor.&lt;/p&gt; &lt;p&gt;The web application itself is called &lt;code&gt;TkApp&lt;/code&gt; and extends &lt;code&gt;TsWrap&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.facets.fork.FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.facets.fork.TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkWrap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkClasspath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/robots.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/css/.*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkClasspath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We’ll discuss this &lt;code&gt;TkFork&lt;/code&gt; class in a minute.&lt;/p&gt; &lt;p&gt;If you’re using Maven, this is the &lt;code&gt;pom.xml&lt;/code&gt; you should start with:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://maven.apache.org/POM/4.0.0&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns:xsi=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xsi:schemaLocation=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://maven.apache.org/POM/4.0.0&lt;/span&gt; &lt;span class=&quot;s&quot;&gt; http://maven.apache.org/xsd/maven-4.0.0.xsd&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;modelVersion&amp;gt;&lt;/span&gt;4.0.0&lt;span class=&quot;nt&quot;&gt;&amp;lt;/modelVersion&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;1.0-SNAPSHOT&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependencies&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.takes&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;takes&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.9&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- check the latest in Maven Central --&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependencies&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;build&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;finalName&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/finalName&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;plugins&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;plugin&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;maven-dependency-plugin&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;executions&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;execution&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;goals&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;goal&amp;gt;&lt;/span&gt;copy-dependencies&lt;span class=&quot;nt&quot;&gt;&amp;lt;/goal&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/goals&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;configuration&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;outputDirectory&amp;gt;&lt;/span&gt;${project.build.directory}/deps&lt;span class=&quot;nt&quot;&gt;&amp;lt;/outputDirectory&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/execution&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/executions&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/plugin&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/plugins&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/build&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/project&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Running &lt;code&gt;mvn clean package&lt;/code&gt; should build a &lt;code&gt;foo.jar&lt;/code&gt; file in &lt;code&gt;target&lt;/code&gt; directory and a collection of all JAR dependencies in &lt;code&gt;target/deps&lt;/code&gt;. Now you can run the app from the command line:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ mvn clean package $ java -Dfile.encoding&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTF-8 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; -cp ./target/foo.jar:./target/deps/* foo.Entry --port&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8080&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The application is ready, and you can deploy it to, say, Heroku. Just create a &lt;code&gt;Procfile&lt;/code&gt; file in the root of the repository and push the repo to Heroku. This is what &lt;code&gt;Procfile&lt;/code&gt; should look like:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;web: java -Dfile.encoding=UTF-8 \ -cp target/foo.jar:target/deps/* \ foo.Entry --port=${PORT}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;h2 id=&quot;tkfork&quot;&gt;&lt;code&gt;TkFork&lt;/code&gt;&lt;/h2&gt; &lt;p&gt;This &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/TkFork.html&quot;&gt;&lt;code&gt;TkFork&lt;/code&gt;&lt;/a&gt; class seems to be one of the core elements of the framework. It helps route an incoming HTTP request to the right &lt;em&gt;take&lt;/em&gt;. Its logic is very simple, and there are just a few lines of code inside it. It encapsulates a collection of “forks,” which are instances of the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/Fork.html&quot;&gt;&lt;code&gt;Fork&lt;/code&gt;&lt;/a&gt; interface:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Fork&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Its only &lt;code&gt;route()&lt;/code&gt; method either returns an empty iterator or an iterator with a single &lt;code&gt;Response&lt;/code&gt;. &lt;code&gt;TkFork&lt;/code&gt; goes through all forks, calling their &lt;code&gt;route()&lt;/code&gt; methods until one of them returns a response. Once that happens, &lt;code&gt;TkFork&lt;/code&gt; returns this response to the caller, which is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html&quot;&gt;&lt;code&gt;FtBasic&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Let’s create a simple fork ourselves now. For example, we want to show the status of the application when the &lt;code&gt;/status&lt;/code&gt; URL is requested. Here is the code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Fork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Collection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ArrayList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqHref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I believe the logic here is clear. We either return an empty iterator or an iterator with an instance of &lt;code&gt;TkStatus&lt;/code&gt; inside. If an empty iterator is returned, &lt;code&gt;TkFork&lt;/code&gt; will try to find another fork in the collection that actually gets an instance of &lt;code&gt;Response&lt;/code&gt;. By the way, if nothing is found and all forks return empty iterators, &lt;code&gt;TkFork&lt;/code&gt; will throw a “Page not found” exception.&lt;/p&gt; &lt;p&gt;This exact logic is implemented by an out-of-the-box fork called &lt;code&gt;FkRegex&lt;/code&gt;, which attempts to match a request URI path with the regular expression provided:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We can compose a multi-level structure of &lt;code&gt;TkFork&lt;/code&gt; classes; for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TsWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkParams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;json&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatusJSON&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkParams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;xml&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatusXML&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Again, I believe it’s obvious. The instance of &lt;code&gt;FkRegex&lt;/code&gt; will ask an encapsulated instance of &lt;code&gt;TkFork&lt;/code&gt; to return a response, and it will try to fetch it from one that &lt;code&gt;FkParams&lt;/code&gt; encapsulated. If the HTTP query is &lt;code&gt;/status?f=xml&lt;/code&gt;, an instance of &lt;code&gt;TkStatusXML&lt;/code&gt; will be returned.&lt;/p&gt; &lt;h2 id=&quot;http-response&quot;&gt;HTTP Response&lt;/h2&gt; &lt;p&gt;Now let’s discuss the structure of the HTTP response and its object-oriented abstraction, &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Response.html&quot;&gt;&lt;code&gt;Response&lt;/code&gt;&lt;/a&gt;. This is how the interface looks:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStream&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Looks very similar to the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt;, doesn’t it? Well, it’s identical, mostly because the structure of the HTTP request and response is almost identical. The only difference is the first line.&lt;/p&gt; &lt;p&gt;There is a collection of useful decorators that help in response building. They are &lt;a href=&quot;/2015/02/26/composable-decorators.html&quot;&gt;composable&lt;/a&gt;, which makes them very convenient. For example, if you want to build a response that contains an HTML page, you compose them like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndex&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Hello, world!&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;text/html&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;In this example, the decorator &lt;code&gt;RsWithBody&lt;/code&gt; creates a response with a body but with no headers at all. Then, &lt;code&gt;RsWithType&lt;/code&gt; adds the header &lt;code&gt;Content-Type: text/html&lt;/code&gt; to it. Then, &lt;code&gt;RsWithStatus&lt;/code&gt; makes sure the first line of the response contains &lt;code&gt;HTTP/1.1 200 OK&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;You can create your own decorators that can reuse existing ones. Take a look at how it’s done in &lt;a href=&quot;https://github.com/yegor256/rultor/blob/1.50.2/src/main/java/com/rultor/web/RsPage.java&quot;&gt;&lt;code&gt;RsPage&lt;/code&gt;&lt;/a&gt; from rultor.com.&lt;/p&gt; &lt;h2 id=&quot;how-about-templates&quot;&gt;How About Templates?&lt;/h2&gt; &lt;p&gt;Returning simple “Hello, world” pages is not a big problem, as we can see. But what about more complex output like HTML pages, &lt;a href=&quot;/2015/11/16/json-vs-xml.html&quot;&gt;XML&lt;/a&gt; documents, JSON data sets, etc? There are a few convenient &lt;code&gt;Response&lt;/code&gt; decorators that enable all of that. Let’s start with &lt;a href=&quot;http://velocity.apache.org&quot;&gt;Velocity&lt;/a&gt;, a simple templating engine. Well, it’s not that simple. It’s rather powerful, but I would suggest to use it in simple situations only. Here is how it works:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndex&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsVelocity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, ${name}&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeffrey&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/RsVelocity.html&quot;&gt;&lt;code&gt;RsVelocity&lt;/code&gt;&lt;/a&gt; constructor accepts a single argument that has to be a Velocity template. Then, you call the &lt;code&gt;with()&lt;/code&gt; method, injecting data into the Velocity context. When it’s time to render the HTTP response, &lt;code&gt;RsVelocity&lt;/code&gt; will “evaluate” the template against the context configured. Again, I would recommend you use this templating approach only for simple outputs.&lt;/p&gt; &lt;p&gt;For more complex HTML documents, I would recommend you use XML/XSLT in combination with Xembly. I explained this idea in a few previous posts: &lt;a href=&quot;/2014/06/25/xml-and-xslt-in-browser.html&quot;&gt;XML+XSLT in a Browser&lt;/a&gt; and &lt;a href=&quot;/2014/09/09/restful-web-sites.html&quot;&gt;RESTful API and a Web Site in the Same URL&lt;/a&gt;. It is simple and powerful—Java generates XML output and the XSLT processor transforms it into HTML documents. This is how we separate representation from data. The XSL stylesheet is a “view” and &lt;code&gt;TkIndex&lt;/code&gt; is a “controller,” in terms of &lt;a href=&quot;/2016/12/13/mvc-vs-oop.html&quot;&gt;MVC&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;I’ll write a separate article about templating with Xembly and XSL very soon.&lt;/p&gt; &lt;p&gt;In the meantime, we’ll create decorators for &lt;a href=&quot;http://en.wikipedia.org/wiki/Facelets&quot;&gt;JSF/Facelets&lt;/a&gt; and &lt;a href=&quot;http://en.wikipedia.org/wiki/JavaServer_Pages&quot;&gt;JSP&lt;/a&gt; rendering in Takes. If you’re interested in helping, please fork the framework and submit your pull requests.&lt;/p&gt; &lt;h2 id=&quot;what-about-persistence&quot;&gt;What About Persistence?&lt;/h2&gt; &lt;p&gt;Now, a question that comes up is what to do with persistent entities, like databases, in-memory structures, network connections, etc. My suggestion is to initialize them inside the &lt;code&gt;Entry&lt;/code&gt; class and pass them as arguments into the &lt;code&gt;TkApp&lt;/code&gt; constructor. Then, the &lt;code&gt;TkApp&lt;/code&gt; will pass them into the constructors of custom &lt;em&gt;takes&lt;/em&gt;.&lt;/p&gt; &lt;p&gt;For example, we have a PostgreSQL database that contains some table data that we need to render. Here is how I would initialize a connection to it in the &lt;code&gt;Entry&lt;/code&gt; class (I’m using a &lt;a href=&quot;http://www.jolbox.com/&quot;&gt;BoneCP&lt;/a&gt; connection pool):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;postgres&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;postgres&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BoneCPDataSource&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BoneCPDataSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setDriverClass&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;org.postgresql.Driver&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setJdbcUrl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;jdbc:postgresql://localhost/db&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setUser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setPassword&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;super-secret-password&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, the constructor of &lt;code&gt;TkApp&lt;/code&gt; must accept a single argument of type &lt;code&gt;java.sql.Source&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Class &lt;code&gt;TkIndex&lt;/code&gt; also accepts a single argument of class &lt;code&gt;Source&lt;/code&gt;. I believe you know what to do with it inside &lt;code&gt;TkIndex&lt;/code&gt; in order to fetch the SQL table data and convert it into HTML. The point here is that the dependency must be injected into the application (instance of class &lt;code&gt;TkApp&lt;/code&gt;) at the moment of its instantiation. This is a pure and clean dependency injection mechanism, which is absolutely container-free. Read more about it in &lt;a href=&quot;/2014/10/03/di-containers-are-evil.html&quot;&gt;Dependency Injection Containers Are Code Polluters&lt;/a&gt;.&lt;/p&gt; &lt;h2 id=&quot;unit-testing&quot;&gt;Unit Testing&lt;/h2&gt; &lt;p&gt;Since every class is immutable and all dependencies are injected only through constructors, unit testing is extremely easy. Let’s say we want to test &lt;code&gt;TkStatus&lt;/code&gt;, which is supposed to return an HTML response (I’m using &lt;a href=&quot;http://junit.org/&quot;&gt;JUnit 4&lt;/a&gt; and &lt;a href=&quot;https://github.com/hamcrest/JavaHamcrest&quot;&gt;Hamcrest&lt;/a&gt;):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.junit.Test&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndexTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;returnsHtmlPage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsPrint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqFake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;equalsTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Hello, world!&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Also, we can start the entire application or any individual &lt;em&gt;take&lt;/em&gt; in a test HTTP server and test its behavior via a real TCP socket; for example (I’m using &lt;a href=&quot;http://http.jcabi.com&quot;&gt;jcabi-http&lt;/a&gt; to make an HTTP request and check the output):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndexTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;returnsHtmlPage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtRemote&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtRemote&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Script&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URI&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;home&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JdkRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;home&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RestResponse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HttpURLConnection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;HTTP_OK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;containsString&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtRemote.html&quot;&gt;&lt;code&gt;FtRemote&lt;/code&gt;&lt;/a&gt; starts a test web server at a random TCP port and calls the &lt;code&gt;exec()&lt;/code&gt; method at the provided instance of &lt;code&gt;FtRemote.Script&lt;/code&gt;. The first argument of this method is a URI of the just-started web server homepage.&lt;/p&gt; &lt;p&gt;The architecture of Takes framework is very modular and composable. Any individual &lt;em&gt;take&lt;/em&gt; can be tested as a standalone component, absolutely independent from the framework and other &lt;em&gt;takes&lt;/em&gt;.&lt;/p&gt; &lt;h2 id=&quot;why-the-name&quot;&gt;Why the Name?&lt;/h2&gt; &lt;p&gt;That’s the question I’ve been hearing rather often. The idea is simple, and it originates from the movie business. When a movie is made, the crew shoots many &lt;em&gt;takes&lt;/em&gt; in order to capture the reality and put it on film. Each capture is called a &lt;em&gt;take&lt;/em&gt;.&lt;/p&gt; &lt;p&gt;In other words, a &lt;em&gt;take&lt;/em&gt; is like a snapshot of the reality.&lt;/p&gt; &lt;p&gt;The same applies to this framework. Each instance of &lt;code&gt;Take&lt;/code&gt; represents a reality at one particular moment in time. This reality is then sent to the user in the form of a &lt;code&gt;Response&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;PS. There are a few words about authentication: &lt;a href=&quot;/2015/05/18/cookie-based-authentication.html&quot;&gt;How Cookie-Based Authentication Works in the Takes Framework&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;PPS. There are a few real web systems, which you may be interested to take a look at. They all are using Takes Framework and their code is open: &lt;a href=&quot;https://github.com/yegor256/rultor&quot;&gt;rultor.com&lt;/a&gt;, &lt;a href=&quot;/2016/03/30/jare-instant-free-cdn.html&quot;&gt;jare.io&lt;/a&gt;, &lt;a href=&quot;/2016/03/15/wring-dispatcher-github-notifications.html&quot;&gt;wring.io&lt;/a&gt;.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, image, jb_picture, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2015-03-22 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Java Web App Architecture In Takes Framework"/> <meta name="twitter:description" property="og:description" content="&lt;p&gt;I used to utilize Servlets, JSP, JAX-RS, Spring Framework, Play Framework, JSF with Facelets, and a bit of Spark Framework. All of these solutions, in my humble opinion, are very far from being object-oriented and elegant. They all are full of static methods, un-testable data structures, and dirty hacks. So about a month ago, I decided to create my own Java web framework. I put a few basic principles into its foundation: 1) No &lt;a href=&quot;/2014/05/13/why-null-is-bad.html&quot;&gt;NULLs&lt;/a&gt;, 2) no public &lt;a href=&quot;/2014/05/05/oop-alternative-to-utility-classes.html&quot;&gt;static&lt;/a&gt; methods, 3) no &lt;a href=&quot;/2014/06/09/objects-should-be-immutable.html&quot;&gt;mutable&lt;/a&gt; classes, and 4) no class casting, reflection, and &lt;a href=&quot;/2015/04/02/class-casting-is-anti-pattern.html&quot;&gt;&lt;code&gt;instanceof&lt;/code&gt;&lt;/a&gt; operators. These four basic principles should guarantee clean code and transparent architecture. That’s how the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework was born. Let’s see what was created and how it works.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;Making of The Godfather (1972) by Francis Ford Coppola&quot; src=&quot;/images/2015/03/godfather-shooting-scene.jpg&quot; longdesc=&quot;#9fedcf46&quot; /&gt;&lt;figcaption id=&quot;9fedcf46&quot;&gt;Making of The Godfather (1972) by Francis Ford Coppola&lt;/figcaption&gt;&lt;/figure&gt; &lt;h2 id=&quot;java-web-architecture-in-a-nutshell&quot;&gt;Java Web Architecture in a Nutshell&lt;/h2&gt; &lt;p&gt;This is how I understand a web application architecture and its components, in simple terms.&lt;/p&gt; &lt;aside class=&quot;youtube&quot;&gt; &lt;a href=&quot;https://www.youtube.com/watch?v=nheD2LNYrpk&quot;&gt;&lt;div class=&quot;box&quot;&gt; &lt;img src=&quot;https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg&quot; alt=&quot;YouTube video #nheD2LNYrpk&quot; /&gt; &lt;div class=&quot;play&quot;&gt;&lt;i class=&quot;icon icon-play&quot;&gt;&lt;/i&gt;&lt;/div&gt; &lt;/div&gt;&lt;/a&gt; &lt;div&gt;Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.&lt;/div&gt;&lt;/aside&gt; &lt;p&gt;First, to create a web server, we should create a new &lt;a href=&quot;http://en.wikipedia.org/wiki/Network_socket&quot;&gt;network socket&lt;/a&gt;, that accepts connections on a certain &lt;a href=&quot;http://en.wikipedia.org/wiki/Port_%28computer_networking%29&quot;&gt;TCP port&lt;/a&gt;. Usually it is 80, but I’m going to use 8080 for testing purposes. This is done in Java with the &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html&quot;&gt;&lt;code&gt;ServerSocket&lt;/code&gt;&lt;/a&gt; class:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s enough to start a web server. Now, the socket is ready and listening on port 8080. When someone opens &lt;code&gt;http://localhost:8080&lt;/code&gt; in their browser, the connection will be established and the browser will spin its waiting wheel forever. Compile this snippet and try. We just built a simple web server without the use of any frameworks. We’re not doing anything with incoming connections yet, but we’re not rejecting them either. All of them are being lined up inside that &lt;code&gt;server&lt;/code&gt; object. It’s being done in a background thread; that’s why we need to put that &lt;code&gt;while(true)&lt;/code&gt; in afterward. Without this endless pause, the app will finish its execution immediately and the server socket will shut down.&lt;/p&gt; &lt;p&gt;The next step is to accept the incoming connections. In Java, that’s done through a blocking call to the &lt;code&gt;accept()&lt;/code&gt; method:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The method is blocking its thread and waiting until a new connection arrives. As soon as that happens, it returns an instance of &lt;code&gt;Socket&lt;/code&gt;. In order to accept the next connection, we should call &lt;code&gt;accept()&lt;/code&gt; again. So basically, our web server should work like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 1. Read HTTP request from the socket&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 2. Prepare an HTTP response&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 3. Send HTTP response to the socket&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 4. Close the socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;It’s an endless cycle that accepts a new connection, understands it, creates a response, returns the response, and accepts a new connection again. HTTP protocol is stateless, which means the server should not remember what happened in any previous connection. All it cares about is the incoming HTTP request in this particular connection.&lt;/p&gt; &lt;p&gt;The HTTP request is coming from the input stream of the socket and looks like a multi-line block of text. This is what you would see if you read an input stream of the socket:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufferedReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufferedReader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStreamReader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readLine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;You will see something like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;GET / HTTP/1.1 Host: localhost:8080 Connection: keep-alive Cache-Control: max-age=0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36 Accept-Encoding: gzip, deflate, sdch Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The client (the Google Chrome browser, for example) passes this text into the connection established. It connects to port 8080 at &lt;code&gt;localhost&lt;/code&gt;, and as soon as the connection is ready, it immediately sends this text into it, then waits for a response.&lt;/p&gt; &lt;p&gt;Our job is to create an HTTP response using the information we get in the request. If our server is very primitive, we can basically ignore all the information in the request and just return “Hello, world!” to all requests (I’m using &lt;a href=&quot;https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/IOUtils.html&quot;&gt;&lt;code&gt;IOUtils&lt;/code&gt;&lt;/a&gt; for simplicity):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.Socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.apache.commons.io.IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServerSocket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Socket&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;accept&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toInputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;HTTP/1.1 200 OK\r\n\r\nHello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getOutputStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s it. The server is ready. Try to compile and run it. Point your browser to &lt;code&gt;http://localhost:8080&lt;/code&gt;, and you will see &lt;code&gt;Hello, world!&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ javac -cp commons-io.jar Foo.java $ java -cp commons-io.jar:. Foo &lt;span class=&quot;p&quot;&gt;&amp;amp;&lt;/span&gt; $ curl http://localhost:8080 -v * Rebuilt URL to: http://localhost:8080/ * Connected to localhost &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;::1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; port &lt;span class=&quot;m&quot;&gt;8080&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;#0)&lt;/span&gt; &amp;gt; GET / HTTP/1.1 &amp;gt; User-Agent: curl/7.37.1 &amp;gt; Host: localhost:8080 &amp;gt; Accept: */* &amp;gt; &amp;lt; HTTP/1.1 &lt;span class=&quot;m&quot;&gt;200&lt;/span&gt; OK * no chunk, no close, no size. Assume close to signal end &amp;lt; * Closing connection &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; Hello, world!&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;That’s all you need to build a web server. Now let’s discuss how to make it object-oriented and composable. Let’s try to see how the &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt; framework was built.&lt;/p&gt; &lt;h2 id=&quot;routingdispatching&quot;&gt;Routing/Dispatching&lt;/h2&gt; &lt;p&gt;Routing/dispatching is combined with response printing in Takes. All you need to do to create a working web application is to create a single class that implements &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Take.html&quot;&gt;&lt;code&gt;Take&lt;/code&gt;&lt;/a&gt; interface:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkFoo&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;And now it’s time to start a server:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtBasic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Foo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtBasic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFoo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html&quot;&gt;&lt;code&gt;FtBasic&lt;/code&gt;&lt;/a&gt; class does the exact same socket manipulations explained above. It starts a server socket on port 8080 and dispatches all incoming connections through an instance of &lt;code&gt;TkFoo&lt;/code&gt; that we are giving to its constructor. It does this dispatching in an endless cycle, checking every second whether it’s time to stop with an instance of &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/Exit.html&quot;&gt;&lt;code&gt;Exit&lt;/code&gt;&lt;/a&gt;. Obviously, &lt;code&gt;Exit.NEVER&lt;/code&gt; always responds with, “Don’t stop, please.”&lt;/p&gt; &lt;h2 id=&quot;http-request&quot;&gt;HTTP Request&lt;/h2&gt; &lt;p&gt;Now let’s see what’s inside the HTTP request arriving at &lt;code&gt;TkFoo&lt;/code&gt; and what we can get out of it. This is how the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt; interface is defined in &lt;a href=&quot;http://www.takes.org&quot;&gt;Takes&lt;/a&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStream&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The request is divided into two parts: the head and the body. The head contains all lines that go before the empty line that starts a body, according to HTTP specification in &lt;a href=&quot;http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html&quot;&gt;RFC 2616&lt;/a&gt;. There are many useful decorators for &lt;code&gt;Request&lt;/code&gt; in the framework. For example, &lt;code&gt;RqMethod&lt;/code&gt; will help you get the method name from the first line of the header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;method&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;code&gt;RqHref&lt;/code&gt; will help extract the query part and parse it. For example, this is the request:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;123&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;1.1&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;Host:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;example&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;com&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This code will extract that &lt;code&gt;123&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Integer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqHref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;param&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;code&gt;RqPrint&lt;/code&gt; can get the entire request or its body printed as a &lt;code&gt;String&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqPrint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The idea here is to keep the &lt;code&gt;Request&lt;/code&gt; interface simple and provide this request parsing functionality to its decorators. This approach helps the framework keep classes small and cohesive. Each decorator is very small and solid, doing exactly one thing. All of these decorators are in the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rq/package-summary.html&quot;&gt;&lt;code&gt;org.takes.rq&lt;/code&gt;&lt;/a&gt; package. As you already probably understand, the &lt;code&gt;Rq&lt;/code&gt; prefix stands for &lt;code&gt;Request&lt;/code&gt;.&lt;/p&gt; &lt;h2 id=&quot;first-real-web-app&quot;&gt;First Real Web App&lt;/h2&gt; &lt;p&gt;Let’s create our first real web application, which will do something useful. I would recommend starting with an &lt;code&gt;Entry&lt;/code&gt; class, which is required by Java to start an app from the command line:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.http.FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;This class contains just a single &lt;code&gt;main()&lt;/code&gt; static method that will be called by JVM when the app starts from the command line. As you see, it instantiates &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtCli.html&quot;&gt;&lt;code&gt;FtCli&lt;/code&gt;&lt;/a&gt;, giving it an instance of class &lt;code&gt;TkApp&lt;/code&gt; and command line arguments. We’ll create the &lt;code&gt;TkApp&lt;/code&gt; class in a second. &lt;code&gt;FtCli&lt;/code&gt; (translates to “front-end with command line interface”) makes an instance of the same &lt;code&gt;FtBasic&lt;/code&gt;, wrapping it into a few useful decorators and configuring it according to command line arguments. For example, &lt;code&gt;--port=8080&lt;/code&gt; will be converted into a &lt;code&gt;8080&lt;/code&gt; port number and passed as a second argument of the &lt;code&gt;FtBasic&lt;/code&gt; constructor.&lt;/p&gt; &lt;p&gt;The web application itself is called &lt;code&gt;TkApp&lt;/code&gt; and extends &lt;code&gt;TsWrap&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.Take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.facets.fork.FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.facets.fork.TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkWrap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.takes.tk.TkClasspath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/robots.txt&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/css/.*&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkClasspath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We’ll discuss this &lt;code&gt;TkFork&lt;/code&gt; class in a minute.&lt;/p&gt; &lt;p&gt;If you’re using Maven, this is the &lt;code&gt;pom.xml&lt;/code&gt; you should start with:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://maven.apache.org/POM/4.0.0&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns:xsi=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xsi:schemaLocation=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://maven.apache.org/POM/4.0.0&lt;/span&gt; &lt;span class=&quot;s&quot;&gt; http://maven.apache.org/xsd/maven-4.0.0.xsd&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;modelVersion&amp;gt;&lt;/span&gt;4.0.0&lt;span class=&quot;nt&quot;&gt;&amp;lt;/modelVersion&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;1.0-SNAPSHOT&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependencies&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.takes&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;takes&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.9&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- check the latest in Maven Central --&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependencies&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;build&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;finalName&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/finalName&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;plugins&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;plugin&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;maven-dependency-plugin&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;executions&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;execution&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;goals&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;goal&amp;gt;&lt;/span&gt;copy-dependencies&lt;span class=&quot;nt&quot;&gt;&amp;lt;/goal&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/goals&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;configuration&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;outputDirectory&amp;gt;&lt;/span&gt;${project.build.directory}/deps&lt;span class=&quot;nt&quot;&gt;&amp;lt;/outputDirectory&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/execution&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/executions&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/plugin&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/plugins&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/build&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/project&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Running &lt;code&gt;mvn clean package&lt;/code&gt; should build a &lt;code&gt;foo.jar&lt;/code&gt; file in &lt;code&gt;target&lt;/code&gt; directory and a collection of all JAR dependencies in &lt;code&gt;target/deps&lt;/code&gt;. Now you can run the app from the command line:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ mvn clean package $ java -Dfile.encoding&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;UTF-8 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt; -cp ./target/foo.jar:./target/deps/* foo.Entry --port&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8080&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The application is ready, and you can deploy it to, say, Heroku. Just create a &lt;code&gt;Procfile&lt;/code&gt; file in the root of the repository and push the repo to Heroku. This is what &lt;code&gt;Procfile&lt;/code&gt; should look like:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;web: java -Dfile.encoding=UTF-8 \ -cp target/foo.jar:target/deps/* \ foo.Entry --port=${PORT}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;h2 id=&quot;tkfork&quot;&gt;&lt;code&gt;TkFork&lt;/code&gt;&lt;/h2&gt; &lt;p&gt;This &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/TkFork.html&quot;&gt;&lt;code&gt;TkFork&lt;/code&gt;&lt;/a&gt; class seems to be one of the core elements of the framework. It helps route an incoming HTTP request to the right &lt;em&gt;take&lt;/em&gt;. Its logic is very simple, and there are just a few lines of code inside it. It encapsulates a collection of “forks,” which are instances of the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/Fork.html&quot;&gt;&lt;code&gt;Fork&lt;/code&gt;&lt;/a&gt; interface:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Fork&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Its only &lt;code&gt;route()&lt;/code&gt; method either returns an empty iterator or an iterator with a single &lt;code&gt;Response&lt;/code&gt;. &lt;code&gt;TkFork&lt;/code&gt; goes through all forks, calling their &lt;code&gt;route()&lt;/code&gt; methods until one of them returns a response. Once that happens, &lt;code&gt;TkFork&lt;/code&gt; returns this response to the caller, which is &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html&quot;&gt;&lt;code&gt;FtBasic&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Let’s create a simple fork ourselves now. For example, we want to show the status of the application when the &lt;code&gt;/status&lt;/code&gt; URL is requested. Here is the code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Fork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Collection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ArrayList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqHref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;I believe the logic here is clear. We either return an empty iterator or an iterator with an instance of &lt;code&gt;TkStatus&lt;/code&gt; inside. If an empty iterator is returned, &lt;code&gt;TkFork&lt;/code&gt; will try to find another fork in the collection that actually gets an instance of &lt;code&gt;Response&lt;/code&gt;. By the way, if nothing is found and all forks return empty iterators, &lt;code&gt;TkFork&lt;/code&gt; will throw a “Page not found” exception.&lt;/p&gt; &lt;p&gt;This exact logic is implemented by an out-of-the-box fork called &lt;code&gt;FkRegex&lt;/code&gt;, which attempts to match a request URI path with the regular expression provided:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We can compose a multi-level structure of &lt;code&gt;TkFork&lt;/code&gt; classes; for example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TsWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;/status&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkParams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;json&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatusJSON&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkParams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;f&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;xml&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatusXML&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Again, I believe it’s obvious. The instance of &lt;code&gt;FkRegex&lt;/code&gt; will ask an encapsulated instance of &lt;code&gt;TkFork&lt;/code&gt; to return a response, and it will try to fetch it from one that &lt;code&gt;FkParams&lt;/code&gt; encapsulated. If the HTTP query is &lt;code&gt;/status?f=xml&lt;/code&gt;, an instance of &lt;code&gt;TkStatusXML&lt;/code&gt; will be returned.&lt;/p&gt; &lt;h2 id=&quot;http-response&quot;&gt;HTTP Response&lt;/h2&gt; &lt;p&gt;Now let’s discuss the structure of the HTTP response and its object-oriented abstraction, &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Response.html&quot;&gt;&lt;code&gt;Response&lt;/code&gt;&lt;/a&gt;. This is how the interface looks:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InputStream&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Looks very similar to the &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html&quot;&gt;&lt;code&gt;Request&lt;/code&gt;&lt;/a&gt;, doesn’t it? Well, it’s identical, mostly because the structure of the HTTP request and response is almost identical. The only difference is the first line.&lt;/p&gt; &lt;p&gt;There is a collection of useful decorators that help in response building. They are &lt;a href=&quot;/2015/02/26/composable-decorators.html&quot;&gt;composable&lt;/a&gt;, which makes them very convenient. For example, if you want to build a response that contains an HTML page, you compose them like this:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndex&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsWithBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Hello, world!&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;text/html&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;In this example, the decorator &lt;code&gt;RsWithBody&lt;/code&gt; creates a response with a body but with no headers at all. Then, &lt;code&gt;RsWithType&lt;/code&gt; adds the header &lt;code&gt;Content-Type: text/html&lt;/code&gt; to it. Then, &lt;code&gt;RsWithStatus&lt;/code&gt; makes sure the first line of the response contains &lt;code&gt;HTTP/1.1 200 OK&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;You can create your own decorators that can reuse existing ones. Take a look at how it’s done in &lt;a href=&quot;https://github.com/yegor256/rultor/blob/1.50.2/src/main/java/com/rultor/web/RsPage.java&quot;&gt;&lt;code&gt;RsPage&lt;/code&gt;&lt;/a&gt; from rultor.com.&lt;/p&gt; &lt;h2 id=&quot;how-about-templates&quot;&gt;How About Templates?&lt;/h2&gt; &lt;p&gt;Returning simple “Hello, world” pages is not a big problem, as we can see. But what about more complex output like HTML pages, &lt;a href=&quot;/2015/11/16/json-vs-xml.html&quot;&gt;XML&lt;/a&gt; documents, JSON data sets, etc? There are a few convenient &lt;code&gt;Response&lt;/code&gt; decorators that enable all of that. Let’s start with &lt;a href=&quot;http://velocity.apache.org&quot;&gt;Velocity&lt;/a&gt;, a simple templating engine. Well, it’s not that simple. It’s rather powerful, but I would suggest to use it in simple situations only. Here is how it works:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndex&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Response&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsVelocity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, ${name}&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeffrey&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The &lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/RsVelocity.html&quot;&gt;&lt;code&gt;RsVelocity&lt;/code&gt;&lt;/a&gt; constructor accepts a single argument that has to be a Velocity template. Then, you call the &lt;code&gt;with()&lt;/code&gt; method, injecting data into the Velocity context. When it’s time to render the HTTP response, &lt;code&gt;RsVelocity&lt;/code&gt; will “evaluate” the template against the context configured. Again, I would recommend you use this templating approach only for simple outputs.&lt;/p&gt; &lt;p&gt;For more complex HTML documents, I would recommend you use XML/XSLT in combination with Xembly. I explained this idea in a few previous posts: &lt;a href=&quot;/2014/06/25/xml-and-xslt-in-browser.html&quot;&gt;XML+XSLT in a Browser&lt;/a&gt; and &lt;a href=&quot;/2014/09/09/restful-web-sites.html&quot;&gt;RESTful API and a Web Site in the Same URL&lt;/a&gt;. It is simple and powerful—Java generates XML output and the XSLT processor transforms it into HTML documents. This is how we separate representation from data. The XSL stylesheet is a “view” and &lt;code&gt;TkIndex&lt;/code&gt; is a “controller,” in terms of &lt;a href=&quot;/2016/12/13/mvc-vs-oop.html&quot;&gt;MVC&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;I’ll write a separate article about templating with Xembly and XSL very soon.&lt;/p&gt; &lt;p&gt;In the meantime, we’ll create decorators for &lt;a href=&quot;http://en.wikipedia.org/wiki/Facelets&quot;&gt;JSF/Facelets&lt;/a&gt; and &lt;a href=&quot;http://en.wikipedia.org/wiki/JavaServer_Pages&quot;&gt;JSP&lt;/a&gt; rendering in Takes. If you’re interested in helping, please fork the framework and submit your pull requests.&lt;/p&gt; &lt;h2 id=&quot;what-about-persistence&quot;&gt;What About Persistence?&lt;/h2&gt; &lt;p&gt;Now, a question that comes up is what to do with persistent entities, like databases, in-memory structures, network connections, etc. My suggestion is to initialize them inside the &lt;code&gt;Entry&lt;/code&gt; class and pass them as arguments into the &lt;code&gt;TkApp&lt;/code&gt; constructor. Then, the &lt;code&gt;TkApp&lt;/code&gt; will pass them into the constructors of custom &lt;em&gt;takes&lt;/em&gt;.&lt;/p&gt; &lt;p&gt;For example, we have a PostgreSQL database that contains some table data that we need to render. Here is how I would initialize a connection to it in the &lt;code&gt;Entry&lt;/code&gt; class (I’m using a &lt;a href=&quot;http://www.jolbox.com/&quot;&gt;BoneCP&lt;/a&gt; connection pool):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtCli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;postgres&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;postgres&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BoneCPDataSource&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BoneCPDataSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setDriverClass&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;org.postgresql.Driver&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setJdbcUrl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;jdbc:postgresql://localhost/db&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setUser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setPassword&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;super-secret-password&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Now, the constructor of &lt;code&gt;TkApp&lt;/code&gt; must accept a single argument of type &lt;code&gt;java.sql.Source&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkApp&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkWrap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TkApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Take&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkFork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FkRegex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Class &lt;code&gt;TkIndex&lt;/code&gt; also accepts a single argument of class &lt;code&gt;Source&lt;/code&gt;. I believe you know what to do with it inside &lt;code&gt;TkIndex&lt;/code&gt; in order to fetch the SQL table data and convert it into HTML. The point here is that the dependency must be injected into the application (instance of class &lt;code&gt;TkApp&lt;/code&gt;) at the moment of its instantiation. This is a pure and clean dependency injection mechanism, which is absolutely container-free. Read more about it in &lt;a href=&quot;/2014/10/03/di-containers-are-evil.html&quot;&gt;Dependency Injection Containers Are Code Polluters&lt;/a&gt;.&lt;/p&gt; &lt;h2 id=&quot;unit-testing&quot;&gt;Unit Testing&lt;/h2&gt; &lt;p&gt;Since every class is immutable and all dependencies are injected only through constructors, unit testing is extremely easy. Let’s say we want to test &lt;code&gt;TkStatus&lt;/code&gt;, which is supposed to return an HTML response (I’m using &lt;a href=&quot;http://junit.org/&quot;&gt;JUnit 4&lt;/a&gt; and &lt;a href=&quot;https://github.com/hamcrest/JavaHamcrest&quot;&gt;Hamcrest&lt;/a&gt;):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.junit.Test&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndexTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;returnsHtmlPage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RsPrint&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;act&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RqFake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;equalsTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;lt;html&amp;gt;Hello, world!&amp;lt;/html&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Also, we can start the entire application or any individual &lt;em&gt;take&lt;/em&gt; in a test HTTP server and test its behavior via a real TCP socket; for example (I’m using &lt;a href=&quot;http://http.jcabi.com&quot;&gt;jcabi-http&lt;/a&gt; to make an HTTP request and check the output):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TkIndexTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;returnsHtmlPage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtRemote&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TkIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FtRemote&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Script&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URI&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;home&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JdkRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;home&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RestResponse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertStatus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HttpURLConnection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;HTTP_OK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Matchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;containsString&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hello, world!&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtRemote.html&quot;&gt;&lt;code&gt;FtRemote&lt;/code&gt;&lt;/a&gt; starts a test web server at a random TCP port and calls the &lt;code&gt;exec()&lt;/code&gt; method at the provided instance of &lt;code&gt;FtRemote.Script&lt;/code&gt;. The first argument of this method is a URI of the just-started web server homepage.&lt;/p&gt; &lt;p&gt;The architecture of Takes framework is very modular and composable. Any individual &lt;em&gt;take&lt;/em&gt; can be tested as a standalone component, absolutely independent from the framework and other &lt;em&gt;takes&lt;/em&gt;.&lt;/p&gt; &lt;h2 id=&quot;why-the-name&quot;&gt;Why the Name?&lt;/h2&gt; &lt;p&gt;That’s the question I’ve been hearing rather often. The idea is simple, and it originates from the movie business. When a movie is made, the crew shoots many &lt;em&gt;takes&lt;/em&gt; in order to capture the reality and put it on film. Each capture is called a &lt;em&gt;take&lt;/em&gt;.&lt;/p&gt; &lt;p&gt;In other words, a &lt;em&gt;take&lt;/em&gt; is like a snapshot of the reality.&lt;/p&gt; &lt;p&gt;The same applies to this framework. Each instance of &lt;code&gt;Take&lt;/code&gt; represents a reality at one particular moment in time. This reality is then sent to the user in the form of a &lt;code&gt;Response&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;PS. There are a few words about authentication: &lt;a href=&quot;/2015/05/18/cookie-based-authentication.html&quot;&gt;How Cookie-Based Authentication Works in the Takes Framework&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;PPS. There are a few real web systems, which you may be interested to take a look at. They all are using Takes Framework and their code is open: &lt;a href=&quot;https://github.com/yegor256/rultor&quot;&gt;rultor.com&lt;/a&gt;, &lt;a href=&quot;/2016/03/30/jare-instant-free-cdn.html&quot;&gt;jare.io&lt;/a&gt;, &lt;a href=&quot;/2016/03/15/wring-dispatcher-github-notifications.html&quot;&gt;wring.io&lt;/a&gt;.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2015/03/22/takes-java-web-framework.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" /> <link rel="amphtml" href="https://www.yegor256.com/2015/03/22/takes-java-web-framework.amp.html" /> <title>Java Web App Architecture In Takes Framework </title> <meta name='og:image' content='https://www.yegor256.com/images/2015/03/godfather-shooting-scene.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2015/03/godfather-shooting-scene.jpg'/><meta name='og:image:width' content='1000'/> <meta name='twitter:image:width' content='1000'/><meta name='og:image:height' content='583'/> <meta name='twitter:image:height' content='583'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Making of The Godfather (1972) by Francis Ford Coppola'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2015/03/22/takes-java-web-framework.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2015/03/22/takes-java-web-framework.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2015/03/22/takes-java-web-framework.html</code></p><h1 itemprop="name headline mainEntityOfPage">Java Web App Architecture In Takes Framework</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2015-03-22T00:00:00+00:00"> 22 March 2015 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2015/03/22/takes-java-web-framework.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><p>I used to utilize Servlets, JSP, JAX-RS, Spring Framework, Play Framework, JSF with Facelets, and a bit of Spark Framework. All of these solutions, in my humble opinion, are very far from being object-oriented and elegant. They all are full of static methods, un-testable data structures, and dirty hacks. So about a month ago, I decided to create my own Java web framework. I put a few basic principles into its foundation: 1) No <a href="/2014/05/13/why-null-is-bad.html">NULLs</a>, 2) no public <a href="/2014/05/05/oop-alternative-to-utility-classes.html">static</a> methods, 3) no <a href="/2014/06/09/objects-should-be-immutable.html">mutable</a> classes, and 4) no class casting, reflection, and <a href="/2015/04/02/class-casting-is-anti-pattern.html"><code>instanceof</code></a> operators. These four basic principles should guarantee clean code and transparent architecture. That’s how the <a href="http://www.takes.org">Takes</a> framework was born. Let’s see what was created and how it works.</p><figure class="jb_picture"><img itemprop="image" alt="Making of The Godfather (1972) by Francis Ford Coppola" src="/images/2015/03/godfather-shooting-scene.jpg" longdesc="#9fedcf46" /><figcaption id="9fedcf46">Making of The Godfather (1972) by Francis Ford Coppola</figcaption></figure><h2 id="java-web-architecture-in-a-nutshell">Java Web Architecture in a Nutshell</h2><p>This is how I understand a web application architecture and its components, in simple terms.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=nheD2LNYrpk"><div class="box"> <img src="https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg" alt="YouTube video #nheD2LNYrpk" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.</div></aside><p>First, to create a web server, we should create a new <a href="http://en.wikipedia.org/wiki/Network_socket">network socket</a>, that accepts connections on a certain <a href="http://en.wikipedia.org/wiki/Port_%28computer_networking%29">TCP port</a>. Usually it is 80, but I’m going to use 8080 for testing purposes. This is done in Java with the <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html"><code>ServerSocket</code></a> class:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s enough to start a web server. Now, the socket is ready and listening on port 8080. When someone opens <code>http://localhost:8080</code> in their browser, the connection will be established and the browser will spin its waiting wheel forever. Compile this snippet and try. We just built a simple web server without the use of any frameworks. We’re not doing anything with incoming connections yet, but we’re not rejecting them either. All of them are being lined up inside that <code>server</code> object. It’s being done in a background thread; that’s why we need to put that <code>while(true)</code> in afterward. Without this endless pause, the app will finish its execution immediately and the server socket will shut down.</p><p>The next step is to accept the incoming connections. In Java, that’s done through a blocking call to the <code>accept()</code> method:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span></code></pre></figure><p>The method is blocking its thread and waiting until a new connection arrives. As soon as that happens, it returns an instance of <code>Socket</code>. In order to accept the next connection, we should call <code>accept()</code> again. So basically, our web server should work like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
      <span class="c1">// 1. Read HTTP request from the socket</span>
      <span class="c1">// 2. Prepare an HTTP response</span>
      <span class="c1">// 3. Send HTTP response to the socket</span>
      <span class="c1">// 4. Close the socket</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>It’s an endless cycle that accepts a new connection, understands it, creates a response, returns the response, and accepts a new connection again. HTTP protocol is stateless, which means the server should not remember what happened in any previous connection. All it cares about is the incoming HTTP request in this particular connection.</p><p>The HTTP request is coming from the input stream of the socket and looks like a multi-line block of text. This is what you would see if you read an input stream of the socket:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
<span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>You will see something like this:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET / HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Cache-Control: max-age=0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4</code></pre></figure><p>The client (the Google Chrome browser, for example) passes this text into the connection established. It connects to port 8080 at <code>localhost</code>, and as soon as the connection is ready, it immediately sends this text into it, then waits for a response.</p><p>Our job is to create an HTTP response using the information we get in the request. If our server is very primitive, we can basically ignore all the information in the request and just return “Hello, world!” to all requests (I’m using <a href="https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/IOUtils.html"><code>IOUtils</code></a> for simplicity):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span>
          <span class="n">IOUtils</span><span class="o">.</span><span class="na">toInputStream</span><span class="o">(</span><span class="s">&quot;HTTP/1.1 200 OK\r\n\r\nHello, world!&quot;</span><span class="o">),</span>
          <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()</span>
        <span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s it. The server is ready. Try to compile and run it. Point your browser to <code>http://localhost:8080</code>, and you will see <code>Hello, world!</code>:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ javac -cp commons-io.jar Foo.java
$ java -cp commons-io.jar:. Foo <span class="p">&amp;</span>
$ curl http://localhost:8080 -v
* Rebuilt URL to: http://localhost:8080/
* Connected to localhost <span class="o">(</span>::1<span class="o">)</span> port <span class="m">8080</span> <span class="o">(</span><span class="c1">#0)</span>
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.37.1
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
* no chunk, no close, no size. Assume close to signal end
&lt;
* Closing connection <span class="m">0</span>
Hello, world!</code></pre></figure><p>That’s all you need to build a web server. Now let’s discuss how to make it object-oriented and composable. Let’s try to see how the <a href="http://www.takes.org">Takes</a> framework was built.</p><h2 id="routingdispatching">Routing/Dispatching</h2><p>Routing/dispatching is combined with response printing in Takes. All you need to do to create a working web application is to create a single class that implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Take.html"><code>Take</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Request</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkFoo</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">route</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>And now it’s time to start a server:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtBasic</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtBasic</span><span class="o">(</span><span class="k">new</span> <span class="n">TkFoo</span><span class="o">(),</span> <span class="mi">8080</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a> class does the exact same socket manipulations explained above. It starts a server socket on port 8080 and dispatches all incoming connections through an instance of <code>TkFoo</code> that we are giving to its constructor. It does this dispatching in an endless cycle, checking every second whether it’s time to stop with an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/Exit.html"><code>Exit</code></a>. Obviously, <code>Exit.NEVER</code> always responds with, “Don’t stop, please.”</p><h2 id="http-request">HTTP Request</h2><p>Now let’s see what’s inside the HTTP request arriving at <code>TkFoo</code> and what we can get out of it. This is how the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a> interface is defined in <a href="http://www.takes.org">Takes</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Request</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>The request is divided into two parts: the head and the body. The head contains all lines that go before the empty line that starts a body, according to HTTP specification in <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html">RFC 2616</a>. There are many useful decorators for <code>Request</code> in the framework. For example, <code>RqMethod</code> will help you get the method name from the first line of the header:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqMethod</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">method</span><span class="o">();</span></code></pre></figure><p><code>RqHref</code> will help extract the query part and parse it. For example, this is the request:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">user</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="mi">123</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">www</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span></code></pre></figure><p>This code will extract that <code>123</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="o">);</span></code></pre></figure><p><code>RqPrint</code> can get the entire request or its body printed as a <code>String</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqPrint</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">printBody</span><span class="o">();</span></code></pre></figure><p>The idea here is to keep the <code>Request</code> interface simple and provide this request parsing functionality to its decorators. This approach helps the framework keep classes small and cohesive. Each decorator is very small and solid, doing exactly one thing. All of these decorators are in the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rq/package-summary.html"><code>org.takes.rq</code></a> package. As you already probably understand, the <code>Rq</code> prefix stands for <code>Request</code>.</p><h2 id="first-real-web-app">First Real Web App</h2><p>Let’s create our first real web application, which will do something useful. I would recommend starting with an <code>Entry</code> class, which is required by Java to start an app from the command line:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This class contains just a single <code>main()</code> static method that will be called by JVM when the app starts from the command line. As you see, it instantiates <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtCli.html"><code>FtCli</code></a>, giving it an instance of class <code>TkApp</code> and command line arguments. We’ll create the <code>TkApp</code> class in a second. <code>FtCli</code> (translates to “front-end with command line interface”) makes an instance of the same <code>FtBasic</code>, wrapping it into a few useful decorators and configuring it according to command line arguments. For example, <code>--port=8080</code> will be converted into a <code>8080</code> port number and passed as a second argument of the <code>FtBasic</code> constructor.</p><p>The web application itself is called <code>TkApp</code> and extends <code>TsWrap</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.FkRegex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.TkFork</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkClasspath</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/robots.txt&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/css/.*&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkClasspath</span><span class="o">()),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We’ll discuss this <code>TkFork</code> class in a minute.</p><p>If you’re using Maven, this is the <code>pom.xml</code> you should start with:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0</span>
<span class="s">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>foo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>foo<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.takes<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>takes<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>0.9<span class="nt">&lt;/version&gt;</span> <span class="c">&lt;!-- check the latest in Maven Central --&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;finalName&gt;</span>foo<span class="nt">&lt;/finalName&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/deps<span class="nt">&lt;/outputDirectory&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre></figure><p>Running <code>mvn clean package</code> should build a <code>foo.jar</code> file in <code>target</code> directory and a collection of all JAR dependencies in <code>target/deps</code>. Now you can run the app from the command line:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ mvn clean package
$ java -Dfile.encoding<span class="o">=</span>UTF-8 <span class="se">\</span>
  -cp ./target/foo.jar:./target/deps/* foo.Entry --port<span class="o">=</span><span class="m">8080</span></code></pre></figure><p>The application is ready, and you can deploy it to, say, Heroku. Just create a <code>Procfile</code> file in the root of the repository and push the repo to Heroku. This is what <code>Procfile</code> should look like:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>web: java -Dfile.encoding=UTF-8 \
  -cp target/foo.jar:target/deps/* \
  foo.Entry --port=${PORT}</code></pre></figure><h2 id="tkfork"><code>TkFork</code></h2><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/TkFork.html"><code>TkFork</code></a> class seems to be one of the core elements of the framework. It helps route an incoming HTTP request to the right <em>take</em>. Its logic is very simple, and there are just a few lines of code inside it. It encapsulates a collection of “forks,” which are instances of the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/Fork.html"><code>Fork</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Fork</span> <span class="o">{</span>
  <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Its only <code>route()</code> method either returns an empty iterator or an iterator with a single <code>Response</code>. <code>TkFork</code> goes through all forks, calling their <code>route()</code> methods until one of them returns a response. Once that happens, <code>TkFork</code> returns this response to the caller, which is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a>.</p><p>Let’s create a simple fork ourselves now. For example, we want to show the status of the application when the <code>/status</code> URL is requested. Here is the code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">Fork</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">responses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">path</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">responses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">TkStatus</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">responses</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>I believe the logic here is clear. We either return an empty iterator or an iterator with an instance of <code>TkStatus</code> inside. If an empty iterator is returned, <code>TkFork</code> will try to find another fork in the collection that actually gets an instance of <code>Response</code>. By the way, if nothing is found and all forks return empty iterators, <code>TkFork</code> will throw a “Page not found” exception.</p><p>This exact logic is implemented by an out-of-the-box fork called <code>FkRegex</code>, which attempts to match a request URI path with the regular expression provided:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatus</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We can compose a multi-level structure of <code>TkFork</code> classes; for example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TsWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span>
        <span class="s">&quot;/status&quot;</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;json&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusJSON</span><span class="o">()),</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;xml&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusXML</span><span class="o">())</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Again, I believe it’s obvious. The instance of <code>FkRegex</code> will ask an encapsulated instance of <code>TkFork</code> to return a response, and it will try to fetch it from one that <code>FkParams</code> encapsulated. If the HTTP query is <code>/status?f=xml</code>, an instance of <code>TkStatusXML</code> will be returned.</p><h2 id="http-response">HTTP Response</h2><p>Now let’s discuss the structure of the HTTP response and its object-oriented abstraction, <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Response.html"><code>Response</code></a>. This is how the interface looks:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Response</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Looks very similar to the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a>, doesn’t it? Well, it’s identical, mostly because the structure of the HTTP request and response is almost identical. The only difference is the first line.</p><p>There is a collection of useful decorators that help in response building. They are <a href="/2015/02/26/composable-decorators.html">composable</a>, which makes them very convenient. For example, if you want to build a response that contains an HTML page, you compose them like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsWithStatus</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">RsWithBody</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">),</span>
        <span class="s">&quot;text/html&quot;</span>
      <span class="o">),</span>
      <span class="mi">200</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>In this example, the decorator <code>RsWithBody</code> creates a response with a body but with no headers at all. Then, <code>RsWithType</code> adds the header <code>Content-Type: text/html</code> to it. Then, <code>RsWithStatus</code> makes sure the first line of the response contains <code>HTTP/1.1 200 OK</code>.</p><p>You can create your own decorators that can reuse existing ones. Take a look at how it’s done in <a href="https://github.com/yegor256/rultor/blob/1.50.2/src/main/java/com/rultor/web/RsPage.java"><code>RsPage</code></a> from rultor.com.</p><h2 id="how-about-templates">How About Templates?</h2><p>Returning simple “Hello, world” pages is not a big problem, as we can see. But what about more complex output like HTML pages, <a href="/2015/11/16/json-vs-xml.html">XML</a> documents, JSON data sets, etc? There are a few convenient <code>Response</code> decorators that enable all of that. Let’s start with <a href="http://velocity.apache.org">Velocity</a>, a simple templating engine. Well, it’s not that simple. It’s rather powerful, but I would suggest to use it in simple situations only. Here is how it works:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsVelocity</span><span class="o">(</span><span class="s">&quot;Hello, ${name}&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeffrey&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/RsVelocity.html"><code>RsVelocity</code></a> constructor accepts a single argument that has to be a Velocity template. Then, you call the <code>with()</code> method, injecting data into the Velocity context. When it’s time to render the HTTP response, <code>RsVelocity</code> will “evaluate” the template against the context configured. Again, I would recommend you use this templating approach only for simple outputs.</p><p>For more complex HTML documents, I would recommend you use XML/XSLT in combination with Xembly. I explained this idea in a few previous posts: <a href="/2014/06/25/xml-and-xslt-in-browser.html">XML+XSLT in a Browser</a> and <a href="/2014/09/09/restful-web-sites.html">RESTful API and a Web Site in the Same URL</a>. It is simple and powerful—Java generates XML output and the XSLT processor transforms it into HTML documents. This is how we separate representation from data. The XSL stylesheet is a “view” and <code>TkIndex</code> is a “controller,” in terms of <a href="/2016/12/13/mvc-vs-oop.html">MVC</a>.</p><p>I’ll write a separate article about templating with Xembly and XSL very soon.</p><p>In the meantime, we’ll create decorators for <a href="http://en.wikipedia.org/wiki/Facelets">JSF/Facelets</a> and <a href="http://en.wikipedia.org/wiki/JavaServer_Pages">JSP</a> rendering in Takes. If you’re interested in helping, please fork the framework and submit your pull requests.</p><h2 id="what-about-persistence">What About Persistence?</h2><p>Now, a question that comes up is what to do with persistent entities, like databases, in-memory structures, network connections, etc. My suggestion is to initialize them inside the <code>Entry</code> class and pass them as arguments into the <code>TkApp</code> constructor. Then, the <code>TkApp</code> will pass them into the constructors of custom <em>takes</em>.</p><p>For example, we have a PostgreSQL database that contains some table data that we need to render. Here is how I would initialize a connection to it in the <code>Entry</code> class (I’m using a <a href="http://www.jolbox.com/">BoneCP</a> connection pool):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(</span><span class="n">Entry</span><span class="o">.</span><span class="na">postgres</span><span class="o">()),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Source</span> <span class="nf">postgres</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">BoneCPDataSource</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BoneCPDataSource</span><span class="o">();</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setDriverClass</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">&quot;jdbc:postgresql://localhost/db&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">&quot;root&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;super-secret-password&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">src</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Now, the constructor of <code>TkApp</code> must accept a single argument of type <code>java.sql.Source</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">(</span><span class="n">source</span><span class="o">))</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Class <code>TkIndex</code> also accepts a single argument of class <code>Source</code>. I believe you know what to do with it inside <code>TkIndex</code> in order to fetch the SQL table data and convert it into HTML. The point here is that the dependency must be injected into the application (instance of class <code>TkApp</code>) at the moment of its instantiation. This is a pure and clean dependency injection mechanism, which is absolutely container-free. Read more about it in <a href="/2014/10/03/di-containers-are-evil.html">Dependency Injection Containers Are Code Polluters</a>.</p><h2 id="unit-testing">Unit Testing</h2><p>Since every class is immutable and all dependencies are injected only through constructors, unit testing is extremely easy. Let’s say we want to test <code>TkStatus</code>, which is supposed to return an HTML response (I’m using <a href="http://junit.org/">JUnit 4</a> and <a href="https://github.com/hamcrest/JavaHamcrest">Hamcrest</a>):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.Matchers</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsPrint</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">TkStatus</span><span class="o">().</span><span class="na">act</span><span class="o">(</span><span class="k">new</span> <span class="n">RqFake</span><span class="o">())</span>
      <span class="o">).</span><span class="na">printBody</span><span class="o">(),</span>
      <span class="n">Matchers</span><span class="o">.</span><span class="na">equalsTo</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Also, we can start the entire application or any individual <em>take</em> in a test HTTP server and test its behavior via a real TCP socket; for example (I’m using <a href="http://http.jcabi.com">jcabi-http</a> to make an HTTP request and check the output):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtRemote</span><span class="o">(</span><span class="k">new</span> <span class="n">TkIndex</span><span class="o">()).</span><span class="na">exec</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FtRemote</span><span class="o">.</span><span class="na">Script</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exec</span><span class="o">(</span><span class="kd">final</span> <span class="n">URI</span> <span class="n">home</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
          <span class="k">new</span> <span class="n">JdkRequest</span><span class="o">(</span><span class="n">home</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fetch</span><span class="o">()</span>
            <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="n">RestResponse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertStatus</span><span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertBody</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">containsString</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtRemote.html"><code>FtRemote</code></a> starts a test web server at a random TCP port and calls the <code>exec()</code> method at the provided instance of <code>FtRemote.Script</code>. The first argument of this method is a URI of the just-started web server homepage.</p><p>The architecture of Takes framework is very modular and composable. Any individual <em>take</em> can be tested as a standalone component, absolutely independent from the framework and other <em>takes</em>.</p><h2 id="why-the-name">Why the Name?</h2><p>That’s the question I’ve been hearing rather often. The idea is simple, and it originates from the movie business. When a movie is made, the crew shoots many <em>takes</em> in order to capture the reality and put it on film. Each capture is called a <em>take</em>.</p><p>In other words, a <em>take</em> is like a snapshot of the reality.</p><p>The same applies to this framework. Each instance of <code>Take</code> represents a reality at one particular moment in time. This reality is then sent to the user in the form of a <code>Response</code>.</p><p>PS. There are a few words about authentication: <a href="/2015/05/18/cookie-based-authentication.html">How Cookie-Based Authentication Works in the Takes Framework</a>.</p><p>PPS. There are a few real web systems, which you may be interested to take a look at. They all are using Takes Framework and their code is open: <a href="https://github.com/yegor256/rultor">rultor.com</a>, <a href="/2016/03/30/jare-instant-free-cdn.html">jare.io</a>, <a href="/2016/03/15/wring-dispatcher-github-notifications.html">wring.io</a>.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html&amp;text=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html%3F2015-12&amp;title=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html%3F2015-12&amp;t=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>I used to utilize Servlets, JSP, JAX-RS, Spring Framework, Play Framework, JSF with Facelets, and a bit of Spark Framework. All of these solutions, in my humble opinion, are very far from being object-oriented and elegant. They all are full of static methods, un-testable data structures, and dirty hacks. So about a month ago, I decided to create my own Java web framework. I put a few basic principles into its foundation: 1) No <a href="/2014/05/13/why-null-is-bad.html">NULLs</a>, 2) no public <a href="/2014/05/05/oop-alternative-to-utility-classes.html">static</a> methods, 3) no <a href="/2014/06/09/objects-should-be-immutable.html">mutable</a> classes, and 4) no class casting, reflection, and <a href="/2015/04/02/class-casting-is-anti-pattern.html"><code>instanceof</code></a> operators. These four basic principles should guarantee clean code and transparent architecture. That’s how the <a href="http://www.takes.org">Takes</a> framework was born. Let’s see what was created and how it works.</p><figure class="jb_picture"><img itemprop="image" alt="Making of The Godfather (1972) by Francis Ford Coppola" src="/images/2015/03/godfather-shooting-scene.jpg" longdesc="#9fedcf46" /><figcaption id="9fedcf46">Making of The Godfather (1972) by Francis Ford Coppola</figcaption></figure><h2 id="java-web-architecture-in-a-nutshell">Java Web Architecture in a Nutshell</h2><p>This is how I understand a web application architecture and its components, in simple terms.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=nheD2LNYrpk"><div class="box"> <img src="https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg" alt="YouTube video #nheD2LNYrpk" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.</div></aside><p>First, to create a web server, we should create a new <a href="http://en.wikipedia.org/wiki/Network_socket">network socket</a>, that accepts connections on a certain <a href="http://en.wikipedia.org/wiki/Port_%28computer_networking%29">TCP port</a>. Usually it is 80, but I’m going to use 8080 for testing purposes. This is done in Java with the <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html"><code>ServerSocket</code></a> class:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s enough to start a web server. Now, the socket is ready and listening on port 8080. When someone opens <code>http://localhost:8080</code> in their browser, the connection will be established and the browser will spin its waiting wheel forever. Compile this snippet and try. We just built a simple web server without the use of any frameworks. We’re not doing anything with incoming connections yet, but we’re not rejecting them either. All of them are being lined up inside that <code>server</code> object. It’s being done in a background thread; that’s why we need to put that <code>while(true)</code> in afterward. Without this endless pause, the app will finish its execution immediately and the server socket will shut down.</p><p>The next step is to accept the incoming connections. In Java, that’s done through a blocking call to the <code>accept()</code> method:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span></code></pre></figure><p>The method is blocking its thread and waiting until a new connection arrives. As soon as that happens, it returns an instance of <code>Socket</code>. In order to accept the next connection, we should call <code>accept()</code> again. So basically, our web server should work like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
      <span class="c1">// 1. Read HTTP request from the socket</span>
      <span class="c1">// 2. Prepare an HTTP response</span>
      <span class="c1">// 3. Send HTTP response to the socket</span>
      <span class="c1">// 4. Close the socket</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>It’s an endless cycle that accepts a new connection, understands it, creates a response, returns the response, and accepts a new connection again. HTTP protocol is stateless, which means the server should not remember what happened in any previous connection. All it cares about is the incoming HTTP request in this particular connection.</p><p>The HTTP request is coming from the input stream of the socket and looks like a multi-line block of text. This is what you would see if you read an input stream of the socket:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
<span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>You will see something like this:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET / HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Cache-Control: max-age=0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4</code></pre></figure><p>The client (the Google Chrome browser, for example) passes this text into the connection established. It connects to port 8080 at <code>localhost</code>, and as soon as the connection is ready, it immediately sends this text into it, then waits for a response.</p><p>Our job is to create an HTTP response using the information we get in the request. If our server is very primitive, we can basically ignore all the information in the request and just return “Hello, world!” to all requests (I’m using <a href="https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/IOUtils.html"><code>IOUtils</code></a> for simplicity):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span>
          <span class="n">IOUtils</span><span class="o">.</span><span class="na">toInputStream</span><span class="o">(</span><span class="s">&quot;HTTP/1.1 200 OK\r\n\r\nHello, world!&quot;</span><span class="o">),</span>
          <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()</span>
        <span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s it. The server is ready. Try to compile and run it. Point your browser to <code>http://localhost:8080</code>, and you will see <code>Hello, world!</code>:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ javac -cp commons-io.jar Foo.java
$ java -cp commons-io.jar:. Foo <span class="p">&amp;</span>
$ curl http://localhost:8080 -v
* Rebuilt URL to: http://localhost:8080/
* Connected to localhost <span class="o">(</span>::1<span class="o">)</span> port <span class="m">8080</span> <span class="o">(</span><span class="c1">#0)</span>
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.37.1
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
* no chunk, no close, no size. Assume close to signal end
&lt;
* Closing connection <span class="m">0</span>
Hello, world!</code></pre></figure><p>That’s all you need to build a web server. Now let’s discuss how to make it object-oriented and composable. Let’s try to see how the <a href="http://www.takes.org">Takes</a> framework was built.</p><h2 id="routingdispatching">Routing/Dispatching</h2><p>Routing/dispatching is combined with response printing in Takes. All you need to do to create a working web application is to create a single class that implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Take.html"><code>Take</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Request</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkFoo</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">route</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>And now it’s time to start a server:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtBasic</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtBasic</span><span class="o">(</span><span class="k">new</span> <span class="n">TkFoo</span><span class="o">(),</span> <span class="mi">8080</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a> class does the exact same socket manipulations explained above. It starts a server socket on port 8080 and dispatches all incoming connections through an instance of <code>TkFoo</code> that we are giving to its constructor. It does this dispatching in an endless cycle, checking every second whether it’s time to stop with an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/Exit.html"><code>Exit</code></a>. Obviously, <code>Exit.NEVER</code> always responds with, “Don’t stop, please.”</p><h2 id="http-request">HTTP Request</h2><p>Now let’s see what’s inside the HTTP request arriving at <code>TkFoo</code> and what we can get out of it. This is how the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a> interface is defined in <a href="http://www.takes.org">Takes</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Request</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>The request is divided into two parts: the head and the body. The head contains all lines that go before the empty line that starts a body, according to HTTP specification in <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html">RFC 2616</a>. There are many useful decorators for <code>Request</code> in the framework. For example, <code>RqMethod</code> will help you get the method name from the first line of the header:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqMethod</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">method</span><span class="o">();</span></code></pre></figure><p><code>RqHref</code> will help extract the query part and parse it. For example, this is the request:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">user</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="mi">123</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">www</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span></code></pre></figure><p>This code will extract that <code>123</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="o">);</span></code></pre></figure><p><code>RqPrint</code> can get the entire request or its body printed as a <code>String</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqPrint</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">printBody</span><span class="o">();</span></code></pre></figure><p>The idea here is to keep the <code>Request</code> interface simple and provide this request parsing functionality to its decorators. This approach helps the framework keep classes small and cohesive. Each decorator is very small and solid, doing exactly one thing. All of these decorators are in the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rq/package-summary.html"><code>org.takes.rq</code></a> package. As you already probably understand, the <code>Rq</code> prefix stands for <code>Request</code>.</p><h2 id="first-real-web-app">First Real Web App</h2><p>Let’s create our first real web application, which will do something useful. I would recommend starting with an <code>Entry</code> class, which is required by Java to start an app from the command line:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This class contains just a single <code>main()</code> static method that will be called by JVM when the app starts from the command line. As you see, it instantiates <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtCli.html"><code>FtCli</code></a>, giving it an instance of class <code>TkApp</code> and command line arguments. We’ll create the <code>TkApp</code> class in a second. <code>FtCli</code> (translates to “front-end with command line interface”) makes an instance of the same <code>FtBasic</code>, wrapping it into a few useful decorators and configuring it according to command line arguments. For example, <code>--port=8080</code> will be converted into a <code>8080</code> port number and passed as a second argument of the <code>FtBasic</code> constructor.</p><p>The web application itself is called <code>TkApp</code> and extends <code>TsWrap</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.FkRegex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.TkFork</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkClasspath</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/robots.txt&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/css/.*&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkClasspath</span><span class="o">()),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We’ll discuss this <code>TkFork</code> class in a minute.</p><p>If you’re using Maven, this is the <code>pom.xml</code> you should start with:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0</span>
<span class="s">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>foo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>foo<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.takes<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>takes<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>0.9<span class="nt">&lt;/version&gt;</span> <span class="c">&lt;!-- check the latest in Maven Central --&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;finalName&gt;</span>foo<span class="nt">&lt;/finalName&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/deps<span class="nt">&lt;/outputDirectory&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre></figure><p>Running <code>mvn clean package</code> should build a <code>foo.jar</code> file in <code>target</code> directory and a collection of all JAR dependencies in <code>target/deps</code>. Now you can run the app from the command line:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ mvn clean package
$ java -Dfile.encoding<span class="o">=</span>UTF-8 <span class="se">\</span>
  -cp ./target/foo.jar:./target/deps/* foo.Entry --port<span class="o">=</span><span class="m">8080</span></code></pre></figure><p>The application is ready, and you can deploy it to, say, Heroku. Just create a <code>Procfile</code> file in the root of the repository and push the repo to Heroku. This is what <code>Procfile</code> should look like:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>web: java -Dfile.encoding=UTF-8 \
  -cp target/foo.jar:target/deps/* \
  foo.Entry --port=${PORT}</code></pre></figure><h2 id="tkfork"><code>TkFork</code></h2><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/TkFork.html"><code>TkFork</code></a> class seems to be one of the core elements of the framework. It helps route an incoming HTTP request to the right <em>take</em>. Its logic is very simple, and there are just a few lines of code inside it. It encapsulates a collection of “forks,” which are instances of the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/Fork.html"><code>Fork</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Fork</span> <span class="o">{</span>
  <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Its only <code>route()</code> method either returns an empty iterator or an iterator with a single <code>Response</code>. <code>TkFork</code> goes through all forks, calling their <code>route()</code> methods until one of them returns a response. Once that happens, <code>TkFork</code> returns this response to the caller, which is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a>.</p><p>Let’s create a simple fork ourselves now. For example, we want to show the status of the application when the <code>/status</code> URL is requested. Here is the code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">Fork</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">responses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">path</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">responses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">TkStatus</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">responses</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>I believe the logic here is clear. We either return an empty iterator or an iterator with an instance of <code>TkStatus</code> inside. If an empty iterator is returned, <code>TkFork</code> will try to find another fork in the collection that actually gets an instance of <code>Response</code>. By the way, if nothing is found and all forks return empty iterators, <code>TkFork</code> will throw a “Page not found” exception.</p><p>This exact logic is implemented by an out-of-the-box fork called <code>FkRegex</code>, which attempts to match a request URI path with the regular expression provided:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatus</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We can compose a multi-level structure of <code>TkFork</code> classes; for example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TsWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span>
        <span class="s">&quot;/status&quot;</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;json&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusJSON</span><span class="o">()),</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;xml&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusXML</span><span class="o">())</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Again, I believe it’s obvious. The instance of <code>FkRegex</code> will ask an encapsulated instance of <code>TkFork</code> to return a response, and it will try to fetch it from one that <code>FkParams</code> encapsulated. If the HTTP query is <code>/status?f=xml</code>, an instance of <code>TkStatusXML</code> will be returned.</p><h2 id="http-response">HTTP Response</h2><p>Now let’s discuss the structure of the HTTP response and its object-oriented abstraction, <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Response.html"><code>Response</code></a>. This is how the interface looks:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Response</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Looks very similar to the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a>, doesn’t it? Well, it’s identical, mostly because the structure of the HTTP request and response is almost identical. The only difference is the first line.</p><p>There is a collection of useful decorators that help in response building. They are <a href="/2015/02/26/composable-decorators.html">composable</a>, which makes them very convenient. For example, if you want to build a response that contains an HTML page, you compose them like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsWithStatus</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">RsWithBody</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">),</span>
        <span class="s">&quot;text/html&quot;</span>
      <span class="o">),</span>
      <span class="mi">200</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>In this example, the decorator <code>RsWithBody</code> creates a response with a body but with no headers at all. Then, <code>RsWithType</code> adds the header <code>Content-Type: text/html</code> to it. Then, <code>RsWithStatus</code> makes sure the first line of the response contains <code>HTTP/1.1 200 OK</code>.</p><p>You can create your own decorators that can reuse existing ones. Take a look at how it’s done in <a href="https://github.com/yegor256/rultor/blob/1.50.2/src/main/java/com/rultor/web/RsPage.java"><code>RsPage</code></a> from rultor.com.</p><h2 id="how-about-templates">How About Templates?</h2><p>Returning simple “Hello, world” pages is not a big problem, as we can see. But what about more complex output like HTML pages, <a href="/2015/11/16/json-vs-xml.html">XML</a> documents, JSON data sets, etc? There are a few convenient <code>Response</code> decorators that enable all of that. Let’s start with <a href="http://velocity.apache.org">Velocity</a>, a simple templating engine. Well, it’s not that simple. It’s rather powerful, but I would suggest to use it in simple situations only. Here is how it works:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsVelocity</span><span class="o">(</span><span class="s">&quot;Hello, ${name}&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeffrey&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/RsVelocity.html"><code>RsVelocity</code></a> constructor accepts a single argument that has to be a Velocity template. Then, you call the <code>with()</code> method, injecting data into the Velocity context. When it’s time to render the HTTP response, <code>RsVelocity</code> will “evaluate” the template against the context configured. Again, I would recommend you use this templating approach only for simple outputs.</p><p>For more complex HTML documents, I would recommend you use XML/XSLT in combination with Xembly. I explained this idea in a few previous posts: <a href="/2014/06/25/xml-and-xslt-in-browser.html">XML+XSLT in a Browser</a> and <a href="/2014/09/09/restful-web-sites.html">RESTful API and a Web Site in the Same URL</a>. It is simple and powerful—Java generates XML output and the XSLT processor transforms it into HTML documents. This is how we separate representation from data. The XSL stylesheet is a “view” and <code>TkIndex</code> is a “controller,” in terms of <a href="/2016/12/13/mvc-vs-oop.html">MVC</a>.</p><p>I’ll write a separate article about templating with Xembly and XSL very soon.</p><p>In the meantime, we’ll create decorators for <a href="http://en.wikipedia.org/wiki/Facelets">JSF/Facelets</a> and <a href="http://en.wikipedia.org/wiki/JavaServer_Pages">JSP</a> rendering in Takes. If you’re interested in helping, please fork the framework and submit your pull requests.</p><h2 id="what-about-persistence">What About Persistence?</h2><p>Now, a question that comes up is what to do with persistent entities, like databases, in-memory structures, network connections, etc. My suggestion is to initialize them inside the <code>Entry</code> class and pass them as arguments into the <code>TkApp</code> constructor. Then, the <code>TkApp</code> will pass them into the constructors of custom <em>takes</em>.</p><p>For example, we have a PostgreSQL database that contains some table data that we need to render. Here is how I would initialize a connection to it in the <code>Entry</code> class (I’m using a <a href="http://www.jolbox.com/">BoneCP</a> connection pool):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(</span><span class="n">Entry</span><span class="o">.</span><span class="na">postgres</span><span class="o">()),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Source</span> <span class="nf">postgres</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">BoneCPDataSource</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BoneCPDataSource</span><span class="o">();</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setDriverClass</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">&quot;jdbc:postgresql://localhost/db&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">&quot;root&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;super-secret-password&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">src</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Now, the constructor of <code>TkApp</code> must accept a single argument of type <code>java.sql.Source</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">(</span><span class="n">source</span><span class="o">))</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Class <code>TkIndex</code> also accepts a single argument of class <code>Source</code>. I believe you know what to do with it inside <code>TkIndex</code> in order to fetch the SQL table data and convert it into HTML. The point here is that the dependency must be injected into the application (instance of class <code>TkApp</code>) at the moment of its instantiation. This is a pure and clean dependency injection mechanism, which is absolutely container-free. Read more about it in <a href="/2014/10/03/di-containers-are-evil.html">Dependency Injection Containers Are Code Polluters</a>.</p><h2 id="unit-testing">Unit Testing</h2><p>Since every class is immutable and all dependencies are injected only through constructors, unit testing is extremely easy. Let’s say we want to test <code>TkStatus</code>, which is supposed to return an HTML response (I’m using <a href="http://junit.org/">JUnit 4</a> and <a href="https://github.com/hamcrest/JavaHamcrest">Hamcrest</a>):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.Matchers</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsPrint</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">TkStatus</span><span class="o">().</span><span class="na">act</span><span class="o">(</span><span class="k">new</span> <span class="n">RqFake</span><span class="o">())</span>
      <span class="o">).</span><span class="na">printBody</span><span class="o">(),</span>
      <span class="n">Matchers</span><span class="o">.</span><span class="na">equalsTo</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Also, we can start the entire application or any individual <em>take</em> in a test HTTP server and test its behavior via a real TCP socket; for example (I’m using <a href="http://http.jcabi.com">jcabi-http</a> to make an HTTP request and check the output):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtRemote</span><span class="o">(</span><span class="k">new</span> <span class="n">TkIndex</span><span class="o">()).</span><span class="na">exec</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FtRemote</span><span class="o">.</span><span class="na">Script</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exec</span><span class="o">(</span><span class="kd">final</span> <span class="n">URI</span> <span class="n">home</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
          <span class="k">new</span> <span class="n">JdkRequest</span><span class="o">(</span><span class="n">home</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fetch</span><span class="o">()</span>
            <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="n">RestResponse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertStatus</span><span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertBody</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">containsString</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtRemote.html"><code>FtRemote</code></a> starts a test web server at a random TCP port and calls the <code>exec()</code> method at the provided instance of <code>FtRemote.Script</code>. The first argument of this method is a URI of the just-started web server homepage.</p><p>The architecture of Takes framework is very modular and composable. Any individual <em>take</em> can be tested as a standalone component, absolutely independent from the framework and other <em>takes</em>.</p><h2 id="why-the-name">Why the Name?</h2><p>That’s the question I’ve been hearing rather often. The idea is simple, and it originates from the movie business. When a movie is made, the crew shoots many <em>takes</em> in order to capture the reality and put it on film. Each capture is called a <em>take</em>.</p><p>In other words, a <em>take</em> is like a snapshot of the reality.</p><p>The same applies to this framework. Each instance of <code>Take</code> represents a reality at one particular moment in time. This reality is then sent to the user in the form of a <code>Response</code>.</p><p>PS. There are a few words about authentication: <a href="/2015/05/18/cookie-based-authentication.html">How Cookie-Based Authentication Works in the Takes Framework</a>.</p><p>PPS. There are a few real web systems, which you may be interested to take a look at. They all are using Takes Framework and their code is open: <a href="https://github.com/yegor256/rultor">rultor.com</a>, <a href="/2016/03/30/jare-instant-free-cdn.html">jare.io</a>, <a href="/2016/03/15/wring-dispatcher-github-notifications.html">wring.io</a>.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;p&gt;When two or more software modules are accessing the same resource, they have to be synchronized. This means that only one module at a time should be working with the resource. Without such synchronization, there will be collisions and conflicts. This is especially true when we’re talking about “resources” that do not support &lt;em&gt;atomic&lt;/em&gt; transactions.&lt;/p&gt; &lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.stateful.co&quot;&gt;&lt;img src=&quot;http://img.stateful.co/pomegranate.svg&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;To solve this issue and prevent conflicts, we have to introduce one more element into the picture. All software modules, before accessing the resource, should &lt;em&gt;capture&lt;/em&gt; a lock from a centralized server. Once the manipulations with the resource are complete, the module should &lt;em&gt;release&lt;/em&gt; the lock. While the lock is being captured by one module, no other modules will be able to capture it. The approach is very simple and well-known. However, I didn’t find any cloud services that would provide such a locking and unlocking service over a RESTful API. So I decided to create one—&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;No Retreat, No Surrender (1986) by Corey Yuen&quot; src=&quot;/images/2014/12/van-damme-split.png&quot; longdesc=&quot;#2a251ead&quot; /&gt;&lt;figcaption id=&quot;2a251ead&quot;&gt;No Retreat, No Surrender (1986) by Corey Yuen&lt;/figcaption&gt;&lt;/figure&gt; &lt;p&gt;Here is a practical example. I have a Java web app that is hosted at Heroku. There are three servers (a.k.a. “dynos”) running the same &lt;code&gt;.war&lt;/code&gt; application. Why three? Because the web traffic is rather active, and one server is not powerful enough. So I have to have three of them. They all run exactly the same applications.&lt;/p&gt; &lt;p&gt;Each web app works with a table in Amazon DynamoDB. It updates the table, puts new items into it, deletes some items sometimes, and selects them. So far, so good, but conflicts are inevitable. Here is an example of a typical interaction scenario between the web app and DynamoDB (I’m using jcabi-dynamo):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeff&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;recalculate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The logic is obvious here. First, I retrieve an item from the table &lt;code&gt;posts&lt;/code&gt;, then read its &lt;code&gt;salary&lt;/code&gt;, and then modify it according to my recalculation algorithm. The problem is that another module may start to do the same while I’m recalculating. It will read the same initial value from the table and will start exactly the same recalculation. Then it will save a new value, and I will save one too. We will end up having Jeff’s salary modified only once, while users will expect a double modification since two of them initiated two transactions with two different web apps.&lt;/p&gt; &lt;p&gt;The right approach here is to “lock” the DynamoDB table first, even before reading the salary. Then do the modifications and eventually unlock it. Here is how &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; helps me. All I need to do is create a new named lock in the &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; web panel, get my authentication keys, and modify my Java code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sttc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RtSttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;urn:github:526301&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// my GitHub ID&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;9FF3-4320-73FB-EEAC&amp;quot;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// my secret key!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Locks&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;locks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;locks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;locks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts-table-lock&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeff&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Atomic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;recalculate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;As you see, I wrap that critical transaction into &lt;code&gt;Callable&lt;/code&gt;, which will be executed in isolation. This approach, obviously, doesn’t guarantee atomicity of transaction—if part of the transaction fails, there won’t be any automatic rollbacks and the DynamoDB table will be left in a “broken” state.&lt;/p&gt; &lt;p&gt;Locks from &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; guarantee isolation in resource usage, and you can use any type of resources, including NoSQL tables, files, S3 objects, embedded software, etc.&lt;/p&gt; &lt;p&gt;I should not forget to add this dependency to my &lt;code&gt;pom.xml&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;co.stateful&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;java-sdk&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Of course, you can do the same; the service is absolutely free of charge. And you can use any other languages, not just Java. BTW, if interested, contribute with your own SDK in your preferred language; I’ll add it to the &lt;a href=&quot;https://github.com/sttc&quot;&gt;GitHub collection&lt;/a&gt;.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, image, jb_picture, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-12-04 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Synchronization Between Nodes"/> <meta name="twitter:description" property="og:description" content="&lt;p&gt;When two or more software modules are accessing the same resource, they have to be synchronized. This means that only one module at a time should be working with the resource. Without such synchronization, there will be collisions and conflicts. This is especially true when we’re talking about “resources” that do not support &lt;em&gt;atomic&lt;/em&gt; transactions.&lt;/p&gt; &lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.stateful.co&quot;&gt;&lt;img src=&quot;http://img.stateful.co/pomegranate.svg&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;To solve this issue and prevent conflicts, we have to introduce one more element into the picture. All software modules, before accessing the resource, should &lt;em&gt;capture&lt;/em&gt; a lock from a centralized server. Once the manipulations with the resource are complete, the module should &lt;em&gt;release&lt;/em&gt; the lock. While the lock is being captured by one module, no other modules will be able to capture it. The approach is very simple and well-known. However, I didn’t find any cloud services that would provide such a locking and unlocking service over a RESTful API. So I decided to create one—&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;.&lt;/p&gt; &lt;!--more--&gt; &lt;figure class=&quot;jb_picture&quot;&gt;&lt;img itemprop=&quot;image&quot; alt=&quot;No Retreat, No Surrender (1986) by Corey Yuen&quot; src=&quot;/images/2014/12/van-damme-split.png&quot; longdesc=&quot;#2a251ead&quot; /&gt;&lt;figcaption id=&quot;2a251ead&quot;&gt;No Retreat, No Surrender (1986) by Corey Yuen&lt;/figcaption&gt;&lt;/figure&gt; &lt;p&gt;Here is a practical example. I have a Java web app that is hosted at Heroku. There are three servers (a.k.a. “dynos”) running the same &lt;code&gt;.war&lt;/code&gt; application. Why three? Because the web traffic is rather active, and one server is not powerful enough. So I have to have three of them. They all run exactly the same applications.&lt;/p&gt; &lt;p&gt;Each web app works with a table in Amazon DynamoDB. It updates the table, puts new items into it, deletes some items sometimes, and selects them. So far, so good, but conflicts are inevitable. Here is an example of a typical interaction scenario between the web app and DynamoDB (I’m using jcabi-dynamo):&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeff&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;recalculate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The logic is obvious here. First, I retrieve an item from the table &lt;code&gt;posts&lt;/code&gt;, then read its &lt;code&gt;salary&lt;/code&gt;, and then modify it according to my recalculation algorithm. The problem is that another module may start to do the same while I’m recalculating. It will read the same initial value from the table and will start exactly the same recalculation. Then it will save a new value, and I will save one too. We will end up having Jeff’s salary modified only once, while users will expect a double modification since two of them initiated two transactions with two different web apps.&lt;/p&gt; &lt;p&gt;The right approach here is to “lock” the DynamoDB table first, even before reading the salary. Then do the modifications and eventually unlock it. Here is how &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; helps me. All I need to do is create a new named lock in the &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; web panel, get my authentication keys, and modify my Java code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sttc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RtSttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;urn:github:526301&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// my GitHub ID&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;9FF3-4320-73FB-EEAC&amp;quot;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// my secret key!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Locks&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;locks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;locks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;locks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts-table-lock&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;posts&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jeff&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Atomic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;salary&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;recalculate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;salary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;As you see, I wrap that critical transaction into &lt;code&gt;Callable&lt;/code&gt;, which will be executed in isolation. This approach, obviously, doesn’t guarantee atomicity of transaction—if part of the transaction fails, there won’t be any automatic rollbacks and the DynamoDB table will be left in a “broken” state.&lt;/p&gt; &lt;p&gt;Locks from &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; guarantee isolation in resource usage, and you can use any type of resources, including NoSQL tables, files, S3 objects, embedded software, etc.&lt;/p&gt; &lt;p&gt;I should not forget to add this dependency to my &lt;code&gt;pom.xml&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;co.stateful&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;java-sdk&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Of course, you can do the same; the service is absolutely free of charge. And you can use any other languages, not just Java. BTW, if interested, contribute with your own SDK in your preferred language; I’ll add it to the &lt;a href=&quot;https://github.com/sttc&quot;&gt;GitHub collection&lt;/a&gt;.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html" /> <link rel="amphtml" href="https://www.yegor256.com/2014/12/04/synchronization-between-nodes.amp.html" /> <title>Synchronization Between Nodes </title> <meta name='og:image' content='https://www.yegor256.com/images/2014/12/van-damme-split.png'/><meta name='twitter:image' content='https://www.yegor256.com/images/2014/12/van-damme-split.png'/><meta name='og:image:width' content='1920'/> <meta name='twitter:image:width' content='1920'/><meta name='og:image:height' content='982'/> <meta name='twitter:image:height' content='982'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='No Retreat, No Surrender (1986) by Corey Yuen'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2014/12/04/synchronization-between-nodes.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2014/12/04/synchronization-between-nodes.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html</code></p><h1 itemprop="name headline mainEntityOfPage">Synchronization Between Nodes</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-12-04T00:00:00+00:00"> 4 December 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><p>When two or more software modules are accessing the same resource, they have to be synchronized. This means that only one module at a time should be working with the resource. Without such synchronization, there will be collisions and conflicts. This is especially true when we’re talking about “resources” that do not support <em>atomic</em> transactions.</p><figure class="badge"><a href="http://www.stateful.co"><img src="http://img.stateful.co/pomegranate.svg" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>To solve this issue and prevent conflicts, we have to introduce one more element into the picture. All software modules, before accessing the resource, should <em>capture</em> a lock from a centralized server. Once the manipulations with the resource are complete, the module should <em>release</em> the lock. While the lock is being captured by one module, no other modules will be able to capture it. The approach is very simple and well-known. However, I didn’t find any cloud services that would provide such a locking and unlocking service over a RESTful API. So I decided to create one—<a href="http://www.stateful.co">stateful.co</a>.</p><figure class="jb_picture"><img itemprop="image" alt="No Retreat, No Surrender (1986) by Corey Yuen" src="/images/2014/12/van-damme-split.png" longdesc="#2a251ead" /><figcaption id="2a251ead">No Retreat, No Surrender (1986) by Corey Yuen</figcaption></figure><p>Here is a practical example. I have a Java web app that is hosted at Heroku. There are three servers (a.k.a. “dynos”) running the same <code>.war</code> application. Why three? Because the web traffic is rather active, and one server is not powerful enough. So I have to have three of them. They all run exactly the same applications.</p><p>Each web app works with a table in Amazon DynamoDB. It updates the table, puts new items into it, deletes some items sometimes, and selects them. So far, so good, but conflicts are inevitable. Here is an example of a typical interaction scenario between the web app and DynamoDB (I’m using jcabi-dynamo):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">&quot;posts&quot;</span><span class="o">);</span>
<span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">frame</span><span class="o">()</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeff&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
<span class="n">String</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">);</span>
<span class="n">item</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">recalculate</span><span class="o">(</span><span class="n">salary</span><span class="o">));</span></code></pre></figure><p>The logic is obvious here. First, I retrieve an item from the table <code>posts</code>, then read its <code>salary</code>, and then modify it according to my recalculation algorithm. The problem is that another module may start to do the same while I’m recalculating. It will read the same initial value from the table and will start exactly the same recalculation. Then it will save a new value, and I will save one too. We will end up having Jeff’s salary modified only once, while users will expect a double modification since two of them initiated two transactions with two different web apps.</p><p>The right approach here is to “lock” the DynamoDB table first, even before reading the salary. Then do the modifications and eventually unlock it. Here is how <a href="http://www.stateful.co">stateful.co</a> helps me. All I need to do is create a new named lock in the <a href="http://www.stateful.co">stateful.co</a> web panel, get my authentication keys, and modify my Java code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Sttc</span> <span class="n">sttc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RtSttc</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">URN</span><span class="o">(</span><span class="s">&quot;urn:github:526301&quot;</span><span class="o">),</span> <span class="c1">// my GitHub ID</span>
  <span class="s">&quot;9FF3-4320-73FB-EEAC&quot;</span> <span class="c1">// my secret key!</span>
<span class="o">);</span>
<span class="n">Locks</span> <span class="n">locks</span> <span class="o">=</span> <span class="n">sttc</span><span class="o">.</span><span class="na">locks</span><span class="o">();</span>
<span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">locks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;posts-table-lock&quot;</span><span class="o">);</span>
<span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">&quot;posts&quot;</span><span class="o">);</span>
<span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">frame</span><span class="o">()</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeff&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
<span class="k">new</span> <span class="n">Atomic</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">call</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">);</span>
      <span class="n">item</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">recalculate</span><span class="o">(</span><span class="n">salary</span><span class="o">));</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">);</span></code></pre></figure><p>As you see, I wrap that critical transaction into <code>Callable</code>, which will be executed in isolation. This approach, obviously, doesn’t guarantee atomicity of transaction—if part of the transaction fails, there won’t be any automatic rollbacks and the DynamoDB table will be left in a “broken” state.</p><p>Locks from <a href="http://www.stateful.co">stateful.co</a> guarantee isolation in resource usage, and you can use any type of resources, including NoSQL tables, files, S3 objects, embedded software, etc.</p><p>I should not forget to add this dependency to my <code>pom.xml</code>:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>co.stateful<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-sdk<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure><p>Of course, you can do the same; the service is absolutely free of charge. And you can use any other languages, not just Java. BTW, if interested, contribute with your own SDK in your preferred language; I’ll add it to the <a href="https://github.com/sttc">GitHub collection</a>.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html&amp;text=Synchronization+Between+Nodes" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html%3F2014-48&amp;title=Synchronization+Between+Nodes" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/12/04/synchronization-between-nodes.html%3F2014-48&amp;t=Synchronization+Between+Nodes" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>When two or more software modules are accessing the same resource, they have to be synchronized. This means that only one module at a time should be working with the resource. Without such synchronization, there will be collisions and conflicts. This is especially true when we’re talking about “resources” that do not support <em>atomic</em> transactions.</p><figure class="badge"><a href="http://www.stateful.co"><img src="http://img.stateful.co/pomegranate.svg" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>To solve this issue and prevent conflicts, we have to introduce one more element into the picture. All software modules, before accessing the resource, should <em>capture</em> a lock from a centralized server. Once the manipulations with the resource are complete, the module should <em>release</em> the lock. While the lock is being captured by one module, no other modules will be able to capture it. The approach is very simple and well-known. However, I didn’t find any cloud services that would provide such a locking and unlocking service over a RESTful API. So I decided to create one—<a href="http://www.stateful.co">stateful.co</a>.</p><figure class="jb_picture"><img itemprop="image" alt="No Retreat, No Surrender (1986) by Corey Yuen" src="/images/2014/12/van-damme-split.png" longdesc="#2a251ead" /><figcaption id="2a251ead">No Retreat, No Surrender (1986) by Corey Yuen</figcaption></figure><p>Here is a practical example. I have a Java web app that is hosted at Heroku. There are three servers (a.k.a. “dynos”) running the same <code>.war</code> application. Why three? Because the web traffic is rather active, and one server is not powerful enough. So I have to have three of them. They all run exactly the same applications.</p><p>Each web app works with a table in Amazon DynamoDB. It updates the table, puts new items into it, deletes some items sometimes, and selects them. So far, so good, but conflicts are inevitable. Here is an example of a typical interaction scenario between the web app and DynamoDB (I’m using jcabi-dynamo):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">&quot;posts&quot;</span><span class="o">);</span>
<span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">frame</span><span class="o">()</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeff&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
<span class="n">String</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">);</span>
<span class="n">item</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">recalculate</span><span class="o">(</span><span class="n">salary</span><span class="o">));</span></code></pre></figure><p>The logic is obvious here. First, I retrieve an item from the table <code>posts</code>, then read its <code>salary</code>, and then modify it according to my recalculation algorithm. The problem is that another module may start to do the same while I’m recalculating. It will read the same initial value from the table and will start exactly the same recalculation. Then it will save a new value, and I will save one too. We will end up having Jeff’s salary modified only once, while users will expect a double modification since two of them initiated two transactions with two different web apps.</p><p>The right approach here is to “lock” the DynamoDB table first, even before reading the salary. Then do the modifications and eventually unlock it. Here is how <a href="http://www.stateful.co">stateful.co</a> helps me. All I need to do is create a new named lock in the <a href="http://www.stateful.co">stateful.co</a> web panel, get my authentication keys, and modify my Java code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Sttc</span> <span class="n">sttc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RtSttc</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">URN</span><span class="o">(</span><span class="s">&quot;urn:github:526301&quot;</span><span class="o">),</span> <span class="c1">// my GitHub ID</span>
  <span class="s">&quot;9FF3-4320-73FB-EEAC&quot;</span> <span class="c1">// my secret key!</span>
<span class="o">);</span>
<span class="n">Locks</span> <span class="n">locks</span> <span class="o">=</span> <span class="n">sttc</span><span class="o">.</span><span class="na">locks</span><span class="o">();</span>
<span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">locks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;posts-table-lock&quot;</span><span class="o">);</span>
<span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="s">&quot;posts&quot;</span><span class="o">);</span>
<span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">frame</span><span class="o">()</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeff&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
<span class="k">new</span> <span class="n">Atomic</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">call</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">);</span>
      <span class="n">item</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">recalculate</span><span class="o">(</span><span class="n">salary</span><span class="o">));</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">);</span></code></pre></figure><p>As you see, I wrap that critical transaction into <code>Callable</code>, which will be executed in isolation. This approach, obviously, doesn’t guarantee atomicity of transaction—if part of the transaction fails, there won’t be any automatic rollbacks and the DynamoDB table will be left in a “broken” state.</p><p>Locks from <a href="http://www.stateful.co">stateful.co</a> guarantee isolation in resource usage, and you can use any type of resources, including NoSQL tables, files, S3 objects, embedded software, etc.</p><p>I should not forget to add this dependency to my <code>pom.xml</code>:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>co.stateful<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-sdk<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure><p>Of course, you can do the same; the service is absolutely free of charge. And you can use any other languages, not just Java. BTW, if interested, contribute with your own SDK in your preferred language; I’ll add it to the <a href="https://github.com/sttc">GitHub collection</a>.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2014/04/dynamodb-logo.png&quot; style=&quot;width:150px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Amazon DynamoDB is a great NoSQL cloud database. It is cheap, highly reliable and rather powerful. I’m using it in many web systems.&lt;/p&gt; &lt;p&gt;There is one feature that it lacks, though—auto-increment attributes.&lt;/p&gt; &lt;p&gt;Say that you have a table with a list of messages:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;+------+----------------------------+ | id | Attributes | +------+----------------------------+ | 205 | author=&amp;quot;jeff&amp;quot;, text=&amp;quot;...&amp;quot; | | 206 | author=&amp;quot;bob&amp;quot;, text=&amp;quot;...&amp;quot; | | 207 | author=&amp;quot;alice&amp;quot;, text=&amp;quot;...&amp;quot; | +------+----------------------------+&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Every time you add a new item to the table, a new value of &lt;code&gt;id&lt;/code&gt; has to be set. And this has to be done with concurrency in mind. SQL databases like PostgreSQL, Oracle, MySQL and others support auto-increment features. When you add a new record to the table, the value of the primary key is omitted and the server retrieves the next one automatically. If a number of &lt;code&gt;INSERT&lt;/code&gt; requests arrive at the same time the server guarantees that the numbers won’t be duplicated.&lt;/p&gt; &lt;p&gt;However, DynamoDB doesn’t have this feature. Instead, DynamoDB has &lt;a href=&quot;http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters&quot;&gt;Atomic Counters&lt;/a&gt; and &lt;a href=&quot;http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.ConditionalUpdate&quot;&gt;Conditional Updates&lt;/a&gt;, which are very similar features. Still, they’re not exactly the same.&lt;/p&gt; &lt;p&gt;In case of an atomic counter, you should create a supplementary table and keep the latest value of &lt;code&gt;id&lt;/code&gt; in it.&lt;/p&gt; &lt;p&gt;In case of conditional updates, you should &lt;a href=&quot;/2014/08/15/retry-java-method-on-exception.html&quot;&gt;retry&lt;/a&gt; a few times in case of collisions.&lt;/p&gt; &lt;figure class=&quot;badge&quot;&gt;&lt;img src=&quot;http://img.stateful.co/pomegranate.svg&quot; style=&quot;width:128px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/figure&gt; &lt;p&gt;To make life easier in a few of my applications, I created a simple web service—&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;. It provides a simple atomic counter feature through its RESTful API.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, you create a counter with a unique name. Then, you set its initial value (it is zero by default). And, that’s it. Every time you need to obtain a new value for &lt;code&gt;id&lt;/code&gt; column in DynamoDB table, you make an HTTP request to &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; asking to increment your counter by one and return its next value.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; guarantees that values returned will never duplicate each other—no matter how many clients are using a counter or how fast they request increments simultaneously.&lt;/p&gt; &lt;p&gt;Moreover, I designed a small &lt;a href=&quot;https://github.com/sttc/java-sdk&quot;&gt;Java SDK&lt;/a&gt; for &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;. All you need to do is add this &lt;a href=&quot;http://repo1.maven.org/maven2/co/stateful/java-sdk/&quot;&gt;java-sdk.jar&lt;/a&gt; Maven dependency to your project:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;co.stateful&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;java-sdk&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.6&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;And, you can use &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; counters from Java code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sttc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RtSttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;urn:github:526301&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;9FF3-41E0-73FB-F900&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Counters&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counters&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;counters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Counter&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;incrementAndGet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1L&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;new value: &amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;You can review authentication parameters for &lt;code&gt;RtSttc&lt;/code&gt; constructor at &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;The service is absolutely free of charge.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-05-18 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Atomic Counters at Stateful.co"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2014/04/dynamodb-logo.png&quot; style=&quot;width:150px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Amazon DynamoDB is a great NoSQL cloud database. It is cheap, highly reliable and rather powerful. I’m using it in many web systems.&lt;/p&gt; &lt;p&gt;There is one feature that it lacks, though—auto-increment attributes.&lt;/p&gt; &lt;p&gt;Say that you have a table with a list of messages:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;+------+----------------------------+ | id | Attributes | +------+----------------------------+ | 205 | author=&amp;quot;jeff&amp;quot;, text=&amp;quot;...&amp;quot; | | 206 | author=&amp;quot;bob&amp;quot;, text=&amp;quot;...&amp;quot; | | 207 | author=&amp;quot;alice&amp;quot;, text=&amp;quot;...&amp;quot; | +------+----------------------------+&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Every time you add a new item to the table, a new value of &lt;code&gt;id&lt;/code&gt; has to be set. And this has to be done with concurrency in mind. SQL databases like PostgreSQL, Oracle, MySQL and others support auto-increment features. When you add a new record to the table, the value of the primary key is omitted and the server retrieves the next one automatically. If a number of &lt;code&gt;INSERT&lt;/code&gt; requests arrive at the same time the server guarantees that the numbers won’t be duplicated.&lt;/p&gt; &lt;p&gt;However, DynamoDB doesn’t have this feature. Instead, DynamoDB has &lt;a href=&quot;http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters&quot;&gt;Atomic Counters&lt;/a&gt; and &lt;a href=&quot;http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.ConditionalUpdate&quot;&gt;Conditional Updates&lt;/a&gt;, which are very similar features. Still, they’re not exactly the same.&lt;/p&gt; &lt;p&gt;In case of an atomic counter, you should create a supplementary table and keep the latest value of &lt;code&gt;id&lt;/code&gt; in it.&lt;/p&gt; &lt;p&gt;In case of conditional updates, you should &lt;a href=&quot;/2014/08/15/retry-java-method-on-exception.html&quot;&gt;retry&lt;/a&gt; a few times in case of collisions.&lt;/p&gt; &lt;figure class=&quot;badge&quot;&gt;&lt;img src=&quot;http://img.stateful.co/pomegranate.svg&quot; style=&quot;width:128px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/figure&gt; &lt;p&gt;To make life easier in a few of my applications, I created a simple web service—&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;. It provides a simple atomic counter feature through its RESTful API.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;First, you create a counter with a unique name. Then, you set its initial value (it is zero by default). And, that’s it. Every time you need to obtain a new value for &lt;code&gt;id&lt;/code&gt; column in DynamoDB table, you make an HTTP request to &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; asking to increment your counter by one and return its next value.&lt;/p&gt; &lt;p&gt;&lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; guarantees that values returned will never duplicate each other—no matter how many clients are using a counter or how fast they request increments simultaneously.&lt;/p&gt; &lt;p&gt;Moreover, I designed a small &lt;a href=&quot;https://github.com/sttc/java-sdk&quot;&gt;Java SDK&lt;/a&gt; for &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;. All you need to do is add this &lt;a href=&quot;http://repo1.maven.org/maven2/co/stateful/java-sdk/&quot;&gt;java-sdk.jar&lt;/a&gt; Maven dependency to your project:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;co.stateful&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;java-sdk&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.6&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;And, you can use &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt; counters from Java code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sttc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RtSttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;urn:github:526301&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;9FF3-41E0-73FB-F900&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Counters&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counters&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sttc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;counters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Counter&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;counter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;incrementAndGet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1L&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;new value: &amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;You can review authentication parameters for &lt;code&gt;RtSttc&lt;/code&gt; constructor at &lt;a href=&quot;http://www.stateful.co&quot;&gt;stateful.co&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;The service is absolutely free of charge.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html" /> <link rel="amphtml" href="https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.amp.html" /> <title>Atomic Counters at Stateful.co </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2014/05/18/cloud-autoincrement-counters.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2014/05/18/cloud-autoincrement-counters.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html</code></p><h1 itemprop="name headline mainEntityOfPage">Atomic Counters at Stateful.co</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-05-18T00:00:00+00:00"> 18 May 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><img src="https://www.yegor256.com/images/2014/04/dynamodb-logo.png" style="width:150px;max-width:100%;" alt="badge" /></figure><p>Amazon DynamoDB is a great NoSQL cloud database. It is cheap, highly reliable and rather powerful. I’m using it in many web systems.</p><p>There is one feature that it lacks, though—auto-increment attributes.</p><p>Say that you have a table with a list of messages:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>+------+----------------------------+
| id   | Attributes                 |
+------+----------------------------+
| 205  | author=&quot;jeff&quot;, text=&quot;...&quot;  |
| 206  | author=&quot;bob&quot;, text=&quot;...&quot;   |
| 207  | author=&quot;alice&quot;, text=&quot;...&quot; |
+------+----------------------------+</code></pre></figure><p>Every time you add a new item to the table, a new value of <code>id</code> has to be set. And this has to be done with concurrency in mind. SQL databases like PostgreSQL, Oracle, MySQL and others support auto-increment features. When you add a new record to the table, the value of the primary key is omitted and the server retrieves the next one automatically. If a number of <code>INSERT</code> requests arrive at the same time the server guarantees that the numbers won’t be duplicated.</p><p>However, DynamoDB doesn’t have this feature. Instead, DynamoDB has <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters">Atomic Counters</a> and <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.ConditionalUpdate">Conditional Updates</a>, which are very similar features. Still, they’re not exactly the same.</p><p>In case of an atomic counter, you should create a supplementary table and keep the latest value of <code>id</code> in it.</p><p>In case of conditional updates, you should <a href="/2014/08/15/retry-java-method-on-exception.html">retry</a> a few times in case of collisions.</p><figure class="badge"><img src="http://img.stateful.co/pomegranate.svg" style="width:128px;max-width:100%;" alt="badge" /></figure><p>To make life easier in a few of my applications, I created a simple web service—<a href="http://www.stateful.co">stateful.co</a>. It provides a simple atomic counter feature through its RESTful API.</p><p>First, you create a counter with a unique name. Then, you set its initial value (it is zero by default). And, that’s it. Every time you need to obtain a new value for <code>id</code> column in DynamoDB table, you make an HTTP request to <a href="http://www.stateful.co">stateful.co</a> asking to increment your counter by one and return its next value.</p><p><a href="http://www.stateful.co">stateful.co</a> guarantees that values returned will never duplicate each other—no matter how many clients are using a counter or how fast they request increments simultaneously.</p><p>Moreover, I designed a small <a href="https://github.com/sttc/java-sdk">Java SDK</a> for <a href="http://www.stateful.co">stateful.co</a>. All you need to do is add this <a href="http://repo1.maven.org/maven2/co/stateful/java-sdk/">java-sdk.jar</a> Maven dependency to your project:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>co.stateful<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-sdk<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>0.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure><p>And, you can use <a href="http://www.stateful.co">stateful.co</a> counters from Java code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Sttc</span> <span class="n">sttc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RtSttc</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">URN</span><span class="o">(</span><span class="s">&quot;urn:github:526301&quot;</span><span class="o">),</span>
  <span class="s">&quot;9FF3-41E0-73FB-F900&quot;</span>
<span class="o">);</span>
<span class="n">Counters</span> <span class="n">counters</span> <span class="o">=</span> <span class="n">sttc</span><span class="o">.</span><span class="na">counters</span><span class="o">();</span>
<span class="n">Counter</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">counters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">);</span>
<span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;new value: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span></code></pre></figure><p>You can review authentication parameters for <code>RtSttc</code> constructor at <a href="http://www.stateful.co">stateful.co</a>.</p><p>The service is absolutely free of charge.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html&amp;text=Atomic+Counters+at+Stateful.co" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html%3F2014-20&amp;title=Atomic+Counters+at+Stateful.co" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/05/18/cloud-autoincrement-counters.html%3F2014-20&amp;t=Atomic+Counters+at+Stateful.co" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><img src="https://www.yegor256.com/images/2014/04/dynamodb-logo.png" style="width:150px;max-width:100%;" alt="badge" /></figure><p>Amazon DynamoDB is a great NoSQL cloud database. It is cheap, highly reliable and rather powerful. I’m using it in many web systems.</p><p>There is one feature that it lacks, though—auto-increment attributes.</p><p>Say that you have a table with a list of messages:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>+------+----------------------------+
| id   | Attributes                 |
+------+----------------------------+
| 205  | author=&quot;jeff&quot;, text=&quot;...&quot;  |
| 206  | author=&quot;bob&quot;, text=&quot;...&quot;   |
| 207  | author=&quot;alice&quot;, text=&quot;...&quot; |
+------+----------------------------+</code></pre></figure><p>Every time you add a new item to the table, a new value of <code>id</code> has to be set. And this has to be done with concurrency in mind. SQL databases like PostgreSQL, Oracle, MySQL and others support auto-increment features. When you add a new record to the table, the value of the primary key is omitted and the server retrieves the next one automatically. If a number of <code>INSERT</code> requests arrive at the same time the server guarantees that the numbers won’t be duplicated.</p><p>However, DynamoDB doesn’t have this feature. Instead, DynamoDB has <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters">Atomic Counters</a> and <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.ConditionalUpdate">Conditional Updates</a>, which are very similar features. Still, they’re not exactly the same.</p><p>In case of an atomic counter, you should create a supplementary table and keep the latest value of <code>id</code> in it.</p><p>In case of conditional updates, you should <a href="/2014/08/15/retry-java-method-on-exception.html">retry</a> a few times in case of collisions.</p><figure class="badge"><img src="http://img.stateful.co/pomegranate.svg" style="width:128px;max-width:100%;" alt="badge" /></figure><p>To make life easier in a few of my applications, I created a simple web service—<a href="http://www.stateful.co">stateful.co</a>. It provides a simple atomic counter feature through its RESTful API.</p><p>First, you create a counter with a unique name. Then, you set its initial value (it is zero by default). And, that’s it. Every time you need to obtain a new value for <code>id</code> column in DynamoDB table, you make an HTTP request to <a href="http://www.stateful.co">stateful.co</a> asking to increment your counter by one and return its next value.</p><p><a href="http://www.stateful.co">stateful.co</a> guarantees that values returned will never duplicate each other—no matter how many clients are using a counter or how fast they request increments simultaneously.</p><p>Moreover, I designed a small <a href="https://github.com/sttc/java-sdk">Java SDK</a> for <a href="http://www.stateful.co">stateful.co</a>. All you need to do is add this <a href="http://repo1.maven.org/maven2/co/stateful/java-sdk/">java-sdk.jar</a> Maven dependency to your project:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>co.stateful<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-sdk<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>0.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure><p>And, you can use <a href="http://www.stateful.co">stateful.co</a> counters from Java code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Sttc</span> <span class="n">sttc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RtSttc</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">URN</span><span class="o">(</span><span class="s">&quot;urn:github:526301&quot;</span><span class="o">),</span>
  <span class="s">&quot;9FF3-41E0-73FB-F900&quot;</span>
<span class="o">);</span>
<span class="n">Counters</span> <span class="n">counters</span> <span class="o">=</span> <span class="n">sttc</span><span class="o">.</span><span class="na">counters</span><span class="o">();</span>
<span class="n">Counter</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">counters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">);</span>
<span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;new value: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span></code></pre></figure><p>You can review authentication parameters for <code>RtSttc</code> constructor at <a href="http://www.stateful.co">stateful.co</a>.</p><p>The service is absolutely free of charge.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.s3auth.com&quot;&gt;&lt;img src=&quot;http://img.s3auth.com/logo.png&quot; style=&quot;width:200px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://aws.amazon.com/s3/&quot;&gt;Amazon S3&lt;/a&gt; is a simple and very useful storage of binary objects (aka “files”). To use it, you create a “bucket” there with a unique name and upload your objects.&lt;/p&gt; &lt;p&gt;Afterwards, AWS guarantees your object will be available for download through their &lt;a href=&quot;http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html&quot;&gt;RESTful API&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;A few years ago, AWS introduced a S3 feature called &lt;a href=&quot;http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html&quot;&gt;static website hosting&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;With static website hosting, you simply turn on the feature and all objects in your bucket become available through public HTTP. This is an awesome feature for hosting static content, such as images, JavaScript files, video and audio content.&lt;/p&gt; &lt;p&gt;When using the hosting, you need to change the CNAME record in your DNS so that it points to &lt;code&gt;www.example.com.aws.amazon.com&lt;/code&gt;. After changing the DNS entry, your static website is available at &lt;code&gt;www.example.com&lt;/code&gt; just as it would be normally.&lt;/p&gt; &lt;p&gt;When using Amazon S3, though, it is not possible to protect your website because the content is purely static. This means you can’t have a login page on the front end. With the service, you can either make your objects either absolutely public—so that anyone can see them online—or assign access rights to them—but only for users connected through RESTful API.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;My use case with the service was a bit more complex, though. I wanted to host my static content as S3 objects. However, I wanted to do this while ensuring only a few people had access to the content using their Web browsers.&lt;/p&gt; &lt;h2 id=&quot;http-basic-authentication&quot;&gt;HTTP Basic Authentication&lt;/h2&gt; &lt;p&gt;The HTTP protocol offers a nice &lt;a href=&quot;http://en.wikipedia.org/wiki/Basic_access_authentication&quot;&gt;“basic access authentication”&lt;/a&gt; feature that doesn’t require any extra site pages.&lt;/p&gt; &lt;p&gt;When an HTTP request arrives at the server, it doesn’t deliver the content but replies with a 401 status response. This response means literally “I don’t know who you are, please authenticate yourself.”&lt;/p&gt; &lt;p&gt;The browser shows its native login screen and prompts for a user name and password. After entering the login credentials, they are concatenated, &lt;a href=&quot;http://en.wikipedia.org/wiki/Base64&quot;&gt;Base64&lt;/a&gt; encoded, and added to the next request in &lt;code&gt;Authorization&lt;/code&gt; HTTP header.&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2014/04/s3auth-authentication-dialog.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Now, the browser tries to make another attempt to fetch the same webpage. But, this time, the HTTP request contains a header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;Authorization: Basic am9lOnNlY3JldA==&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The above is just an example. In the example, the Base64 encoded part means &lt;code&gt;joe:secret&lt;/code&gt;, where &lt;code&gt;joe&lt;/code&gt; is the user name and &lt;code&gt;secret&lt;/code&gt; the password entered by the user.&lt;/p&gt; &lt;p&gt;This time the server has authentication information and can make a decision whether this user is authenticated (his password matches the server’s records) and authorized (he has permission to access the request webpage).&lt;/p&gt; &lt;h2 id=&quot;s3authcom&quot;&gt;&lt;code&gt;s3auth.com&lt;/code&gt;&lt;/h2&gt; &lt;p&gt;Since Amazon doesn’t provide this feature, I decided to create a simple web service, &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt;, which stays in front of my Amazon S3 buckets and implements the HTTP-native authentication and authorization mechanism.&lt;/p&gt; &lt;p&gt;Instead of making my objects public, though, I make them private and point my CNAME record to &lt;code&gt;relay.s3auth.com&lt;/code&gt;. HTTP requests from Web browsers then arrive at my server, connect to Amazon S3, retrieve my objects and deliver them back in HTTP responses.&lt;/p&gt; &lt;p&gt;The server implements authentication and authorization using a special file &lt;code&gt;.htpasswd&lt;/code&gt; in the root of my bucket. The format of the &lt;code&gt;.htpasswd&lt;/code&gt; file is identical to the one used by &lt;a href=&quot;http://httpd.apache.org/docs/2.2/programs/htpasswd.html&quot;&gt;Apache HTTP Server&lt;/a&gt;—one user per line. Every line has the name of a user and a hash version of his password.&lt;/p&gt; &lt;h2 id=&quot;implementation&quot;&gt;Implementation&lt;/h2&gt; &lt;p&gt;I made this software open source mostly to guarantee to my users that the server doesn’t store their private data anywhere, but rather acts only as a pass-through service. As a result, the software is on &lt;a href=&quot;https://github.com/yegor256/s3auth&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;For the sake of privacy and convenience, I use only OAuth2 for user accounts. This means that I don’t know who my users are. I don’t possess their names or emails, but only their account numbers in Facebook, Google Plus or GitHub. Of course, I can find their names using these numbers, but this information is public anyway.&lt;/p&gt; &lt;p&gt;The server is implemented in Java6. For its hosting, I’m using a single Amazon EC2 &lt;a href=&quot;http://aws.amazon.com/ec2/instance-types/&quot;&gt;m1.small&lt;/a&gt; Ubuntu server. These days, the server seems to work properly and is stable.&lt;/p&gt; &lt;h2 id=&quot;extra-features&quot;&gt;Extra Features&lt;/h2&gt; &lt;p&gt;Besides authentication and authorization, the &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; server can render lists of pages—just like Apache HTTP Server. If you have a collection of objects in your bucket—but the &lt;code&gt;index.html&lt;/code&gt; file is missing—Amazon S3 delivers a “page not found” result. Conversely, my server displays a list of objects in the bucket, when no &lt;code&gt;index.html&lt;/code&gt; is present, and makes it possible to navigate up or down one folder.&lt;/p&gt; &lt;p&gt;When your bucket has the versioning feature turned on, you are able to list all versions of any object in the browser. To do this, just add &lt;code&gt;?all-versions&lt;/code&gt; to the end of the URL to display the list. Next, click a version to have &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; retrieve and render it.&lt;/p&gt; &lt;h2 id=&quot;traction&quot;&gt;Traction&lt;/h2&gt; &lt;p&gt;I created this service mostly for myself, but apparently I’m not the only with the problems described above. At the moment, &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; hosts over 300 domains and sends through more than 10Mb of data each hour.&lt;/p&gt; &lt;p&gt;PS. This post explains how &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; can be used as a front-end to your Maven repository: &lt;a href=&quot;/2015/09/07/maven-repository-amazon-s3.html&quot;&gt;How to Set Up a Private Maven Repository in Amazon S3&lt;/a&gt;.&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-04-21 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Basic HTTP Auth for S3 Buckets"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.s3auth.com&quot;&gt;&lt;img src=&quot;http://img.s3auth.com/logo.png&quot; style=&quot;width:200px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;&lt;a href=&quot;http://aws.amazon.com/s3/&quot;&gt;Amazon S3&lt;/a&gt; is a simple and very useful storage of binary objects (aka “files”). To use it, you create a “bucket” there with a unique name and upload your objects.&lt;/p&gt; &lt;p&gt;Afterwards, AWS guarantees your object will be available for download through their &lt;a href=&quot;http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html&quot;&gt;RESTful API&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;A few years ago, AWS introduced a S3 feature called &lt;a href=&quot;http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html&quot;&gt;static website hosting&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;With static website hosting, you simply turn on the feature and all objects in your bucket become available through public HTTP. This is an awesome feature for hosting static content, such as images, JavaScript files, video and audio content.&lt;/p&gt; &lt;p&gt;When using the hosting, you need to change the CNAME record in your DNS so that it points to &lt;code&gt;www.example.com.aws.amazon.com&lt;/code&gt;. After changing the DNS entry, your static website is available at &lt;code&gt;www.example.com&lt;/code&gt; just as it would be normally.&lt;/p&gt; &lt;p&gt;When using Amazon S3, though, it is not possible to protect your website because the content is purely static. This means you can’t have a login page on the front end. With the service, you can either make your objects either absolutely public—so that anyone can see them online—or assign access rights to them—but only for users connected through RESTful API.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;My use case with the service was a bit more complex, though. I wanted to host my static content as S3 objects. However, I wanted to do this while ensuring only a few people had access to the content using their Web browsers.&lt;/p&gt; &lt;h2 id=&quot;http-basic-authentication&quot;&gt;HTTP Basic Authentication&lt;/h2&gt; &lt;p&gt;The HTTP protocol offers a nice &lt;a href=&quot;http://en.wikipedia.org/wiki/Basic_access_authentication&quot;&gt;“basic access authentication”&lt;/a&gt; feature that doesn’t require any extra site pages.&lt;/p&gt; &lt;p&gt;When an HTTP request arrives at the server, it doesn’t deliver the content but replies with a 401 status response. This response means literally “I don’t know who you are, please authenticate yourself.”&lt;/p&gt; &lt;p&gt;The browser shows its native login screen and prompts for a user name and password. After entering the login credentials, they are concatenated, &lt;a href=&quot;http://en.wikipedia.org/wiki/Base64&quot;&gt;Base64&lt;/a&gt; encoded, and added to the next request in &lt;code&gt;Authorization&lt;/code&gt; HTTP header.&lt;/p&gt; &lt;figure class=&quot;unprintable&quot;&gt;&lt;img src=&quot;https://www.yegor256.com/images/2014/04/s3auth-authentication-dialog.png&quot; itemprop=&quot;image&quot; style=&quot;width:600px;max-width:100%;&quot; alt=&quot;The figure&quot; /&gt;&lt;/figure&gt; &lt;p&gt;Now, the browser tries to make another attempt to fetch the same webpage. But, this time, the HTTP request contains a header:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;Authorization: Basic am9lOnNlY3JldA==&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;The above is just an example. In the example, the Base64 encoded part means &lt;code&gt;joe:secret&lt;/code&gt;, where &lt;code&gt;joe&lt;/code&gt; is the user name and &lt;code&gt;secret&lt;/code&gt; the password entered by the user.&lt;/p&gt; &lt;p&gt;This time the server has authentication information and can make a decision whether this user is authenticated (his password matches the server’s records) and authorized (he has permission to access the request webpage).&lt;/p&gt; &lt;h2 id=&quot;s3authcom&quot;&gt;&lt;code&gt;s3auth.com&lt;/code&gt;&lt;/h2&gt; &lt;p&gt;Since Amazon doesn’t provide this feature, I decided to create a simple web service, &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt;, which stays in front of my Amazon S3 buckets and implements the HTTP-native authentication and authorization mechanism.&lt;/p&gt; &lt;p&gt;Instead of making my objects public, though, I make them private and point my CNAME record to &lt;code&gt;relay.s3auth.com&lt;/code&gt;. HTTP requests from Web browsers then arrive at my server, connect to Amazon S3, retrieve my objects and deliver them back in HTTP responses.&lt;/p&gt; &lt;p&gt;The server implements authentication and authorization using a special file &lt;code&gt;.htpasswd&lt;/code&gt; in the root of my bucket. The format of the &lt;code&gt;.htpasswd&lt;/code&gt; file is identical to the one used by &lt;a href=&quot;http://httpd.apache.org/docs/2.2/programs/htpasswd.html&quot;&gt;Apache HTTP Server&lt;/a&gt;—one user per line. Every line has the name of a user and a hash version of his password.&lt;/p&gt; &lt;h2 id=&quot;implementation&quot;&gt;Implementation&lt;/h2&gt; &lt;p&gt;I made this software open source mostly to guarantee to my users that the server doesn’t store their private data anywhere, but rather acts only as a pass-through service. As a result, the software is on &lt;a href=&quot;https://github.com/yegor256/s3auth&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;For the sake of privacy and convenience, I use only OAuth2 for user accounts. This means that I don’t know who my users are. I don’t possess their names or emails, but only their account numbers in Facebook, Google Plus or GitHub. Of course, I can find their names using these numbers, but this information is public anyway.&lt;/p&gt; &lt;p&gt;The server is implemented in Java6. For its hosting, I’m using a single Amazon EC2 &lt;a href=&quot;http://aws.amazon.com/ec2/instance-types/&quot;&gt;m1.small&lt;/a&gt; Ubuntu server. These days, the server seems to work properly and is stable.&lt;/p&gt; &lt;h2 id=&quot;extra-features&quot;&gt;Extra Features&lt;/h2&gt; &lt;p&gt;Besides authentication and authorization, the &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; server can render lists of pages—just like Apache HTTP Server. If you have a collection of objects in your bucket—but the &lt;code&gt;index.html&lt;/code&gt; file is missing—Amazon S3 delivers a “page not found” result. Conversely, my server displays a list of objects in the bucket, when no &lt;code&gt;index.html&lt;/code&gt; is present, and makes it possible to navigate up or down one folder.&lt;/p&gt; &lt;p&gt;When your bucket has the versioning feature turned on, you are able to list all versions of any object in the browser. To do this, just add &lt;code&gt;?all-versions&lt;/code&gt; to the end of the URL to display the list. Next, click a version to have &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; retrieve and render it.&lt;/p&gt; &lt;h2 id=&quot;traction&quot;&gt;Traction&lt;/h2&gt; &lt;p&gt;I created this service mostly for myself, but apparently I’m not the only with the problems described above. At the moment, &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; hosts over 300 domains and sends through more than 10Mb of data each hour.&lt;/p&gt; &lt;p&gt;PS. This post explains how &lt;a href=&quot;http://www.s3auth.com&quot;&gt;s3auth.com&lt;/a&gt; can be used as a front-end to your Maven repository: &lt;a href=&quot;/2015/09/07/maven-repository-amazon-s3.html&quot;&gt;How to Set Up a Private Maven Repository in Amazon S3&lt;/a&gt;.&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html" /> <link rel="amphtml" href="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.amp.html" /> <title>Basic HTTP Auth for S3 Buckets </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2014/04/21/s3-http-basic-auth.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2014/04/21/s3-http-basic-auth.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html</code></p><h1 itemprop="name headline mainEntityOfPage">Basic HTTP Auth for S3 Buckets</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-04-21T00:00:00+00:00"> 21 April 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.s3auth.com"><img src="http://img.s3auth.com/logo.png" style="width:200px;max-width:100%;" alt="badge" /></a></figure><p><a href="http://aws.amazon.com/s3/">Amazon S3</a> is a simple and very useful storage of binary objects (aka “files”). To use it, you create a “bucket” there with a unique name and upload your objects.</p><p>Afterwards, AWS guarantees your object will be available for download through their <a href="http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html">RESTful API</a>.</p><p>A few years ago, AWS introduced a S3 feature called <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">static website hosting</a>.</p><p>With static website hosting, you simply turn on the feature and all objects in your bucket become available through public HTTP. This is an awesome feature for hosting static content, such as images, JavaScript files, video and audio content.</p><p>When using the hosting, you need to change the CNAME record in your DNS so that it points to <code>www.example.com.aws.amazon.com</code>. After changing the DNS entry, your static website is available at <code>www.example.com</code> just as it would be normally.</p><p>When using Amazon S3, though, it is not possible to protect your website because the content is purely static. This means you can’t have a login page on the front end. With the service, you can either make your objects either absolutely public—so that anyone can see them online—or assign access rights to them—but only for users connected through RESTful API.</p><p>My use case with the service was a bit more complex, though. I wanted to host my static content as S3 objects. However, I wanted to do this while ensuring only a few people had access to the content using their Web browsers.</p><h2 id="http-basic-authentication">HTTP Basic Authentication</h2><p>The HTTP protocol offers a nice <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">“basic access authentication”</a> feature that doesn’t require any extra site pages.</p><p>When an HTTP request arrives at the server, it doesn’t deliver the content but replies with a 401 status response. This response means literally “I don’t know who you are, please authenticate yourself.”</p><p>The browser shows its native login screen and prompts for a user name and password. After entering the login credentials, they are concatenated, <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> encoded, and added to the next request in <code>Authorization</code> HTTP header.</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2014/04/s3auth-authentication-dialog.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Now, the browser tries to make another attempt to fetch the same webpage. But, this time, the HTTP request contains a header:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>Authorization: Basic am9lOnNlY3JldA==</code></pre></figure><p>The above is just an example. In the example, the Base64 encoded part means <code>joe:secret</code>, where <code>joe</code> is the user name and <code>secret</code> the password entered by the user.</p><p>This time the server has authentication information and can make a decision whether this user is authenticated (his password matches the server’s records) and authorized (he has permission to access the request webpage).</p><h2 id="s3authcom"><code>s3auth.com</code></h2><p>Since Amazon doesn’t provide this feature, I decided to create a simple web service, <a href="http://www.s3auth.com">s3auth.com</a>, which stays in front of my Amazon S3 buckets and implements the HTTP-native authentication and authorization mechanism.</p><p>Instead of making my objects public, though, I make them private and point my CNAME record to <code>relay.s3auth.com</code>. HTTP requests from Web browsers then arrive at my server, connect to Amazon S3, retrieve my objects and deliver them back in HTTP responses.</p><p>The server implements authentication and authorization using a special file <code>.htpasswd</code> in the root of my bucket. The format of the <code>.htpasswd</code> file is identical to the one used by <a href="http://httpd.apache.org/docs/2.2/programs/htpasswd.html">Apache HTTP Server</a>—one user per line. Every line has the name of a user and a hash version of his password.</p><h2 id="implementation">Implementation</h2><p>I made this software open source mostly to guarantee to my users that the server doesn’t store their private data anywhere, but rather acts only as a pass-through service. As a result, the software is on <a href="https://github.com/yegor256/s3auth">GitHub</a>.</p><p>For the sake of privacy and convenience, I use only OAuth2 for user accounts. This means that I don’t know who my users are. I don’t possess their names or emails, but only their account numbers in Facebook, Google Plus or GitHub. Of course, I can find their names using these numbers, but this information is public anyway.</p><p>The server is implemented in Java6. For its hosting, I’m using a single Amazon EC2 <a href="http://aws.amazon.com/ec2/instance-types/">m1.small</a> Ubuntu server. These days, the server seems to work properly and is stable.</p><h2 id="extra-features">Extra Features</h2><p>Besides authentication and authorization, the <a href="http://www.s3auth.com">s3auth.com</a> server can render lists of pages—just like Apache HTTP Server. If you have a collection of objects in your bucket—but the <code>index.html</code> file is missing—Amazon S3 delivers a “page not found” result. Conversely, my server displays a list of objects in the bucket, when no <code>index.html</code> is present, and makes it possible to navigate up or down one folder.</p><p>When your bucket has the versioning feature turned on, you are able to list all versions of any object in the browser. To do this, just add <code>?all-versions</code> to the end of the URL to display the list. Next, click a version to have <a href="http://www.s3auth.com">s3auth.com</a> retrieve and render it.</p><h2 id="traction">Traction</h2><p>I created this service mostly for myself, but apparently I’m not the only with the problems described above. At the moment, <a href="http://www.s3auth.com">s3auth.com</a> hosts over 300 domains and sends through more than 10Mb of data each hour.</p><p>PS. This post explains how <a href="http://www.s3auth.com">s3auth.com</a> can be used as a front-end to your Maven repository: <a href="/2015/09/07/maven-repository-amazon-s3.html">How to Set Up a Private Maven Repository in Amazon S3</a>.</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html&amp;text=Basic+HTTP+Auth+for+S3+Buckets" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html%3F2014-16&amp;title=Basic+HTTP+Auth+for+S3+Buckets" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html%3F2014-16&amp;t=Basic+HTTP+Auth+for+S3+Buckets" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.s3auth.com"><img src="http://img.s3auth.com/logo.png" style="width:200px;max-width:100%;" alt="badge" /></a></figure><p><a href="http://aws.amazon.com/s3/">Amazon S3</a> is a simple and very useful storage of binary objects (aka “files”). To use it, you create a “bucket” there with a unique name and upload your objects.</p><p>Afterwards, AWS guarantees your object will be available for download through their <a href="http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html">RESTful API</a>.</p><p>A few years ago, AWS introduced a S3 feature called <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">static website hosting</a>.</p><p>With static website hosting, you simply turn on the feature and all objects in your bucket become available through public HTTP. This is an awesome feature for hosting static content, such as images, JavaScript files, video and audio content.</p><p>When using the hosting, you need to change the CNAME record in your DNS so that it points to <code>www.example.com.aws.amazon.com</code>. After changing the DNS entry, your static website is available at <code>www.example.com</code> just as it would be normally.</p><p>When using Amazon S3, though, it is not possible to protect your website because the content is purely static. This means you can’t have a login page on the front end. With the service, you can either make your objects either absolutely public—so that anyone can see them online—or assign access rights to them—but only for users connected through RESTful API.</p><p>My use case with the service was a bit more complex, though. I wanted to host my static content as S3 objects. However, I wanted to do this while ensuring only a few people had access to the content using their Web browsers.</p><h2 id="http-basic-authentication">HTTP Basic Authentication</h2><p>The HTTP protocol offers a nice <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">“basic access authentication”</a> feature that doesn’t require any extra site pages.</p><p>When an HTTP request arrives at the server, it doesn’t deliver the content but replies with a 401 status response. This response means literally “I don’t know who you are, please authenticate yourself.”</p><p>The browser shows its native login screen and prompts for a user name and password. After entering the login credentials, they are concatenated, <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> encoded, and added to the next request in <code>Authorization</code> HTTP header.</p><figure class="unprintable"><img src="https://www.yegor256.com/images/2014/04/s3auth-authentication-dialog.png" itemprop="image" style="width:600px;max-width:100%;" alt="The figure" /></figure><p>Now, the browser tries to make another attempt to fetch the same webpage. But, this time, the HTTP request contains a header:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>Authorization: Basic am9lOnNlY3JldA==</code></pre></figure><p>The above is just an example. In the example, the Base64 encoded part means <code>joe:secret</code>, where <code>joe</code> is the user name and <code>secret</code> the password entered by the user.</p><p>This time the server has authentication information and can make a decision whether this user is authenticated (his password matches the server’s records) and authorized (he has permission to access the request webpage).</p><h2 id="s3authcom"><code>s3auth.com</code></h2><p>Since Amazon doesn’t provide this feature, I decided to create a simple web service, <a href="http://www.s3auth.com">s3auth.com</a>, which stays in front of my Amazon S3 buckets and implements the HTTP-native authentication and authorization mechanism.</p><p>Instead of making my objects public, though, I make them private and point my CNAME record to <code>relay.s3auth.com</code>. HTTP requests from Web browsers then arrive at my server, connect to Amazon S3, retrieve my objects and deliver them back in HTTP responses.</p><p>The server implements authentication and authorization using a special file <code>.htpasswd</code> in the root of my bucket. The format of the <code>.htpasswd</code> file is identical to the one used by <a href="http://httpd.apache.org/docs/2.2/programs/htpasswd.html">Apache HTTP Server</a>—one user per line. Every line has the name of a user and a hash version of his password.</p><h2 id="implementation">Implementation</h2><p>I made this software open source mostly to guarantee to my users that the server doesn’t store their private data anywhere, but rather acts only as a pass-through service. As a result, the software is on <a href="https://github.com/yegor256/s3auth">GitHub</a>.</p><p>For the sake of privacy and convenience, I use only OAuth2 for user accounts. This means that I don’t know who my users are. I don’t possess their names or emails, but only their account numbers in Facebook, Google Plus or GitHub. Of course, I can find their names using these numbers, but this information is public anyway.</p><p>The server is implemented in Java6. For its hosting, I’m using a single Amazon EC2 <a href="http://aws.amazon.com/ec2/instance-types/">m1.small</a> Ubuntu server. These days, the server seems to work properly and is stable.</p><h2 id="extra-features">Extra Features</h2><p>Besides authentication and authorization, the <a href="http://www.s3auth.com">s3auth.com</a> server can render lists of pages—just like Apache HTTP Server. If you have a collection of objects in your bucket—but the <code>index.html</code> file is missing—Amazon S3 delivers a “page not found” result. Conversely, my server displays a list of objects in the bucket, when no <code>index.html</code> is present, and makes it possible to navigate up or down one folder.</p><p>When your bucket has the versioning feature turned on, you are able to list all versions of any object in the browser. To do this, just add <code>?all-versions</code> to the end of the URL to display the list. Next, click a version to have <a href="http://www.s3auth.com">s3auth.com</a> retrieve and render it.</p><h2 id="traction">Traction</h2><p>I created this service mostly for myself, but apparently I’m not the only with the problems described above. At the moment, <a href="http://www.s3auth.com">s3auth.com</a> hosts over 300 domains and sends through more than 10Mb of data each hour.</p><p>PS. This post explains how <a href="http://www.s3auth.com">s3auth.com</a> can be used as a front-end to your Maven repository: <a href="/2015/09/07/maven-repository-amazon-s3.html">How to Set Up a Private Maven Repository in Amazon S3</a>.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> <!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.phandom.org&quot;&gt;&lt;img src=&quot;http://img.phandom.org/logo-256x256.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I created &lt;a href=&quot;http://www.phandom.org&quot;&gt;phandom.org&lt;/a&gt; a few months ago, but yesterday finally found the time to make some needed changes to it. So, now is a good time to explain how I’m using Phandom in some of my unit tests.&lt;/p&gt; &lt;p&gt;Before I get started, though, I should say a few words about &lt;a href=&quot;http://phantomjs.org/&quot;&gt;&lt;code&gt;phantomjs&lt;/code&gt;&lt;/a&gt;, which is a JavaScript interface for WebKit. WebKit, on the other hand, is a web browser without a user interface. WebKit is a C++ library that enables manipulation of HTML content, through DOM calls. For example, this is a simple JavaScript located code in &lt;code&gt;example.js&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;page&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;webpage&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;http://google.com&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;loaded!&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;phantom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We run &lt;code&gt;phantomjs&lt;/code&gt; from the command line with the following code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ phantomjs example.js&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;PhantomJS creates a &lt;code&gt;page&lt;/code&gt; object (provided by &lt;a href=&quot;https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage&quot;&gt;webpage&lt;/a&gt; module inside &lt;code&gt;phantomjs&lt;/code&gt;), and then asks it to &lt;code&gt;open()&lt;/code&gt; a Web page. The object communicates with WebKit and converts this call into DOM instructions. After which, the page loads. The PhantomJS engine then terminates on line 6.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;WebKit renders a web page with all necessary components such as CSS, JavaScript, ActionScript, etc, just as any standard Web browser would.&lt;/p&gt; &lt;p&gt;So far so good, and this is the traditional way of using PhantomJS. Now, on to giving you an idea of how &lt;a href=&quot;http://www.phandom.org&quot;&gt;Phandom&lt;/a&gt; (which stands for “PhantomJS DOM”) works inside Java unit tests:&lt;/p&gt; &lt;p&gt;To test this, let’s give &lt;code&gt;phantomjs&lt;/code&gt; an HTML page and ask him to render it. When the page is ready, we’ll ask &lt;code&gt;phantomjs&lt;/code&gt; to show us how this HTML looks in WebKit. If we see the elements we need and desire,—we’re good to go. Let’s use the following example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;com.rexsl.test.XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.phandom.Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DocumentTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rendersValidHtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Document&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Document&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// This is the method we&amp;#39;re testing. It is supposed&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// to return a valid HTML without broken JavaScript&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// and with all required HTML elements.&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;xhtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;dom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hasXPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//p[.=&amp;#39;Hello, world!&amp;#39;]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;When we use the above code, here is what happens. First, we get HTML &lt;code&gt;html&lt;/code&gt; as a &lt;code&gt;String&lt;/code&gt; from &lt;code&gt;doc&lt;/code&gt; object, and then pass it to &lt;a href=&quot;http://www.phandom.org/apidocs-0.2.1/org/phandom/Phandom.html&quot;&gt;&lt;code&gt;Phandom&lt;/code&gt;&lt;/a&gt; as an argument. Then, on line 13, we call the &lt;code&gt;Phandom.dom()&lt;/code&gt; method to get an instance of the class &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;If our HTML contains any broken JavaScript code, method &lt;code&gt;dom()&lt;/code&gt; produces a runtime exception and the unit test fail. If HTML is clean and WebKit is able to render it without problems, the test passes.&lt;/p&gt; &lt;p&gt;I’m using this mechanism in a few different projects,and it works quite well. Therefore, I highly recommend it.&lt;/p&gt; &lt;p&gt;Of course, you shouldn’t forget that you must have &lt;code&gt;phantomjs&lt;/code&gt; installed on your build machine. In order to avoid unit test failures when &lt;code&gt;phantomjs&lt;/code&gt; is not available or present, I’ve created the following supplementary method:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DocumentTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rendersValidHtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Assume&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assumeTrue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;installed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// the rest of the unit test method body...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Enjoy and feel free to report any bugs or problems you encounter to: &lt;a href=&quot;https://github.com/yegor256/phandom/issues&quot;&gt;GitHub issues&lt;/a&gt; :)&lt;/p&gt; " /> <meta name="keywords" content="next, path, output, content, previous, url, relative_path, id, collection, excerpt, draft, categories, layout, title, date, tags, description, keywords, slug, ext" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-04-06 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="PhantomJS as an HTML Validator"/> <meta name="twitter:description" property="og:description" content="&lt;figure class=&quot;badge&quot;&gt;&lt;a href=&quot;http://www.phandom.org&quot;&gt;&lt;img src=&quot;http://img.phandom.org/logo-256x256.png&quot; style=&quot;width:64px;max-width:100%;&quot; alt=&quot;badge&quot; /&gt;&lt;/a&gt;&lt;/figure&gt; &lt;p&gt;I created &lt;a href=&quot;http://www.phandom.org&quot;&gt;phandom.org&lt;/a&gt; a few months ago, but yesterday finally found the time to make some needed changes to it. So, now is a good time to explain how I’m using Phandom in some of my unit tests.&lt;/p&gt; &lt;p&gt;Before I get started, though, I should say a few words about &lt;a href=&quot;http://phantomjs.org/&quot;&gt;&lt;code&gt;phantomjs&lt;/code&gt;&lt;/a&gt;, which is a JavaScript interface for WebKit. WebKit, on the other hand, is a web browser without a user interface. WebKit is a C++ library that enables manipulation of HTML content, through DOM calls. For example, this is a simple JavaScript located code in &lt;code&gt;example.js&lt;/code&gt;:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;page&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;webpage&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;http://google.com&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;loaded!&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;phantom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;We run &lt;code&gt;phantomjs&lt;/code&gt; from the command line with the following code:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;&lt;/span&gt;$ phantomjs example.js&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;PhantomJS creates a &lt;code&gt;page&lt;/code&gt; object (provided by &lt;a href=&quot;https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage&quot;&gt;webpage&lt;/a&gt; module inside &lt;code&gt;phantomjs&lt;/code&gt;), and then asks it to &lt;code&gt;open()&lt;/code&gt; a Web page. The object communicates with WebKit and converts this call into DOM instructions. After which, the page loads. The PhantomJS engine then terminates on line 6.&lt;/p&gt; &lt;!--more--&gt; &lt;p&gt;WebKit renders a web page with all necessary components such as CSS, JavaScript, ActionScript, etc, just as any standard Web browser would.&lt;/p&gt; &lt;p&gt;So far so good, and this is the traditional way of using PhantomJS. Now, on to giving you an idea of how &lt;a href=&quot;http://www.phandom.org&quot;&gt;Phandom&lt;/a&gt; (which stands for “PhantomJS DOM”) works inside Java unit tests:&lt;/p&gt; &lt;p&gt;To test this, let’s give &lt;code&gt;phantomjs&lt;/code&gt; an HTML page and ask him to render it. When the page is ready, we’ll ask &lt;code&gt;phantomjs&lt;/code&gt; to show us how this HTML looks in WebKit. If we see the elements we need and desire,—we’re good to go. Let’s use the following example:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;com.rexsl.test.XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.hamcrest.MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.phandom.Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DocumentTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rendersValidHtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Document&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Document&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// This is the method we&amp;#39;re testing. It is supposed&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// to return a valid HTML without broken JavaScript&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// and with all required HTML elements.&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MatcherAssert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;xhtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;dom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;XhtmlMatchers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hasXPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;//p[.=&amp;#39;Hello, world!&amp;#39;]&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;When we use the above code, here is what happens. First, we get HTML &lt;code&gt;html&lt;/code&gt; as a &lt;code&gt;String&lt;/code&gt; from &lt;code&gt;doc&lt;/code&gt; object, and then pass it to &lt;a href=&quot;http://www.phandom.org/apidocs-0.2.1/org/phandom/Phandom.html&quot;&gt;&lt;code&gt;Phandom&lt;/code&gt;&lt;/a&gt; as an argument. Then, on line 13, we call the &lt;code&gt;Phandom.dom()&lt;/code&gt; method to get an instance of the class &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;If our HTML contains any broken JavaScript code, method &lt;code&gt;dom()&lt;/code&gt; produces a runtime exception and the unit test fail. If HTML is clean and WebKit is able to render it without problems, the test passes.&lt;/p&gt; &lt;p&gt;I’m using this mechanism in a few different projects,and it works quite well. Therefore, I highly recommend it.&lt;/p&gt; &lt;p&gt;Of course, you shouldn’t forget that you must have &lt;code&gt;phantomjs&lt;/code&gt; installed on your build machine. In order to avoid unit test failures when &lt;code&gt;phantomjs&lt;/code&gt; is not available or present, I’ve created the following supplementary method:&lt;/p&gt; &lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DocumentTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@Test&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rendersValidHtml&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Assume&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;assumeTrue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Phandom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;installed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// the rest of the unit test method body...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt; &lt;p&gt;Enjoy and feel free to report any bugs or problems you encounter to: &lt;a href=&quot;https://github.com/yegor256/phandom/issues&quot;&gt;GitHub issues&lt;/a&gt; :)&lt;/p&gt; "/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/04/06/phandom.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="apple-touch-icon" href="/favicon.ico?7d5b276b9b5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7d5b276b9b5"/> <link rel="stylesheet" href="/css/icons.css?7d5b276b9b5"/> <link rel="canonical" href="https://www.yegor256.com/2014/04/06/phandom.html" /> <link rel="amphtml" href="https://www.yegor256.com/2014/04/06/phandom.amp.html" /> <title>PhantomJS as an HTML Validator </title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li /2014/04/06/phandom.html><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li /2014/04/06/phandom.html><a href="/contents.html" title="The contents of the entire blog">All&#160;292</a></li> <li /2014/04/06/phandom.html><a href="/webinars.html" title="My webinars">Webinars</a></li> <li /2014/04/06/phandom.html><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li /2014/04/06/phandom.html><a href="/books.html" title="The books I wrote">Books</a></li> <li /2014/04/06/phandom.html><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li /2014/04/06/phandom.html><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li /2014/04/06/phandom.html class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li /2014/04/06/phandom.html><a href="/award.html" title="Software quality award">Award</a></li> <li /2014/04/06/phandom.html><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li /2014/04/06/phandom.html><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li /2014/04/06/phandom.html><a href="/paintings.html" title="My paintings for sale">Paintings</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/04/06/phandom.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/04/06/phandom.html</code></p><h1 itemprop="name headline mainEntityOfPage">PhantomJS as an HTML Validator</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-04-06T00:00:00+00:00"> 6 April 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/04/06/phandom.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><figure class="badge"><a href="http://www.phandom.org"><img src="http://img.phandom.org/logo-256x256.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>I created <a href="http://www.phandom.org">phandom.org</a> a few months ago, but yesterday finally found the time to make some needed changes to it. So, now is a good time to explain how I’m using Phandom in some of my unit tests.</p><p>Before I get started, though, I should say a few words about <a href="http://phantomjs.org/"><code>phantomjs</code></a>, which is a JavaScript interface for WebKit. WebKit, on the other hand, is a web browser without a user interface. WebKit is a C++ library that enables manipulation of HTML content, through DOM calls. For example, this is a simple JavaScript located code in <code>example.js</code>:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span>
  <span class="s1">&#39;http://google.com&#39;</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loaded!&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></figure><p>We run <code>phantomjs</code> from the command line with the following code:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ phantomjs example.js</code></pre></figure><p>PhantomJS creates a <code>page</code> object (provided by <a href="https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage">webpage</a> module inside <code>phantomjs</code>), and then asks it to <code>open()</code> a Web page. The object communicates with WebKit and converts this call into DOM instructions. After which, the page loads. The PhantomJS engine then terminates on line 6.</p><p>WebKit renders a web page with all necessary components such as CSS, JavaScript, ActionScript, etc, just as any standard Web browser would.</p><p>So far so good, and this is the traditional way of using PhantomJS. Now, on to giving you an idea of how <a href="http://www.phandom.org">Phandom</a> (which stands for “PhantomJS DOM”) works inside Java unit tests:</p><p>To test this, let’s give <code>phantomjs</code> an HTML page and ask him to render it. When the page is ready, we’ll ask <code>phantomjs</code> to show us how this HTML looks in WebKit. If we see the elements we need and desire,—we’re good to go. Let’s use the following example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">com.rexsl.test.XhtmlMatchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.phandom.Phandom</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">();</span>
    <span class="c1">// This is the method we&#39;re testing. It is supposed</span>
    <span class="c1">// to return a valid HTML without broken JavaScript</span>
    <span class="c1">// and with all required HTML elements.</span>
    <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">html</span><span class="o">();</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">xhtml</span><span class="o">(</span><span class="k">new</span> <span class="n">Phandom</span><span class="o">(</span><span class="n">html</span><span class="o">).</span><span class="na">dom</span><span class="o">()),</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">hasXPath</span><span class="o">(</span><span class="s">&quot;//p[.=&#39;Hello, world!&#39;]&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>When we use the above code, here is what happens. First, we get HTML <code>html</code> as a <code>String</code> from <code>doc</code> object, and then pass it to <a href="http://www.phandom.org/apidocs-0.2.1/org/phandom/Phandom.html"><code>Phandom</code></a> as an argument. Then, on line 13, we call the <code>Phandom.dom()</code> method to get an instance of the class <code>org.w3c.dom.Document</code>.</p><p>If our HTML contains any broken JavaScript code, method <code>dom()</code> produces a runtime exception and the unit test fail. If HTML is clean and WebKit is able to render it without problems, the test passes.</p><p>I’m using this mechanism in a few different projects,and it works quite well. Therefore, I highly recommend it.</p><p>Of course, you shouldn’t forget that you must have <code>phantomjs</code> installed on your build machine. In order to avoid unit test failures when <code>phantomjs</code> is not available or present, I’ve created the following supplementary method:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Assume</span><span class="o">.</span><span class="na">assumeTrue</span><span class="o">(</span><span class="n">Phandom</span><span class="o">.</span><span class="na">installed</span><span class="o">());</span>
    <span class="c1">// the rest of the unit test method body...</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Enjoy and feel free to report any bugs or problems you encounter to: <a href="https://github.com/yegor256/phandom/issues">GitHub issues</a> :)</p></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/04/06/phandom.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/04/06/phandom.html&amp;text=PhantomJS+as+an+HTML+Validator" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://plus.google.com/share?url=https://www.yegor256.com/2014/04/06/phandom.html" title="Share on Google+" class="button" rel="nofollow"> <span class="count count-googleplus">0</span> <i class="icon icon-googleplus notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/04/06/phandom.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2014/04/06/phandom.html%3F2014-14&amp;title=PhantomJS+as+an+HTML+Validator" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/04/06/phandom.html%3F2014-14&amp;t=PhantomJS+as+an+HTML+Validator" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.phandom.org"><img src="http://img.phandom.org/logo-256x256.png" style="width:64px;max-width:100%;" alt="badge" /></a></figure><p>I created <a href="http://www.phandom.org">phandom.org</a> a few months ago, but yesterday finally found the time to make some needed changes to it. So, now is a good time to explain how I’m using Phandom in some of my unit tests.</p><p>Before I get started, though, I should say a few words about <a href="http://phantomjs.org/"><code>phantomjs</code></a>, which is a JavaScript interface for WebKit. WebKit, on the other hand, is a web browser without a user interface. WebKit is a C++ library that enables manipulation of HTML content, through DOM calls. For example, this is a simple JavaScript located code in <code>example.js</code>:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span>
  <span class="s1">&#39;http://google.com&#39;</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loaded!&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></figure><p>We run <code>phantomjs</code> from the command line with the following code:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ phantomjs example.js</code></pre></figure><p>PhantomJS creates a <code>page</code> object (provided by <a href="https://github.com/ariya/phantomjs/wiki/API-Reference-WebPage">webpage</a> module inside <code>phantomjs</code>), and then asks it to <code>open()</code> a Web page. The object communicates with WebKit and converts this call into DOM instructions. After which, the page loads. The PhantomJS engine then terminates on line 6.</p><p>WebKit renders a web page with all necessary components such as CSS, JavaScript, ActionScript, etc, just as any standard Web browser would.</p><p>So far so good, and this is the traditional way of using PhantomJS. Now, on to giving you an idea of how <a href="http://www.phandom.org">Phandom</a> (which stands for “PhantomJS DOM”) works inside Java unit tests:</p><p>To test this, let’s give <code>phantomjs</code> an HTML page and ask him to render it. When the page is ready, we’ll ask <code>phantomjs</code> to show us how this HTML looks in WebKit. If we see the elements we need and desire,—we’re good to go. Let’s use the following example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">com.rexsl.test.XhtmlMatchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.phandom.Phandom</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">();</span>
    <span class="c1">// This is the method we&#39;re testing. It is supposed</span>
    <span class="c1">// to return a valid HTML without broken JavaScript</span>
    <span class="c1">// and with all required HTML elements.</span>
    <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">html</span><span class="o">();</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">xhtml</span><span class="o">(</span><span class="k">new</span> <span class="n">Phandom</span><span class="o">(</span><span class="n">html</span><span class="o">).</span><span class="na">dom</span><span class="o">()),</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">hasXPath</span><span class="o">(</span><span class="s">&quot;//p[.=&#39;Hello, world!&#39;]&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>When we use the above code, here is what happens. First, we get HTML <code>html</code> as a <code>String</code> from <code>doc</code> object, and then pass it to <a href="http://www.phandom.org/apidocs-0.2.1/org/phandom/Phandom.html"><code>Phandom</code></a> as an argument. Then, on line 13, we call the <code>Phandom.dom()</code> method to get an instance of the class <code>org.w3c.dom.Document</code>.</p><p>If our HTML contains any broken JavaScript code, method <code>dom()</code> produces a runtime exception and the unit test fail. If HTML is clean and WebKit is able to render it without problems, the test passes.</p><p>I’m using this mechanism in a few different projects,and it works quite well. Therefore, I highly recommend it.</p><p>Of course, you shouldn’t forget that you must have <code>phantomjs</code> installed on your build machine. In order to avoid unit test failures when <code>phantomjs</code> is not available or present, I’ve created the following supplementary method:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rendersValidHtml</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Assume</span><span class="o">.</span><span class="na">assumeTrue</span><span class="o">(</span><span class="n">Phandom</span><span class="o">.</span><span class="na">installed</span><span class="o">());</span>
    <span class="c1">// the rest of the unit test method body...</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Enjoy and feel free to report any bugs or problems you encounter to: <a href="https://github.com/yegor256/phandom/issues">GitHub issues</a> :)</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2018</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html> </article></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="http://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge"/> </a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7d5b276b9b5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
