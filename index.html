<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta charset="utf-8"/><meta name="description" content="Personal blog of Yegor Bugayenko about programming, mostly in Java, bug also in PHP, JavaScript, Ruby, Python and Lisp"/><meta name="keywords" content="java blog, java, software development blog, programming blog, yegor bugayenko blog, quality of software, software blog, high quality programming, static analysis, software testing, ruby blog, javascript blog, php blog"/><meta name="viewport" content="width=device-width"/><link rel="icon" type="image/gif" href="http://img.yegor256.com/icon-64x64.png"><link rel="shortcut icon" href="http://img.yegor256.com/icon-64x64.png"/><link rel="alternate" type="application/rss+xml" title="RSS" href="http://www.yegor256.com/rss.xml"/><link rel="author" href="https://plus.google.com/u/0/114792568016408327418?rel=author"/><link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"><link rel="stylesheet" href="/css/layout.css?e14888f"/><link rel="canonical" href="http://www.yegor256.com/index.html"/> <script src="https://code.jquery.com/jquery-2.1.0.min.js"></script><title>Yegor Bugayenko About Programming</title></head><body><div class="wrapper"><div class="content"> <nav class="top" class="navigation"> <a class="item" href="/">home</a> <a class="item" href="/about-me.html">about me</a> <a class="item" href="http://feeds.feedburner.com/yegor256"><i class="fa fa-rss"></i></a> <a class="item" href="http://feedburner.google.com/fb/a/mailverify?uri=yegor256&amp;loc=en_US">subscribe</a><div class="gcse" role="search"><div class="gcse-search"></div></div> </nav> <section class="front"><p> <time datetime="2014-04-28T00:00:00+00:00"> 28 April 2014 </time></p> <header><h1> <a href="/2014/04/28/xml-xpath-hamcrest-matchers.html"> XML/XPath Matchers for Hamcrest </a></h1> </header> <article> <figure class='badge'><img src='http://img.jcabi.com/logo-square.png' style='width:64px' alt='badge'/></figure><p><a href="https://github.com/hamcrest/JavaHamcrest">Hamcrest</a> is my favorite instrument in unit testing. It replaces the JUnit procedural assertions of <code>org.junit.Assert</code> with an object-oriented mechanism. However, I will discuss that subject in more detail sometime later.</p><p>Now, though, I want to demonstrate a new library published today on Github and Maven Central:</p><p><a href="http://matchers.jcabi.com">jcabi-matchers</a>. jcabi-matchers is a collection of Hamcrest matchers to make XPath assertions in XML and XHTML documents.</p><p>Let's say, for instance, a class that is undergoing testing produces an XML that needs to contain a single <code>&lt;message&gt;</code> element with the content <code>"hello, world!"</code></p><p>This is how that code would look in a unit test:</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="java"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">com.jcabi.matchers.XhtmlMatchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hasWelcomeMessage</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">Foo</span><span class="o">().</span><span class="na">createXml</span><span class="o">(),</span>
      <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">hasXPaths</span><span class="o">(</span>
        <span class="s">"/document[count(message)=1]"</span><span class="o">,</span>
        <span class="s">"/document/message[.='hello, world!']"</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></pre></div></td></tr></table><p>There are two alternatives to the above that I'm aware of, which are do almost the same thing: <a href="https://code.google.com/p/xml-matchers/">xml-matchers</a> by <a href="http://blog.davidehringer.com/testing/xmlmatchers-hamcrest-matchers-xml/">David Ehringer</a> and <a href="http://hamcrest.org/JavaHamcrest/javadoc/1.3/org/hamcrest/Matchers.html#hasXPath%28java.lang.String%29"><code>hasXPath()</code></a> method in Hamcrest itself.</p><p>I have tried them both, but faced a number of problems.</p><p>First, Hamcrest <code>hasXPath()</code> works only with an instance of <a href="http://docs.oracle.com/javase/7/docs/api/org/w3c/dom/Node.html"><code>Node</code></a>. With this method, converting a <code>String</code> into <code>Node</code> becomes a repetitive and routine task in every unit test.</p><p>The above is a very strange limitation of Hamcrest in contrast to <a href="http://matchers.jcabi.com">jcabi-matchers</a>, which works with almost anything, from a <code>String</code> to a <a href="http://docs.oracle.com/javase/7/docs/api/java/io/Reader.html"><code>Reader</code></a> and even an <a href="http://docs.oracle.com/javase/7/docs/api/java/io/InputStream.html"><code>InputStream</code></a>.</p><p>Second, `XmlMatchers from <a href="https://code.google.com/p/xml-matchers/">xml-matchers</a> provides a very inconvenient way for working with namespaces. Before you can use an XPath query with a non-default namespace, you should create an instance of NamespaceContext.</p><p>The library provides <a href="https://code.google.com/p/xml-matchers/source/browse/trunk/xml-matchers/src/main/java/org/xmlmatchers/namespace/SimpleNamespaceContext.java">a simple implementation</a> of this interface, but, still, it is requires extra code in every unit test.</p><p><a href="http://matchers.jcabi.com">jcabi-matchers</a> simplifies namespace handling problems even further, as it pre-defines most popular namespaces, including <code>xtml</code>, <code>xs</code>, <code>xsl</code>, etc.</p><p>The following example works right out-of-the-box — without any extra configuration:</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="java">1
2
3
4</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
  <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="s">"http://www.google.com"</span><span class="o">).</span><span class="na">getContent</span><span class="o">(),</span>
  <span class="n">XhtmlMatchers</span><span class="o">.</span><span class="na">hasXPath</span><span class="o">(</span><span class="s">"//xhtml:body"</span><span class="o">)</span>
<span class="o">);</span></pre></div></td></tr></table><p>To summarize, my primary objective with the library was its simplicity of usage.</p></article> <a href="/2014/04/28/xml-xpath-hamcrest-matchers.html#disqus_thread">comments</a> </section><section class="front"><p> <time datetime="2014-04-27T00:00:00+00:00"> 27 April 2014 </time></p> <header><h1> <a href="/2014/04/27/typical-mistakes-in-java-code.html"> Typical Mistakes in Java Code </a></h1> </header> <article><p>This page contains most typical mistakes I see in the Java code of people working with me. Static analysis (we're using <a href="http://www.qulice.com">qulice</a> can't catch all of the mistakes for obvious reasons, and that's why I decided to list them all here.</p><p>Let me know if you want to see something else added here, and I'll be happy to oblige.</p><p>All of the listed mistakes are related to object-oriented programming in general and to Java in particular.</p><h2 id="toc_0">Class Names</h2><p>Read this short <a href="https://github.com/yegor256/d29/wiki/What-is-an-Object%3F">"What is an Object?"</a> article. Your class should be an abstraction of a real life entity with no "validators", "controllers", "managers", etc. If your class name ends with an "-er" — it's <a href="http://c2.com/cgi/wiki?DontNameClassesObjectManagerHandlerOrData">a bad design</a>.</p><p>And, of course, utility classes are anti-patterns, like <a href="http://commons.apache.org/proper/commons-lang/javadocs/api-2.6/org/apache/commons/lang/StringUtils.html"><code>StringUtils</code></a>, <a href="http://commons.apache.org/proper/commons-io/apidocs/org/apache/commons/io/FileUtils.html"><code>FileUtils</code></a>, and <a href="http://commons.apache.org/proper/commons-io/apidocs/org/apache/commons/io/IOUtils.html"><code>IOUtils</code></a> from Apache. The above are perfect examples of terrible designs.</p><p>Of course, never add suffixes or prefixes to distinguish between <a href="http://c2.com/cgi/wiki?DontDistinguishBetweenClassesAndInterfaces">interfaces and classes</a>. For example, all of these names are terribly wrong: <code>IRecord</code>, <code>IfaceEmployee</code>, or <code>RecordInterface</code>. Usually, interface name is the name of a real-life entity, while class name should explain its implementation details. If there is nothing specific to say about an implementation, name it <code>Default,</code> <code>Simple</code>, or something similar. For example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">class</span> <span class="nc">SimpleUser</span> <span class="kd">implements</span> <span class="n">User</span> <span class="o">{};</span>
<span class="kd">class</span> <span class="nc">DefaultRecord</span> <span class="kd">implements</span> <span class="n">Record</span> <span class="o">{};</span>
<span class="kd">class</span> <span class="nc">Suffixed</span> <span class="kd">implements</span> <span class="n">Name</span> <span class="o">{};</span>
<span class="kd">class</span> <span class="nc">Validated</span> <span class="kd">implements</span> <span class="n">Content</span> <span class="o">{};</span>
</code></pre></div><h2 id="toc_1">Method Names</h2><p>Methods can either return something or return <code>void</code>. If a method returns something, then its name should explain <em>what it returns</em>, for example (don't use the <code>get</code> prefix ever):</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="n">String</span> <span class="nf">content</span><span class="o">();</span>
<span class="kt">int</span> <span class="nf">ageOf</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">);</span>
</code></pre></div><p>If it returns <code>void,</code> then its name should explain <em>what it does</em>. For example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">);</span>
<span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Work</span> <span class="n">work</span><span class="o">);</span>
<span class="kt">void</span> <span class="nf">append</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">,</span> <span class="n">String</span> <span class="n">line</span><span class="o">);</span>
</code></pre></div><p>There is only one exception to the rule just mentioned — test methods for JUnit. They are explained below.</p><h2 id="toc_2">Test Method Names</h2><p>Method names in JUnit tests should be created as English sentences without spaces. It's easier to explain by example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * HttpRequest can return its content in Unicode.</span>
<span class="cm"> * @throws Exception If test fails</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsItsContentInUnicode</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div><p>It's important to start the first sentence of your JavaDoc with the name of the class you're testing followed by <code>can</code>. So, your first sentence should always be similar to "somebody <em>can</em> do something".</p><p>The method name will state exactly the same, but without the subject. If I add a subject at the beginning of the method name, I should get a complete English sentence, as in above example: "HttpRequest returns its content in unicode".</p><p>Pay attention that the test method doesn't start with <code>can</code>.Only JavaDoc comments start with 'can.' Additionally, method names shouldn’t start with a verb.</p><p>It's a good practice to always declare test methods as throwing <code>Exception</code>.</p><h2 id="toc_3">Variable Names</h2><p>Avoid composite names of variables, like <code>timeOfDay</code>, <code>firstItem</code>, or <code>httpRequest</code>. I mean with both — class variables and in-method ones. A variable name should be long enough to avoid ambiguity in its scope of visibility, but not too long if possible. A name should be a noun in singular or plural form, or an appropriate abbreviation. For example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span><span class="o">;</span>
<span class="kt">void</span> <span class="nf">sendThroughProxy</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">,</span> <span class="n">Protocol</span> <span class="n">proto</span><span class="o">);</span>
<span class="kd">private</span> <span class="n">File</span> <span class="n">content</span><span class="o">;</span>
<span class="kd">public</span> <span class="n">HttpRequest</span> <span class="n">request</span><span class="o">;</span>
</code></pre></div><p>Sometimes, you may have collisions between constructor parameters and in-class properties if the constructor saves incoming data in an instantiated object. In this case, I recommend to create abbreviations by removing vowels (see how <a href="https://www.usps.com/send/official-abbreviations.htm">USPS abbreviates street names</a>).</p><p>Another example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">recipient</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="n">String</span> <span class="n">rcpt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">recipient</span> <span class="o">=</span> <span class="n">rcpt</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>In many cases, the best hint for a name of a variable can ascertained by reading its class name. Just write it with a small letter, and you should be good:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">File</span> <span class="n">file</span><span class="o">;</span>
<span class="n">User</span> <span class="n">user</span><span class="o">;</span>
<span class="n">Branch</span> <span class="n">branch</span><span class="o">;</span>
</code></pre></div><p>However, <em>never</em> do the same for primitive types, like <code>Integer number</code> or <code>String string</code>.</p><p>You can also use an adjective, when there are multiple variables with different characteristics. For instance:</p><div class="highlight"><pre><code class="text language-text" data-lang="text">String contact(String left, String right);
</code></pre></div><h2 id="toc_4">Constructors</h2><p>Without exceptions, there should be only <em>one</em> constructor that stores data in object variables. All other constructors should call this one with different arguments. For example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Server</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Server</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="toc_5">One-time Variables</h2><p>Avoid one-time variables at all costs. By "one-time" I mean variables that are used only once. Like in this example:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"data.txt"</span><span class="o">;</span>
<span class="k">return</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</code></pre></div><p>This above variable is used only once and the code should be refactored to:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="k">return</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"data.txt"</span><span class="o">);</span>
</code></pre></div><p>Sometimes, in very rare cases — mostly because of better formatting — one-time variables may be used. Nevertheless, try to avoid such situations at all costs.</p><h2 id="toc_6">Exceptions</h2><p>Needless to say, you should <strong>never</strong> swallow exceptions, but rather let them bubble up as high as possible. Private methods should always let checked exceptions go out.</p><p>Never use exceptions for flow control. For example this code is wrong:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">fileSize</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>Seriously, what if that <code>IOException</code> says "disk is full"? Will you still assume that the size of the file is zero and move on?</p><h2 id="toc_7">Indentation</h2><p>For indentation, the main rule is that a bracket should either end a line or be closed on the same line (reverse rule applies to a closing bracket). For example, the following is not correct because the first bracket is not closed on the same line and there are symbols after it. The second bracket is also in trouble because there are symbols in front of it and it is not opened on the same line:</p><div class="highlight"><pre><code class="text language-text" data-lang="text">final File file = new File(directory,
  "file.txt");
</code></pre></div><p>Correct indentation should look like:</p><div class="highlight"><pre><code class="text language-text" data-lang="text">StringUtils.join(
  Arrays.asList(
    "first line",
    "second line",
    StringUtils.join(
      Arrays.asList("a", "b")
    )
  ),
  "separator"
);
</code></pre></div><p>The second important rule of indentation says that you should put as much as possible on one line - within the limit of 80 characters. The example above is not valid since it can be compacted:</p><div class="highlight"><pre><code class="text language-text" data-lang="text">StringUtils.join(
  Arrays.asList(
    "first line", "second line",
    StringUtils.join(Arrays.asList("a", "b"))
  ),
  "separator"
);
</code></pre></div><h2 id="toc_8">Redundant Constants</h2><p>Class constants should be used when you want to share information between class methods, and this information is a characteristic (!) of your class. Don't use constants as a replacement of string or numeric literals — very bad practice that leads to code pollution. Constants (as with any object in OOP) should have a meaning in a real world. What meaning do these constants have in the real world:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Document</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">D_LETTER</span> <span class="o">=</span> <span class="s">"D"</span><span class="o">;</span> <span class="c1">// bad practice</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXTENSION</span> <span class="o">=</span> <span class="s">".doc"</span><span class="o">;</span> <span class="c1">// good practice</span>
<span class="o">}</span>
</code></pre></div><p>Another typical mistake is to use constants in unit tests to avoid duplicate string/numeric literals in test methods. Don't do this! Every test method should work with its own set of input values.</p><p>Use new texts and numbers in every new test method. They are independent. So, why do they have to share the same input constants?</p><h2 id="toc_9">Test Data Coupling</h2><p>This is an example of <a href="http://en.wikipedia.org/wiki/Coupling_%28computer_programming%29">data coupling</a> in a test method:</p><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">"Jeff"</span><span class="o">);</span>
<span class="c1">// maybe some other code here</span>
<span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">Matchers</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">"Jeff"</span><span class="o">));</span>
</code></pre></div><p>On the last line, we couple <code>"Jeff"</code> with the same string literal from the first line. If, a few months later, someone wants to change the value on the third line, he/she has to spend extra time finding where else <code>"Jeff"</code> is used in the same method.</p><p>To avoid this data coupling, you should introduce a variable.</p></article> <a href="/2014/04/27/typical-mistakes-in-java-code.html#disqus_thread">comments</a> </section><section class="front"><p> <time datetime="2014-04-24T00:00:00+00:00"> 24 April 2014 </time></p> <header><h1> <a href="/2014/04/24/java-xml-parsing-and-traversing.html"> Java XML Parsing Made Easy </a></h1> </header> <article><p>Unlike with many other modern languages, parsing XML in Java requires more than one line of code. XML traversing using XPath takes even more code, and I find this is unfair and annoying.</p><p>I'm a big fan of XML and use it it in almost every Java application. Some time ago, I decided to put all of that XML-to-DOM parsing code into a small library —<a href="http://xml.jcabi.com">jcabi-xml</a>.</p><p>Put simply, the library is a convenient wrapper for JDK-native DOM manipulations. That's why it is small and dependency-free. With the following example, you can see just how simple XML parsing can be:</p><div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">com.jcabi.xml.XML</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.jcabi.xml.XMLDocument</span><span class="o">;</span>
<span class="n">XML</span> <span class="n">xml</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XMLDocument</span><span class="o">(</span>
  <span class="s">"&lt;root&gt;&lt;a&gt;hello&lt;/a&gt;&lt;b&gt;world!&lt;/b&gt;&lt;/root&gt;"</span>
<span class="o">);</span>
</code></pre></div><p>Now, we have an object of interface <a href="http://xml.jcabi.com/apidocs-0.7.7/com/jcabi/xml/XML.html"><code>XML</code></a> that can traverse the XML tree and convert it back to text.</p><p>For example:</p><div class="highlight"><pre><code class="java"><span class="c1">// outputs "hello"</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">xml</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">"/root/a/text()"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
<span class="c1">// outputs the entire XML document</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">xml</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div><p>Method <code>xpath()</code> allows you to find a collection of text nodes or attributes in the document, and then convert them to a collection of strings, using <a href="http://en.wikipedia.org/wiki/XPath">XPath query</a>:</p><div class="highlight"><pre><code class="java"><span class="c1">// outputs "hello" and "world"</span>
<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">text</span> <span class="o">:</span> <span class="n">xml</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">"/root/*/text()"</span><span class="o">))</span> <span class="o">{</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>Method <code>nodes()</code> enables the same XPath search operation, but instead returns a collection of instances of <code>XML</code> interface:</p><div class="highlight"><pre><code class="java"><span class="c1">// outputs "&lt;a&gt;hello&lt;/a&gt;" and "&lt;b&gt;world&lt;/b&gt;"</span>
<span class="k">for</span> <span class="o">(</span><span class="n">XML</span> <span class="n">node</span> <span class="o">:</span> <span class="n">xml</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">"/root/*"</span><span class="o">))</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>Besides XML parsing, printing and XPath traversing, <a href="http://xml.jcabi.com">jcabi-xml</a> also provides XSD validation and XSL transformations. I'll write about those features in the next post :)</p></article> <a href="/2014/04/24/java-xml-parsing-and-traversing.html#disqus_thread">comments</a> </section><section class="front"><p> <time datetime="2014-04-21T00:00:00+00:00"> 21 April 2014 </time></p> <header><h1> <a href="/2014/04/21/s3-http-basic-auth.html"> Basic HTTP Auth for S3 Buckets </a></h1> </header> <article> <figure class='badge'><img src='http://img.s3auth.com/logo.png' style='width:200px' alt='badge'/></figure><p><a href="http://aws.amazon.com/s3/">Amazon S3</a> is a simple and very useful storage of binary objects (aka "files"). To use it, you create a "bucket" there with a unique name and upload your objects.</p><p>Afterwards, AWS guarantees your object will be available for download through their <a href="http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html">RESTful API</a>.</p><p>A few years ago, AWS introduced a S3 feature S3 called <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">static website hosting</a>.</p><p>With static website hosting, you simply turn on the feature and all objects in your bucket become available through public HTTP. This is an awesome feature for hosting static content, such as images, JavaScript files, video and audio content.</p><p>When using the hosting, you need to change the CNAME record in your DNS so that it points to <code>www.example.com.aws.amazon.com</code>. After changing the DNS entry, your static website is available at <code>www.example.com</code> just as it would be normally.</p><p>When using Amazon S3, though, it is not possible to protect your website because the content is purely static. This means you can't have a login page on the front end. With the service, you can either make your objects either absolutely public — so that anyone can see them online — or assign access rights to them — but only for users connected through RESTful API.</p><p>My use case with the service was a bit more complex, though. I wanted to host my static content as S3 objects. However, I wanted to do this while ensuring only a few people had access to the content using their Web browsers.</p><h2 id="toc_0">HTTP Basic Authentication</h2><p>The HTTP protocol offers a nice <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">"basic access authentication"</a> feature that doesn't require any extra site pages.</p><p>When an HTTP request arrives at the server, it doesn't deliver the content but replies with a 401 status response. This response means literally "I don't know who you are, please authenticate yourself."</p><p>The browser shows its native login screen and prompts for a user name and password. After entering the login credentials, they are concatenated, <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> encoded, and added to the next request in <code>Authorization</code> HTTP header.</p><figure><img src='http://img.yegor256.com/2014/04/s3auth-authentication-dialog.jpg' style='width:600px' alt='figure'/></figure><p>Now, the browser tries to make another attempt to fetch the same webpage. But, this time, the HTTP request contains a header:</p><div class="highlight"><pre><code class="text">Authorization: Basic am9lOnNlY3JldA==
</code></pre></div><p>The above is just an example. In the example, the Base64 encoded part means <code>joe:secret</code>, where <code>joe</code> is the user name and <code>secret</code> the password entered by the user.</p><p>This time the server has authentication information and can make a decision whether this user is authenticated (his password matches the server's records) and authorized (he has permission to access the request webpage).</p><h2 id="toc_1">s3auth.com</h2><p>Since Amazon doesn't provide this feature, I decided to create a simple web service, <a href="http://www.s3auth.com">s3auth.com</a>, which stays in front of my Amazon S3 buckets and implements the HTTP-native authentication and authorization mechanism.</p><p>Instead of making my objects public, though, I make them private and point my CNAME record to <code>relay.s3auth.com</code>. HTTP requests from Web browsers then arrive at my server, connect to Amazon S3, retrieve my objects and deliver them back in HTTP responses.</p><p>The server implements authentication and authorization using a special file <code>.htpasswd</code> in the root of my bucket. The format of the ".htpasswd" file is identical to the one used by <a href="http://httpd.apache.org/docs/2.2/programs/htpasswd.html">Apache HTTP Server</a> — one user per line. Every line has the name of a user and a hash version of his password.</p><h2 id="toc_2">Implementation</h2><p>I made this software open source mostly to guarantee to my users that the server doesn't store their private data anywhere, but rather acts only as a pass-through service. As a result, the software is on <a href="https://github.com/yegor256/s3auth">Github</a>.</p><p>For the sake of privacy and convenience, I use only OAuth2 for user accounts. This means that I don't know who my users are. I don't possess their names or emails, but only their account numbers in Facebook, Google Plus or Github. Of course, I can find their names using these numbers, but this information is public anyway.</p><p>The server is implemented in Java6. For its hosting, I'm using a single Amazon EC2 <a href="http://aws.amazon.com/ec2/instance-types/">m1.small</a> Ubuntu server. These days, the server seems to work properly and is stable.</p><h2 id="toc_3">Extra Features</h2><p>Besides authentication and authorization, the <a href="http://www.s3auth.com">s3auth.com</a> server can render lists of pages — just like Apache HTTP Server. If you have a collection of objects in your bucket — but the <code>index.html</code> file is missing — Amazon S3 delivers a "page not found" result. Conversely, my server displays a list of objects in the bucket, when no "index.html" is present, and makes it possible to navigate up or down one folder.</p><p>When your bucket has the versioning feature turned on, you are able to list all versions of any object in the browser. To do this, just add <code>?all-versions</code> to the end of the URL to display the list. Next, click a version to have <a href="http://www.s3auth.com">s3auth.com</a> retrieve and render it.</p><h2 id="toc_4">Traction</h2><p>I created this service mostly for myself, but apparently I'm not the only with the problems described above. At the moment, <a href="http://www.s3auth.com">s3auth.com</a> hosts over 300 domains and sends through more than 10Mb of data each hour.</p></article> <a href="/2014/04/21/s3-http-basic-auth.html#disqus_thread">comments</a> </section><section class="front"><p> <time datetime="2014-04-18T00:00:00+00:00"> 18 April 2014 </time></p> <header><h1> <a href="/2014/04/18/jcabi-http-server-mocking.html"> Mocking of HTTP Server in Java </a></h1> </header> <article> <figure class='badge'><img src='http://img.jcabi.com/logo-square.png' style='width:64px' alt='badge'/></figure><p>Recently, I explained a <a href="/2014/04/11/jcabi-http-intro.html">fluent Java HTTP client</a> created (mostly) to make HTTP interactions more object-oriented than with other available clients,including: <a href="http://hc.apache.org/httpclient-3.x/">Apache Client</a>, <a href="https://jersey.java.net/documentation/latest/client.html">Jersey Client</a> and plain old <a href="http://docs.oracle.com/javase/7/docs/api/java/net/HttpURLConnection.html"><code>HttpURLConnection</code></a>.</p><p>This client ships in the <a href="http://http.jcabi.com">jcabi-http</a> Maven artifact. However, the client part is not the only benefit of using <a href="http://http.jcabi.com">jcabi-http</a>. Jcabi also includes a server component that can help you in unit and integration testing of your HTTP clients.</p><p>Let me show you an example first. In the example, I'm using <a href="http://hamcrest.org/JavaHamcrest/">hamcrest</a> for assertions.</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="java"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="n">MkContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MkGrizzlyContainer</span><span class="o">()</span>
  <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="k">new</span> <span class="n">MkAnswer</span><span class="o">.</span><span class="na">Simple</span><span class="o">(</span><span class="s">"hello, world!"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="k">new</span> <span class="nf">JdkRequest</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">home</span><span class="o">())</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"User-agent"</span><span class="o">,</span> <span class="s">"Myself"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">fetch</span><span class="o">()</span>
    <span class="o">.</span><span class="na">assertBody</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">containsString</span><span class="o">(</span><span class="s">"hello"</span><span class="o">));</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="n">container</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">MkQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
<span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
  <span class="n">query</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"User-agent"</span><span class="o">),</span>
  <span class="n">Matchers</span><span class="o">.</span><span class="na">hasItem</span><span class="o">(</span><span class="s">"Myself"</span><span class="o">)</span>
<span class="o">);</span></pre></div></td></tr></table><p>Now, let's discover what happens here.</p><p>In the first few lines, I create an instance of <a href="http://http.jcabi.com/apidocs-1.1/com/jcabi/http/mock/MkContainer.html"><code>MkContainer</code></a>, which literally has four methods: <code>next(MkAnswer)</code>, <code>start()</code>, <code>stop()</code>, and <code>home()</code>.</p><p>It works as an HTTP server with a "first-in-first-out" queue for HTTP answers. We add answers, and the server returns them in response to HTTP requests.</p><p>The server starts on <code>start()</code> call and stops on <code>stop()</code>. Its method <code>home()</code> returns a URL of its "home page". The server then binds itself to a randomly allocated TCP port.</p><p>The container finds the first available and unoccupied port.</p><p>In the example above, I added just one answer. This means that the container will reply only to the first HTTP request with that answer and that all consecutive requests will cause HTTP responses with status "internal server error <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">500</a>."</p><p>In lines 5 through 8, I make an HTTP request to the already started server. Also, I make an assertion that the body of the HTTP response contains the text <code>"hello"</code>. Obviously, this assertion will pass because the server will return <code>"hello, world!"</code> to my first request:</p><div class="highlight"><pre><code class="java"><span class="k">new</span> <span class="nf">JdkRequest</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">home</span><span class="o">())</span>
  <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"User-agent"</span><span class="o">,</span> <span class="s">"Myself"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">fetch</span><span class="o">()</span>
  <span class="o">.</span><span class="na">assertBody</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">containsString</span><span class="o">(</span><span class="s">"hello"</span><span class="o">));</span>
</code></pre></div><p>As you can see, I use <code>container.home()</code> in order to get the URL of the server. It is recommended that you allow the container to find the first unoccupied TCP port and bind itself to it. Nevertheless, if you need to specify your own port, you can do it with a one-argument method <a href="http://http.jcabi.com/apidocs-1.3/com/jcabi/http/mock/MkContainer.html#start%28int%29"><code>start(int)</code></a> in <code>MkContainer</code>.</p><p>I use <code>try/finally</code> to stop the container safely. In unit tests, this is not critical, as you can simplify your code and never stop the container. Besides, the container will be killed together with the JVM. However, for the sake of clarity, I would recommend you stop the container in the <code>finally</code> block.</p><p>On line 12, I ask the stopped container to give me the first request it received. This mechanism is similar conceptually to the "verify" technology of mocking frameworks. For example, <a href="http://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html#4">Mockito</a>.</p><div class="highlight"><pre><code class="java"><span class="n">MkQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
<span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
  <span class="n">query</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"User-agent"</span><span class="o">),</span>
  <span class="n">Matchers</span><span class="o">.</span><span class="na">hasItem</span><span class="o">(</span><span class="s">"Myself"</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div><p>An instance of <a href="http://http.jcabi.com/apidocs-1.3/com/jcabi/http/mock/MkQuery.html"><code>MkQuery</code></a> exposes information about the query made. In this example, I get all headers of the HTTP request and making an assertion that the<code>"User-Agent"</code> header was there and had at least one value equal to <code>"Myself"</code>.</p><p>This mocking technology is used actively in unit and integration tests of <a href="http://github.com/jcabi/jcabi-github">jcabi-github</a>, which is a Java client to Github API. In its development, the technology is very important in checking which requests are being sent to the server and validating whether they comply with our requirements. Here, we are using <a href="http://http.jcabi.com">jcabi-http</a> mocking.</p><p>As with the client, you need the <a href="%60http://repo1.maven.org/maven2/com/jcabi/jcabi-http%60">jcabi-http.jar</a> dependency:</p><div class="highlight"><pre><code class="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jcabi-http<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span><span class="c">&lt;!-- check http://http.jcabi.com --&gt;</span><span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><p>Besides the above, you need to add one more dependency, which is a Grizzly HTTP server. <a href="http://http.jcabi.com/apidocs-1.3/com/jcabi/http/mock/MkGrizzlyContainer.html"><code>MkGrizzlyContainer</code></a> is based on it.</p><div class="highlight"><pre><code class="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.sun.grizzly<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>grizzly-servlet-webserver<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.9.59<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><p>If you have any questions or suggestions, please submit them through <a href="http://github.com/jcabi/jcabi-http/issues">Github issues</a>. As always, bugs are welcome :)</p></article> <a href="/2014/04/18/jcabi-http-server-mocking.html#disqus_thread">comments</a> </section><div class="pagination"><div style="float:left"> <span class="mute">prev</span></div> page 1 of 3<div style="float:right"> <a href="/p/2">next</a></div></div></div></div></body> <script src="/js/all.js?e14888f"></script></html>